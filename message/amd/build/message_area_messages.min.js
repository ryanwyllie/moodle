define(["jquery","core/ajax","core/templates","core/notification","core/custom_interaction_events","core/auto_rows","core_message/message_area_actions"],function(a,b,c,d,e,f,g){function h(a){this.messageArea=a,this._init()}var i=500,j=50;return h.prototype._isSendingMessage=!1,h.prototype._isLoadingMessages=!1,h.prototype._numMessagesDisplayed=0,h.prototype._numMessagesToRetrieve=20,h.prototype.messageArea=null,h.prototype._init=function(){e.define(this.messageArea.node,[e.events.activate,e.events.up,e.events.down,e.events.enter]),f.init(this.messageArea.node),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONVERSATIONDELETED,this._handleConversationDeleted.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONVERSATIONSELECTED,this._viewMessages.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.SENDMESSAGE,this._viewMessages.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CHOOSEMESSAGESTODELETE,this._chooseMessagesToDelete.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,this.messageArea.SELECTORS.SENDMESSAGE,this._sendMessage.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,this.messageArea.SELECTORS.STARTDELETEMESSAGES,this._startDeleting.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,this.messageArea.SELECTORS.DELETEMESSAGES,this._deleteMessages.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,this.messageArea.SELECTORS.CANCELDELETEMESSAGES,this._cancelMessagesToDelete.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,this.messageArea.SELECTORS.MESSAGE,this._toggleMessage.bind(this)),this.messageArea.onDelegateEvent(e.events.up,this.messageArea.SELECTORS.MESSAGE,this._selectPreviousMessage.bind(this)),this.messageArea.onDelegateEvent(e.events.down,this.messageArea.SELECTORS.MESSAGE,this._selectNextMessage.bind(this)),this.messageArea.onDelegateEvent("focus",this.messageArea.SELECTORS.SENDMESSAGETEXT,this._setMessaging.bind(this)),this.messageArea.onDelegateEvent("blur",this.messageArea.SELECTORS.SENDMESSAGETEXT,this._clearMessaging.bind(this)),this.messageArea.onDelegateEvent(e.events.enter,this.messageArea.SELECTORS.SENDMESSAGETEXT,this._sendMessageHandler.bind(this)),a(document).on(f.events.ROW_CHANGE,this._adjustMessagesAreaHeight.bind(this)),this._scrollBottom()},h.prototype._viewMessages=function(f,g){this._numMessagesDisplayed=0;var h=b.call([{methodname:"core_message_mark_all_messages_as_read",args:{useridto:this.messageArea.getCurrentUserId(),useridfrom:g}}]),i=0;return c.render("core/loading",{}).then(function(a,b){return c.replaceNodeContents(this.messageArea.SELECTORS.MESSAGESAREA,a,b),h[0]}.bind(this)).then(function(){var b=this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS+" "+this.messageArea.SELECTORS.CONTACT+"[data-userid='"+g+"']");return b.hasClass("unread")&&(b.removeClass("unread"),a(document).trigger("messagearea:conversationselected",g)),this._getMessages(g)}.bind(this)).then(function(a){return i=a.messages.length,c.render("core_message/message_area_messages_area",a)}).then(function(a,b){c.replaceNodeContents(this.messageArea.SELECTORS.MESSAGESAREA,a,b),this._scrollBottom(),i>0&&(this._numMessagesDisplayed=i),e.define(this.messageArea.SELECTORS.MESSAGES,[e.events.scrollTop]),this.messageArea.onCustomEvent(e.events.scrollTop,this._loadMessages.bind(this))}.bind(this)).fail(d.exception)},h.prototype._loadMessages=function(){if(!this._isLoadingMessages){this._isLoadingMessages=!0;var b=0;return c.render("core/loading",{}).then(function(a,b){return c.prependNodeContents(this.messageArea.SELECTORS.MESSAGES,"<div style='text-align:center'>"+a+"</div>",b),this._getMessages(this._getUserId())}.bind(this)).then(function(a){return b=a.messages.length,c.render("core_message/message_area_messages",a)}).then(function(d,e){if(this.messageArea.find(this.messageArea.SELECTORS.MESSAGES+" "+this.messageArea.SELECTORS.LOADINGICON).remove(),b>0){var f=this.messageArea.node.find(this.messageArea.SELECTORS.BLOCKTIME+":first"),g=a(d).find(this.messageArea.SELECTORS.BLOCKTIME+":first").addBack();f.html()==g.html()&&f.remove();var h=this.messageArea.find(this.messageArea.SELECTORS.MESSAGES)[0].scrollHeight;c.prependNodeContents(this.messageArea.SELECTORS.MESSAGES,d,e);var i=this.messageArea.find(this.messageArea.SELECTORS.MESSAGES)[0].scrollHeight;this.messageArea.find(this.messageArea.SELECTORS.MESSAGES).scrollTop(i-h),this._numMessagesDisplayed+=b}this._isLoadingMessages=!1}.bind(this)).fail(d.exception)}},h.prototype._getMessages=function(a){var c=b.call([{methodname:"core_message_data_for_messagearea_messages",args:{currentuserid:this.messageArea.getCurrentUserId(),otheruserid:a,limitfrom:this._numMessagesDisplayed,limitnum:this._numMessagesToRetrieve,newest:!0}}]);return c[0]},h.prototype._sendMessage=function(){var a=this.messageArea.find(this.messageArea.SELECTORS.SENDMESSAGETEXT).val();if(""!==a.trim()&&!this._isSendingMessage){this._isSendingMessage=!0;var c=b.call([{methodname:"core_message_send_instant_messages",args:{messages:[{touserid:this._getUserId(),text:a}]}}]);return c[0].then(function(b){if(b.length<0)throw new Error("Invalid response");if(b[0].errormessage)throw new Error(b[0].errormessage);return this.messageArea.trigger(this.messageArea.EVENTS.MESSAGESENT,[this._getUserId(),a]),this._addMessageToDom()}.bind(this)).then(function(){this._isSendingMessage=!1}.bind(this)).fail(d.exception)}},h.prototype._chooseMessagesToDelete=function(){this.messageArea.find(this.messageArea.SELECTORS.MESSAGESAREA).addClass("editing"),this.messageArea.find(this.messageArea.SELECTORS.MESSAGE).attr("role","checkbox").attr("aria-checked","false")},h.prototype._deleteMessages=function(){var c=this.messageArea.getCurrentUserId(),e=this.messageArea.find(this.messageArea.SELECTORS.MESSAGE+"[aria-checked='true']"),f=[],g=[];e.each(function(b,d){var e=a(d),h=e.data("messageid"),i=e.data("messageread")?1:0;g.push(e),f.push({methodname:"core_message_delete_message",args:{messageid:h,userid:c,read:i}})}.bind(this)),f.length>0?b.call(f)[f.length-1].then(function(){a.each(g,function(a,b){b.remove()}),a.each(g,function(a,b){var c=b.data("blocktime");0===this.messageArea.find(this.messageArea.SELECTORS.MESSAGE+"[data-blocktime='"+c+"']").length&&this.messageArea.find(this.messageArea.SELECTORS.BLOCKTIME+"[data-blocktime='"+c+"']").remove()}.bind(this)),0===this.messageArea.find(this.messageArea.SELECTORS.MESSAGE).length&&this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS+" "+this.messageArea.SELECTORS.CONTACT+"[data-userid='"+this._getUserId()+"']").remove(),this.messageArea.trigger(this.messageArea.EVENTS.MESSAGESDELETED,this._getUserId())}.bind(this),d.exception):this.messageArea.trigger(this.messageArea.EVENTS.MESSAGESDELETED,this._getUserId()),this._hideDeleteAction()},h.prototype._handleConversationDeleted=function(a,b){b==this._getUserId()&&this.messageArea.find(this.messageArea.SELECTORS.MESSAGESAREA).empty()},h.prototype._hideDeleteAction=function(){this.messageArea.find(this.messageArea.SELECTORS.MESSAGE).removeAttr("role").removeAttr("aria-checked"),this.messageArea.find(this.messageArea.SELECTORS.MESSAGESAREA).removeClass("editing")},h.prototype._cancelMessagesToDelete=function(){this._hideDeleteAction(),this.messageArea.trigger(this.messageArea.EVENTS.CANCELDELETEMESSAGES)},h.prototype._addMessageToDom=function(){var a=b.call([{methodname:"core_message_data_for_messagearea_get_most_recent_message",args:{currentuserid:this.messageArea.getCurrentUserId(),otheruserid:this._getUserId()}}]);return a[0].then(function(a){return c.render("core_message/message_area_message",a)}).then(function(a,b){c.appendNodeContents(this.messageArea.SELECTORS.MESSAGES,a,b),this.messageArea.find(this.messageArea.SELECTORS.SENDMESSAGETEXT).val("").trigger("input"),this._scrollBottom()}.bind(this)).fail(d.exception)},h.prototype._getUserId=function(){return this.messageArea.find(this.messageArea.SELECTORS.MESSAGES).data("userid")},h.prototype._scrollBottom=function(){var a=this.messageArea.find(this.messageArea.SELECTORS.MESSAGES);0!==a.length&&a.scrollTop(a[0].scrollHeight)},h.prototype._selectPreviousMessage=function(b,c){var d=a(b.target).closest(this.messageArea.SELECTORS.MESSAGE);do d=d.prev();while(d.length&&!d.is(this.messageArea.SELECTORS.MESSAGE));d.focus(),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation()},h.prototype._selectNextMessage=function(b,c){var d=a(b.target).closest(this.messageArea.SELECTORS.MESSAGE);do d=d.next();while(d.length&&!d.is(this.messageArea.SELECTORS.MESSAGE));d.focus(),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation()},h.prototype._setMessaging=function(b){a(b.target).closest(this.messageArea.SELECTORS.MESSAGERESPONSE).addClass("messaging")},h.prototype._clearMessaging=function(b){a(b.target).closest(this.messageArea.SELECTORS.MESSAGERESPONSE).removeClass("messaging")},h.prototype._startDeleting=function(a){var b=new g(this.messageArea);b.chooseMessagesToDelete(),a.preventDefault()},h.prototype._isEditing=function(){return this.messageArea.find(this.messageArea.SELECTORS.MESSAGESAREA).hasClass("editing")},h.prototype._toggleMessage=function(b){if(this._isEditing()){var c=a(b.target).closest(this.messageArea.SELECTORS.MESSAGE);"true"===c.attr("aria-checked")?c.attr("aria-checked","false"):c.attr("aria-checked","true")}},h.prototype._adjustMessagesAreaHeight=function(a){var b=this.messageArea.find(this.messageArea.SELECTORS.MESSAGES),c=this.messageArea.find(this.messageArea.SELECTORS.MESSAGERESPONSE),d=c.outerHeight(),e=d-j,f=i-e;b.outerHeight(f)},h.prototype._sendMessageHandler=function(a,b){b.originalEvent.preventDefault(),this._sendMessage()},h});