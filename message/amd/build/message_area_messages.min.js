'use strict';define('core_message/message_area_messages',['jquery','core/ajax','core/templates','core/notification','core/custom_interaction_events','core/auto_rows','core_message/message_area_actions','core/modal_factory','core/modal_events','core/str','core_message/message_area_events','core/backoff_timer'],function($,Ajax,Templates,Notification,CustomEvents,AutoRows,Actions,ModalFactory,ModalEvents,Str,Events,BackOffTimer){function Messages(messageArea){this.messageArea=messageArea,this._init()}var MESSAGES_AREA_DEFAULT_HEIGHT=500,SELECTORS={BLOCKTIME:'[data-region=\'blocktime\']',CANCELDELETEMESSAGES:'[data-action=\'cancel-delete-messages\']',CONTACT:'[data-region=\'contact\']',CONVERSATIONS:'[data-region=\'contacts\'][data-region-content=\'conversations\']',DELETEALLMESSAGES:'[data-action=\'delete-all-messages\']',DELETEMESSAGES:'[data-action=\'delete-messages\']',LOADINGICON:'.loading-icon',MESSAGE:'[data-region=\'message\']',MESSAGERESPONSE:'[data-region=\'response\']',MESSAGES:'[data-region=\'messages\']',MESSAGESAREA:'[data-region=\'messages-area\']',MESSAGINGAREA:'[data-region=\'messaging-area\']',SENDMESSAGE:'[data-action=\'send-message\']',SENDMESSAGETEXT:'[data-region=\'send-message-txt\']',SHOWCONTACTS:'[data-action=\'show-contacts\']',STARTDELETEMESSAGES:'[data-action=\'start-delete-messages\']'};return Messages.prototype._isSendingMessage=!1,Messages.prototype._isLoadingMessages=!1,Messages.prototype._numMessagesDisplayed=0,Messages.prototype._messageQueue=[],Messages.prototype._numMessagesToRetrieve=20,Messages.prototype._confirmationModal=null,Messages.prototype._latestMessageTimestamp=0,Messages.prototype._backoffTimer=null,Messages.prototype.messageArea=null,Messages.prototype._init=function(){CustomEvents.define(this.messageArea.node,[CustomEvents.events.activate,CustomEvents.events.up,CustomEvents.events.down,CustomEvents.events.enter]),670>=$(window).height()&&(MESSAGES_AREA_DEFAULT_HEIGHT=400),AutoRows.init(this.messageArea.node),this.messageArea.onCustomEvent(Events.CONVERSATIONSELECTED,this._viewMessages.bind(this)),this.messageArea.onCustomEvent(Events.SENDMESSAGE,this._viewMessages.bind(this)),this.messageArea.onCustomEvent(Events.CHOOSEMESSAGESTODELETE,this._chooseMessagesToDelete.bind(this)),this.messageArea.onCustomEvent(Events.CANCELDELETEMESSAGES,this._hideDeleteAction.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.SENDMESSAGE,this._sendMessage.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.STARTDELETEMESSAGES,this._startDeleting.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.DELETEMESSAGES,this._deleteMessages.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.DELETEALLMESSAGES,this._deleteAllMessages.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.CANCELDELETEMESSAGES,this._triggerCancelMessagesToDelete.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.MESSAGE,this._toggleMessage.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.SHOWCONTACTS,this._hideMessagingArea.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.up,SELECTORS.MESSAGE,this._selectPreviousMessage.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.down,SELECTORS.MESSAGE,this._selectNextMessage.bind(this)),this.messageArea.onDelegateEvent('focus',SELECTORS.SENDMESSAGETEXT,this._setMessaging.bind(this)),this.messageArea.onDelegateEvent('blur',SELECTORS.SENDMESSAGETEXT,this._clearMessaging.bind(this)),$(document).on(AutoRows.events.ROW_CHANGE,this._adjustMessagesAreaHeight.bind(this));var messages=this.messageArea.find(SELECTORS.MESSAGES);messages.length&&(this._addScrollEventListener(messages.find(SELECTORS.MESSAGE).length),this._latestMessageTimestamp=messages.find(SELECTORS.MESSAGE+':last').data('timecreated')),this._backoffTimer=new BackOffTimer(this._loadNewMessages.bind(this),BackOffTimer.getIncrementalCallback(1000*this.messageArea.pollmin,1000,1000*this.messageArea.pollmax,1000*this.messageArea.polltimeout)),this._backoffTimer.start()},Messages.prototype._viewMessages=function(event,userid){this._numMessagesDisplayed=0,this._backoffTimer.stop(),this._latestMessageTimestamp=0;var markMessagesAsRead=Ajax.call([{methodname:'core_message_mark_all_messages_as_read',args:{useridto:this.messageArea.getCurrentUserId(),useridfrom:userid}}]),numberreceived=0;return Templates.render('core/loading',{}).then(function(html,js){return Templates.replaceNodeContents(this.messageArea.find(SELECTORS.MESSAGESAREA),html,js),markMessagesAsRead[0]}.bind(this)).then(function(){var conversationnode=this.messageArea.find(SELECTORS.CONVERSATIONS+' '+SELECTORS.CONTACT+'[data-userid=\''+userid+'\']');return conversationnode.hasClass('unread')&&(conversationnode.removeClass('unread'),$(document).trigger('messagearea:conversationselected',userid)),this._getMessages(userid)}.bind(this)).then(function(data){return numberreceived=data.messages.length,Templates.render('core_message/message_area_messages_area',data)}).then(function(html,js){Templates.replaceNodeContents(this.messageArea.find(SELECTORS.MESSAGESAREA),html,js),this._addScrollEventListener(numberreceived),this._backoffTimer.restart(),this.messageArea.find(SELECTORS.SENDMESSAGETEXT).focus()}.bind(this)).fail(Notification.exception)},Messages.prototype._loadMessages=function(){if(this._isLoadingMessages)return!1;this._isLoadingMessages=!0;var numberreceived=0;return Templates.render('core/loading',{}).then(function(html,js){return Templates.prependNodeContents(this.messageArea.find(SELECTORS.MESSAGES),'<div style=\'text-align:center\'>'+html+'</div>',js),this._getMessages(this._getUserId())}.bind(this)).then(function(data){return numberreceived=data.messages.length,Templates.render('core_message/message_area_messages',data)}).then(function(html,js){if(this.messageArea.find(SELECTORS.MESSAGES+' '+SELECTORS.LOADINGICON).remove(),0<numberreceived){var newHtml=$('<div>'+html+'</div>');this._hasMatchingBlockTime(this.messageArea.node,newHtml,!0)&&this.messageArea.node.find(SELECTORS.BLOCKTIME+':first').remove();var oldheight=this.messageArea.find(SELECTORS.MESSAGES)[0].scrollHeight;Templates.prependNodeContents(this.messageArea.find(SELECTORS.MESSAGES),html,js);var newheight=this.messageArea.find(SELECTORS.MESSAGES)[0].scrollHeight;this.messageArea.find(SELECTORS.MESSAGES).scrollTop(newheight-oldheight),this._numMessagesDisplayed+=numberreceived}this._isLoadingMessages=!1}.bind(this)).fail(Notification.exception)},Messages.prototype._loadNewMessages=function(){if(this._isLoadingMessages)return!1;if(!this._getUserId())return!1;this._isLoadingMessages=!0;var shouldScrollBottom=!1,messages=this.messageArea.find(SELECTORS.MESSAGES);if(0!==messages.length){var scrollTop=messages.scrollTop(),innerHeight=messages.innerHeight(),scrollHeight=messages[0].scrollHeight;scrollTop+innerHeight>=scrollHeight&&(shouldScrollBottom=!0)}return this._getMessages(this._getUserId(),!0).then(function(data){return this._addMessagesToDom(data.messages,shouldScrollBottom)}.bind(this)).always(function(){this._isLoadingMessages=!1}.bind(this)).fail(Notification.exception)},Messages.prototype._getMessages=function(userid,fromTimestamp){var args={currentuserid:this.messageArea.getCurrentUserId(),otheruserid:userid,limitfrom:this._numMessagesDisplayed,limitnum:this._numMessagesToRetrieve,newest:!0};fromTimestamp&&(args.timefrom=this._latestMessageTimestamp,args.limitfrom=0,args.limitnum=0);var promises=Ajax.call([{methodname:'core_message_data_for_messagearea_messages',args:args}]);return promises[0].then(function(data){var messages=data.messages;if(messages&&messages.length){var latestMessage=messages[messages.length-1];latestMessage.timecreated>this._latestMessageTimestamp&&(this._latestMessageTimestamp=latestMessage.timecreated+1)}return data}.bind(this)).fail(function(ex){this._backoffTimer.stop(),Notification.exception(ex)}.bind(this))},Messages.prototype._sendMessage=function(){var element=this.messageArea.find(SELECTORS.SENDMESSAGETEXT),text=element.val().trim();if(''===text)return!1;if(this._isSendingMessage)return!1;this._isSendingMessage=!0;var promises=Ajax.call([{methodname:'core_message_send_instant_messages',args:{messages:[{touserid:this._getUserId(),text:text}]}}]);return element.prop('disabled',!0),promises[0].then(function(response){if(0>response.length)throw new Error('Invalid response');if(response[0].errormessage)throw new Error(response[0].errormessage);return this.messageArea.trigger(Events.MESSAGESENT,[this._getUserId(),text]),this._addLastMessageToDom()}.bind(this)).then(function(){this._isSendingMessage=!1}.bind(this)).always(function(){element.prop('disabled',!1),element.focus()}).fail(Notification.exception)},Messages.prototype._chooseMessagesToDelete=function(){this.messageArea.find(SELECTORS.MESSAGESAREA).addClass('editing'),this.messageArea.find(SELECTORS.MESSAGE).attr('role','checkbox').attr('aria-checked','false')},Messages.prototype._deleteMessages=function(){var userid=this.messageArea.getCurrentUserId(),checkboxes=this.messageArea.find(SELECTORS.MESSAGE+'[aria-checked=\'true\']'),requests=[],messagestoremove=[];checkboxes.each(function(id,element){var node=$(element),messageid=node.data('messageid'),isread=node.data('messageread')?1:0;messagestoremove.push(node),requests.push({methodname:'core_message_delete_message',args:{messageid:messageid,userid:userid,read:isread}})}),0<requests.length?$.when(Ajax.call(requests)).then(function(){var updatemessage=null,messages=this.messageArea.find(SELECTORS.MESSAGE),lastmessage=messages.last(),lastremovedmessage=messagestoremove[messagestoremove.length-1];$.each(messagestoremove,function(key,message){message.remove()}),lastmessage.data('id')===lastremovedmessage.data('id')&&(updatemessage=this.messageArea.find(SELECTORS.MESSAGE).last()),$.each(messagestoremove,function(key,message){var blocktime=message.data('blocktime');0===this.messageArea.find(SELECTORS.MESSAGE+'[data-blocktime=\''+blocktime+'\']').length&&this.messageArea.find(SELECTORS.BLOCKTIME+'[data-blocktime=\''+blocktime+'\']').remove()}.bind(this)),0===this.messageArea.find(SELECTORS.MESSAGE).length&&this.messageArea.find(SELECTORS.CONVERSATIONS+' '+SELECTORS.CONTACT+'[data-userid=\''+this._getUserId()+'\']').remove(),this.messageArea.trigger(Events.MESSAGESDELETED,[this._getUserId(),updatemessage])}.bind(this)).catch(Notification.exception):this.messageArea.trigger(Events.MESSAGESDELETED,this._getUserId()),this._hideDeleteAction()},Messages.prototype._addScrollEventListener=function(numberreceived){this._scrollBottom(),this._numMessagesDisplayed=numberreceived,CustomEvents.define(this.messageArea.find(SELECTORS.MESSAGES),[CustomEvents.events.scrollTop]),this.messageArea.onCustomEvent(CustomEvents.events.scrollTop,this._loadMessages.bind(this))},Messages.prototype._deleteAllMessages=function(){if(this._confirmationModal)return void this._confirmationModal.show();var stringsPromise=Str.get_strings([{key:'confirm'},{key:'deleteallconfirm',component:'message'},{key:'delete'}]),deleteModalPromise=ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL},this.messageArea.find(SELECTORS.DELETEALLMESSAGES));$.when(stringsPromise,deleteModalPromise).then(function(s,modal){modal.setTitle(s[0]),modal.setBody(s[1]),modal.setSaveButtonText(s[2]),this._confirmationModal=modal,modal.getRoot().on(ModalEvents.save,function(){var otherUserId=this._getUserId(),request={methodname:'core_message_delete_conversation',args:{userid:this.messageArea.getCurrentUserId(),otheruserid:otherUserId}};Ajax.call([request])[0].then(function(){this.messageArea.find(SELECTORS.MESSAGESAREA).empty(),this.messageArea.trigger(Events.CONVERSATIONDELETED,otherUserId),this._hideDeleteAction()}.bind(this)).catch(Notification.exception)}.bind(this)),modal.show()}.bind(this)).catch(Notification.exception)},Messages.prototype._hideDeleteAction=function(){this.messageArea.find(SELECTORS.MESSAGE).removeAttr('role').removeAttr('aria-checked'),this.messageArea.find(SELECTORS.MESSAGESAREA).removeClass('editing')},Messages.prototype._triggerCancelMessagesToDelete=function(){this.messageArea.trigger(Events.CANCELDELETEMESSAGES)},Messages.prototype._addMessagesToDom=function(messages,shouldScrollBottom){var numberreceived=0,messagesArea=this.messageArea.find(SELECTORS.MESSAGES);return messages=messages.filter(function(message){var id=''+message.id+message.isread;if(this._messageQueue[id])return!1;var result=messagesArea.find(SELECTORS.MESSAGE+'[data-id="'+id+'"]');return result.length||(this._messageQueue[id]=!0),!result.length}.bind(this)),numberreceived=messages.length,Templates.render('core_message/message_area_messages',{messages:messages}).then(function(html,js){if(0<numberreceived){var newHtml=$('<div>'+html+'</div>');this._hasMatchingBlockTime(this.messageArea.node,newHtml,!1)&&newHtml.find(SELECTORS.BLOCKTIME+':first').remove(),Templates.appendNodeContents(this.messageArea.find(SELECTORS.MESSAGES),newHtml,js),shouldScrollBottom&&this._scrollBottom(),this._numMessagesDisplayed+=numberreceived,this._backoffTimer.restart()}}.bind(this))},Messages.prototype._addLastMessageToDom=function(){var promises=Ajax.call([{methodname:'core_message_data_for_messagearea_get_most_recent_message',args:{currentuserid:this.messageArea.getCurrentUserId(),otheruserid:this._getUserId()}}]);return promises[0].then(function(data){return this._addMessagesToDom([data],!0)}.bind(this)).always(function(){this.messageArea.find(SELECTORS.SENDMESSAGETEXT).val('').trigger('input')}.bind(this)).fail(Notification.exception)},Messages.prototype._getUserId=function(){return this.messageArea.find(SELECTORS.MESSAGES).data('userid')},Messages.prototype._scrollBottom=function(){var messages=this.messageArea.find(SELECTORS.MESSAGES);0!==messages.length&&messages.scrollTop(messages[0].scrollHeight)},Messages.prototype._selectPreviousMessage=function(e,data){var currentMessage=$(e.target).closest(SELECTORS.MESSAGE);do currentMessage=currentMessage.prev();while(currentMessage.length&&!currentMessage.is(SELECTORS.MESSAGE));currentMessage.focus(),data.originalEvent.preventDefault(),data.originalEvent.stopPropagation()},Messages.prototype._selectNextMessage=function(e,data){var currentMessage=$(e.target).closest(SELECTORS.MESSAGE);do currentMessage=currentMessage.next();while(currentMessage.length&&!currentMessage.is(SELECTORS.MESSAGE));currentMessage.focus(),data.originalEvent.preventDefault(),data.originalEvent.stopPropagation()},Messages.prototype._setMessaging=function(e){$(e.target).closest(SELECTORS.MESSAGERESPONSE).addClass('messaging')},Messages.prototype._clearMessaging=function(e){$(e.target).closest(SELECTORS.MESSAGERESPONSE).removeClass('messaging')},Messages.prototype._startDeleting=function(e){var actions=new Actions(this.messageArea);actions.chooseMessagesToDelete(),e.preventDefault()},Messages.prototype._isEditing=function(){return this.messageArea.find(SELECTORS.MESSAGESAREA).hasClass('editing')},Messages.prototype._toggleMessage=function(e){if(this._isEditing()){var message=$(e.target).closest(SELECTORS.MESSAGE);'true'===message.attr('aria-checked')?message.attr('aria-checked','false'):message.attr('aria-checked','true')}},Messages.prototype._adjustMessagesAreaHeight=function(){var messagesArea=this.messageArea.find(SELECTORS.MESSAGES),messagesResponse=this.messageArea.find(SELECTORS.MESSAGERESPONSE),currentMessageResponseHeight=messagesResponse.outerHeight(),newMessagesAreaHeight=MESSAGES_AREA_DEFAULT_HEIGHT-(currentMessageResponseHeight-50);messagesArea.outerHeight(newMessagesAreaHeight)},Messages.prototype._sendMessageHandler=function(e,data){data.originalEvent.preventDefault(),this._sendMessage()},Messages.prototype._hideMessagingArea=function(){this.messageArea.find(SELECTORS.MESSAGINGAREA).removeClass('show-messages').addClass('hide-messages')},Messages.prototype._hasMatchingBlockTime=function(domHtml,newHtml,loadingPreviousMessages){var blockTime,blockTimePos,newBlockTime,newBlockTimePos;return loadingPreviousMessages?(blockTimePos=':first',newBlockTimePos=':last'):(blockTimePos=':last',newBlockTimePos=':first'),blockTime=domHtml.find(SELECTORS.BLOCKTIME+blockTimePos),newBlockTime=newHtml.find(SELECTORS.BLOCKTIME+newBlockTimePos),!!(blockTime.length&&newBlockTime.length)&&blockTime.data('blocktime')==newBlockTime.data('blocktime')},Messages});
//# sourceMappingURL=message_area_messages.min.js.map
