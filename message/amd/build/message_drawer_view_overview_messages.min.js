define(["jquery","core/notification","core/pubsub","core/str","core/templates","core/user_date","core_message/message_repository","core_message/message_drawer_events","core_message/message_drawer_view_overview_section"],function(a,b,c,d,e,f,g,h,i){var j={BLOCKED_ICON_CONTAINER:'[data-region="contact-icon-blocked"]',CONTENT_CONTAINER:'[data-region="content-container"]',LAST_MESSAGE:'[data-region="last-message"]',LAST_MESSAGE_DATE:'[data-region="last-message-date"]',UNREAD_COUNT:'[data-region="unread-count"]',SECTION_TOTAL_COUNT:'[data-region="section-total-count"]',SECTION_UNREAD_COUNT:'[data-region="section-unread-count"]'},k={MESSAGES_LIST:"core_message/message_drawer_messages_list"},l=50,m=0,n=function(a,c){return e.render(k.MESSAGES_LIST,{messages:c}).then(function(b){a.append(b)})["catch"](b.exception)},o=function(a,c){return g.query({userid:c,limit:l+1,offset:m}).then(function(b){var c=b.contacts;return c.length>l?c=c.slice(0,-1):i.setLoadedAll(a,!0),m+=l,c})["catch"](b.exception)},p=function(a){return a.find(j.SECTION_TOTAL_COUNT)},q=function(a){return a.find(j.SECTION_UNREAD_COUNT)},r=function(a){var b=p(a),c=parseInt(b.text());c+=1,b.text(c)},s=function(a){var b=p(a),c=parseInt(b.text());c-=1,b.text(c)},t=function(a){var b=q(a),c=parseInt(b.text());c-=1,b.text(c),c<1&&b.addClass("hidden")},u=function(a,b){return a.find('[data-conversation-id="'+b+'"]')},v=function(a,b){u(a,b).find(j.BLOCKED_ICON_CONTAINER).removeClass("hidden")},w=function(a,b){u(a,b).find(j.BLOCKED_ICON_CONTAINER).addClass("hidden")},x=function(c,e){var g="",h=[{key:"you",component:"core_message"},{key:"strftimetime24",component:"core_langconfig"}];return d.get_strings(h).then(function(a){return g=a[0],f.get([{timestamp:e.timeCreated,format:a[1]}])}).then(function(a){return a[0]}).then(function(b){var d=a(e.text).text();e.fromLoggedInUser&&(d=g+" "+d),c.find(j.LAST_MESSAGE).html(d),c.find(j.LAST_MESSAGE_DATE).text(b).removeClass("hidden")})["catch"](b.exception)},y=function(c,d){var f=Object.assign({fullname:d.conversation.title,lastmessagedate:d.timeCreated,sentfromcurrentuser:d.fromLoggedInUser,lastmessage:a(d.text).text(),profileimageurl:d.conversation.imageurl,userid:d.conversation.id},d);return e.render(k.MESSAGES_LIST,{messages:[f]}).then(function(a){var b=c.find(j.CONTENT_CONTAINER);return b.prepend(a)}).then(function(){return r(c)})["catch"](b.exception)},z=function(a,b){u(a,b).remove(),s(a)},A=function(a,b){var c=u(a,b).find(j.UNREAD_COUNT);c.text("0"),c.addClass("hidden"),t(a)},B=function(a){c.subscribe(h.CONTACT_BLOCKED,function(b){v(a,b)}),c.subscribe(h.CONTACT_UNBLOCKED,function(b){w(a,b)}),c.subscribe(h.CONVERSATION_NEW_LAST_MESSAGE,function(b){var c=b.conversation.id,d=u(a,c);d.length?x(d,b):y(a,b)}),c.subscribe(h.CONVERSATION_DELETED,function(b){z(a,b)}),c.subscribe(h.CONVERSATION_READ,function(b){A(a,b)})},C=function(b){b=a(b),b.attr("data-messages-init")||(B(b),b.attr("data-messages-init",!0)),i.show(b,o,n)};return{show:C}});