define(["jquery","core/ajax","core/templates","core/notification"],function(a,b,c,d){function e(b){this._node=a(b),this._init()}return e.prototype.maxstringlength=60,e.prototype.find=function(a){return this._node.find(a)},e.prototype._init=function(){this._node.on("click",".tabconversations",this._loadConversations.bind(this)),this._node.on("click",".tabcontacts",this._loadContacts.bind(this)),this._node.on("click",".contact-msg",this._loadMessages.bind(this)),this._node.on("click",".sendmessagebtn",this._sendMessage.bind(this))},e.prototype._loadConversations=function(){this._loadContactArea("core_message_data_for_messagearea_conversations")},e.prototype._loadContacts=function(){this._loadContactArea("core_message_data_for_messagearea_contacts")},e.prototype._loadContactArea=function(a){c.render("core_message/loading",{}).done(function(a){this.find(".contacts").empty().append(a)}.bind(this));var e=b.call([{methodname:a,args:[]}]);e[0].then(function(a){return c.render("core_message/contacts",a).then(function(a,b){this.find(".contacts-area").empty().append(a),c.runTemplateJS(b)}.bind(this))}.bind(this)).fail(d.exception)},e.prototype._loadMessages=function(a){c.render("core_message/loading",{}).done(function(a){this.find(".messages-area").empty().append(a)}.bind(this));var e=a.currentTarget.id.substr(8),f=b.call([{methodname:"core_message_data_for_messagearea_messages",args:{userid:e}}]);f[0].then(function(a){return c.render("core_message/messages",a).then(function(a,b){this.find(".messages-area").empty().append(a),c.runTemplateJS(b)}.bind(this))}.bind(this)).fail(d.exception)},e.prototype._sendMessage=function(a){var c=a.currentTarget.id.substr(15),e=this.find("#sendmessagetxt").val(),f=b.call([{methodname:"core_message_send_instant_messages",args:{messages:[{touserid:c,text:e}]}}]);f[0].then(function(){this._addMessageToDom(e,c),this.find("#sendmessagetxt").val("")}.bind(this)).fail(d.exception)},e.prototype._addMessageToDom=function(a,b){var d={blocktime:this._getBlockTime(),position:"right",text:a,timesent:this._getMessageTime()};c.render("core_message/message",d).then(function(a,b){this.find(".messages").append(a),c.runTemplateJS(b)}.bind(this));var e=a.substr(0,this.maxstringlength);a.length>this.maxstringlength&&(e+=" ..."),this.find("#contact-"+b+" .lastmessage").empty().append(e)},e.prototype._getBlockTime=function(){return""},e.prototype._getMessageTime=function(){var a=new Date,b=a.getHours(),c=a.getMinutes(),d=b>=12?"pm":"am";return b%=12,b=b?b:12,c=10>c?"0"+c:c,b+":"+c+" "+d},e});