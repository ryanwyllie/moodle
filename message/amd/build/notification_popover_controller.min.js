define(["jquery","theme_bootstrapbase/bootstrap","core/ajax","core/templates","core/str","core/notification","core/custom_interaction_events","core/mdl_popover_controller","message/notification_repository"],function(a,b,c,d,e,f,g,h,i){var j={MARK_ALL_READ_BUTTON:".mark-all-read-button",USER_ID:"data-userid",MODE_TOGGLE:".mdl-popover-header-actions .fancy-toggle",UNREAD_NOTIFICATIONS_CONTAINER:".unread-notifications",ALL_NOTIFICATIONS_CONTAINER:".all-notifications",SHOW_BUTTON:".show-button",HIDE_BUTTON:".hide-button",CONTENT_ITEM_CONTAINER:".content-item-container",EMPTY_MESSAGE:".empty-message",CONTENT_BODY_SHORT:".content-body-short",CONTENT_BODY_FULL:".content-body-full"},k=function(a){h.call(this,a),this.markAllReadButton=this.root.find(j.MARK_ALL_READ_BUTTON),this.unreadCount=0,this.userId=this.root.attr(j.USER_ID),this.modeToggle=this.root.find(j.MODE_TOGGLE),this.state={unread:{container:this.root.find(j.UNREAD_NOTIFICATIONS_CONTAINER),limit:6,offset:0,loadedAll:!1,initialLoad:!1},all:{container:this.root.find(j.ALL_NOTIFICATIONS_CONTAINER),limit:20,offset:0,loadedAll:!1,initialLoad:!1}},this.loadUnreadNotificationCount(),this.root.find('[data-toggle="tooltip"]').tooltip()};return k.prototype=Object.create(h.prototype),k.prototype.updateButtonAriaLabel=function(){this.isMenuOpen()?e.get_string("hidenotificationwindow","message").done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this)):this.unreadCount?e.get_string("shownotificationwindowwithcount","message",this.unreadCount).done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this)):e.get_string("shownotificationwindownonew","message").done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this))},k.prototype.getContent=function(){return this.getState().container},k.prototype.unreadOnlyMode=function(){return this.modeToggle.hasClass("on")},k.prototype.getState=function(){return this.unreadOnlyMode()?this.state.unread:this.state.all},k.prototype.getOffset=function(){return this.getState().offset},k.prototype.incrementOffset=function(){this.unreadOnlyMode()||(this.getState().offset+=this.getState().limit)},k.prototype.resetOffset=function(){this.getState().offset=0},k.prototype.hasDoneInitialLoad=function(){return this.getState().initialLoad},k.prototype.hasLoadedAllContent=function(){return this.getState().loadedAll},k.prototype.setLoadedAllContent=function(a){this.getState().loadedAll=a},k.prototype.clearUnreadNotifications=function(){this.state.unread.offset=0,this.state.unread.loadedAll=!1,this.state.unread.initialLoad=!1,this.state.unread.container.empty()},k.prototype.renderUnreadCount=function(){var a=this.root.find(".count-container");this.unreadCount?(a.text(this.unreadCount),a.removeClass("hidden")):a.addClass("hidden")},k.prototype.hideUnreadCount=function(){this.root.find(".count-container").addClass("hidden")},k.prototype.loadUnreadNotificationCount=function(){i.countUnread({useridto:this.userId}).then(function(a){this.unreadCount=a,this.renderUnreadCount(),this.updateButtonAriaLabel()}.bind(this))},k.prototype.renderNotifications=function(b,c){var e=[];return b.length&&a.each(b,function(a,b){var f=d.render("message/notification_content_item",b);f.then(function(a,b){c.append(a),d.runTemplateJS(b)}.bind(this)),e.push(f)}.bind(this)),a.when.apply(a.when,e)},k.prototype.loadMoreNotifications=function(){if(this.isLoading||this.hasLoadedAllContent())return a.Deferred().resolve();this.startLoading();var b={limit:this.limit,offset:this.getOffset(),useridto:this.userId,markasread:!0,embeduserto:!1,embeduserfrom:!0};this.unreadOnlyMode()&&(b.status="unread");var c=this.getContent(),d=i.query(b).then(function(a){var b=a.notifications;return this.unreadCount=a.unreadcount,this.setLoadedAllContent(!b.length||b.length<this.limit),this.getState().initialLoad=!0,this.updateButtonAriaLabel(),b.length?(this.incrementOffset(),this.renderNotifications(b,c)):void 0}.bind(this)).always(function(){this.stopLoading()}.bind(this));return d},k.prototype.markAllAsRead=function(){return this.markAllReadButton.addClass("loading"),i.markAllAsRead({useridto:this.userId}).then(function(){this.unreadCount=0,this.clearUnreadNotifications()}.bind(this)).always(function(){this.markAllReadButton.removeClass("loading")}.bind(this))},k.prototype.focusNextContentItem=function(){var b=a(document.activeElement),c=this.getContent();if(c.has(b).length){var d=b.closest(j.CONTENT_ITEM_CONTAINER);d.next().focus()}else this.focusFirstContentItem()},k.prototype.focusPreviousContentItem=function(){var b=a(document.activeElement),c=this.getContent();if(c.has(b).length){var d=b.closest(j.CONTENT_ITEM_CONTAINER);d.prev().focus()}},k.prototype.focusFirstContentItem=function(){var a=this.getContent(),b=a.children().first();b.length||(b=a.next(j.EMPTY_MESSAGE)),b.focus()},k.prototype.focusLastContentItem=function(){var a=this.getContent(),b=a.children().last();b.length||(b=a.next(j.EMPTY_MESSAGE)),b.focus()},k.prototype.expandAllContentItems=function(){this.getContent().find(j.CONTENT_ITEM_CONTAINER).addClass("expanded").attr("aria-expanded","true")},k.prototype.expandContentItem=function(a){a.addClass("expanded"),a.attr("aria-expanded","true"),a.find(j.SHOW_BUTTON).attr("aria-hidden","true"),a.find(j.CONTENT_BODY_SHORT).attr("aria-hidden","true"),a.find(j.CONTENT_BODY_FULL).attr("aria-hidden","false"),a.find(j.HIDE_BUTTON).attr("aria-hidden","false").focus()},k.prototype.collapseContentItem=function(a){a.removeClass("expanded"),a.attr("aria-expanded","false"),a.find(j.HIDE_BUTTON).attr("aria-hidden","true"),a.find(j.CONTENT_BODY_FULL).attr("aria-hidden","true"),a.find(j.CONTENT_BODY_SHORT).attr("aria-hidden","false"),a.find(j.SHOW_BUTTON).attr("aria-hidden","false").focus()},k.prototype.navigateToContextURL=function(a){var b=a.attr("data-context-url");b&&window.location.assign(b)},k.prototype.registerEventListeners=function(){g.define(this.root,[g.events.activate,g.events.next,g.events.previous,g.events.asterix]),this.root.on(g.events.activate,j.SHOW_BUTTON,function(b,c){var d=a(b.target).closest(j.CONTENT_ITEM_CONTAINER);this.expandContentItem(d),b.stopPropagation(),c.originalEvent.preventDefault()}.bind(this)),this.root.on(g.events.next,j.CONTENT_ITEM_CONTAINER,function(b){var c=a(b.target).closest(j.CONTENT_ITEM_CONTAINER);this.expandContentItem(c)}.bind(this)),this.root.on(g.events.activate,j.HIDE_BUTTON,function(b,c){var d=a(b.target).closest(j.CONTENT_ITEM_CONTAINER);this.collapseContentItem(d),b.stopPropagation(),c.originalEvent.preventDefault()}.bind(this)),this.root.on(g.events.previous,j.CONTENT_ITEM_CONTAINER,function(b){var c=a(b.target).closest(j.CONTENT_ITEM_CONTAINER);this.collapseContentItem(c)}.bind(this)),this.root.on(g.events.activate,j.MODE_TOGGLE,function(a){this.modeToggle.hasClass("on")?(this.clearUnreadNotifications(),this.modeToggle.removeClass("on"),this.modeToggle.addClass("off"),this.root.removeClass("unread-only"),e.get_string("shownewnotifications","message").done(function(a){this.modeToggle.attr("aria-label",a)}.bind(this))):(this.modeToggle.removeClass("off"),this.modeToggle.addClass("on"),this.root.addClass("unread-only"),e.get_string("showallnotifications","message").done(function(a){this.modeToggle.attr("aria-label",a)}.bind(this))),this.hasDoneInitialLoad()||this.loadMoreNotifications(),a.stopPropagation()}.bind(this)),this.root.on(g.events.activate,j.CONTENT_ITEM_CONTAINER,function(b){var c=a(b.target).closest(j.CONTENT_ITEM_CONTAINER);this.navigateToContextURL(c),b.stopPropagation()}.bind(this)),this.root.on(g.events.activate,j.MARK_ALL_READ_BUTTON,function(a){this.markAllAsRead(),a.stopPropagation()}.bind(this)),this.root.on(g.events.asterix,function(){this.expandAllContentItems()}.bind(this)),this.root.on(this.events().menuOpened,function(){this.hideUnreadCount(),this.updateButtonAriaLabel(),this.hasDoneInitialLoad()||this.loadMoreNotifications()}.bind(this)),this.root.on(this.events().menuClosed,function(){this.renderUnreadCount(),this.clearUnreadNotifications(),this.updateButtonAriaLabel()}.bind(this)),this.root.on(this.events().startLoading,function(){this.getContent().attr("aria-busy","true")}.bind(this)),this.root.on(this.events().stopLoading,function(){this.getContent().attr("aria-busy","false")}.bind(this)),this.root.on(this.events().contentScrollBottom,function(){this.isLoading||this.hasLoadedAllContent()||this.loadMoreNotifications()}.bind(this))},k});