define(["jquery","theme_bootstrapbase/bootstrap","core/ajax","core/templates","core/str","core/notification","core/custom_interaction_events","core/popover_region_controller","core_message/notification_repository"],function(a,b,c,d,e,f,g,h,i){var j={MARK_ALL_READ_BUTTON:".mark-all-read-button",USER_ID:"data-userid",MODE_TOGGLE:".popover-region-header-actions .fancy-toggle",UNREAD_NOTIFICATIONS_CONTAINER:".unread-notifications",ALL_NOTIFICATIONS_CONTAINER:".all-notifications",BLOCK_BUTTON:".block-button",SHOW_BUTTON:".show-button",HIDE_BUTTON:".hide-button",CONTENT_ITEM_CONTAINER:".content-item-container",EMPTY_MESSAGE:".empty-message",CONTENT_BODY_SHORT:".content-body-short",CONTENT_BODY_FULL:".content-body-full",LINK_URL:"[data-link-url]",DISABLE_ALL_BUTTON:"[data-disable-all]"},k="popup",l=function(a){h.call(this,a),this.markAllReadButton=this.root.find(j.MARK_ALL_READ_BUTTON),this.disableAllButton=this.root.find(j.DISABLE_ALL_BUTTON),this.unreadCount=0,this.userId=this.root.attr(j.USER_ID),this.modeToggle=this.root.find(j.MODE_TOGGLE),this.state={unread:{container:this.root.find(j.UNREAD_NOTIFICATIONS_CONTAINER),limit:6,offset:0,loadedAll:!1,initialLoad:!1},all:{container:this.root.find(j.ALL_NOTIFICATIONS_CONTAINER),limit:20,offset:0,loadedAll:!1,initialLoad:!1}},this.loadUnreadNotificationCount(),this.root.find('[data-toggle="tooltip"]').tooltip()};return l.prototype=Object.create(h.prototype),l.prototype.constructor=l,l.prototype.updateButtonAriaLabel=function(){this.isMenuOpen()?e.get_string("hidenotificationwindow","message").done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this)):this.unreadCount?e.get_string("shownotificationwindowwithcount","message",this.unreadCount).done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this)):e.get_string("shownotificationwindownonew","message").done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this))},l.prototype.getContent=function(){return this.getState().container},l.prototype.unreadOnlyMode=function(){return this.modeToggle.hasClass("on")},l.prototype.getState=function(){return this.unreadOnlyMode()?this.state.unread:this.state.all},l.prototype.getOffset=function(){return this.getState().offset},l.prototype.incrementOffset=function(){this.unreadOnlyMode()||(this.getState().offset+=this.getState().limit)},l.prototype.resetOffset=function(){this.getState().offset=0},l.prototype.hasDoneInitialLoad=function(){return this.getState().initialLoad},l.prototype.hasLoadedAllContent=function(){return this.getState().loadedAll},l.prototype.setLoadedAllContent=function(a){this.getState().loadedAll=a},l.prototype.clearUnreadNotifications=function(){this.state.unread.offset=0,this.state.unread.loadedAll=!1,this.state.unread.initialLoad=!1,this.state.unread.container.empty()},l.prototype.renderUnreadCount=function(){var a=this.root.find(".count-container");this.unreadCount?(a.text(this.unreadCount),a.removeClass("hidden")):a.addClass("hidden")},l.prototype.hideUnreadCount=function(){this.root.find(".count-container").addClass("hidden")},l.prototype.loadUnreadNotificationCount=function(){i.countUnread({useridto:this.userId}).then(function(a){this.unreadCount=a,this.renderUnreadCount(),this.updateButtonAriaLabel()}.bind(this))},l.prototype.renderNotifications=function(b,c){var e=[];return b.length&&a.each(b,function(a,b){if(b.preferenceenabled=!1,b.preference){var f=new RegExp(k);(b.preference.loggedin.match(f)||b.preference.loggedoff.match(f))&&(b.preferenceenabled=!0)}var g=d.render("message/notification_content_item",b);g.then(function(a,b){c.append(a),d.runTemplateJS(b)}.bind(this)),e.push(g)}.bind(this)),a.when.apply(a.when,e)},l.prototype.loadMoreNotifications=function(){if(this.isLoading||this.hasLoadedAllContent())return a.Deferred().resolve();this.startLoading();var b={limit:this.limit,offset:this.getOffset(),useridto:this.userId,markasread:!0,embedpreference:!0,embeduserto:!1,embeduserfrom:!0};this.unreadOnlyMode()&&(b.status="unread");var c=this.getContent(),d=i.query(b).then(function(a){var b=a.notifications;if(this.unreadCount=a.unreadcount,this.setLoadedAllContent(!b.length||b.length<this.limit),this.getState().initialLoad=!0,this.updateButtonAriaLabel(),b.length)return this.incrementOffset(),this.renderNotifications(b,c)}.bind(this)).always(function(){this.stopLoading()}.bind(this));return d},l.prototype.markAllAsRead=function(){return this.markAllReadButton.addClass("loading"),i.markAllAsRead({useridto:this.userId}).then(function(){this.unreadCount=0,this.clearUnreadNotifications()}.bind(this)).always(function(){this.markAllReadButton.removeClass("loading")}.bind(this))},l.prototype.toggleDisableAllStatus=function(){var b=this.disableAllButton,d="true"===b.attr("aria-checked"),g="",h="";return b.addClass("loading"),e.get_strings([{key:"disableall",component:"message"},{key:"enableall",component:"message"}]).then(function(a){g=a[0],h=a[1];var b={methodname:"core_user_update_user",args:{user:{emailstop:d?0:1}}};return c.call([b])[0]}).done(function(){d?(b.attr("aria-checked",!1),b.attr("data-original-title",g),a(document).trigger("messageprefs:enableall")):(b.attr("aria-checked",!0),b.attr("data-original-title",h),a(document).trigger("messageprefs:disableall"))}).fail(f.exception).always(function(){b.removeClass("loading")})},l.prototype.focusNextContentItem=function(){var b=a(document.activeElement),c=this.getContent();if(c.has(b).length){var d=b.closest(j.CONTENT_ITEM_CONTAINER);d.next().focus()}else this.focusFirstContentItem()},l.prototype.focusPreviousContentItem=function(){var b=a(document.activeElement),c=this.getContent();if(c.has(b).length){var d=b.closest(j.CONTENT_ITEM_CONTAINER);d.prev().focus()}},l.prototype.focusFirstContentItem=function(){var a=this.getContent(),b=a.children().first();b.length||(b=a.next(j.EMPTY_MESSAGE)),b.focus()},l.prototype.focusLastContentItem=function(){var a=this.getContent(),b=a.children().last();b.length||(b=a.next(j.EMPTY_MESSAGE)),b.focus()},l.prototype.expandAllContentItems=function(){this.getContent().find(j.CONTENT_ITEM_CONTAINER).addClass("expanded").attr("aria-expanded","true")},l.prototype.expandContentItem=function(a){a.addClass("expanded"),a.attr("aria-expanded","true"),a.find(j.SHOW_BUTTON).attr("aria-hidden","true"),a.find(j.CONTENT_BODY_SHORT).attr("aria-hidden","true"),a.find(j.CONTENT_BODY_FULL).attr("aria-hidden","false"),a.find(j.HIDE_BUTTON).attr("aria-hidden","false").focus()},l.prototype.collapseContentItem=function(a){a.removeClass("expanded"),a.attr("aria-expanded","false"),a.find(j.HIDE_BUTTON).attr("aria-hidden","true"),a.find(j.CONTENT_BODY_FULL).attr("aria-hidden","true"),a.find(j.CONTENT_BODY_SHORT).attr("aria-hidden","false"),a.find(j.SHOW_BUTTON).attr("aria-hidden","false").focus()},l.prototype.navigateToLinkURL=function(a,b){var c=a.attr("data-link-url");b=b||!1,c&&(b?window.open(c,"_blank"):window.location.assign(c))},l.prototype.removeDisableNotificationButtons=function(a){this.root.find('[data-preference-key="'+a+'"]').remove()},l.prototype.disableNotificationType=function(b){if(b.hasClass("loading"))return a.Deferred();b.addClass("loading");var d=b.attr("data-preference-key"),e=b.attr("data-preference-loggedin"),g=b.attr("data-preference-loggedoff");e=e.split(",").filter(function(a){return a!==k}).join(","),g=g.split(",").filter(function(a){return a!==k}).join(","),""===e&&(e="none"),""===g&&(g="none");var h={user:{preferences:[{type:d+"_loggedin",value:e},{type:d+"_loggedoff",value:g}]}},i={methodname:"core_user_update_user",args:h},j=c.call([i])[0];return j.fail(f.exception),j.always(function(){b.removeClass("loading")}),j.done(function(){this.removeDisableNotificationButtons(d)}.bind(this)),j},l.prototype.registerEventListeners=function(){g.define(this.root,[g.events.activate,g.events.keyboardActivate,g.events.next,g.events.previous,g.events.asterix]),this.root.on(g.events.activate,j.SHOW_BUTTON,function(b,c){var d=a(b.target).closest(j.CONTENT_ITEM_CONTAINER);this.expandContentItem(d),b.stopPropagation(),c.originalEvent.preventDefault()}.bind(this)),this.root.on(g.events.next,j.CONTENT_ITEM_CONTAINER,function(b){var c=a(b.target).closest(j.CONTENT_ITEM_CONTAINER);this.expandContentItem(c)}.bind(this)),this.root.on(g.events.activate,j.HIDE_BUTTON,function(b,c){var d=a(b.target).closest(j.CONTENT_ITEM_CONTAINER);this.collapseContentItem(d),b.stopPropagation(),c.originalEvent.preventDefault()}.bind(this)),this.root.on(g.events.previous,j.CONTENT_ITEM_CONTAINER,function(b){var c=a(b.target).closest(j.CONTENT_ITEM_CONTAINER);this.collapseContentItem(c)}.bind(this)),this.root.on(g.events.activate,j.BLOCK_BUTTON,function(b,c){var d=a(b.target).closest(j.BLOCK_BUTTON);this.disableNotificationType(d),b.stopPropagation(),c.originalEvent.preventDefault()}.bind(this)),this.root.on(g.events.activate,j.MODE_TOGGLE,function(a){this.modeToggle.hasClass("on")?(this.clearUnreadNotifications(),this.modeToggle.removeClass("on"),this.modeToggle.addClass("off"),this.root.removeClass("unread-only"),e.get_string("shownewnotifications","message").done(function(a){this.modeToggle.attr("aria-label",a)}.bind(this))):(this.modeToggle.removeClass("off"),this.modeToggle.addClass("on"),this.root.addClass("unread-only"),e.get_string("showallnotifications","message").done(function(a){this.modeToggle.attr("aria-label",a)}.bind(this))),this.hasDoneInitialLoad()||this.loadMoreNotifications(),a.stopPropagation()}.bind(this)),this.root.on("click",j.LINK_URL,function(b){var c=a(b.target).closest(j.LINK_URL);b.ctrlKey||b.metaKey?this.navigateToLinkURL(c,!0):this.navigateToLinkURL(c,!1),b.stopPropagation(),b.preventDefault()}.bind(this)),this.root.on(g.events.keyboardActivate,j.LINK_URL,function(b){var c=a(b.target).closest(j.LINK_URL);this.navigateToLinkURL(c,!1),b.stopPropagation()}.bind(this)),this.root.on(g.events.activate,j.MARK_ALL_READ_BUTTON,function(a){this.markAllAsRead(),a.stopPropagation()}.bind(this)),this.root.on(g.events.activate,j.DISABLE_ALL_BUTTON,function(a,b){this.toggleDisableAllStatus(),a.stopPropagation(),b.originalEvent.preventDefault()}.bind(this)),this.root.on(g.events.asterix,function(){this.expandAllContentItems()}.bind(this)),this.root.on(this.events().menuOpened,function(){this.hideUnreadCount(),this.updateButtonAriaLabel(),this.hasDoneInitialLoad()||this.loadMoreNotifications()}.bind(this)),this.root.on(this.events().menuClosed,function(){this.renderUnreadCount(),this.clearUnreadNotifications(),this.updateButtonAriaLabel()}.bind(this)),this.root.on(this.events().startLoading,function(){this.getContent().attr("aria-busy","true")}.bind(this)),this.root.on(this.events().stopLoading,function(){this.getContent().attr("aria-busy","false")}.bind(this)),this.getContentContainer().on(g.events.scrollBottom,function(){this.isLoading||this.hasLoadedAllContent()||this.loadMoreNotifications()}.bind(this))},l});