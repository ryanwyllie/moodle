define(["jquery","theme_bootstrapbase/bootstrap","core/ajax","core/templates","core/str","core/url","core/notification","core/custom_interaction_events","core/popover_region_controller","core_message/notification_repository","core_message/notification_area_events"],function(a,b,c,d,e,f,g,h,i,j,k){var l={MARK_ALL_READ_BUTTON:'[data-action="mark-all-read"]',ALL_NOTIFICATIONS_CONTAINER:'[data-region="all-notifications"]',NOTIFICATION:'[data-region="notification-content-item-container"]',UNREAD_NOTIFICATION:'[data-region="notification-content-item-container"].unread',NOTIFICATION_LINK:'[data-action="content-item-link"]',EMPTY_MESSAGE:'[data-region="empty-message"]',COUNT_CONTAINER:'[data-region="count-container"]'},m=function(a){i.call(this,a),this.markAllReadButton=this.root.find(l.MARK_ALL_READ_BUTTON),this.unreadCount=0,this.userId=this.root.attr("data-userid"),this.container=this.root.find(l.ALL_NOTIFICATIONS_CONTAINER),this.limit=20,this.offset=0,this.loadedAll=!1,this.initialLoad=!1,this.loadUnreadNotificationCount(),this.root.find('[data-toggle="tooltip"]').tooltip()};return m.prototype=Object.create(i.prototype),m.prototype.constructor=m,m.prototype.updateButtonAriaLabel=function(){this.isMenuOpen()?e.get_string("hidenotificationwindow","message").done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this)):this.unreadCount?e.get_string("shownotificationwindowwithcount","message",this.unreadCount).done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this)):e.get_string("shownotificationwindownonew","message").done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this))},m.prototype.getContent=function(){return this.container},m.prototype.getOffset=function(){return this.offset},m.prototype.incrementOffset=function(){this.offset+=this.limit},m.prototype.hasDoneInitialLoad=function(){return this.initialLoad},m.prototype.hasLoadedAllContent=function(){return this.loadedAll},m.prototype.setLoadedAllContent=function(a){this.loadedAll=a},m.prototype.renderUnreadCount=function(){var a=this.root.find(l.COUNT_CONTAINER);this.unreadCount?(a.text(this.unreadCount),a.removeClass("hidden")):a.addClass("hidden")},m.prototype.hideUnreadCount=function(){this.root.find(l.COUNT_CONTAINER).addClass("hidden")},m.prototype.loadUnreadNotificationCount=function(){j.countUnread({useridto:this.userId}).then(function(a){this.unreadCount=a,this.renderUnreadCount(),this.updateButtonAriaLabel()}.bind(this))},m.prototype.getNotificationElement=function(a){var b=this.root.find(l.NOTIFICATION+'[data-id="'+a+'"]');return 1==b.length?b:null},m.prototype.renderNotifications=function(b,c){var e=[],h=[],i=[];return b.length&&a.each(b,function(a,b){var c=this.getOffset()-this.limit;b.viewmoreurl=f.relativeUrl("/message/notifications.php",{notificationid:b.id,offset:c},!0);var j=d.render("message/notification_content_item",b);e.push(j),j.then(function(b,c){h[a]=b,i[a]=c}).fail(g.exception)}.bind(this)),a.when.apply(a.when,e).then(function(){b.length&&a.each(b,function(a){c.append(h[a]),d.runTemplateJS(i[a])})})},m.prototype.loadMoreNotifications=function(){if(this.isLoading||this.hasLoadedAllContent())return a.Deferred().resolve();this.startLoading();var b={limit:this.limit,offset:this.getOffset(),useridto:this.userId,markasread:!1,embeduserto:!1,embeduserfrom:!1},c=this.getContent();return j.query(b).then(function(a){var b=a.notifications;return this.unreadCount=a.unreadcount,this.setLoadedAllContent(!b.length||b.length<this.limit),this.initialLoad=!0,this.updateButtonAriaLabel(),!!b.length&&(this.incrementOffset(),this.renderNotifications(b,c))}.bind(this)).always(function(){this.stopLoading()}.bind(this))},m.prototype.markAllAsRead=function(){return this.markAllReadButton.addClass("loading"),j.markAllAsRead({useridto:this.userId}).then(function(){this.unreadCount=0,this.root.find(l.UNREAD_NOTIFICATION).removeClass("unread")}.bind(this)).always(function(){this.markAllReadButton.removeClass("loading")}.bind(this))},m.prototype.markNotificationAsRead=function(a){return!!a.hasClass("unread")&&j.markAsRead(a.attr("data-id")).then(function(){this.unreadCount--,a.removeClass("unread")}.bind(this))},m.prototype.registerEventListeners=function(){h.define(this.root,[h.events.activate]),this.root.on(h.events.activate,l.MARK_ALL_READ_BUTTON,function(a){this.markAllAsRead(),a.stopPropagation()}.bind(this)),this.root.on(h.events.activate,l.NOTIFICATION_LINK,function(b){var c=a(b.target).closest(l.NOTIFICATION);this.markNotificationAsRead(c),b.stopPropagation()}.bind(this)),this.root.on(this.events().menuOpened,function(){this.hideUnreadCount(),this.updateButtonAriaLabel(),this.hasDoneInitialLoad()||this.loadMoreNotifications()}.bind(this)),this.root.on(this.events().menuClosed,function(){this.renderUnreadCount(),this.updateButtonAriaLabel()}.bind(this)),this.root.on(this.events().startLoading,function(){this.getContent().attr("aria-busy","true")}.bind(this)),this.root.on(this.events().stopLoading,function(){this.getContent().attr("aria-busy","false")}.bind(this)),this.getContentContainer().on(h.events.scrollBottom,function(){this.isLoading||this.hasLoadedAllContent()||this.loadMoreNotifications()}.bind(this)),h.define(this.getContentContainer(),[h.events.scrollLock]),a(document).on(k.notificationShown,function(a,b){if(!b.read){var c=this.getNotificationElement(b.id);c&&c.removeClass("unread"),this.unreadCount--,this.renderUnreadCount()}}.bind(this))},m});