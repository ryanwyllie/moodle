define(["jquery","theme_bootstrapbase/bootstrap","core/ajax","core/templates","core/str","core/notification","core/custom_interaction_events","core/popover_region_controller","core_message/message_repository","core/url"],function(a,b,c,d,e,f,g,h,i,j){var k={MARK_ALL_READ_BUTTON:".mark-all-read-button",USER_ID:"data-userid",MODE_TOGGLE:".popover-region-header-actions .fancy-toggle",CONTENT:".messages",CONTENT_ITEM_CONTAINER:".content-item-container",EMPTY_MESSAGE:".empty-message",LINK_URL:"[data-link-url]",BLOCK_NON_CONTACTS_BUTTON:"[data-block-non-contacts]"},l=function(a){h.call(this,a),this.markAllReadButton=this.root.find(k.MARK_ALL_READ_BUTTON),this.blockNonContactsButton=this.root.find(k.BLOCK_NON_CONTACTS_BUTTON),this.content=this.root.find(k.CONTENT),this.userId=this.root.attr(k.USER_ID),this.limit=20,this.offset=0,this.loadedAll=!1,this.initialLoad=!1,this.loadUnreadMessageCount(),this.root.find('[data-toggle="tooltip"]').tooltip()};return l.prototype=Object.create(h.prototype),l.prototype.constructor=l,l.prototype.getContent=function(){return this.content},l.prototype.incrementOffset=function(){this.offset+=this.limit},l.prototype.updateButtonAriaLabel=function(){this.isMenuOpen()?e.get_string("hidemessagewindow","message").done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this)):this.unreadCount?e.get_string("showmessagewindowwithcount","message",this.unreadCount).done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this)):e.get_string("showmessagewindownonew","message").done(function(a){this.menuToggle.attr("aria-label",a)}.bind(this))},l.prototype.navigateToLinkURL=function(a,b){var c=a.attr("data-link-url");b=b||!1,c&&(b?window.open(c,"_blank"):window.location.assign(c))},l.prototype.renderUnreadCount=function(){var a=this.root.find(".count-container");this.unreadCount?(a.text(this.unreadCount),a.removeClass("hidden")):a.addClass("hidden")},l.prototype.hideUnreadCount=function(){this.root.find(".count-container").addClass("hidden")},l.prototype.loadUnreadMessageCount=function(){i.countUnreadConversations({useridto:this.userId}).then(function(a){this.unreadCount=a,this.renderUnreadCount(),this.updateButtonAriaLabel()}.bind(this))},l.prototype.renderMessages=function(b,c){var e=[];return b.length&&a.each(b,function(a,b){b.contexturl=j.relativeUrl("/message/index.php",{user:this.userId,id:b.userid},!0),b.profileurl=j.relativeUrl("/user/profile.php",{id:b.userid});var f=d.render("message/message_content_item",b);f.then(function(a,b){c.append(a),d.runTemplateJS(b)}.bind(this)),e.push(f)}.bind(this)),a.when.apply(a.when,e)},l.prototype.loadMoreMessages=function(){if(this.isLoading||this.loadedAll)return a.Deferred().resolve();this.startLoading();var b={userid:this.userId,limit:this.limit,offset:this.offset},c=this.getContent(),d=i.query(b).then(function(a){var b=a.contacts;if(this.loadedAll=!b.length||b.length<this.limit,this.initialLoad=!0,this.updateButtonAriaLabel(),b.length)return this.incrementOffset(),this.renderMessages(b,c)}.bind(this)).always(function(){this.stopLoading()}.bind(this));return d},l.prototype.markAllAsRead=function(){return this.markAllReadButton.hasClass("loading")?a.Deferred().resolve():(this.markAllReadButton.addClass("loading"),i.markAllAsRead({useridto:this.userId}).then(function(){this.unreadCount=0,this.hideUnreadCount(),this.getContent().find(k.CONTENT_ITEM_CONTAINER).removeClass("unread")}.bind(this)).always(function(){this.markAllReadButton.removeClass("loading")}.bind(this)))},l.prototype.toggleBlockNonContactsStatus=function(){var b=this.blockNonContactsButton,d="true"===b.attr("aria-checked"),g="",h="";return b.hasClass("loading")?a.Deferred().resolve():(b.addClass("loading"),e.get_strings([{key:"blocknoncontacts",component:"message"},{key:"unblocknoncontacts",component:"message"}]).then(function(a){g=a[0],h=a[1];var e={methodname:"core_user_update_user",args:{user:{preferences:[{type:b.attr("data-preference-key"),value:d?0:1}]}}};return c.call([e])[0]}).done(function(){d?(b.attr("aria-checked",!1),b.attr("data-original-title",g)):(b.attr("aria-checked",!0),b.attr("data-original-title",h))}).fail(f.exception).always(function(){b.removeClass("loading")}))},l.prototype.registerEventListeners=function(){g.define(this.root,[g.events.keyboardActivate]),this.root.on(this.events().menuOpened,function(){this.hideUnreadCount(),this.updateButtonAriaLabel(),this.initialLoad||this.loadMoreMessages()}.bind(this)),this.root.on(this.events().menuClosed,function(){this.renderUnreadCount(),this.updateButtonAriaLabel()}.bind(this)),this.root.on(g.events.scrollBottom,function(){this.loadMoreMessages()}.bind(this)),this.root.on("click",k.LINK_URL,function(b){var c=a(b.target).closest(k.LINK_URL);b.ctrlKey||b.metaKey?this.navigateToLinkURL(c,!0):this.navigateToLinkURL(c,!1),b.stopPropagation(),b.preventDefault()}.bind(this)),this.root.on(g.events.keyboardActivate,k.LINK_URL,function(b){var c=a(b.target).closest(k.LINK_URL);this.navigateToLinkURL(c,!1),b.stopPropagation()}.bind(this)),this.root.on(g.events.activate,k.BLOCK_NON_CONTACTS_BUTTON,function(a,b){this.toggleBlockNonContactsStatus(),a.stopPropagation(),b.originalEvent.preventDefault()}.bind(this)),this.root.on(g.events.activate,k.MARK_ALL_READ_BUTTON,function(a,b){this.markAllAsRead(),a.stopPropagation(),b.originalEvent.preventDefault()}.bind(this))},l});