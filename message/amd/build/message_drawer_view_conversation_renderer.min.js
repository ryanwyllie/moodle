define(["jquery","core/notification","core/str","core/templates"],function(a,b,c,d){var e={ACTION_CONFIRM_BLOCK:'[data-action="confirm-block"]',ACTION_CONFIRM_UNBLOCK:'[data-action="confirm-unblock"]',ACTION_CONFIRM_REMOVE_CONTACT:'[data-action="confirm-remove-contact"]',ACTION_CONFIRM_ADD_CONTACT:'[data-action="confirm-add-contact"]',ACTION_CONFIRM_DELETE_SELECTED_MESSAGES:'[data-action="confirm-delete-selected-messages"]',ACTION_CONFIRM_DELETE_CONVERSATION:'[data-action="confirm-delete-conversation"]',ACTION_REQUEST_BLOCK:'[data-action="request-block"]',ACTION_REQUEST_UNBLOCK:'[data-action="request-unblock"]',ACTION_REQUEST_REMOVE_CONTACT:'[data-action="request-remove-contact"]',ACTION_REQUEST_ADD_CONTACT:'[data-action="request-add-contact"]',CONFIRM_DIALOGUE_TEXT:'[data-region="dialogue-text"]',CONFIRM_DIALOGUE_HEADER:'[data-region="dialogue-header"]',HEADER:'[data-region="header-content"]',HEADER_EDIT_MODE:'[data-region="header-edit-mode"]',HEADER_PLACEHOLDER_CONTAINER:'[data-region="header-placeholder"]',MESSAGE:'[data-region="message"]',MESSAGE_NOT_SELECTED:'[data-region="message"][aria-checked="false"]',MESSAGE_NOT_SELECTED_ICON:'[data-region="not-selected-icon"]',MESSAGE_SELECTED_ICON:'[data-region="selected-icon"]',MESSAGES:'[data-region="content-message-container"]',MESSAGES_SELECTED_COUNT:'[data-region="message-selected-court"]',CONTENT_PLACEHOLDER_CONTAINER:'[data-region="content-placeholder"]',MESSAGE_TEXT_AREA:'[data-region="send-message-txt"]',SEND_MESSAGE_BUTTON:'[data-action="send-message"]',SEND_MESSAGE_ICON_CONTAINER:'[data-region="send-icon-container"]',DAY_MESSAGES_CONTAINER:'[data-region="day-messages-container"]',CONTENT_CONTAINER:'[data-region="content-container"]',CONTENT_MESSAGES_CONTAINER:'[data-region="content-message-container"]',CONTENT_MESSAGES_FOOTER_CONTAINER:'[data-region="content-messages-footer-container"]',CONTENT_MESSAGES_FOOTER_EDIT_MODE_CONTAINER:'[data-region="content-messages-footer-edit-mode-container"]',CONTENT_MESSAGES_FOOTER_REQUIRE_CONTACT_CONTAINER:'[data-region="content-messages-footer-require-contact-container"]',CONTENT_MESSAGES_FOOTER_REQUIRE_UNBLOCK_CONTAINER:'[data-region="content-messages-footer-require-unblock-container"]',CONTENT_MESSAGES_FOOTER_UNABLE_TO_MESSAGE_CONTAINER:'[data-region="content-messages-footer-unable-to-message"]',LOADING_ICON_CONTAINER:'[data-region="loading-icon-container"]',MORE_MESSAGES_LOADING_ICON_CONTAINER:'[data-region="more-messages-loading-icon-container"]',CONFIRM_DIALOGUE_CONTAINER:'[data-region="confirm-dialogue-container"]',CONFIRM_DIALOGUE_BUTTON_TEXT:'[data-region="dialogue-button-text"]',CONFIRM_DIALOGUE_CANCEL_BUTTON:'[data-action="cancel-confirm"]',PLACEHOLDER_CONTAINER:'[data-region="placeholder-container"]',TITLE:'[data-region="title"]',TEXT:'[data-region="text"]'},f={HEADER:"core_message/message_drawer_view_conversation_header_content",DAY:"core_message/message_drawer_view_conversation_body_day",MESSAGE:"core_message/message_drawer_view_conversation_body_message",MESSAGES:"core_message/message_drawer_view_conversation_body_messages"},g=function(a){return a.find(e.CONTENT_MESSAGES_CONTAINER)},h=function(a){g(a).removeClass("hidden")},i=function(a){g(a).addClass("hidden")},j=function(a){return a.find(e.CONTENT_MESSAGES_FOOTER_CONTAINER)},k=function(a){j(a).removeClass("hidden")},l=function(a){j(a).addClass("hidden")},m=function(a){return a.find(e.CONTENT_MESSAGES_FOOTER_EDIT_MODE_CONTAINER)},n=function(a){m(a).removeClass("hidden")},o=function(a){m(a).addClass("hidden")},p=function(a){return a.find(e.PLACEHOLDER_CONTAINER)},q=function(a){p(a).removeClass("hidden")},r=function(a){p(a).addClass("hidden")},s=function(a){return a.find(e.CONTENT_MESSAGES_FOOTER_REQUIRE_CONTACT_CONTAINER)},t=function(a){s(a).removeClass("hidden")},u=function(a){s(a).addClass("hidden")},v=function(a){return a.find(e.CONTENT_MESSAGES_FOOTER_REQUIRE_UNBLOCK_CONTAINER)},w=function(a){v(a).removeClass("hidden")},x=function(a){v(a).addClass("hidden")},y=function(a){return a.find(e.CONTENT_MESSAGES_FOOTER_UNABLE_TO_MESSAGE_CONTAINER)},z=function(a){y(a).removeClass("hidden")},A=function(a){y(a).addClass("hidden")},B=function(a){l(a),o(a),r(a),u(a),x(a),A(a)},C=function(a){return a.find(e.CONTENT_PLACEHOLDER_CONTAINER)},D=function(a){C(a).removeClass("hidden")},E=function(a){C(a).addClass("hidden")},F=function(a){return a.find(e.HEADER)},G=function(a){F(a).removeClass("hidden")},H=function(a){F(a).addClass("hidden")},I=function(a){return a.find(e.HEADER_EDIT_MODE)},J=function(a){I(a).removeClass("hidden")},K=function(a){I(a).addClass("hidden")},L=function(a){return a.find(e.HEADER_PLACEHOLDER_CONTAINER)},M=function(a){L(a).removeClass("hidden")},N=function(a){L(a).addClass("hidden")},O=function(a){return a.find(e.MESSAGE_TEXT_AREA)},P=function(a,b){var c=g(a);return c.find('[data-message-id="'+b+'"]')},Q=function(a,b){var c=g(a);return c.find('[data-day-id="'+b+'"]')},R=function(a){return a.find(e.MORE_MESSAGES_LOADING_ICON_CONTAINER)},S=function(a){R(a).removeClass("hidden")},T=function(a){R(a).addClass("hidden")},U=function(a){a.find(e.SEND_MESSAGE_BUTTON).prop("disabled",!0),O(a).prop("disabled",!0)},V=function(a){a.find(e.SEND_MESSAGE_BUTTON).prop("disabled",!1),O(a).prop("disabled",!1)},W=function(a){U(a),a.find(e.SEND_MESSAGE_ICON_CONTAINER).addClass("hidden"),a.find(e.LOADING_ICON_CONTAINER).removeClass("hidden")},X=function(a){V(a),a.find(e.SEND_MESSAGE_ICON_CONTAINER).removeClass("hidden"),a.find(e.LOADING_ICON_CONTAINER).addClass("hidden")},Y=function(a){var b=O(a);b.val(""),b.focus()},Z=function(a){return a.find(e.CONFIRM_DIALOGUE_CONTAINER)},$=function(a){Z(a).removeClass("hidden")},_=function(a){Z(a).addClass("hidden")},aa=function(a,b){I(a).find(e.MESSAGES_SELECTED_COUNT).text(b)},ba=function(a){return a.map(function(a){return{id:a.id,isread:a.isRead,fromloggedinuser:a.fromLoggedInUser,userfrom:a.userFrom,text:a.text,timecreated:parseInt(a.timeCreated,10)}})},ca=function(b,c,e,h){var i=g(c),j=h.map(function(a){return d.render(f.DAY,{timestamp:a.value.timestamp,messages:ba(a.value.messages)})});return a.when.apply(a,j).then(function(){h.forEach(function(b,d){j[d].then(function(d){if(b.before){var e=Q(c,b.before.timestamp);return a(d).insertBefore(e)}return i.append(d)})})})},da=function(b,c,g,h){var i=h.map(function(a){var b=ba([a.value]);return d.render(f.MESSAGE,b[0])});return a.when.apply(a,i).then(function(){h.forEach(function(b,d){i[d].then(function(d){if(b.before){var f=P(c,b.before.id);return a(d).insertBefore(f)}var g=Q(c,b.day.timestamp),h=g.find(e.DAY_MESSAGES_CONTAINER);return h.append(d)})})})},ea=function(a,b){b.forEach(function(b){Q(a,b.timestamp).remove()})},fa=function(a,b){b.forEach(function(b){P(a,b.id).remove()})},ga=function(b,c,d,e){var f=[];return e.days.add.length>0&&(f=f.concat(ca(b,c,d,e.days.add))),e.messages.add.length>0&&(f=f.concat(da(b,c,d,e.messages.add))),e.days.remove.length>0&&ea(c,e.days.remove),e.messages.remove.length>0&&fa(c,e.messages.remove),a.when.apply(a,f)},ha=function(a,b,c,e){var g=F(a);return d.render(f.HEADER,e.context).then(function(a,b){d.replaceNodeContents(g,a,b)})},ia=function(a,b,d,f){switch(B(d),f.type){case"placeholder":return q(d);case"add-contact":return c.get_strings([{key:"requirecontacttomessage",component:"core_message",param:f.user.fullname},{key:"isnotinyourcontacts",component:"core_message",param:f.user.fullname}]).then(function(a){var b=a[1],c=a[0],f=s(d);f.find(e.TITLE).text(b),f.find(e.TEXT).text(c),t(d)});case"edit-mode":return n(d);case"content":return k(d);case"unblock":return w(d);case"unable-to-message":return z(d)}return!0},ja=function(a,b,c,d){var e=g(b),f=P(b,d),h=e.scrollTop()+f.position().top;e.scrollTop(h)},ka=function(a,b,c,d){d?(H(a),M(a)):(G(a),N(a))},la=function(a,b,c,d){d?(i(b),D(b)):(h(b),E(b))},ma=function(a,b,c,d){d?S(b):T(b)},na=function(a,b,c,d){d?W(c):(X(c),Y(c))},oa=function(a,b,c,d,f,g){var h=Z(a),i=h.find(c),j=h.find(e.CONFIRM_DIALOGUE_CANCEL_BUTTON),k=h.find(e.CONFIRM_DIALOGUE_TEXT),l=h.find(e.CONFIRM_DIALOGUE_HEADER);h.find("button").addClass("hidden"),g?j.removeClass("hidden"):j.addClass("hidden"),f?(l.removeClass("hidden"),l.text(f)):(l.addClass("hidden"),l.text("")),i.removeClass("hidden"),k.text(d),$(b),$(a)},pa=function(a,b){var c=Z(a),d=c.find(e.CONFIRM_DIALOGUE_CANCEL_BUTTON),f=c.find(e.CONFIRM_DIALOGUE_TEXT),g=c.find(e.CONFIRM_DIALOGUE_HEADER);return _(a),_(b),c.find("button").addClass("hidden"),d.removeClass("hidden"),f.text(""),g.addClass("hidden"),g.text(""),!0},qa=function(a,b,d,f){return f?c.get_string("blockuserconfirm","core_message",f.fullname).then(function(a){return oa(b,d,e.ACTION_CONFIRM_BLOCK,a,"",!0)}):pa(b,d)},ra=function(a,b,d,f){return f?c.get_string("unblockuserconfirm","core_message",f.fullname).then(function(a){oa(b,d,e.ACTION_CONFIRM_UNBLOCK,a,"",!0)}):pa(b,d)},sa=function(a,b,d,f){return f?c.get_string("addcontactconfirm","core_message",f.fullname).then(function(a){return oa(b,d,e.ACTION_CONFIRM_ADD_CONTACT,a,"",!0)}):pa(b,d)},ta=function(a,b,d,f){return f?c.get_string("removecontactconfirm","core_message",f.fullname).then(function(a){return oa(b,d,e.ACTION_CONFIRM_REMOVE_CONTACT,a,"",!0)}):pa(b,d)},ua=function(a,b,d,f){return f?c.get_string("deleteselectedmessagesconfirm","core_message").then(function(a){return oa(b,d,e.ACTION_CONFIRM_DELETE_SELECTED_MESSAGES,a,"",!0)}):pa(b,d)},va=function(a,b,d,f){return f?c.get_string("deleteallconfirm","core_message").then(function(a){return oa(b,d,e.ACTION_CONFIRM_DELETE_CONVERSATION,a,"",!0)}):pa(b,d)},wa=function(a,b,c,d){d?(a.find(e.ACTION_REQUEST_BLOCK).addClass("hidden"),a.find(e.ACTION_REQUEST_UNBLOCK).removeClass("hidden")):(a.find(e.ACTION_REQUEST_BLOCK).removeClass("hidden"),a.find(e.ACTION_REQUEST_UNBLOCK).addClass("hidden"))},xa=function(a,b,c,d){d?(a.find(e.ACTION_REQUEST_ADD_CONTACT).addClass("hidden"),a.find(e.ACTION_REQUEST_REMOVE_CONTACT).removeClass("hidden")):(a.find(e.ACTION_REQUEST_ADD_CONTACT).removeClass("hidden"),a.find(e.ACTION_REQUEST_REMOVE_CONTACT).addClass("hidden"))},ya=function(a,b,c,d){var f=Z(b),g=f.find("button"),h=f.find(e.CONFIRM_DIALOGUE_BUTTON_TEXT),i=f.find(e.LOADING_ICON_CONTAINER);d?(g.prop("disabled",!0),h.addClass("hidden"),i.removeClass("hidden")):(g.prop("disabled",!1),h.removeClass("hidden"),i.addClass("hidden"))},za=function(a,b,c,d){if(d){var f=b.find(e.MESSAGE_NOT_SELECTED);f.find(e.MESSAGE_NOT_SELECTED_ICON).removeClass("hidden"),H(a),J(a)}else{var f=g(b);f.find(e.MESSAGE_NOT_SELECTED_ICON).addClass("hidden"),f.find(e.MESSAGE_SELECTED_ICON).addClass("hidden"),G(a),K(a)}},Aa=function(a,b,c,d){var f=d.count>0;d.add.length&&d.add.forEach(function(a){var c=P(b,a);c.find(e.MESSAGE_NOT_SELECTED_ICON).addClass("hidden"),c.find(e.MESSAGE_SELECTED_ICON).removeClass("hidden"),c.attr("aria-checked",!0)}),d.remove.length&&d.remove.forEach(function(a){var c=P(b,a);f&&c.find(e.MESSAGE_NOT_SELECTED_ICON).removeClass("hidden"),c.find(e.MESSAGE_SELECTED_ICON).addClass("hidden"),c.attr("aria-checked",!1)}),aa(a,d.count)},Ba=function(a,b,d,f){return f.show&&!f.hasMessages?c.get_strings([{key:"requirecontacttomessage",component:"core_message",param:f.user.fullname},{key:"isnotinyourcontacts",component:"core_message",param:f.user.fullname}]).then(function(a){var c=a[1],f=a[0];oa(b,d,e.ACTION_REQUEST_ADD_CONTACT,f,c,!1)}):pa(b,d)},Ca=function(c,d,e,f){var g=[{conversation:ga,header:ha,footer:ia,confirmBlockUser:qa,confirmUnblockUser:ra,confirmAddContact:sa,confirmRemoveContact:ta,confirmDeleteSelectedMessages:ua,confirmDeleteConversation:va,requireAddContact:Ba},{loadingMembers:ka,loadingFirstMessages:la,loadingMessages:ma,sendingMessage:na,isBlocked:wa,isContact:xa,loadingConfirmAction:ya,inEditMode:za},{scrollToMessage:ja,selectedMessages:Aa}],h=function(a){var b=[];for(var g in f)if(a.hasOwnProperty(g)){var h=a[g],i=f[g];b.push(h(c,d,e,i))}return b},i=h(g[0]);return a.when.apply(a,i).then(function(){for(var a=1;a<g.length;a++)h(g[a])})["catch"](b.exception)};return{render:Ca}});