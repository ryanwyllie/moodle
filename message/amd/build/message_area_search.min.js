'use strict';define('core_message/message_area_search',['jquery','core/ajax','core/templates','core/notification','core/str','core/custom_interaction_events','core_message/message_area_events'],function($,Ajax,Templates,Notification,Str,CustomEvents,Events){function Search(messageArea){this.messageArea=messageArea,this._init()}var SELECTORS={CONTACTS:'[data-region=\'contacts\'][data-region-content=\'contacts\']',CONTACTSAREA:'[data-region=\'contacts-area\']',CONVERSATIONS:'[data-region=\'contacts\'][data-region-content=\'conversations\']',DELETESEARCHFILTER:'[data-region=\'search-filter-area\']',LOADINGICON:'.loading-icon',SEARCHBOX:'[data-region=\'search-box\']',SEARCHFILTER:'[data-region=\'search-filter\']',SEARCHFILTERAREA:'[data-region=\'search-filter-area\']',SEARCHRESULTSAREA:'[data-region=\'search-results-area\']',SEARCHTEXTAREA:'[data-region=\'search-text-area\']',SEARCHUSERSINCOURSE:'[data-action=\'search-users-in-course\']'};return Search.prototype.messageArea=null,Search.prototype._searchArea=null,Search.prototype._courseid=null,Search.prototype._isLoading=!1,Search.prototype._numMessagesDisplayed=0,Search.prototype._numMessagesToRetrieve=20,Search.prototype._numUsersDisplayed=0,Search.prototype._numUsersToRetrieve=20,Search.prototype._searchAreas={MESSAGES:'messages',USERS:'users',USERSINCOURSE:'usersincourse'},Search.prototype._requestTimeout=null,Search.prototype._init=function(){this.messageArea.find(SELECTORS.SEARCHTEXTAREA).on('input',this._searchRequest.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.SEARCHUSERSINCOURSE,function(e){this._setFilter($(e.currentTarget).html()),this._setPlaceholderText('searchforuser'),this._clearSearchArea(),this._searchArea=this._searchAreas.USERSINCOURSE,this._courseid=$(e.currentTarget).data('courseid'),this._searchUsersInCourse(),this.messageArea.find(SELECTORS.SEARCHBOX).focus()}.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.DELETESEARCHFILTER,function(){this._hideSearchResults(),this._searchArea=this._searchAreas.USERS,this._setPlaceholderText('searchforuserorcourse'),this.messageArea.trigger(Events.USERSSEARCHCANCELED),this.messageArea.find(SELECTORS.SEARCHBOX).focus()}.bind(this)),this.messageArea.onCustomEvent(Events.CONVERSATIONSSELECTED,function(){this._hideSearchResults(),this._searchArea=this._searchAreas.MESSAGES,this._setPlaceholderText('searchmessages')}.bind(this)),this.messageArea.onCustomEvent(Events.CONTACTSSELECTED,function(){this._hideSearchResults(),this._searchArea=this._searchAreas.USERS,this._setPlaceholderText('searchforuserorcourse')}.bind(this)),this.messageArea.onCustomEvent(Events.MESSAGESENT,function(){this._hideSearchResults(),this._searchArea=this._searchAreas.MESSAGES,this._setPlaceholderText('searchmessages')}.bind(this)),CustomEvents.define(this.messageArea.find(SELECTORS.SEARCHRESULTSAREA),[CustomEvents.events.scrollBottom]),this.messageArea.onDelegateEvent(CustomEvents.events.scrollBottom,SELECTORS.SEARCHRESULTSAREA,function(){this._searchArea==this._searchAreas.MESSAGES?this._searchMessages():this._searchArea==this._searchAreas.USERSINCOURSE&&this._searchUsersInCourse()}.bind(this)),this._searchArea=this.messageArea.showContactsFirst()?this._searchAreas.USERS:this._searchAreas.MESSAGES},Search.prototype._searchRequest=function(){var str=this.messageArea.find(SELECTORS.SEARCHTEXTAREA+' input').val();return this._requestTimeout&&clearTimeout(this._requestTimeout),''===str.trim()?void(this._searchArea==this._searchAreas.MESSAGES?(this._hideSearchResults(),this.messageArea.trigger(Events.MESSAGESEARCHCANCELED)):this._searchArea==this._searchAreas.USERS?(this._hideSearchResults(),this.messageArea.trigger(Events.USERSSEARCHCANCELED)):this._searchArea==this._searchAreas.USERSINCOURSE&&(this._clearSearchArea(),this._searchUsersInCourse())):void(this.messageArea.find(SELECTORS.CONVERSATIONS).hide(),this.messageArea.find(SELECTORS.CONTACTS).hide(),this.messageArea.find(SELECTORS.SEARCHRESULTSAREA).show(),this._requestTimeout=this._searchArea==this._searchAreas.MESSAGES?setTimeout(function(){this._clearSearchArea(),this._numMessagesDisplayed=0,this._searchMessages()}.bind(this),300):this._searchArea==this._searchAreas.USERSINCOURSE?setTimeout(function(){this._clearSearchArea(),this._numUsersDisplayed=0,this._searchUsersInCourse()}.bind(this),300):setTimeout(function(){this._clearSearchArea(),this._numUsersDisplayed=0,this._searchUsers()}.bind(this),300))},Search.prototype._searchMessages=function(){if(this._isLoading)return!1;var str=this.messageArea.find(SELECTORS.SEARCHBOX).val();this._isLoading=!0;var promises=Ajax.call([{methodname:'core_message_data_for_messagearea_search_messages',args:{userid:this.messageArea.getCurrentUserId(),search:str,limitfrom:this._numMessagesDisplayed,limitnum:this._numMessagesToRetrieve}}]),numberreceived=0;return Templates.render('core/loading',{}).then(function(html,js){return Templates.appendNodeContents(this.messageArea.find(SELECTORS.SEARCHRESULTSAREA),'<div style=\'text-align:center\'>'+html+'</div>',js),promises[0]}.bind(this)).then(function(data){return numberreceived=data.contacts.length,Templates.render('core_message/message_area_message_search_results',data)}).then(function(html,js){this.messageArea.find(SELECTORS.SEARCHRESULTSAREA+' '+SELECTORS.LOADINGICON).remove(),0<numberreceived?(Templates.appendNodeContents(this.messageArea.find(SELECTORS.SEARCHRESULTSAREA),html,js),this._numMessagesDisplayed+=numberreceived):0==this._numMessagesDisplayed&&Templates.replaceNodeContents(this.messageArea.find(SELECTORS.SEARCHRESULTSAREA),html,js),this._isLoading=!1}.bind(this)).fail(Notification.exception)},Search.prototype._searchUsers=function(){var str=this.messageArea.find(SELECTORS.SEARCHBOX).val(),promises=Ajax.call([{methodname:'core_message_data_for_messagearea_search_users',args:{userid:this.messageArea.getCurrentUserId(),search:str,limitnum:this._numUsersToRetrieve}}]);return Templates.render('core/loading',{}).then(function(html,js){return Templates.replaceNodeContents(this.messageArea.find(SELECTORS.SEARCHRESULTSAREA),'<div style=\'text-align:center\'>'+html+'</div>',js),promises[0]}.bind(this)).then(function(data){return 0<data.contacts.length&&(data.hascontacts=!0),0<data.courses.length&&(data.hascourses=!0),0<data.noncontacts.length&&(data.hasnoncontacts=!0),Templates.render('core_message/message_area_user_search_results',data)}).then(function(html,js){Templates.replaceNodeContents(this.messageArea.find(SELECTORS.SEARCHRESULTSAREA),html,js)}.bind(this)).fail(Notification.exception)},Search.prototype._searchUsersInCourse=function(){if(this._isLoading)return!1;var str=this.messageArea.find(SELECTORS.SEARCHBOX).val();this._isLoading=!0;var promises=Ajax.call([{methodname:'core_message_data_for_messagearea_search_users_in_course',args:{userid:this.messageArea.getCurrentUserId(),courseid:this._courseid,search:str,limitfrom:this._numUsersDisplayed,limitnum:this._numUsersToRetrieve}}]),numberreceived=0;return Templates.render('core/loading',{}).then(function(html,js){return Templates.appendNodeContents(this.messageArea.find(SELECTORS.SEARCHRESULTSAREA),'<div style=\'text-align:center\'>'+html+'</div>',js),promises[0]}.bind(this)).then(function(data){return numberreceived=data.contacts.length,0<numberreceived&&(data.hascontacts=!0),Templates.render('core_message/message_area_user_search_results',data)}).then(function(html,js){this.messageArea.find(SELECTORS.SEARCHRESULTSAREA+' '+SELECTORS.LOADINGICON).remove(),0<numberreceived?(Templates.appendNodeContents(this.messageArea.find(SELECTORS.SEARCHRESULTSAREA),html,js),this._numUsersDisplayed+=numberreceived):0==this._numUsersDisplayed&&Templates.replaceNodeContents(this.messageArea.find(SELECTORS.SEARCHRESULTSAREA),html,js),this._isLoading=!1}.bind(this)).fail(Notification.exception)},Search.prototype._setPlaceholderText=function(text){return Str.get_string(text,'message').then(function(s){this.messageArea.find(SELECTORS.SEARCHTEXTAREA+' input').attr('placeholder',s)}.bind(this))},Search.prototype._setFilter=function(text){this.messageArea.find(SELECTORS.SEARCHBOX).val(''),this.messageArea.find(SELECTORS.CONTACTSAREA).addClass('searchfilter'),this.messageArea.find(SELECTORS.SEARCHFILTERAREA).show(),this.messageArea.find(SELECTORS.SEARCHFILTER).html(text),Str.get_string('removecoursefilter','message',text).then(function(languagestring){this.messageArea.find(SELECTORS.SEARCHFILTERAREA).attr('aria-label',languagestring)}.bind(this)).catch(Notification.exception)},Search.prototype._clearFilters=function(){this.messageArea.find(SELECTORS.CONTACTSAREA).removeClass('searchfilter'),this.messageArea.find(SELECTORS.SEARCHFILTER).empty(),this.messageArea.find(SELECTORS.SEARCHFILTERAREA).hide(),this.messageArea.find(SELECTORS.SEARCHFILTERAREA).removeAttr('aria-label')},Search.prototype._clearSearchArea=function(){this.messageArea.find(SELECTORS.SEARCHRESULTSAREA).empty()},Search.prototype._hideSearchResults=function(){this._clearFilters(),this.messageArea.find(SELECTORS.SEARCHTEXTAREA+' input').val(''),this._clearSearchArea(),this.messageArea.find(SELECTORS.SEARCHRESULTSAREA).hide()},Search});
//# sourceMappingURL=message_area_search.min.js.map
