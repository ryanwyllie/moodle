define(["jquery","core/ajax","core/templates","core/notification","core/str","core/custom_interaction_events"],function(a,b,c,d,e,f){function g(a){this.messageArea=a,this._init()}return g.prototype.messageArea=null,g.prototype._searchArea=null,g.prototype._courseid=null,g.prototype._isLoading=!1,g.prototype._numMessagesDisplayed=0,g.prototype._numMessagesToRetrieve=20,g.prototype._numPeopleDisplayed=0,g.prototype._numPeopleToRetrieve=20,g.prototype._searchAreas={MESSAGES:"messages",PEOPLE:"people",PEOPLEINCOURSE:"peopleincourse"},g.prototype._requestTimeout=null,g.prototype._init=function(){this.messageArea.find(this.messageArea.SELECTORS.SEARCHTEXTAREA).on("input",this._searchRequest.bind(this)),this.messageArea.onDelegateEvent("click",this.messageArea.SELECTORS.SEARCHPEOPLEINCOURSE,function(b){this._setFilter(a(b.currentTarget).html()),this._setPlaceholderText("searchforperson"),this._setSearchArea(this._searchAreas.PEOPLEINCOURSE),this._courseid=a(b.currentTarget).data("courseid"),this._searchPeopleInCourse("")}.bind(this)),this.messageArea.onDelegateEvent("click",this.messageArea.SELECTORS.DELETESEARCHFILTER,function(){this._clearFilters(),this._hideSearchResults(),this._searchArea===this._searchAreas.PEOPLEINCOURSE&&(this._setSearchArea(this._searchAreas.PEOPLE),this._setPlaceholderText("searchforpersonorcourse")),this._searchArea===this._searchAreas.MESSAGES?this.messageArea.trigger(this.messageArea.EVENTS.MESSAGESEARCHCANCELED):this.messageArea.trigger(this.messageArea.EVENTS.PEOPLESEARCHCANCELED)}.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONVERSATIONSSELECTED,function(){this._clearFilters(),this._hideSearchResults(),this._setSearchArea(this._searchAreas.MESSAGES),this._setPlaceholderText("searchmessages")}.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONTACTSSELECTED,function(){this._clearFilters(),this._hideSearchResults(),this._setSearchArea(this._searchAreas.PEOPLE),this._setPlaceholderText("searchforpersonorcourse")}.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.MESSAGESENT,function(){this._clearFilters(),this._hideSearchResults(),this._setSearchArea(this._searchAreas.MESSAGES),this._setPlaceholderText("searchmessages")}.bind(this)),this._setSearchArea(this._searchAreas.MESSAGES)},g.prototype._setSearchArea=function(a){this._numMessagesDisplayed=0,this._numPeopleDisplayed=0,this._courseid=0,this._searchArea=a},g.prototype._searchRequest=function(){var a=this.messageArea.find(this.messageArea.SELECTORS.SEARCHTEXTAREA+" input").val();return this._requestTimeout&&clearTimeout(this._requestTimeout),""===a.trim()?void(this._searchArea==this._searchAreas.MESSAGES?(this._hideSearchResults(),this.messageArea.trigger(this.messageArea.EVENTS.MESSAGESEARCHCANCELED)):this._searchArea==this._searchAreas.PEOPLE&&(this._hideSearchResults(),this.messageArea.trigger(this.messageArea.EVENTS.PEOPLESEARCHCANCELED))):(this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS).hide(),this.messageArea.find(this.messageArea.SELECTORS.CONTACTS).hide(),this.messageArea.find(this.messageArea.SELECTORS.SEARCHRESULTSAREA).show(),void(this._searchArea==this._searchAreas.MESSAGES?this._requestTimeout=setTimeout(function(){this._searchMessages(a)}.bind(this),300):this._searchArea==this._searchAreas.PEOPLEINCOURSE?this._requestTimeout=setTimeout(function(){this._searchPeopleInCourse(a)}.bind(this),300):this._requestTimeout=setTimeout(function(){this._searchPeople(a)}.bind(this),300)))},g.prototype._searchMessages=function(a){var b=0;return c.render("core/loading",{}).then(function(b,d){return c.replaceNodeContents(this.messageArea.SELECTORS.SEARCHRESULTSAREA,"<div style='text-align:center'>"+b+"</div>",d),this._getMessages(a)}.bind(this)).then(function(a){return b=a.contacts.length,c.render("core_message/message_area_contacts",a)}).then(function(d,e){c.replaceNodeContents(this.messageArea.SELECTORS.SEARCHRESULTSAREA,d,e),b>0&&(this._numMessagesDisplayed+=b,f.define(this.messageArea.SELECTORS.SEARCHRESULTSAREA,[f.events.scrollBottom]),this.messageArea.onDelegateEvent(f.events.scrollBottom,this.messageArea.SELECTORS.SEARCHRESULTSAREA,function(){this._loadMessages(a)}.bind(this)))}.bind(this)).fail(d.exception)},g.prototype._searchPeople=function(a){var e=b.call([{methodname:"core_message_data_for_messagearea_search_people",args:{userid:this.messageArea.getCurrentUserId(),search:a,limitnum:this._numPeopleToRetrieve}}]);return c.render("core/loading",{}).then(function(a,b){return c.replaceNodeContents(this.messageArea.SELECTORS.SEARCHRESULTSAREA,"<div style='text-align:center'>"+a+"</div>",b),e[0]}.bind(this)).then(function(a){return c.render("core_message/message_area_people_search_results",a)}).then(function(a,b){c.replaceNodeContents(this.messageArea.SELECTORS.SEARCHRESULTSAREA,a,b)}.bind(this)).fail(d.exception)},g.prototype._searchPeopleInCourse=function(a){var b=0;return c.render("core/loading",{}).then(function(b,d){return c.replaceNodeContents(this.messageArea.SELECTORS.SEARCHRESULTSAREA,"<div style='text-align:center'>"+b+"</div>",d),this._getPeopleInCourse(a)}.bind(this)).then(function(a){return b=a.contacts.length,c.render("core_message/message_area_people_search_results",a)}).then(function(d,e){c.replaceNodeContents(this.messageArea.SELECTORS.SEARCHRESULTSAREA,d,e),b>0&&(this._numPeopleDisplayed+=b,f.define(this.messageArea.SELECTORS.SEARCHRESULTSAREA,[f.events.scrollBottom]),this.messageArea.onDelegateEvent(f.events.scrollBottom,this.messageArea.SELECTORS.SEARCHRESULTSAREA,function(){this._loadPeopleInCourse(a)}.bind(this)))}.bind(this)).fail(d.exception)},g.prototype._loadMessages=function(a){if(!this._isLoading){this._isLoading=!0;var b=0;return c.render("core/loading",{}).then(function(b,d){return c.appendNodeContents(this.messageArea.SELECTORS.SEARCHRESULTSAREA,"<div style='text-align:center'>"+b+"</div>",d),this._getMessages(a)}.bind(this)).then(function(a){return b=a.contacts.length,c.render("core_message/message_area_contacts",a)}).then(function(a,d){this.messageArea.find(this.messageArea.SELECTORS.SEARCHRESULTSAREA+" "+this.messageArea.SELECTORS.LOADINGICON).remove(),b>0&&(c.appendNodeContents(this.messageArea.SELECTORS.SEARCHRESULTSAREA,a,d),this._numMessagesDisplayed+=b),this._isLoading=!1}.bind(this)).fail(d.exception)}},g.prototype._loadPeopleInCourse=function(a){if(!this._isLoading){this._isLoading=!0;var b=0;return c.render("core/loading",{}).then(function(b,d){return c.appendNodeContents(this.messageArea.SELECTORS.SEARCHRESULTSAREA,"<div style='text-align:center'>"+b+"</div>",d),this._getPeopleInCourse(a)}.bind(this)).then(function(a){return b=a.contacts.length,c.render("core_message/message_area_people_search_results",a)}).then(function(a,d){this.messageArea.find(this.messageArea.SELECTORS.SEARCHRESULTSAREA+" "+this.messageArea.SELECTORS.LOADINGICON).remove(),b>0&&(c.appendNodeContents(this.messageArea.SELECTORS.SEARCHRESULTSAREA,a,d),this._numPeopleDisplayed+=b),this._isLoading=!1}.bind(this)).fail(d.exception)}},g.prototype._getMessages=function(a){var c=b.call([{methodname:"core_message_data_for_messagearea_search_messages",args:{userid:this.messageArea.getCurrentUserId(),search:a,limitfrom:this._numMessagesDisplayed,limitnum:this._numMessagesToRetrieve}}]);return c[0]},g.prototype._getPeopleInCourse=function(a){var c=b.call([{methodname:"core_message_data_for_messagearea_search_people_in_course",args:{userid:this.messageArea.getCurrentUserId(),courseid:this._courseid,search:a,limitfrom:this._numPeopleDisplayed,limitnum:this._numPeopleToRetrieve}}]);return c[0]},g.prototype._setPlaceholderText=function(a){return e.get_string(a,"message").then(function(a){this.messageArea.find(this.messageArea.SELECTORS.SEARCHTEXTAREA+" input").attr("placeholder",a)}.bind(this))},g.prototype._setFilter=function(a){this.messageArea.find(this.messageArea.SELECTORS.CONTACTSAREA).addClass("searchfilter"),this.messageArea.find(this.messageArea.SELECTORS.SEARCHFILTERAREA).show(),this.messageArea.find(this.messageArea.SELECTORS.SEARCHFILTER).html(a)},g.prototype._clearFilters=function(){this.messageArea.find(this.messageArea.SELECTORS.CONTACTSAREA).removeClass("searchfilter"),this.messageArea.find(this.messageArea.SELECTORS.SEARCHFILTER).empty(),this.messageArea.find(this.messageArea.SELECTORS.SEARCHFILTERAREA).hide()},g.prototype._hideSearchResults=function(){this._numMessagesDisplayed=0,this._numPeopleDisplayed=0,this._courseid=0,this.messageArea.find(this.messageArea.SELECTORS.SEARCHTEXTAREA+" input").val(""),this.messageArea.find(this.messageArea.SELECTORS.SEARCHRESULTSAREA).empty(),this.messageArea.find(this.messageArea.SELECTORS.SEARCHRESULTSAREA).hide()},g});