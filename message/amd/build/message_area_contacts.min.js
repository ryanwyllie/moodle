define(["jquery","core/ajax","core/templates","core/notification","core/custom_interaction_events","core/str"],function(a,b,c,d,e,f){function g(a){this.messageArea=a,this._init()}return g.prototype._isDeleting=!1,g.prototype._isLoadingConversations=!1,g.prototype._isLoadingContacts=!1,g.prototype._numContactsDisplayed=0,g.prototype._numContactsToRetrieve=20,g.prototype._numConversationsDisplayed=0,g.prototype._numConversationsToRetrieve=20,g.prototype._messageLength=60,g.prototype.messageArea=null,g.prototype._init=function(){e.define(this.messageArea.node,[e.events.activate,e.events.down,e.events.up]),this.messageArea.onCustomEvent(this.messageArea.EVENTS.MESSAGESEARCHCANCELED,this._viewConversations.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.PEOPLESEARCHCANCELED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONTACTSSELECTED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONVERSATIONDELETED,this._deleteConversation.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONVERSATIONSSELECTED,this._viewConversations.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONTACTSSELECTED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.MESSAGESDELETED,this._updateLastMessage.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.MESSAGESENT,this._handleMessageSent.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONTACTREMOVED,function(a,b){this._removeContact(this.messageArea.SELECTORS.CONTACTS,b)}.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONTACTADDED,function(a,b){this._addContact(b)}.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONTACTBLOCKED,function(a,b){this._blockContact(b)}.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONTACTUNBLOCKED,function(a,b){this._unblockContact(b)}.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CHOOSEMESSAGESTODELETE,this._startDeleting.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CANCELDELETEMESSAGES,this._stopDeleting.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,this.messageArea.SELECTORS.VIEWCONVERSATION,this._viewConversation.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,this.messageArea.SELECTORS.VIEWPROFILE,this._viewContact.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,this.messageArea.SELECTORS.SHOWMESSAGES,this._showMessagingArea.bind(this)),this.messageArea.onDelegateEvent(e.events.up,this.messageArea.SELECTORS.CONTACT,this._selectPreviousContact.bind(this)),this.messageArea.onDelegateEvent(e.events.down,this.messageArea.SELECTORS.CONTACT,this._selectNextContact.bind(this)),this.messageArea.onDelegateEvent(e.events.up,this.messageArea.SELECTORS.VIEWCONVERSATION,this._selectPreviousConversation.bind(this)),this.messageArea.onDelegateEvent(e.events.down,this.messageArea.SELECTORS.VIEWCONVERSATION,this._selectNextConversation.bind(this)),this.messageArea.onDelegateEvent("focus",this.messageArea.SELECTORS.SEARCHBOX,this._setSearching.bind(this)),this.messageArea.onDelegateEvent("blur",this.messageArea.SELECTORS.SEARCHBOX,this._clearSearching.bind(this)),e.define(this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS),[e.events.scrollBottom]),e.define(this.messageArea.find(this.messageArea.SELECTORS.CONTACTS),[e.events.scrollBottom]),this.messageArea.onDelegateEvent(e.events.scrollBottom,this.messageArea.SELECTORS.CONVERSATIONS,this._loadConversations.bind(this)),this.messageArea.onDelegateEvent(e.events.scrollBottom,this.messageArea.SELECTORS.CONTACTS,this._loadContacts.bind(this)),this._numConversationsDisplayed=20},g.prototype._startDeleting=function(){this._isDeleting=!0,this.messageArea.find(this.messageArea.SELECTORS.CONTACTSAREA).addClass("editing")},g.prototype._stopDeleting=function(){this._isDeleting=!1,this.messageArea.find(this.messageArea.SELECTORS.CONTACTSAREA).removeClass("editing")},g.prototype._viewConversations=function(){0===this._numConversationsDisplayed&&this._loadConversations(),this.messageArea.find(this.messageArea.SELECTORS.CONTACTS).hide(),this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS).show()},g.prototype._viewContacts=function(){0===this._numContactsDisplayed&&this._loadContacts(),this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS).hide(),this.messageArea.find(this.messageArea.SELECTORS.CONTACTS).show()},g.prototype._handleMessageSent=function(a,b,c){this._viewConversations();var d=this._getUserNode(this.messageArea.SELECTORS.CONVERSATIONS,b);if(0===d.length){var e=this._getUserNode(this.messageArea.SELECTORS.CONTACTS,b);if(0===e.length&&(e=this._getUserNode(this.messageArea.SELECTORS.SEARCHRESULTSAREA,b)),0==e.length)return;d=e.clone(),d.attr("data-action","view-contact-msg"),this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS+" "+this.messageArea.SELECTORS.NOCONTACTS).remove(),this._numConversationsDisplayed++}d.prependTo(this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS)),this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS).scrollTop(0),this._updateContactText(d,c,!0),this._setSelectedUser("[data-userid='"+b+"']")},g.prototype._loadConversations=function(){if(this._isDeleting)return!1;if(this._isLoadingConversations)return!1;this._isLoadingConversations=!0;var a=0;return c.render("core/loading",{}).then(function(a,b){return this._numConversationsDisplayed?c.appendNodeContents(this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS),"<div style='text-align:center'>"+a+"</div>",b):c.replaceNodeContents(this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS),"<div style='text-align:center'>"+a+"</div>",b),this._getItems("core_message_data_for_messagearea_conversations",this._numConversationsDisplayed,this._numConversationsToRetrieve)}.bind(this)).then(function(b){return a=b.contacts.length,c.render("core_message/message_area_contacts",b)}).then(function(b,d){this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS+" "+this.messageArea.SELECTORS.LOADINGICON).remove(),a>0?(c.appendNodeContents(this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS),b,d),this._numConversationsDisplayed+=this._numConversationsToRetrieve):this._numConversationsDisplayed||c.replaceNodeContents(this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS),b,d),this._isLoadingConversations=!1}.bind(this)).fail(d.exception)},g.prototype._loadContacts=function(){if(this._isDeleting)return!1;if(this._isLoadingContacts)return!1;this._isLoadingContacts=!0;var a=0;return c.render("core/loading",{}).then(function(a,b){return this._numContactsDisplayed?c.appendNodeContents(this.messageArea.find(this.messageArea.SELECTORS.CONTACTS),"<div style='text-align:center'>"+a+"</div>",b):c.replaceNodeContents(this.messageArea.find(this.messageArea.SELECTORS.CONTACTS),"<div style='text-align:center'>"+a+"</div>",b),this._getItems("core_message_data_for_messagearea_contacts",this._numContactsDisplayed,this._numContactsToRetrieve)}.bind(this)).then(function(b){return a=b.contacts.length,c.render("core_message/message_area_contacts",b)}).then(function(b,d){this.messageArea.find(this.messageArea.SELECTORS.CONTACTS+" "+this.messageArea.SELECTORS.LOADINGICON).remove(),a>0?(c.appendNodeContents(this.messageArea.find(this.messageArea.SELECTORS.CONTACTS),b,d),this._numContactsDisplayed+=a):this._numContactsDisplayed||c.replaceNodeContents(this.messageArea.find(this.messageArea.SELECTORS.CONTACTS),b,d),this._isLoadingContacts=!1}.bind(this)).fail(d.exception)},g.prototype._viewConversation=function(b){this._isDeleting&&this.messageArea.trigger(this.messageArea.EVENTS.CANCELDELETEMESSAGES,c);var c=a(b.currentTarget).data("userid"),d=a(b.currentTarget).data("messageid"),e="[data-userid='"+c+"']";d&&(e="[data-messageid='"+d+"']"),this._setSelectedUser(e),this.messageArea.trigger(this.messageArea.EVENTS.CONVERSATIONSELECTED,c),this.messageArea.find(this.messageArea.SELECTORS.SELECTEDVIEWPROFILE).removeClass("selected"),this._showMessagingArea()},g.prototype._viewContact=function(b){if(!this._isDeleting){var c=a(b.currentTarget).data("userid");this._setSelectedUser("[data-userid='"+c+"']"),this.messageArea.trigger(this.messageArea.EVENTS.CONTACTSELECTED,c),this.messageArea.find(this.messageArea.SELECTORS.SELECTEDVIEWCONVERSATION).removeClass("selected"),this._showMessagingArea()}},g.prototype._getItems=function(a,c,d){var e=b.call([{methodname:a,args:{userid:this.messageArea.getCurrentUserId(),limitfrom:c,limitnum:d}}]);return e[0]},g.prototype._deleteConversation=function(a,b){this._removeContact(this.messageArea.SELECTORS.CONVERSATIONS,b),this._numConversationsDisplayed--,this._hideMessagingArea(),this._stopDeleting()},g.prototype._updateLastMessage=function(a,b,c){if(c){var d=this._getUserNode(this.messageArea.SELECTORS.CONVERSATIONS,b),e=c.find(this.messageArea.SELECTORS.MESSAGETEXT).text().trim(),f=!1;c.data("useridto")==b&&(f=!0),this._updateContactText(d,e,f)}this._stopDeleting()},g.prototype._addContact=function(){this.messageArea.find(this.messageArea.SELECTORS.CONTACTS).empty(),this._numContactsDisplayed=0,this._loadContacts()},g.prototype._removeContact=function(a,b){this._getUserNode(a,b).remove(),this._numContactsDisplayed--},g.prototype._blockContact=function(a){var b=this._getUserNode(this.messageArea.SELECTORS.CONTACTS,a);b.find(this.messageArea.SELECTORS.CONTACTICONBLOCKED).removeClass("hidden"),b=this._getUserNode(this.messageArea.SELECTORS.CONVERSATIONS,a),b.find(this.messageArea.SELECTORS.CONTACTICONBLOCKED).removeClass("hidden"),b=this._getUserNode(this.messageArea.SELECTORS.SEARCHRESULTSAREA,a),b.find(this.messageArea.SELECTORS.CONTACTICONBLOCKED).removeClass("hidden")},g.prototype._unblockContact=function(a){var b=this._getUserNode(this.messageArea.SELECTORS.CONTACTS,a);b.find(this.messageArea.SELECTORS.CONTACTICONBLOCKED).addClass("hidden"),b=this._getUserNode(this.messageArea.SELECTORS.CONVERSATIONS,a),b.find(this.messageArea.SELECTORS.CONTACTICONBLOCKED).addClass("hidden"),b=this._getUserNode(this.messageArea.SELECTORS.SEARCHRESULTSAREA,a),b.find(this.messageArea.SELECTORS.CONTACTICONBLOCKED).addClass("hidden")},g.prototype._getUserNode=function(a,b){return this.messageArea.find(a+" "+this.messageArea.SELECTORS.CONTACT+"[data-userid='"+b+"']")},g.prototype._setSelectedUser=function(a){this.messageArea.find(this.messageArea.SELECTORS.CONTACT).removeClass("selected"),this.messageArea.find(this.messageArea.SELECTORS.CONTACT+a).addClass("selected")},g.prototype._getContactText=function(a){return a.length>this._messageLength&&(a=a.substr(0,this._messageLength-3),a+="..."),a},g.prototype._updateContactText=function(a,b,c){b=this._getContactText(b),c?f.get_string("you","message").done(function(b){a.find(this.messageArea.SELECTORS.LASTMESSAGEUSER).empty().append(b)}.bind(this)).always(function(){a.find(this.messageArea.SELECTORS.LASTMESSAGETEXT).empty().append(b)}.bind(this)):(a.find(this.messageArea.SELECTORS.LASTMESSAGEUSER).empty(),a.find(this.messageArea.SELECTORS.LASTMESSAGETEXT).empty().append(b))},g.prototype._selectNextContact=function(b,c){var d=a(b.target).closest(this.messageArea.SELECTORS.CONTACT),e=d.next();e.focus(),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation()},g.prototype._selectPreviousContact=function(b,c){var d=a(b.target).closest(this.messageArea.SELECTORS.CONTACT),e=d.prev();e.focus(),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation()},g.prototype._selectNextConversation=function(b,c){var d=a(b.target).closest(this.messageArea.SELECTORS.VIEWCONVERSATION),e=d.next();e.focus(),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation()},g.prototype._selectPreviousConversation=function(b,c){var d=a(b.target).closest(this.messageArea.SELECTORS.VIEWCONVERSATION),e=d.prev();e.focus(),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation()},g.prototype._setSearching=function(){a(this.messageArea.SELECTORS.SEARCHTEXTAREA).addClass("searching")},g.prototype._clearSearching=function(){a(this.messageArea.SELECTORS.SEARCHTEXTAREA).removeClass("searching")},g.prototype._showMessagingArea=function(){this.messageArea.find(this.messageArea.SELECTORS.MESSAGINGAREA).removeClass("hide-messages").addClass("show-messages")},g.prototype._hideMessagingArea=function(){this.messageArea.find(this.messageArea.SELECTORS.MESSAGINGAREA).removeClass("show-messages").addClass("hide-messages")},g});