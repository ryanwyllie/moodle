'use strict';define('core_message/message_area_contacts',['jquery','core/ajax','core/templates','core/notification','core/custom_interaction_events','core/str','core_message/message_area_events'],function($,Ajax,Templates,Notification,CustomEvents,Str,Events){function Contacts(messageArea){this.messageArea=messageArea,this._init()}var SELECTORS={CONTACT:'[data-region=\'contact\']',CONTACTICONBLOCKED:'[data-region=\'contact-icon-blocked\']',CONTACTS:'[data-region=\'contacts\'][data-region-content=\'contacts\']',CONTACTSAREA:'[data-region=\'contacts-area\']',CONVERSATIONS:'[data-region=\'contacts\'][data-region-content=\'conversations\']',COURSE:'[data-region=\'course\']',LASTMESSAGETEXT:'[data-region=\'last-message-text\']',LASTMESSAGEUSER:'[data-region=\'last-message-user\']',LOADINGICON:'.loading-icon',MESSAGETEXT:'[data-region=\'message-text\']',MESSAGINGAREA:'[data-region=\'messaging-area\']',NOCONTACTS:'[data-region=no-contacts]',SEARCHBOX:'[data-region=\'search-box\']',SEARCHRESULTSAREA:'[data-region=\'search-results-area\']',SEARCHTEXTAREA:'[data-region=\'search-text-area\']',SELECTEDVIEWCONVERSATION:'[data-action=\'view-contact-msg\'].selected',SELECTEDVIEWPROFILE:'[data-action=\'view-contact-profile\'].selected',SHOWMESSAGES:'[data-action=\'show-messages\']',VIEWCONVERSATION:'[data-action=\'view-contact-msg\']',VIEWPROFILE:'[data-action=\'view-contact-profile\']'};return Contacts.prototype._isLoadingConversations=!1,Contacts.prototype._isLoadingContacts=!1,Contacts.prototype._numContactsDisplayed=0,Contacts.prototype._numContactsToRetrieve=20,Contacts.prototype._numConversationsDisplayed=0,Contacts.prototype._numConversationsToRetrieve=20,Contacts.prototype._messageLength=60,Contacts.prototype.messageArea=null,Contacts.prototype._init=function(){CustomEvents.define(this.messageArea.node,[CustomEvents.events.activate,CustomEvents.events.down,CustomEvents.events.up]),this.messageArea.onCustomEvent(Events.MESSAGESEARCHCANCELED,this._viewConversations.bind(this)),this.messageArea.onCustomEvent(Events.USERSSEARCHCANCELED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(Events.CONTACTSSELECTED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(Events.CONVERSATIONDELETED,this._deleteConversation.bind(this)),this.messageArea.onCustomEvent(Events.CONVERSATIONSSELECTED,this._viewConversations.bind(this)),this.messageArea.onCustomEvent(Events.CONTACTSSELECTED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(Events.MESSAGESDELETED,this._updateLastMessage.bind(this)),this.messageArea.onCustomEvent(Events.MESSAGESENT,this._handleMessageSent.bind(this)),this.messageArea.onCustomEvent(Events.CONTACTREMOVED,function(e,userid){this._removeContact(SELECTORS.CONTACTS,userid)}.bind(this)),this.messageArea.onCustomEvent(Events.CONTACTADDED,function(e,userid){this._addContact(userid)}.bind(this)),this.messageArea.onCustomEvent(Events.CONTACTBLOCKED,function(e,userid){this._blockContact(userid)}.bind(this)),this.messageArea.onCustomEvent(Events.CONTACTUNBLOCKED,function(e,userid){this._unblockContact(userid)}.bind(this)),this.messageArea.onCustomEvent(Events.CHOOSEMESSAGESTODELETE,this._startDeleting.bind(this)),this.messageArea.onCustomEvent(Events.CANCELDELETEMESSAGES,this._stopDeleting.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.VIEWCONVERSATION,this._viewConversation.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.VIEWPROFILE,this._viewContact.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.activate,SELECTORS.SHOWMESSAGES,this._showMessagingArea.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.up,SELECTORS.CONTACT,this._selectPreviousContact.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.down,SELECTORS.CONTACT,this._selectNextContact.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.up,SELECTORS.VIEWCONVERSATION,this._selectPreviousConversation.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.down,SELECTORS.VIEWCONVERSATION,this._selectNextConversation.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.up,SELECTORS.COURSE,this._selectPreviousCourse.bind()),this.messageArea.onDelegateEvent(CustomEvents.events.down,SELECTORS.COURSE,this._selectNextCourse.bind()),this.messageArea.onDelegateEvent('focus',SELECTORS.SEARCHBOX,this._setSearching.bind(this)),this.messageArea.onDelegateEvent('blur',SELECTORS.SEARCHBOX,this._clearSearching.bind(this)),CustomEvents.define(this.messageArea.find(SELECTORS.CONVERSATIONS),[CustomEvents.events.scrollBottom]),CustomEvents.define(this.messageArea.find(SELECTORS.CONTACTS),[CustomEvents.events.scrollBottom]),this.messageArea.onDelegateEvent(CustomEvents.events.scrollBottom,SELECTORS.CONVERSATIONS,this._loadConversations.bind(this)),this.messageArea.onDelegateEvent(CustomEvents.events.scrollBottom,SELECTORS.CONTACTS,this._loadContacts.bind(this)),this.messageArea.showContactsFirst()||(this._numConversationsDisplayed=20)},Contacts.prototype._startDeleting=function(){this.messageArea.find(SELECTORS.CONTACTSAREA).addClass('editing')},Contacts.prototype._stopDeleting=function(){this.messageArea.find(SELECTORS.CONTACTSAREA).removeClass('editing')},Contacts.prototype._viewConversations=function(){0===this._numConversationsDisplayed&&this._loadConversations(),this.messageArea.find(SELECTORS.CONTACTS).hide(),this.messageArea.find(SELECTORS.CONVERSATIONS).show()},Contacts.prototype._viewContacts=function(){0===this._numContactsDisplayed&&this._loadContacts(),this.messageArea.find(SELECTORS.CONVERSATIONS).hide(),this.messageArea.find(SELECTORS.CONTACTS).show()},Contacts.prototype._handleMessageSent=function(event,userid,text){this._viewConversations();var user=this._getUserNode(SELECTORS.CONVERSATIONS,userid);if(0===user.length){var usercontact=this._getUserNode(SELECTORS.CONTACTS,userid);if(0===usercontact.length&&(usercontact=this._getUserNode(SELECTORS.SEARCHRESULTSAREA,userid)),0==usercontact.length)return;user=usercontact.clone(),user.attr('data-action','view-contact-msg'),this.messageArea.find(SELECTORS.CONVERSATIONS+' '+SELECTORS.NOCONTACTS).remove(),this._numConversationsDisplayed++}user.prependTo(this.messageArea.find(SELECTORS.CONVERSATIONS)),this.messageArea.find(SELECTORS.CONVERSATIONS).scrollTop(0),this._updateContactText(user,text,!0),this._setSelectedUser('[data-userid=\''+userid+'\']')},Contacts.prototype._loadConversations=function(){if(this._isLoadingConversations)return!1;this._isLoadingConversations=!0;var numberreceived=0;return Templates.render('core/loading',{}).then(function(html,js){return this._numConversationsDisplayed?Templates.appendNodeContents(this.messageArea.find(SELECTORS.CONVERSATIONS),'<div style=\'text-align:center\'>'+html+'</div>',js):Templates.replaceNodeContents(this.messageArea.find(SELECTORS.CONVERSATIONS),'<div style=\'text-align:center\'>'+html+'</div>',js),this._getItems('core_message_data_for_messagearea_conversations',this._numConversationsDisplayed,this._numConversationsToRetrieve)}.bind(this)).then(function(data){return numberreceived=data.contacts.length,data.isconversation=!0,Templates.render('core_message/message_area_contacts',data)}).then(function(html,js){this.messageArea.find(SELECTORS.CONVERSATIONS+' '+SELECTORS.LOADINGICON).remove(),0<numberreceived?(Templates.appendNodeContents(this.messageArea.find(SELECTORS.CONVERSATIONS),html,js),this._numConversationsDisplayed+=this._numConversationsToRetrieve):!this._numConversationsDisplayed&&Templates.replaceNodeContents(this.messageArea.find(SELECTORS.CONVERSATIONS),html,js),this._isLoadingConversations=!1}.bind(this)).fail(Notification.exception)},Contacts.prototype._loadContacts=function(){if(this._isLoadingContacts)return!1;this._isLoadingContacts=!0;var numberreceived=0;return Templates.render('core/loading',{}).then(function(html,js){return this._numContactsDisplayed?Templates.appendNodeContents(this.messageArea.find(SELECTORS.CONTACTS),'<div style=\'text-align:center\'>'+html+'</div>',js):Templates.replaceNodeContents(this.messageArea.find(SELECTORS.CONTACTS),'<div style=\'text-align:center\'>'+html+'</div>',js),this._getItems('core_message_data_for_messagearea_contacts',this._numContactsDisplayed,this._numContactsToRetrieve)}.bind(this)).then(function(data){return numberreceived=data.contacts.length,data.isconversation=!1,Templates.render('core_message/message_area_contacts',data)}).then(function(html,js){this.messageArea.find(SELECTORS.CONTACTS+' '+SELECTORS.LOADINGICON).remove(),0<numberreceived?(Templates.appendNodeContents(this.messageArea.find(SELECTORS.CONTACTS),html,js),this._numContactsDisplayed+=numberreceived):!this._numContactsDisplayed&&Templates.replaceNodeContents(this.messageArea.find(SELECTORS.CONTACTS),html,js),this._isLoadingContacts=!1}.bind(this)).fail(Notification.exception)},Contacts.prototype._viewConversation=function(event){this.messageArea.trigger(Events.CANCELDELETEMESSAGES);var userid=$(event.currentTarget).data('userid'),messageid=$(event.currentTarget).data('messageid'),selector='[data-userid=\''+userid+'\']';messageid&&(selector='[data-messageid=\''+messageid+'\']'),this._setSelectedUser(selector),this.messageArea.trigger(Events.CONVERSATIONSELECTED,userid),this.messageArea.find(SELECTORS.SELECTEDVIEWPROFILE).removeClass('selected'),this._showMessagingArea()},Contacts.prototype._viewContact=function(event){this.messageArea.trigger(Events.CANCELDELETEMESSAGES);var userid=$(event.currentTarget).data('userid');this._setSelectedUser('[data-userid=\''+userid+'\']'),this.messageArea.trigger(Events.CONTACTSELECTED,userid),this.messageArea.find(SELECTORS.SELECTEDVIEWCONVERSATION).removeClass('selected'),this._showMessagingArea()},Contacts.prototype._getItems=function(webservice,limitfrom,limitnum){var promises=Ajax.call([{methodname:webservice,args:{userid:this.messageArea.getCurrentUserId(),limitfrom:limitfrom,limitnum:limitnum}}]);return promises[0]},Contacts.prototype._deleteConversation=function(event,userid){this._removeContact(SELECTORS.CONVERSATIONS,userid),this._numConversationsDisplayed--,this._hideMessagingArea(),this._stopDeleting()},Contacts.prototype._updateLastMessage=function(event,userid,updatemessage){if(updatemessage){var user=this._getUserNode(SELECTORS.CONVERSATIONS,userid),updatemessagetext=updatemessage.find(SELECTORS.MESSAGETEXT).text().trim(),sentbyuser=!1;updatemessage.data('useridto')==userid&&(sentbyuser=!0),this._updateContactText(user,updatemessagetext,sentbyuser)}this._stopDeleting()},Contacts.prototype._addContact=function(){this.messageArea.find(SELECTORS.CONTACTS).empty(),this._numContactsDisplayed=0,this._loadContacts()},Contacts.prototype._removeContact=function(selector,userid){this._getUserNode(selector,userid).remove(),this._numContactsDisplayed--},Contacts.prototype._blockContact=function(userid){var user=this._getUserNode(SELECTORS.CONTACTS,userid);user.find(SELECTORS.CONTACTICONBLOCKED).removeClass('hidden'),user=this._getUserNode(SELECTORS.CONVERSATIONS,userid),user.find(SELECTORS.CONTACTICONBLOCKED).removeClass('hidden'),user=this._getUserNode(SELECTORS.SEARCHRESULTSAREA,userid),user.find(SELECTORS.CONTACTICONBLOCKED).removeClass('hidden')},Contacts.prototype._unblockContact=function(userid){var user=this._getUserNode(SELECTORS.CONTACTS,userid);user.find(SELECTORS.CONTACTICONBLOCKED).addClass('hidden'),user=this._getUserNode(SELECTORS.CONVERSATIONS,userid),user.find(SELECTORS.CONTACTICONBLOCKED).addClass('hidden'),user=this._getUserNode(SELECTORS.SEARCHRESULTSAREA,userid),user.find(SELECTORS.CONTACTICONBLOCKED).addClass('hidden')},Contacts.prototype._getUserNode=function(selector,userid){return this.messageArea.find(selector+' '+SELECTORS.CONTACT+'[data-userid=\''+userid+'\']')},Contacts.prototype._setSelectedUser=function(selector){this.messageArea.find(SELECTORS.CONTACT).removeClass('selected'),this.messageArea.find(SELECTORS.CONTACT).attr('aria-pressed',!1),this.messageArea.find(SELECTORS.CONTACT+selector).addClass('selected'),this.messageArea.find(SELECTORS.CONTACT+selector).attr('aria-pressed',!0)},Contacts.prototype._getContactText=function(text){return text=$(document.createElement('div')).html(text).text(),text.length>this._messageLength&&(text=text.substr(0,this._messageLength-3),text+='...'),text},Contacts.prototype._updateContactText=function(user,text,sentbyuser){text=this._getContactText(text),sentbyuser?Str.get_string('you','message').done(function(string){user.find(SELECTORS.LASTMESSAGEUSER).empty().append(string)}).always(function(){user.find(SELECTORS.LASTMESSAGETEXT).empty().append(text)}):(user.find(SELECTORS.LASTMESSAGEUSER).empty(),user.find(SELECTORS.LASTMESSAGETEXT).empty().append(text))},Contacts.prototype._selectNextContact=function(e,data){var contact=$(e.target).closest(SELECTORS.CONTACT),next=contact.next();next.focus(),data.originalEvent.preventDefault(),data.originalEvent.stopPropagation()},Contacts.prototype._selectPreviousContact=function(e,data){var contact=$(e.target).closest(SELECTORS.CONTACT),previous=contact.prev();previous.focus(),data.originalEvent.preventDefault(),data.originalEvent.stopPropagation()},Contacts.prototype._selectNextCourse=function(e,data){var course=$(e.target).closest(SELECTORS.COURSE);course.next().focus(),data.originalEvent.preventDefault(),data.originalEvent.stopPropagation()},Contacts.prototype._selectPreviousCourse=function(e,data){var course=$(e.target).closest(SELECTORS.COURSE);course.prev().focus(),data.originalEvent.preventDefault(),data.originalEvent.stopPropagation()},Contacts.prototype._selectNextConversation=function(e,data){var conversation=$(e.target).closest(SELECTORS.VIEWCONVERSATION),next=conversation.next();next.focus(),data.originalEvent.preventDefault(),data.originalEvent.stopPropagation()},Contacts.prototype._selectPreviousConversation=function(e,data){var conversation=$(e.target).closest(SELECTORS.VIEWCONVERSATION),previous=conversation.prev();previous.focus(),data.originalEvent.preventDefault(),data.originalEvent.stopPropagation()},Contacts.prototype._setSearching=function(){$(SELECTORS.SEARCHTEXTAREA).addClass('searching')},Contacts.prototype._clearSearching=function(){$(SELECTORS.SEARCHTEXTAREA).removeClass('searching')},Contacts.prototype._showMessagingArea=function(){this.messageArea.find(SELECTORS.MESSAGINGAREA).removeClass('hide-messages').addClass('show-messages')},Contacts.prototype._hideMessagingArea=function(){this.messageArea.find(SELECTORS.MESSAGINGAREA).removeClass('show-messages').addClass('hide-messages')},Contacts});
//# sourceMappingURL=message_area_contacts.min.js.map
