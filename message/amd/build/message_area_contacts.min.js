define(["jquery","core/ajax","core/templates","core/notification","core/custom_interaction_events"],function(a,b,c,d,e){function f(a){this.messageArea=a,this._init()}return f.prototype._isDeleting=!1,f.prototype._isLoadingConversations=!1,f.prototype._isLoadingContacts=!1,f.prototype._numContactsDisplayed=0,f.prototype._numContactsToRetrieve=20,f.prototype._numConversationsDisplayed=0,f.prototype._numConversationsToRetrieve=20,f.prototype._messageLength=60,f.prototype.messageArea=null,f.prototype._init=function(){e.define(this.messageArea.node,[e.events.activate,e.events.down,e.events.up]),this.messageArea.onCustomEvent(this.messageArea.EVENTS.MESSAGESEARCHCANCELED,this._viewConversations.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.PEOPLESEARCHCANCELED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONTACTSSELECTED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONVERSATIONSSELECTED,this._viewConversations.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONTACTSSELECTED,this._viewContacts.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.MESSAGESDELETED,this._deleteConversations.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.MESSAGESENT,this._handleMessageSent.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONTACTREMOVED,function(a,b){this._removeContact(this.messageArea.SELECTORS.CONTACTS,b)}.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CONTACTADDED,function(a,b){this._addContact(b)}.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CHOOSEMESSAGESTODELETE,this._chooseConversationsToDelete.bind(this)),this.messageArea.onCustomEvent(this.messageArea.EVENTS.CANCELDELETEMESSAGES,this._cancelConversationsToDelete.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,this.messageArea.SELECTORS.VIEWCONVERSATION,this._handleConversationActivate.bind(this)),this.messageArea.onDelegateEvent(e.events.activate,this.messageArea.SELECTORS.VIEWPROFILE,this._viewContact.bind(this)),this.messageArea.onDelegateEvent(e.events.up,this.messageArea.SELECTORS.CONTACT,this._selectPreviousContact.bind(this)),this.messageArea.onDelegateEvent(e.events.down,this.messageArea.SELECTORS.CONTACT,this._selectNextContact.bind(this)),this.messageArea.onDelegateEvent(e.events.up,this.messageArea.SELECTORS.VIEWCONVERSATION,this._selectPreviousConversation.bind(this)),this.messageArea.onDelegateEvent(e.events.down,this.messageArea.SELECTORS.VIEWCONVERSATION,this._selectNextConversation.bind(this)),this.messageArea.onDelegateEvent("focus",this.messageArea.SELECTORS.SEARCHBOX,this._setSearching.bind(this)),this.messageArea.onDelegateEvent("blur",this.messageArea.SELECTORS.SEARCHBOX,this._clearSearching.bind(this)),e.define(this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS),[e.events.scrollBottom]),e.define(this.messageArea.find(this.messageArea.SELECTORS.CONTACTS),[e.events.scrollBottom]),this.messageArea.onDelegateEvent(e.events.scrollBottom,this.messageArea.SELECTORS.CONVERSATIONS,this._loadConversations.bind(this)),this.messageArea.onDelegateEvent(e.events.scrollBottom,this.messageArea.SELECTORS.CONTACTS,this._loadContacts.bind(this)),this._numConversationsDisplayed=this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS+" "+this.messageArea.SELECTORS.CONTACT).length},f.prototype._viewConversations=function(){0===this._numConversationsDisplayed&&this._loadConversations(),this.messageArea.find(this.messageArea.SELECTORS.CONTACTS).hide(),this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS).show()},f.prototype._viewContacts=function(){0===this._numContactsDisplayed&&this._loadContacts(),this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS).hide(),this.messageArea.find(this.messageArea.SELECTORS.CONTACTS).show()},f.prototype._handleMessageSent=function(a,b,c){this._viewConversations(),c=this._getContactText(c);var d=this._getUserNode(this.messageArea.SELECTORS.CONVERSATIONS,b);if(0===d.length){var e=this._getUserNode(this.messageArea.SELECTORS.CONTACTS,b);if(0===e.length&&(e=this._getUserNode(this.messageArea.SELECTORS.SEARCHRESULTSAREA,b)),0==e.length)return;d=e.clone(),d.attr("data-action","view-contact-msg"),this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS+" "+this.messageArea.SELECTORS.NOCONTACTS).remove(),this._numConversationsDisplayed++}d.prependTo(this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS)),this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS).scrollTop(0),d.find(this.messageArea.SELECTORS.LASTMESSAGE).empty().append(c),this._setSelectedUser("[data-userid='"+b+"']")},f.prototype._loadConversations=function(){if(!this._isDeleting&&!this._isLoadingConversations){this._isLoadingConversations=!0;var a=0;return c.render("core/loading",{}).then(function(a,b){return this._numConversationsDisplayed?c.appendNodeContents(this.messageArea.SELECTORS.CONVERSATIONS,"<div style='text-align:center'>"+a+"</div>",b):c.replaceNodeContents(this.messageArea.SELECTORS.CONVERSATIONS,"<div style='text-align:center'>"+a+"</div>",b),this._getItems("core_message_data_for_messagearea_conversations",this._numConversationsDisplayed,this._numConversationsToRetrieve)}.bind(this)).then(function(b){return a=b.contacts.length,c.render("core_message/message_area_contacts",b)}).then(function(b,d){this.messageArea.find(this.messageArea.SELECTORS.CONVERSATIONS+" "+this.messageArea.SELECTORS.LOADINGICON).remove(),a>0?(c.appendNodeContents(this.messageArea.SELECTORS.CONVERSATIONS,b,d),this._numConversationsDisplayed+=a):this._numConversationsDisplayed||c.replaceNodeContents(this.messageArea.SELECTORS.CONVERSATIONS,b,d),this._isLoadingConversations=!1}.bind(this)).fail(d.exception)}},f.prototype._loadContacts=function(){if(!this._isDeleting&&!this._isLoadingContacts){this._isLoadingContacts=!0;var a=0;return c.render("core/loading",{}).then(function(a,b){return this._numContactsDisplayed?c.appendNodeContents(this.messageArea.SELECTORS.CONTACTS,"<div style='text-align:center'>"+a+"</div>",b):c.replaceNodeContents(this.messageArea.SELECTORS.CONTACTS,"<div style='text-align:center'>"+a+"</div>",b),this._getItems("core_message_data_for_messagearea_contacts",this._numContactsDisplayed,this._numContactsToRetrieve)}.bind(this)).then(function(b){return a=b.contacts.length,c.render("core_message/message_area_contacts",b)}).then(function(b,d){this.messageArea.find(this.messageArea.SELECTORS.CONTACTS+" "+this.messageArea.SELECTORS.LOADINGICON).remove(),a>0?(c.appendNodeContents(this.messageArea.SELECTORS.CONTACTS,b,d),this._numContactsDisplayed+=a):this._numContactsDisplayed||c.replaceNodeContents(this.messageArea.SELECTORS.CONTACTS,b,d),this._isLoadingContacts=!1}.bind(this)).fail(d.exception)}},f.prototype._viewConversation=function(b){if(!this._isDeleting){var c=a(b.currentTarget).data("userid"),d=a(b.currentTarget).data("messageid"),e="[data-userid='"+c+"']";d&&(e="[data-messageid='"+d+"']"),this._setSelectedUser(e),this.messageArea.trigger(this.messageArea.EVENTS.CONVERSATIONSELECTED,c),this.messageArea.find(this.messageArea.SELECTORS.SELECTEDVIEWPROFILE).removeClass("selected")}},f.prototype._viewContact=function(b){if(!this._isDeleting){var c=a(b.currentTarget).data("userid");this._setSelectedUser("[data-userid='"+c+"']"),this.messageArea.trigger(this.messageArea.EVENTS.CONTACTSELECTED,c),this.messageArea.find(this.messageArea.SELECTORS.SELECTEDVIEWCONVERSATION).removeClass("selected")}},f.prototype._getItems=function(a,c,d){var e=b.call([{methodname:a,args:{userid:this.messageArea.getCurrentUserId(),limitfrom:c,limitnum:d}}]);return e[0]},f.prototype._chooseConversationsToDelete=function(){this._isDeleting=!0,this.messageArea.find(this.messageArea.SELECTORS.CONTACTSAREA).addClass("editing"),this.messageArea.find(this.messageArea.SELECTORS.CONTACT).attr("role","checkbox").attr("aria-checked","false")},f.prototype._cancelConversationsToDelete=function(){this._isDeleting=!1,this.messageArea.find(this.messageArea.SELECTORS.CONTACTSAREA).removeClass("editing"),this.messageArea.find(this.messageArea.SELECTORS.CONTACT).removeAttr("role").removeAttr("aria-checked")},f.prototype._deleteConversations=function(c,e){var f=this.messageArea.find(this.messageArea.SELECTORS.CONTACT+"[aria-checked='true']"),g=[];f.each(function(b,c){var d=a(c),e=d.data("userid");g.push({methodname:"core_message_delete_conversation",args:{userid:this.messageArea.getCurrentUserId(),otheruserid:e}})}.bind(this)),g.length>0&&b.call(g)[g.length-1].then(function(){for(var a=0;a<=g.length-1;a++)this._removeContact(this.messageArea.SELECTORS.CONVERSATIONS,g[a].args.otheruserid),this._numConversationsDisplayed--,this.messageArea.trigger(this.messageArea.EVENTS.CONVERSATIONDELETED,g[a].args.otheruserid)}.bind(this),d.exception);var h=this._getUserNode(this.messageArea.SELECTORS.CONVERSATIONS,e);if(0!==h.length){var i=h.find(this.messageArea.SELECTORS.LASTMESSAGE);i=i.html();var j=this.messageArea.find(this.messageArea.SELECTORS.MESSAGESAREA+" "+this.messageArea.SELECTORS.MESSAGE),k=j.length;j.each(function(b,c){if(b===k-1){var d=a(c).find(this.messageArea.SELECTORS.MESSAGETEXT).html().trim();i!=d&&h.find(this.messageArea.SELECTORS.LASTMESSAGE).empty().append(this._getContactText(d))}}.bind(this))}this._isDeleting=!1,this._cancelConversationsToDelete()},f.prototype._addContact=function(){this.messageArea.find(this.messageArea.SELECTORS.CONTACTS).empty(),this._numContactsDisplayed=0,this._loadContacts()},f.prototype._getUserNode=function(a,b){return this.messageArea.find(a+" "+this.messageArea.SELECTORS.CONTACT+"[data-userid='"+b+"']")},f.prototype._removeContact=function(a,b){this._getUserNode(a,b).remove(),this._numContactsDisplayed--},f.prototype._setSelectedUser=function(a){this.messageArea.find(this.messageArea.SELECTORS.CONTACT).removeClass("selected"),this.messageArea.find(this.messageArea.SELECTORS.CONTACT+a).addClass("selected")},f.prototype._getContactText=function(a){return a.length>this._messageLength&&(a=a.substr(0,this._messageLength-3),a+="..."),a},f.prototype._selectNextContact=function(b,c){var d=a(b.target).closest(this.messageArea.SELECTORS.CONTACT),e=d.next();e.focus(),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation()},f.prototype._selectPreviousContact=function(b,c){var d=a(b.target).closest(this.messageArea.SELECTORS.CONTACT),e=d.prev();e.focus(),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation()},f.prototype._selectNextConversation=function(b,c){var d=a(b.target).closest(this.messageArea.SELECTORS.VIEWCONVERSATION),e=d.next();e.focus(),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation()},f.prototype._selectPreviousConversation=function(b,c){var d=a(b.target).closest(this.messageArea.SELECTORS.VIEWCONVERSATION),e=d.prev();e.focus(),c.originalEvent.preventDefault(),c.originalEvent.stopPropagation()},f.prototype._setSearching=function(){a(this.messageArea.SELECTORS.SEARCHTEXTAREA).addClass("searching")},f.prototype._clearSearching=function(){a(this.messageArea.SELECTORS.SEARCHTEXTAREA).removeClass("searching")},f.prototype._toggleConversationSelection=function(b){if(this._isDeleting){var c=a(b.target).closest(this.messageArea.SELECTORS.CONTACT);"true"===c.attr("aria-checked")?c.attr("aria-checked","false"):c.attr("aria-checked","true")}},f.prototype._handleConversationActivate=function(a){return this._isDeleting?this._toggleConversationSelection(a):this._viewConversation(a)},f});