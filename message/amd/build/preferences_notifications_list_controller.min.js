define(["jquery","core/ajax","core/notification"],function(a,b,c){var d={PREFERENCE_ROW:".preference-row",PROCESSOR:"[data-processor-name]",STATE_NONE:'[data-state="none"]',STATE_BOTH:'[data-state="both"]',STATE_LOGGED_IN:'[data-state="loggedin"]',STATE_LOGGED_OFF:'[data-state="loggedoff"]',STATE_INPUTS:"[data-state] input"},e=function(b){this.root=a(b)};e.prototype.getName=function(){return this.root.attr("data-processor-name")},e.prototype.isLoggedInEnabled=function(){var a=this.root.find(d.STATE_NONE).find("input");if(a.prop("checked"))return!1;var b=this.root.find(d.STATE_BOTH).find("input"),c=this.root.find(d.STATE_LOGGED_IN).find("input");return c.prop("checked")||b.prop("checked")},e.prototype.isLoggedOffEnabled=function(){var a=this.root.find(d.STATE_NONE).find("input");if(a.prop("checked"))return!1;var b=this.root.find(d.STATE_BOTH).find("input"),c=this.root.find(d.STATE_LOGGED_OFF).find("input");return c.prop("checked")||b.prop("checked")};var f=function(b,c){this.root=a(b),this.userId=c};f.prototype.getPreferenceKey=function(){return this.root.attr("data-preference-key")},f.prototype.getLoggedInPreferenceKey=function(){return this.getPreferenceKey()+"_loggedin"},f.prototype.getLoggedOffPreferenceKey=function(){return this.getPreferenceKey()+"_loggedoff"},f.prototype.getProcessors=function(){return this.root.find(d.PROCESSOR).map(function(b,c){return new e(a(c))})},f.prototype.startLoading=function(){this.root.addClass("loading"),this.root.find(d.STATE_INPUTS).prop("disabled",!0)},f.prototype.stopLoading=function(){this.root.removeClass("loading"),this.root.find(d.STATE_INPUTS).prop("disabled",!1)},f.prototype.isLoading=function(){return this.root.hasClass("loading")},f.prototype.save=function(){if(this.isLoading())return a.Deferred();this.startLoading();var d="",e="";this.getProcessors().each(function(a,b){b.isLoggedInEnabled()&&(""===d?d=b.getName():d+=","+b.getName()),b.isLoggedOffEnabled()&&(""===e?e=b.getName():e+=","+b.getName())}),""===d&&(d="none"),""===e&&(e="none");var f={user:{preferences:[{type:this.getLoggedInPreferenceKey(),value:d},{type:this.getLoggedOffPreferenceKey(),value:e}]}},g={methodname:"core_user_update_user",args:f};return b.call([g])[0].fail(c.exception).always(function(){this.stopLoading()}.bind(this))};var g=function(b){this.root=a(b),this.userId=this.root.attr("data-user-id"),this.root.on("change",function(b){if(!this.isDisabled()){var c=a(b.target).closest(d.PREFERENCE_ROW),e=new f(c,this.userId);e.save()}}.bind(this)),a(document).on("messageprefs:disableall",function(){this.setDisabled()}.bind(this)),a(document).on("messageprefs:enableall",function(){this.setEnabled()}.bind(this))};return g.prototype.isDisabled=function(){return this.root.hasClass("disabled")},g.prototype.setDisabled=function(){this.root.addClass("disabled"),this.root.find(d.STATE_INPUTS).prop("disabled",!0)},g.prototype.setEnabled=function(){this.root.removeClass("disabled"),this.root.find(d.STATE_INPUTS).prop("disabled",!1)},g});