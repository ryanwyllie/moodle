define(["core/user_date"],function(a){var b=function(b,c){var d=b.reduce(function(b,d){var e=a.getUserMidnightForTimestamp(d.timeCreated,c);return b.hasOwnProperty(e)?b[e].push(d):b[e]=[d],b},{});return Object.keys(d).map(function(a){return{timestamp:a,messages:d[a]}})},c=function(a,b,c){b=b.slice();var d=[],e=[],f=[];return a.forEach(function(a){for(var d=!1,g=0;g<b.length;g++){var h=b[g];if(c(a,h)){d=!0,f.push({a:a,b:h});break}}d?b.splice(g,1):e.push(a)}),d=b,{missingFromA:d,missingFromB:e,matches:f}},d=function(a,b){for(var c=null,d=0;d<a.length;d++){var e=a[d];if(b(e))return e}return c},e=function(a,b){a.sort(),b.sort();var c=a.length,d=b.length;return c<1&&d<1||c==d&&a.every(function(a,c){return a==b[c]})},f=function(a,b){return{remove:b.missingFromB,add:b.missingFromA.map(function(b){var c=d(a,function(a){return b.timestamp<a.timestamp});return{before:c,value:b}})}},g=function(a){var b=[],e=[];return a.forEach(function(a){var f=a.a,g=a.b,h=c(f.messages,g.messages,function(a,b){return a.id==b.id});b=b.concat(h.missingFromB),h.missingFromA.forEach(function(a){var b=d(f.messages,function(b){return a.timeCreated<b.timeCreated});e.push({before:b,value:a,day:f})})}),{add:e,remove:b}},h=function(a,d){var h=a.messages.map(function(a){return a.id}),i=d.messages.map(function(a){return a.id});if(e(h,i))return null;var j=b(a.messages,a.midnight),k=b(d.messages,d.midnight),l=c(j,k,function(a,b){return a.timestamp==b.timestamp});return{days:f(j,l),messages:g(l.matches)}},i=function(a,b){var c=Object.keys(a.members),d=Object.keys(b.members);if(e(c,d))return null;var f=b.loggedInUserId,g=d.filter(function(a){return a!=f});if(!g.length)return null;var h={},i=g.length>1;if(!i){var j=g[0];h=b.members[j]}return{isGroupMessage:i,context:h}},j=function(a,b){var c=a.messages,d=b.messages;if(d.length<1)return null;if(c.length<1)return d[d.length-1].id;var e=c[a.messages.length-1],f=d[d.length-1],g=c[0],h=d[0];return e.id!=f.id?f.id:g.id!=h.id?g.id:null},k=function(a,b){return!(a.loadingMembers||!b.loadingMembers)||!(a.loadingMembers&&!b.loadingMembers)&&null},l=function(a,b){return a.hasTriedToLoadMessages===b.hasTriedToLoadMessages?null:!(b.hasTriedToLoadMessages||!b.loadingMessages)||!(b.hasTriedToLoadMessages&&!b.loadingMessages)&&null},m=function(a,b){return!(a.loadingMessages||!b.loadingMessages)||!(a.loadingMessages&&!b.loadingMessages)&&null},n=function(a,b){return!(a.sendingMessage||!b.sendingMessage)||!(a.sendingMessage&&!b.sendingMessage)&&null},o=function(a,b){if(b.pendingBlockUserIds.length){var c=b.pendingBlockUserIds[0];return b.members[c]}return!a.pendingBlockUserIds.length&&null},p=function(a,b){if(b.pendingUnblockUserIds.length){var c=b.pendingUnblockUserIds[0];return b.members[c]}return!a.pendingUnblockUserIds.length&&null},q=function(a,b){if(b.pendingAddContactIds.length){var c=b.pendingAddContactIds[0];return b.members[c]}return!a.pendingAddContactIds.length&&null},r=function(a,b){if(b.pendingRemoveContactIds.length){var c=b.pendingRemoveContactIds[0];return b.members[c]}return!a.pendingRemoveContactIds.length&&null},s=function(a,b){return!!b.pendingDeleteMessageIds.length||!a.pendingDeleteMessageIds.length&&null},t=function(a,b){return!(a.pendingDeleteConversation||!b.pendingDeleteConversation)||!(a.pendingDeleteConversation&&!b.pendingDeleteConversation)&&null},u=function(a,b){var c=Object.keys(a.members),d=Object.keys(b.members),e=b.loggedInUserId,f=d.filter(function(a){return a!=e}),g=f.length>1;if(g||!c.length||!d.length)return null;var h=f[0],i=a.members[h],j=b.members[h];return!(i.isblocked&&!j.isblocked)&&(!(i.isblocked||!j.isblocked)||null)},v=function(a,b){var c=Object.keys(a.members),d=Object.keys(b.members),e=b.loggedInUserId,f=d.filter(function(a){return a!=e}),g=f.length>1;if(g||!c.length||!d.length)return null;var h=f[0],i=a.members[h],j=b.members[h];return!(i.iscontact&&!j.iscontact)&&(!(i.iscontact||!j.iscontact)||null)},w=function(a,b){return!(a.loadingConfirmAction||!b.loadingConfirmAction)||!(a.loadingConfirmAction&&!b.loadingConfirmAction)&&null},x=function(a,b){var c=a.selectedMessageIds.length>0,d=b.selectedMessageIds.length>0,e=a.messages.length!=b.messages.length;return!(c||!d)||!(c&&!d)&&(!(!c||!e)||null)},y=function(a,b){var d=a.selectedMessageIds,f=b.selectedMessageIds;if(e(d,f))return null;var g=c(d,f,function(a,b){return a==b});return{count:f.length,add:g.missingFromA,remove:g.missingFromB}},z=function(a){return Object.keys(a.members).reduce(function(b,c){return c==a.loggedInUserId||b||(b=a.members[c]),b},null)},A=function(a,b){var c=z(a),d=z(b),e=a.messages.length>0,f=b.messages.length>0,g=function(a){return a.requirescontact&&!a.iscontact&&!a.sentcontactrequest};if(!a.hasTriedToLoadMessages&&!b.hasTriedToLoadMessages)return null;if(!c&&!d)return null;if(!c&&d&&g(d))return{show:!0,hasMessages:f,user:d};if(a.hasTriedToLoadMessages&&b.hasTriedToLoadMessages){if(!g(c)&&g(d))return{show:!0,hasMessages:f,user:d};if(g(c)&&!g(d))return{show:!1,hasMessages:f}}return!a.hasTriedToLoadMessages&&b.hasTriedToLoadMessages&&d&&g(d)?{show:!0,hasMessages:f,user:d}:a.hasTriedToLoadMessages&&!b.hasTriedToLoadMessages&&g(c)?{show:!1,hasMessages:e}:null},B=function(a,b){var c=z(a),d=z(b);return c||d?c&&!d?!c.isblocked&&null:!c&&d?!!d.isblocked||null:!(c.isblocked||!d.isblocked)||!(c.isblocked&&!d.isblocked)&&null:null},C=function(a,b){var c=z(a),d=z(b);return c||d?c&&!d?!c.canmessage||null:!c&&d?!d.canmessage||null:!(!c.canmessage&&d.canmessage)&&(!(!c.canmessage||d.canmessage)||null):null},D=function(a,b){var c=l(a,b),d=x(a,b),e=A(a,b),f=B(a,b),g=C(a,b),h=null!==e?e.show&&e.hasMessages:null,i=z(b),j=function(a,c){if(a)return c;if(null!==a&&!a){if(!i)return{type:"content"};if(i.isblocked)return{type:"unblock"};if(b.messages.length&&!i.iscontact&&i.requirescontact&&!i.sentcontactrequest)return{type:"add-contact",user:i};if(!i.canmessage)return{type:"unable-to-message"}}return null};if(null===c&&null===d&&null===e&&null===f)return null;for(var k=[[c,{type:"placeholder"}],[d,{type:"edit-mode"}],[g,{type:"unable-to-message"}],[f,{type:"unblock"}],[h,{type:"add-contact",user:i}]],m=0;m<k.length;m++){var n=k[m][0],o=k[m][1],p=j(n,o);if(null!==p)return p}return{type:"content"}},E=function(a,b){var c={conversation:h,header:i,footer:D,scrollToMessage:j,loadingMembers:k,loadingFirstMessages:l,loadingMessages:m,sendingMessage:n,confirmBlockUser:o,confirmUnblockUser:p,confirmAddContact:q,confirmRemoveContact:r,confirmDeleteSelectedMessages:s,confirmDeleteConversation:t,isBlocked:u,isContact:v,loadingConfirmAction:w,inEditMode:x,selectedMessages:y,requireAddContact:A};return Object.keys(c).reduce(function(d,e){var f=c[e],g=f(a,b);return null!==g&&(d[e]=g),d},{})};return{buildPatch:E}});