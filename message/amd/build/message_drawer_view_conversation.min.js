function _typeof(e){if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(e){return typeof e}}else{_typeof=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e}}return _typeof(e)}define ("core_message/message_drawer_view_conversation",["jquery","core/auto_rows","core/backoff_timer","core/custom_interaction_events","core/notification","core/pubsub","core/str","core_message/message_repository","core_message/message_drawer_events","core_message/message_drawer_view_conversation_constants","core_message/message_drawer_view_conversation_patcher","core_message/message_drawer_view_conversation_renderer","core_message/message_drawer_view_conversation_state_manager","core_message/message_drawer_router","core_message/message_drawer_routes"],function(s,e,t,n,d,a,i,r,o,g,l,m,c,E,I){var C={},u=null,_=!1,T=0,A=null,f=!1,h=[],M=!0,O=!1,N=[],v=null,S=[],p=g.NEWEST_MESSAGES_FIRST,b=g.LOAD_MESSAGE_LIMIT,U=g.MILLISECONDS_IN_SEC,L=g.SELECTORS,R=g.CONVERSATION_TYPES,D=function(){if(!u||u.type==R.PUBLIC){return null}var e=u.loggedInUserId;if(u.type==R.SELF){return e}var s=Object.keys(u.members).filter(function(s){return e!=s});return s.length?s[0]:null},y=function(e){return Object.keys(C).reduce(function(s,t){if(!s){var n=C[t].state;if(n.type!=R.PUBLIC){if(e in n.members){s=n.id}}}return s},null)},B=function(e){return{id:parseInt(e.attr("data-user-id"),10),fullname:null,profileimageurl:null,profileimageurlsmall:null,isonline:null,showonlinestatus:null,isblocked:null,iscontact:null,isdeleted:null,canmessage:null,requirescontact:null,contactrequests:[]}},F=function(){return T},P=function(e){T=e;C[u.id].messagesOffset=e},V=function(){return _},x=function(e){_=e;C[u.id].loadedAllMessages=e},w=function(e){return e.find(L.MESSAGES_CONTAINER)},k=function(e){return{id:e.id,name:e.name,subname:e.subname,imageUrl:e.imageUrl,isFavourite:e.isFavourite,isMuted:e.isMuted,type:e.type,totalMemberCount:e.totalMemberCount,loggedInUserId:e.loggedInUserId,messages:e.messages.map(function(e){return s.extend({},e)}),members:Object.keys(e.members).map(function(t){var n=s.extend({},e.members[t]);n.contactrequests=e.members[t].contactrequests.map(function(e){return s.extend({},e)});return n})}},G=function(e,s){var t=e.id,n=t==s?R.SELF:R.PRIVATE,a=c.setLoadingMembers(u,!0);a=c.setLoadingMessages(a,!0);v(a);return r.getMemberInfo(t,[s],!0,!0).then(function(e){if(e.length){return e[0]}else{throw new Error("Unable to load other user profile")}}).then(function(s){var t=n==R.SELF?[s]:[s,e],d=c.addMembers(u,t);d=c.setLoadingMembers(d,!1);d=c.setLoadingMessages(d,!1);d=c.setName(d,s.fullname);d=c.setType(d,n);d=c.setImageUrl(d,s.profileimageurl);d=c.setTotalMemberCount(d,t.length);v(d);return s}).catch(function(e){var s=c.setLoadingMembers(u,!1);v(s);d.exception(e)})},q=function(e,s){var t=null;if(e.type==R.PRIVATE){var n=e.members.filter(function(e){return e.id!=s});t=n.length?n[0]:null}else if(e.type==R.SELF){t=e.members[0]}var d=e.name,a=e.imageurl;if(e.type!=R.PUBLIC){d=d||t?t.fullname:"";a=a||t?t.profileimageurl:""}var i=c.addMembers(u,e.members);i=c.setName(i,d);i=c.setSubname(i,e.subname);i=c.setType(i,e.type);i=c.setImageUrl(i,a);i=c.setTotalMemberCount(i,e.membercount);i=c.setIsFavourite(i,e.isfavourite);i=c.setIsMuted(i,e.ismuted);i=c.addMessages(i,e.messages);i=c.setCanDeleteMessagesForAllUsers(i,e.candeletemessagesforallusers);return i},Q=function(e,s,t,n,a){var i=s.id,o=c.setLoadingMembers(u,!0);o=c.setLoadingMessages(o,!0);v(o);return r.getConversation(i,e,!0,!0,0,0,t+1,n,a).then(function(e){if(e.messages.length>t){e.messages=e.messages.slice(1)}else{x(!0)}P(n+t);return e}).then(function(e){var t=e.members.filter(function(e){return e.id==s.id});if(1>t.length){e.members=e.members.concat([s])}var n=q(e,s.id);n=c.setLoadingMembers(n,!1);n=c.setLoadingMessages(n,!1);return v(n).then(function(){return e})}).then(function(){return X(e)}).catch(function(e){var s=c.setLoadingMembers(u,!1);s=c.setLoadingMessages(s,!1);v(s);d.exception(e)})},W=function(e,s,t,n){var a=e.members.filter(function(e){return e.id==s.id});if(1>a.length){e.members=e.members.concat([s])}var i=e.messages.length,r=i>=t,o=q(e,s.id);o=c.setLoadingMembers(o,!1);o=c.setLoadingMessages(o,!r);var g=v(o);return g.then(function(){if(!r){return K(e.id,t,i,n,[])}else{return{messages:e.messages}}}).then(function(){var e=u.messages;P(e.length);X(u.id);return e}).catch(d.exception)},K=function(e,s,t,n,d,a){return r.getMessages(u.loggedInUserId,e,s?s+1:s,t,n,a).then(function(e){if(e.messages.length&&d.length){e.messages=e.messages.filter(function(e){return 0>d.indexOf(parseInt(e.id,10))})}return e}).then(function(e){if(!s){return e}else if(e.messages.length>s){e.messages=e.messages.slice(0,-1)}else{x(!0)}return e}).then(function(e){var s=e.members.filter(function(e){return!(e.id in u.members)}),t=c.addMembers(u,s);t=c.addMessages(t,e.messages);t=c.setLoadingMessages(t,!1);return v(t).then(function(){return e})}).catch(function(e){var s=c.setLoadingMessages(u,!1);v(s);throw e})},j=function(e,t){return function(){var n=u.messages,d=n.length?n[n.length-1]:null,r=d?d.timeCreated:null;if(r&&!M&&!O){for(var g=[],l=n.length-1,m;0<=l;l--){m=n[l];if(m.timeCreated===r){g.push(m.id)}else{break}}return K(e,0,0,t,g,r).then(function(s){if(s.messages.length){A.restart();var t=k(u);a.publish(o.CONVERSATION_NEW_LAST_MESSAGE,t);return X(e)}else{return s}})}return s.Deferred().resolve().promise()}},X=function(e){var s=u.loggedInUserId;return r.markAllConversationMessagesAsRead(s,e).then(function(){var s=c.markMessagesAsRead(u,u.messages);a.publish(o.CONVERSATION_READ,e);return v(s)})},Y=function(e){le(e);var s=c.addPendingBlockUsersById(u,[e]);v(s)},H=function(e){var s=c.setLoadingConfirmAction(u,!0);v(s);return r.blockUser(u.loggedInUserId,e).then(function(s){var t=c.addMembers(u,[s]);t=c.removePendingBlockUsersById(t,[e]);t=c.setLoadingConfirmAction(t,!1);a.publish(o.CONTACT_BLOCKED,e);return v(t)})},z=function(e){le(e);var s=c.addPendingUnblockUsersById(u,[e]);v(s)},J=function(e){var s=c.setLoadingConfirmAction(u,!0);v(s);return r.unblockUser(u.loggedInUserId,e).then(function(s){var t=c.addMembers(u,[s]);t=c.removePendingUnblockUsersById(t,[e]);t=c.setLoadingConfirmAction(t,!1);a.publish(o.CONTACT_UNBLOCKED,e);return v(t)})},Z=function(e){le(e);var s=c.addPendingRemoveContactsById(u,[e]);v(s)},$=function(e){var s=c.setLoadingConfirmAction(u,!0);v(s);return r.deleteContacts(u.loggedInUserId,[e]).then(function(s){var t=c.addMembers(u,s);t=c.removePendingRemoveContactsById(t,[e]);t=c.setLoadingConfirmAction(t,!1);a.publish(o.CONTACT_REMOVED,e);return v(t)})},ee=function(e){le(e);var s=c.addPendingAddContactsById(u,[e]);v(s)},se=function(e){var s=c.setLoadingConfirmAction(u,!0);v(s);return r.createContactRequest(u.loggedInUserId,e).then(function(e){if(!e.request){throw new Error(e.warnings[0].message)}return e.request}).then(function(s){var t=c.removePendingAddContactsById(u,[e]);t=c.addContactRequests(t,[s]);t=c.setLoadingConfirmAction(t,!1);return v(t)})},te=function(){var e=u.loggedInUserId,s=u.id;return r.setFavouriteConversations(e,[s]).then(function(){var e=c.setIsFavourite(u,!0);return v(e)}).then(function(){return a.publish(o.CONVERSATION_SET_FAVOURITE,k(u))})},ne=function(){var e=u.loggedInUserId,s=u.id;return r.unsetFavouriteConversations(e,[s]).then(function(){var e=c.setIsFavourite(u,!1);return v(e)}).then(function(){return a.publish(o.CONVERSATION_UNSET_FAVOURITE,k(u))})},de=function(){var e=u.loggedInUserId,s=u.id;return r.setMutedConversations(e,[s]).then(function(){var e=c.setIsMuted(u,!0);return v(e)}).then(function(){return a.publish(o.CONVERSATION_SET_MUTED,k(u))})},ae=function(){var e=u.loggedInUserId,s=u.id;return r.unsetMutedConversations(e,[s]).then(function(){var e=c.setIsMuted(u,!1);return v(e)}).then(function(){return a.publish(o.CONVERSATION_UNSET_MUTED,k(u))})},ie=function(e){var s=u.selectedMessageIds;le(e);var t=c.addPendingDeleteMessagesById(u,s);v(t)},re=function(){var e=u.pendingDeleteMessageIds,t=u.messages.filter(function(s){return 0<=e.indexOf(s.id)&&("sent"==s.sendState||null===s.sendState)}),n=c.setLoadingConfirmAction(u,!0);v(n);var i=s.Deferred().resolve().promise();if(t.length){var g=t.map(function(e){return e.id});if(n.deleteMessagesForAllUsers){i=r.deleteMessagesForAllUsers(u.loggedInUserId,g)}else{i=r.deleteMessages(u.loggedInUserId,g)}}return i.then(function(){var s=c.removeMessagesById(u,e);s=c.removePendingDeleteMessagesById(s,e);s=c.removeSelectedMessagesById(s,e);s=c.setLoadingConfirmAction(s,!1);s=c.setDeleteMessagesForAllUsers(s,!1);var t=u.messages[u.messages.length-1],n=s.messages.length?s.messages[s.messages.length-1]:null;if(n&&n.id!=t.id){var d=k(s);a.publish(o.CONVERSATION_NEW_LAST_MESSAGE,d)}else if(!s.messages.length){a.publish(o.CONVERSATION_DELETED,s.id)}return v(s)}).catch(d.exception)},oe=function(e){le(e);var s=c.setPendingDeleteConversation(u,!0);v(s)},ge=function(){var e=c.setLoadingConfirmAction(u,!0);v(e);return r.deleteConversation(u.loggedInUserId,u.id).then(function(){var e=c.removeMessages(u,u.messages);e=c.removeSelectedMessagesById(e,u.selectedMessageIds);e=c.setPendingDeleteConversation(e,!1);e=c.setLoadingConfirmAction(e,!1);a.publish(o.CONVERSATION_DELETED,e.id);return v(e)})},le=function(e){var s=u.pendingDeleteMessageIds,t=c.removePendingAddContactsById(u,[e]);t=c.removePendingRemoveContactsById(t,[e]);t=c.removePendingUnblockUsersById(t,[e]);t=c.removePendingBlockUsersById(t,[e]);t=c.removePendingDeleteMessagesById(t,s);t=c.setPendingDeleteConversation(t,!1);t=c.setDeleteMessagesForAllUsers(t,!1);v(t)},me=function(e){var s=u.loggedInUserId,t=u.members[e].contactrequests.filter(function(e){return e.requesteduserid==s}),n=t[0],d=c.setLoadingConfirmAction(u,!0);v(d);return r.acceptContactRequest(e,s).then(function(e){var s=c.removeContactRequests(u,[n]);s=c.addMembers(u,[e]);s=c.setLoadingConfirmAction(s,!1);return v(s)}).then(function(){a.publish(o.CONTACT_ADDED,u.members[e]);a.publish(o.CONTACT_REQUEST_ACCEPTED,n)})},ce=function(e){var s=u.loggedInUserId,t=u.members[e].contactrequests.filter(function(e){return e.requesteduserid==s}),n=t[0],d=c.setLoadingConfirmAction(u,!0);v(d);return r.declineContactRequest(e,s).then(function(e){var s=c.removeContactRequests(u,[n]);s=c.addMembers(u,[e]);s=c.setLoadingConfirmAction(s,!1);return v(s)}).then(function(){a.publish(o.CONTACT_REQUEST_DECLINED,n)})},Ee=function(){if(O){return}if(!N.length){return}O=!0;var e=N.slice();N=[];var t=u.id,n=null,d=e.map(function(e){return e.text}),g=e.map(function(e){return e.id}),l=null,m=null;if(!t&&u.type!=R.PUBLIC){var E=D();l=r.sendMessagesToUser(E,d).then(function(e){if(e.length){n=parseInt(e[0].conversationid,10);m=e[0].candeletemessagesforallusers}return e})}else{l=r.sendMessagesToConversation(t,d)}l.then(function(s){var t=s.map(function(e){return e.id}),d=[],i=[],r=[];e.forEach(function(e,t){var n=s[t];d.push([e,n]);if(0<=u.selectedMessageIds.indexOf(e.id)){i.push(e.id);r.push(n.id)}});var g=c.updateMessages(u,d);g=c.setMessagesSendSuccessById(g,t);if(i.length){g=c.removeSelectedMessagesById(g,i)}if(r.length){g=c.addSelectedMessagesById(g,r)}var l=k(g);if(!g.id){g=c.setId(g,n);l.id=n;ye(n);a.publish(o.CONVERSATION_CREATED,l);g=c.setCanDeleteMessagesForAllUsers(g,m)}v(g);O=!1;Ee();a.publish(o.CONVERSATION_NEW_LAST_MESSAGE,l)}).catch(function(t){if(t.message){var e=s.Deferred().resolve(t.message).promise()}else{var e=i.get_string("unknownerror","core")}var n=function(e){var s=c.setMessagesSendFailById(u,g,e);v(s);O=!1;Ee()};e.then(n).catch(function(s){var e=s.message||"Something went wrong!";n(e)})})},Ie=function(e){var s="temp"+Date.now(),t={id:s,useridfrom:u.loggedInUserId,text:e,timecreated:null},n=c.addMessages(u,[t]);v(n);N.push(t);Ee()},Ce=function(e){var s=c.setMessagesSendPendingById(u,[e.id]);v(s);N.push(e);Ee()},ue=function(e){var s=u;if(-1<u.selectedMessageIds.indexOf(e)){s=c.removeSelectedMessagesById(u,[e])}else{s=c.addSelectedMessagesById(u,[e])}v(s)},_e=function(){le(D());var e=c.removeSelectedMessagesById(u,u.selectedMessageIds);v(e)},Te=function(e,t,n){if(f){return}if(!h.length){return}f=!0;var a=h.shift(),i=S.map(function(e){return e(a.patch)});s.when.apply(null,i).then(function(){f=!1;a.deferred.resolve(!0);Te(e,t,n)}).catch(function(e){f=!1;a.deferred.reject(e);d.exception(e)})},Ae=function(e,t,n,d){var a=function(s){return m.render(e,t,n,s)};if(!d){var i=c.buildInitialState(u.midnight,u.loggedInUserId,u.id),r=l.buildPatch(i,u);a(r)}S.push(a);return function(d){var a=l.buildPatch(u,d),i=s.Deferred();if(Object.keys(a).length){h.push({patch:a,deferred:i})}else{i.resolve(!0)}u=d;if(d.id){C[d.id]={state:d,messagesOffset:F(),loadedAllMessages:V()}}Te(e,t,n);return i.promise()}},fe=function(e){return function(s,t){if(!u.loadingConfirmAction){e(D());var n=c.setLoadingConfirmAction(u,!1);v(n)}t.originalEvent.preventDefault()}},he=function(t,e){var n=s(t.target),d=n.closest(L.FOOTER_CONTAINER),a=d.find(L.MESSAGE_TEXT_AREA),i=a.val().trim();if(""!==i){Ie(i);a.val("");a.focus()}e.originalEvent.preventDefault()},Me=function(t,e){var n=window.getSelection(),d=s(t.target);if(""!=n.toString()){return}if(d.is("a")){return}var a=d.closest(L.MESSAGE),i=a.attr("data-message-id");ue(i);e.originalEvent.preventDefault()},Oe=function(t,e){var n=s(t.target),d=n.closest(L.MESSAGE),a=d.attr("data-message-id"),i=u.messages.filter(function(e){return e.id==a}),r=i.length?i[0]:null;if(r){Ce(r)}e.originalEvent.preventDefault();e.originalEvent.stopPropagation();t.stopPropagation()},Ne=function(s,e){_e();e.originalEvent.preventDefault()},ve=function(s){return function(t,e){var n=D(),d=u.members[n];E.go(s,I.VIEW_CONTACT,d);e.originalEvent.preventDefault()}},Se=function(s,e){te().catch(d.exception);e.originalEvent.preventDefault()},pe=function(s,e){ne().catch(d.exception);e.originalEvent.preventDefault()},be=function(s,e){de().catch(d.exception);e.originalEvent.preventDefault()},Ue=function(s,e){ae().catch(d.exception);e.originalEvent.preventDefault()},Le=function(t){var e=s(t.target).prop("checked"),n=c.setDeleteMessagesForAllUsers(u,e);v(n)},Re=function(s){return function(t,e){E.go(s,I.VIEW_GROUP_INFO,{id:u.id,name:u.name,subname:u.subname,imageUrl:u.imageUrl,totalMemberCount:u.totalMemberCount},u.loggedInUserId);e.originalEvent.preventDefault()}},De=function(s,t,i,r){var g=!1,l=w(i),m=[[L.ACTION_REQUEST_BLOCK,fe(Y)],[L.ACTION_REQUEST_UNBLOCK,fe(z)],[L.ACTION_REQUEST_ADD_CONTACT,fe(ee)],[L.ACTION_REQUEST_REMOVE_CONTACT,fe(Z)],[L.ACTION_REQUEST_DELETE_CONVERSATION,fe(oe)],[L.ACTION_CANCEL_EDIT_MODE,Ne],[L.ACTION_VIEW_CONTACT,ve(s)],[L.ACTION_VIEW_GROUP_INFO,Re(s)],[L.ACTION_CONFIRM_FAVOURITE,Se],[L.ACTION_CONFIRM_MUTE,be],[L.ACTION_CONFIRM_UNFAVOURITE,pe],[L.ACTION_CONFIRM_UNMUTE,Ue]],E=[[L.ACTION_CANCEL_CONFIRM,fe(le)],[L.ACTION_CONFIRM_BLOCK,fe(H)],[L.ACTION_CONFIRM_UNBLOCK,fe(J)],[L.ACTION_CONFIRM_ADD_CONTACT,fe(se)],[L.ACTION_CONFIRM_REMOVE_CONTACT,fe($)],[L.ACTION_CONFIRM_DELETE_SELECTED_MESSAGES,fe(re)],[L.ACTION_CONFIRM_DELETE_CONVERSATION,fe(ge)],[L.ACTION_REQUEST_ADD_CONTACT,fe(ee)],[L.ACTION_ACCEPT_CONTACT_REQUEST,fe(me)],[L.ACTION_DECLINE_CONTACT_REQUEST,fe(ce)],[L.MESSAGE,Me],[L.DELETE_MESSAGES_FOR_ALL_USERS_TOGGLE,Le],[L.RETRY_SEND,Oe]],C=[[L.SEND_MESSAGE_BUTTON,he],[L.ACTION_REQUEST_DELETE_SELECTED_MESSAGES,fe(ie)],[L.ACTION_REQUEST_ADD_CONTACT,fe(ee)],[L.ACTION_REQUEST_UNBLOCK,fe(z)]];e.init(r);n.define(t,[n.events.activate]);n.define(i,[n.events.activate]);n.define(r,[n.events.activate,n.events.enter]);n.define(l,[n.events.scrollTop,n.events.scrollLock]);l.on(n.events.scrollTop,function(s,e){var t=1<Object.keys(u.members).length;if(!M&&!g&&!V()&&t){g=!0;var n=c.setLoadingMessages(u,!0);v(n);K(u.id,b,F(),p,[]).then(function(){g=!1;P(F()+b)}).catch(function(e){g=!1;d.exception(e)})}e.originalEvent.preventDefault()});m.forEach(function(e){var s=e[0],d=e[1];t.on(n.events.activate,s,d)});E.forEach(function(e){var s=e[0],t=e[1];i.on(n.events.activate,s,t)});C.forEach(function(e){var s=e[0],t=e[1];r.on(n.events.activate,s,t)});r.on(n.events.enter,L.MESSAGE_TEXT_AREA,function(s,e){var t=r.attr("data-enter-to-send");if(t&&"false"!=t&&"0"!=t){he(s,e)}});a.subscribe(o.ROUTE_CHANGED,function(e){if(A){if(e.route!=I.VIEW_CONVERSATION){A.stop()}}})},ye=function(e){if(A){A.stop()}A=new t(j(e,p),t.getIncrementalCallback(u.messagePollMin*U,U,u.messagePollMax*U,u.messagePollAfterMax*U));A.start()},Be=function(e,s,t){_=!1;T=0;A=null;f=!1;h=[];M=!0;O=!1;N=[];var n=t.id,d=parseInt(e.attr("data-midnight"),10),a=parseInt(e.attr("data-message-poll-min"),10),i=parseInt(e.attr("data-message-poll-max"),10),r=parseInt(e.attr("data-message-poll-after-max"),10),o=c.buildInitialState(d,n,s,a,i,r);if(!u){u=o}if(A){A.stop()}v(o)},Fe=function(e,s,t){Be(e,null,s);var n=null;if(s.id!=t){n=r.getConversationBetweenUsers(s.id,t,!0,!0,0,0,b,0,p)}else{n=r.getSelfConversation(s.id,b,0,p)}return n.then(function(t){return Ve(e,t,s)}).catch(function(){return G(s,t)})},Pe=function(e,t,n){var d=null;if(t in C){d=C[t]}Be(e,t,n);var a=s.Deferred().resolve({}).promise();if(d){var i=d.state;i=c.setLoadingMessages(i,!1);i=c.setLoadingMembers(i,!1);P(d.messagesOffset);x(d.loadedAllMessages);v(i)}else{a=Q(t,n,b,0,p)}return a.then(function(){return ye(t)})},Ve=function(e,t,n){var d=null;if(t.id in C){d=C[t.id]}Be(e,t.id,n);var a=s.Deferred().resolve({}).promise();if(d){var i=d.state;i=c.setLoadingMessages(i,!1);i=c.setLoadingMembers(i,!1);P(d.messagesOffset);x(d.loadedAllMessages);v(i)}else{a=W(t,n,b,p)}return a.then(function(){return ye(t.id)})},xe=function(e,t,n,a,i,r,o){var l=null,m=null;if(i&&null!==i&&"object"==_typeof(i)){l=i;m=parseInt(l.id,10)}else{l=null;m=parseInt(i,10);m=isNaN(m)?null:m}if(!m&&r&&o){m=y(o)}var c=!u||u.id!=m||o&&o!=D();if(!n.attr("data-init")){v=Ae(t,n,a,c);De(e,t,n,a);n.attr("data-init",!0)}if(c){var E=null,I=B(n);if(l){E=Ve(n,l,I,o)}else if(m){E=Pe(n,m,I,o)}else{E=Fe(n,I,o)}return E.then(function(){M=!1;t.find(g.SELECTORS.CAN_RECEIVE_FOCUS).first().focus()}).catch(function(e){M=!1;d.exception(e)})}ye(m);if(u.type==R.PRIVATE&&r){var C=D();switch(r){case"block":return Y(C);case"unblock":return z(C);case"add-contact":return ee(C);case"remove-contact":return Z(C);}}return s.Deferred().resolve().promise()},we=function(){return i.get_string("messagedrawerviewconversation","core_message",u.name)};return{show:xe,description:we}});
//# sourceMappingURL=message_drawer_view_conversation.min.js.map
