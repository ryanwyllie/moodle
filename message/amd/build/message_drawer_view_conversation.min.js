function _typeof(e){if("function"==typeof Symbol&&"symbol"==typeof Symbol.iterator){_typeof=function(e){return typeof e}}else{_typeof=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e}}return _typeof(e)}define ("core_message/message_drawer_view_conversation",["jquery","core/auto_rows","core/backoff_timer","core/custom_interaction_events","core/notification","core/pubsub","core/str","core_message/message_repository","core_message/message_drawer_events","core_message/message_drawer_view_conversation_constants","core_message/message_drawer_view_conversation_patcher","core_message/message_drawer_view_conversation_renderer","core_message/message_drawer_view_conversation_state_manager","core_message/message_drawer_router","core_message/message_drawer_routes"],function(s,e,t,n,a,d,i,r,o,g,l,m,c,E,C){var I={},_=null,u=!1,T=0,A=null,f=!1,O=[],M=!0,h=!1,N=null,v=[],S=g.NEWEST_MESSAGES_FIRST,p=g.LOAD_MESSAGE_LIMIT,b=g.MILLISECONDS_IN_SEC,U=g.SELECTORS,L=g.CONVERSATION_TYPES,R=function(){if(!_||_.type==L.PUBLIC){return null}var e=_.loggedInUserId;if(_.type==L.SELF){return e}var s=Object.keys(_.members).filter(function(s){return e!=s});return s.length?s[0]:null},D=function(e){return Object.keys(I).reduce(function(s,t){if(!s){var n=I[t].state;if(n.type!=L.PUBLIC){if(e in n.members){s=n.id}}}return s},null)},y=function(e){return{id:parseInt(e.attr("data-user-id"),10),fullname:null,profileimageurl:null,profileimageurlsmall:null,isonline:null,showonlinestatus:null,isblocked:null,iscontact:null,isdeleted:null,canmessage:null,requirescontact:null,contactrequests:[]}},F=function(){return T},B=function(e){T=e;I[_.id].messagesOffset=e},P=function(){return u},V=function(e){u=e;I[_.id].loadedAllMessages=e},k=function(e){return e.find(U.MESSAGES_CONTAINER)},w=function(e){return{id:e.id,name:e.name,subname:e.subname,imageUrl:e.imageUrl,isFavourite:e.isFavourite,isMuted:e.isMuted,type:e.type,totalMemberCount:e.totalMemberCount,loggedInUserId:e.loggedInUserId,messages:e.messages.map(function(e){return s.extend({},e)}),members:Object.keys(e.members).map(function(t){var n=s.extend({},e.members[t]);n.contactrequests=e.members[t].contactrequests.map(function(e){return s.extend({},e)});return n})}},x=function(e,s){var t=e.id,n=t==s?L.SELF:L.PRIVATE,d=c.setLoadingMembers(_,!0);d=c.setLoadingMessages(d,!0);N(d);return r.getMemberInfo(t,[s],!0,!0).then(function(e){if(e.length){return e[0]}else{throw new Error("Unable to load other user profile")}}).then(function(s){var t=n==L.SELF?[s]:[s,e],a=c.addMembers(_,t);a=c.setLoadingMembers(a,!1);a=c.setLoadingMessages(a,!1);a=c.setName(a,s.fullname);a=c.setType(a,n);a=c.setImageUrl(a,s.profileimageurl);a=c.setTotalMemberCount(a,t.length);N(a);return s}).catch(function(e){var s=c.setLoadingMembers(_,!1);N(s);a.exception(e)})},G=function(e,s){var t=null;if(e.type==L.PRIVATE){var n=e.members.filter(function(e){return e.id!=s});t=n.length?n[0]:null}else if(e.type==L.SELF){t=e.members[0]}var a=e.name,d=e.imageurl;if(e.type!=L.PUBLIC){a=a||t?t.fullname:"";d=d||t?t.profileimageurl:""}var i=c.addMembers(_,e.members);i=c.setName(i,a);i=c.setSubname(i,e.subname);i=c.setType(i,e.type);i=c.setImageUrl(i,d);i=c.setTotalMemberCount(i,e.membercount);i=c.setIsFavourite(i,e.isfavourite);i=c.setIsMuted(i,e.ismuted);i=c.addMessages(i,e.messages);i=c.setCanDeleteMessagesForAllUsers(i,e.candeletemessagesforallusers);return i},q=function(e,s,t,n,d){var i=s.id,o=c.setLoadingMembers(_,!0);o=c.setLoadingMessages(o,!0);N(o);return r.getConversation(i,e,!0,!0,0,0,t+1,n,d).then(function(e){if(e.messages.length>t){e.messages=e.messages.slice(1)}else{V(!0)}B(n+t);return e}).then(function(e){var t=e.members.filter(function(e){return e.id==s.id});if(1>t.length){e.members=e.members.concat([s])}var n=G(e,s.id);n=c.setLoadingMembers(n,!1);n=c.setLoadingMessages(n,!1);return N(n).then(function(){return e})}).then(function(){return j(e)}).catch(function(e){var s=c.setLoadingMembers(_,!1);s=c.setLoadingMessages(s,!1);N(s);a.exception(e)})},Q=function(e,s,t,n){var d=e.members.filter(function(e){return e.id==s.id});if(1>d.length){e.members=e.members.concat([s])}var i=e.messages.length,r=i>=t,o=G(e,s.id);o=c.setLoadingMembers(o,!1);o=c.setLoadingMessages(o,!r);var g=N(o);return g.then(function(){if(!r){return W(e.id,t,i,n,[])}else{return{messages:e.messages}}}).then(function(){var e=_.messages;B(e.length);j(_.id);return e}).catch(a.exception)},W=function(e,s,t,n,a,d){return r.getMessages(_.loggedInUserId,e,s?s+1:s,t,n,d).then(function(e){if(e.messages.length&&a.length){e.messages=e.messages.filter(function(e){return 0>a.indexOf(parseInt(e.id,10))})}return e}).then(function(e){if(!s){return e}else if(e.messages.length>s){e.messages=e.messages.slice(0,-1)}else{V(!0)}return e}).then(function(e){var s=e.members.filter(function(e){return!(e.id in _.members)}),t=c.addMembers(_,s);t=c.addMessages(t,e.messages);t=c.setLoadingMessages(t,!1);return N(t).then(function(){return e})}).catch(function(e){var s=c.setLoadingMessages(_,!1);N(s);throw e})},K=function(e,t){return function(){var n=_.messages,a=n.length?n[n.length-1]:null;if(a&&!M&&!h){for(var r=[],g=n.length-1,l;0<=g;g--){l=n[g];if(l.timeCreated===a.timeCreated){r.push(l.id)}else{break}}return W(e,0,0,t,r,a.timeCreated).then(function(s){if(s.messages.length){A.restart();var t=w(_);d.publish(o.CONVERSATION_NEW_LAST_MESSAGE,t);return j(e)}else{return s}})}return s.Deferred().resolve().promise()}},j=function(e){var s=_.loggedInUserId;return r.markAllConversationMessagesAsRead(s,e).then(function(){var s=c.markMessagesAsRead(_,_.messages);d.publish(o.CONVERSATION_READ,e);return N(s)})},X=function(e){ge(e);var s=c.addPendingBlockUsersById(_,[e]);N(s)},H=function(e){var s=c.setLoadingConfirmAction(_,!0);N(s);return r.blockUser(_.loggedInUserId,e).then(function(s){var t=c.addMembers(_,[s]);t=c.removePendingBlockUsersById(t,[e]);t=c.setLoadingConfirmAction(t,!1);d.publish(o.CONTACT_BLOCKED,e);return N(t)})},Y=function(e){ge(e);var s=c.addPendingUnblockUsersById(_,[e]);N(s)},z=function(e){var s=c.setLoadingConfirmAction(_,!0);N(s);return r.unblockUser(_.loggedInUserId,e).then(function(s){var t=c.addMembers(_,[s]);t=c.removePendingUnblockUsersById(t,[e]);t=c.setLoadingConfirmAction(t,!1);d.publish(o.CONTACT_UNBLOCKED,e);return N(t)})},Z=function(e){ge(e);var s=c.addPendingRemoveContactsById(_,[e]);N(s)},$=function(e){var s=c.setLoadingConfirmAction(_,!0);N(s);return r.deleteContacts(_.loggedInUserId,[e]).then(function(s){var t=c.addMembers(_,s);t=c.removePendingRemoveContactsById(t,[e]);t=c.setLoadingConfirmAction(t,!1);d.publish(o.CONTACT_REMOVED,e);return N(t)})},J=function(e){ge(e);var s=c.addPendingAddContactsById(_,[e]);N(s)},ee=function(e){var s=c.setLoadingConfirmAction(_,!0);N(s);return r.createContactRequest(_.loggedInUserId,e).then(function(e){if(!e.request){throw new Error(e.warnings[0].message)}return e.request}).then(function(s){var t=c.removePendingAddContactsById(_,[e]);t=c.addContactRequests(t,[s]);t=c.setLoadingConfirmAction(t,!1);return N(t)})},se=function(){var e=_.loggedInUserId,s=_.id;return r.setFavouriteConversations(e,[s]).then(function(){var e=c.setIsFavourite(_,!0);return N(e)}).then(function(){return d.publish(o.CONVERSATION_SET_FAVOURITE,w(_))})},te=function(){var e=_.loggedInUserId,s=_.id;return r.unsetFavouriteConversations(e,[s]).then(function(){var e=c.setIsFavourite(_,!1);return N(e)}).then(function(){return d.publish(o.CONVERSATION_UNSET_FAVOURITE,w(_))})},ne=function(){var e=_.loggedInUserId,s=_.id;return r.setMutedConversations(e,[s]).then(function(){var e=c.setIsMuted(_,!0);return N(e)}).then(function(){return d.publish(o.CONVERSATION_SET_MUTED,w(_))})},ae=function(){var e=_.loggedInUserId,s=_.id;return r.unsetMutedConversations(e,[s]).then(function(){var e=c.setIsMuted(_,!1);return N(e)}).then(function(){return d.publish(o.CONVERSATION_UNSET_MUTED,w(_))})},de=function(e){var s=_.selectedMessageIds;ge(e);var t=c.addPendingDeleteMessagesById(_,s);N(t)},ie=function(){var e=_.pendingDeleteMessageIds,s=c.setLoadingConfirmAction(_,!0);N(s);var t=null;if(s.deleteMessagesForAllUsers){t=r.deleteMessagesForAllUsers(_.loggedInUserId,e)}else{t=r.deleteMessages(_.loggedInUserId,e)}return t.then(function(){var s=c.removeMessagesById(_,e);s=c.removePendingDeleteMessagesById(s,e);s=c.removeSelectedMessagesById(s,e);s=c.setLoadingConfirmAction(s,!1);s=c.setDeleteMessagesForAllUsers(s,!1);var t=_.messages[_.messages.length-1],n=s.messages.length?s.messages[s.messages.length-1]:null;if(n&&n.id!=t.id){var a=w(s);d.publish(o.CONVERSATION_NEW_LAST_MESSAGE,a)}else if(!s.messages.length){d.publish(o.CONVERSATION_DELETED,s.id)}return N(s)})},re=function(e){ge(e);var s=c.setPendingDeleteConversation(_,!0);N(s)},oe=function(){var e=c.setLoadingConfirmAction(_,!0);N(e);return r.deleteConversation(_.loggedInUserId,_.id).then(function(){var e=c.removeMessages(_,_.messages);e=c.removeSelectedMessagesById(e,_.selectedMessageIds);e=c.setPendingDeleteConversation(e,!1);e=c.setLoadingConfirmAction(e,!1);d.publish(o.CONVERSATION_DELETED,e.id);return N(e)})},ge=function(e){var s=_.pendingDeleteMessageIds,t=c.removePendingAddContactsById(_,[e]);t=c.removePendingRemoveContactsById(t,[e]);t=c.removePendingUnblockUsersById(t,[e]);t=c.removePendingBlockUsersById(t,[e]);t=c.removePendingDeleteMessagesById(t,s);t=c.setPendingDeleteConversation(t,!1);t=c.setDeleteMessagesForAllUsers(t,!1);N(t)},le=function(e){var s=_.loggedInUserId,t=_.members[e].contactrequests.filter(function(e){return e.requesteduserid==s}),n=t[0],a=c.setLoadingConfirmAction(_,!0);N(a);return r.acceptContactRequest(e,s).then(function(e){var s=c.removeContactRequests(_,[n]);s=c.addMembers(_,[e]);s=c.setLoadingConfirmAction(s,!1);return N(s)}).then(function(){d.publish(o.CONTACT_ADDED,_.members[e]);d.publish(o.CONTACT_REQUEST_ACCEPTED,n)})},me=function(e){var s=_.loggedInUserId,t=_.members[e].contactrequests.filter(function(e){return e.requesteduserid==s}),n=t[0],a=c.setLoadingConfirmAction(_,!0);N(a);return r.declineContactRequest(e,s).then(function(e){var s=c.removeContactRequests(_,[n]);s=c.addMembers(_,[e]);s=c.setLoadingConfirmAction(s,!1);return N(s)}).then(function(){d.publish(o.CONTACT_REQUEST_DECLINED,n)})},ce=function(e,s){h=!0;var t=c.setSendingMessage(_,!0),n=null;N(t);var i=null,g=null;if(!e&&_.type!=L.PUBLIC){var l=R();i=r.sendMessageToUser(l,s).then(function(e){n=parseInt(e.conversationid,10);g=e.candeletemessagesforallusers;return e})}else{i=r.sendMessageToConversation(e,s)}i.then(function(e){var s=c.addMessages(_,[e]);s=c.setSendingMessage(s,!1);var t=w(s);if(!s.id){s=c.setId(s,n);t.id=n;Ue(n);d.publish(o.CONVERSATION_CREATED,t);s=c.setCanDeleteMessagesForAllUsers(s,g)}N(s);h=!1;d.publish(o.CONVERSATION_NEW_LAST_MESSAGE,t)}).catch(function(e){h=!1;var s=c.setSendingMessage(_,!1);N(s);a.exception(e)})},Ee=function(e){var s=_;if(-1<_.selectedMessageIds.indexOf(e)){s=c.removeSelectedMessagesById(_,[e])}else{s=c.addSelectedMessagesById(_,[e])}N(s)},Ce=function(){ge(R());var e=c.removeSelectedMessagesById(_,_.selectedMessageIds);N(e)},Ie=function(e,t,n){if(f){return}if(!O.length){return}f=!0;var d=O.shift(),i=v.map(function(e){return e(d.patch)});s.when.apply(null,i).then(function(){f=!1;d.deferred.resolve(!0);Ie(e,t,n)}).catch(function(e){f=!1;d.deferred.reject(e);a.exception(e)})},_e=function(e,t,n,a){var d=function(s){return m.render(e,t,n,s)};if(!a){var i=c.buildInitialState(_.midnight,_.loggedInUserId,_.id),r=l.buildPatch(i,_);d(r)}v.push(d);return function(a){var d=l.buildPatch(_,a),i=s.Deferred();if(Object.keys(d).length){O.push({patch:d,deferred:i})}else{i.resolve(!0)}_=a;if(a.id){I[a.id]={state:a,messagesOffset:F(),loadedAllMessages:P()}}Ie(e,t,n);return i.promise()}},ue=function(e){return function(s,t){if(!_.loadingConfirmAction){e(R());var n=c.setLoadingConfirmAction(_,!1);N(n)}t.originalEvent.preventDefault()}},Te=function(t,e){var n=s(t.target),a=n.closest(U.FOOTER_CONTAINER),d=a.find(U.MESSAGE_TEXT_AREA),i=d.val().trim();if(""!==i){ce(_.id,i)}e.originalEvent.preventDefault()},Ae=function(t,e){var n=window.getSelection(),a=s(t.target);if(""!=n.toString()){return}if(a.is("a")){return}var d=a.closest(U.MESSAGE),i=parseInt(d.attr("data-message-id"),10);Ee(i);e.originalEvent.preventDefault()},fe=function(s,e){Ce();e.originalEvent.preventDefault()},Oe=function(s){return function(t,e){var n=R(),a=_.members[n];E.go(s,C.VIEW_CONTACT,a);e.originalEvent.preventDefault()}},Me=function(s,e){se().catch(a.exception);e.originalEvent.preventDefault()},he=function(s,e){te().catch(a.exception);e.originalEvent.preventDefault()},Ne=function(s,e){ne().catch(a.exception);e.originalEvent.preventDefault()},ve=function(s,e){ae().catch(a.exception);e.originalEvent.preventDefault()},Se=function(t){var e=s(t.target).prop("checked"),n=c.setDeleteMessagesForAllUsers(_,e);N(n)},pe=function(s){return function(t,e){E.go(s,C.VIEW_GROUP_INFO,{id:_.id,name:_.name,subname:_.subname,imageUrl:_.imageUrl,totalMemberCount:_.totalMemberCount},_.loggedInUserId);e.originalEvent.preventDefault()}},be=function(s,t,i,r){var g=!1,l=k(i),m=[[U.ACTION_REQUEST_BLOCK,ue(X)],[U.ACTION_REQUEST_UNBLOCK,ue(Y)],[U.ACTION_REQUEST_ADD_CONTACT,ue(J)],[U.ACTION_REQUEST_REMOVE_CONTACT,ue(Z)],[U.ACTION_REQUEST_DELETE_CONVERSATION,ue(re)],[U.ACTION_CANCEL_EDIT_MODE,fe],[U.ACTION_VIEW_CONTACT,Oe(s)],[U.ACTION_VIEW_GROUP_INFO,pe(s)],[U.ACTION_CONFIRM_FAVOURITE,Me],[U.ACTION_CONFIRM_MUTE,Ne],[U.ACTION_CONFIRM_UNFAVOURITE,he],[U.ACTION_CONFIRM_UNMUTE,ve]],E=[[U.ACTION_CANCEL_CONFIRM,ue(ge)],[U.ACTION_CONFIRM_BLOCK,ue(H)],[U.ACTION_CONFIRM_UNBLOCK,ue(z)],[U.ACTION_CONFIRM_ADD_CONTACT,ue(ee)],[U.ACTION_CONFIRM_REMOVE_CONTACT,ue($)],[U.ACTION_CONFIRM_DELETE_SELECTED_MESSAGES,ue(ie)],[U.ACTION_CONFIRM_DELETE_CONVERSATION,ue(oe)],[U.ACTION_REQUEST_ADD_CONTACT,ue(J)],[U.ACTION_ACCEPT_CONTACT_REQUEST,ue(le)],[U.ACTION_DECLINE_CONTACT_REQUEST,ue(me)],[U.MESSAGE,Ae],[U.DELETE_MESSAGES_FOR_ALL_USERS_TOGGLE,Se]],I=[[U.SEND_MESSAGE_BUTTON,Te],[U.ACTION_REQUEST_DELETE_SELECTED_MESSAGES,ue(de)],[U.ACTION_REQUEST_ADD_CONTACT,ue(J)],[U.ACTION_REQUEST_UNBLOCK,ue(Y)]];e.init(r);n.define(t,[n.events.activate]);n.define(i,[n.events.activate]);n.define(r,[n.events.activate,n.events.enter]);n.define(l,[n.events.scrollTop,n.events.scrollLock]);l.on(n.events.scrollTop,function(s,e){var t=1<Object.keys(_.members).length;if(!M&&!g&&!P()&&t){g=!0;var n=c.setLoadingMessages(_,!0);N(n);W(_.id,p,F(),S,[]).then(function(){g=!1;B(F()+p)}).catch(function(e){g=!1;a.exception(e)})}e.originalEvent.preventDefault()});m.forEach(function(e){var s=e[0],a=e[1];t.on(n.events.activate,s,a)});E.forEach(function(e){var s=e[0],t=e[1];i.on(n.events.activate,s,t)});I.forEach(function(e){var s=e[0],t=e[1];r.on(n.events.activate,s,t)});r.on(n.events.enter,U.MESSAGE_TEXT_AREA,function(s,e){var t=r.attr("data-enter-to-send");if(t&&"false"!=t&&"0"!=t){Te(s,e)}});d.subscribe(o.ROUTE_CHANGED,function(e){if(A){if(e.route!=C.VIEW_CONVERSATION){A.stop()}}})},Ue=function(e){if(A){A.stop()}A=new t(K(e,S),t.getIncrementalCallback(_.messagePollMin*b,b,_.messagePollMax*b,_.messagePollAfterMax*b));A.start()},Le=function(e,s,t){M=!0;f=!1;O=[];h=!1;var n=t.id,a=parseInt(e.attr("data-midnight"),10),d=parseInt(e.attr("data-message-poll-min"),10),i=parseInt(e.attr("data-message-poll-max"),10),r=parseInt(e.attr("data-message-poll-after-max"),10),o=c.buildInitialState(a,n,s,d,i,r);if(!_){_=o}if(A){A.stop()}N(o)},Re=function(e,s,t){Le(e,null,s);var n=null;if(s.id!=t){n=r.getConversationBetweenUsers(s.id,t,!0,!0,0,0,p,0,S)}else{n=r.getSelfConversation(s.id,p,0,S)}return n.then(function(t){return ye(e,t,s)}).catch(function(){return x(s,t)})},De=function(e,t,n){var a=null;if(t in I){a=I[t]}Le(e,t,n);var d=s.Deferred().resolve({}).promise();if(a){var i=a.state;i=c.setLoadingMessages(i,!1);i=c.setLoadingMembers(i,!1);B(a.messagesOffset);V(a.loadedAllMessages);N(i)}else{d=q(t,n,p,0,S)}return d.then(function(){return Ue(t)})},ye=function(e,t,n){var a=null;if(t.id in I){a=I[t.id]}Le(e,t.id,n);var d=s.Deferred().resolve({}).promise();if(a){var i=a.state;i=c.setLoadingMessages(i,!1);i=c.setLoadingMembers(i,!1);B(a.messagesOffset);V(a.loadedAllMessages);N(i)}else{d=Q(t,n,p,S)}return d.then(function(){return Ue(t.id)})},Fe=function(e,t,n,d,i,r,o){var l=null,m=null;if(i&&null!==i&&"object"==_typeof(i)){l=i;m=parseInt(l.id,10)}else{l=null;m=parseInt(i,10);m=isNaN(m)?null:m}if(!m&&r&&o){m=D(o)}var c=!_||_.id!=m||o&&o!=R();if(!n.attr("data-init")){N=_e(t,n,d,c);be(e,t,n,d);n.attr("data-init",!0)}if(c){var E=null,C=y(n);if(l){E=ye(n,l,C,o)}else if(m){E=De(n,m,C,o)}else{E=Re(n,C,o)}return E.then(function(){M=!1;t.find(g.SELECTORS.CAN_RECEIVE_FOCUS).first().focus()}).catch(function(e){M=!1;a.exception(e)})}Ue(m);if(_.type==L.PRIVATE&&r){var I=R();switch(r){case"block":return X(I);case"unblock":return Y(I);case"add-contact":return J(I);case"remove-contact":return Z(I);}}return s.Deferred().resolve().promise()},Be=function(){return i.get_string("messagedrawerviewconversation","core_message",_.name)};return{show:Fe,description:Be}});
//# sourceMappingURL=message_drawer_view_conversation.min.js.map
