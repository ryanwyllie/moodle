define(["jquery","core/auto_rows","core/backoff_timer","core/custom_interaction_events","core/notification","core/pubsub","core_message/message_repository","core_message/message_drawer_events","core_message/message_drawer_view_conversation_patcher","core_message/message_drawer_view_conversation_renderer","core_message/message_drawer_view_conversation_state_manager","core_message/message_drawer_routes"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m={},n=!1,o=0,p=null,q=null,r=!0,s=100,t=1e3,u={ACTION_CANCEL_CONFIRM:'[data-action="cancel-confirm"]',ACTION_CANCEL_EDIT_MODE:'[data-action="cancel-edit-mode"]',ACTION_CONFIRM_BLOCK:'[data-action="confirm-block"]',ACTION_CONFIRM_UNBLOCK:'[data-action="confirm-unblock"]',ACTION_CONFIRM_ADD_CONTACT:'[data-action="confirm-add-contact"]',ACTION_CONFIRM_REMOVE_CONTACT:'[data-action="confirm-remove-contact"]',ACTION_CONFIRM_DELETE_SELECTED_MESSAGES:'[data-action="confirm-delete-selected-messages"]',ACTION_CONFIRM_DELETE_CONVERSATION:'[data-action="confirm-delete-conversation"]',ACTION_REQUEST_DELETE_CONVERSATION:'[data-action="request-delete-conversation"]',ACTION_REQUEST_DELETE_SELECTED_MESSAGES:'[data-action="delete-selected-messages"]',ACTION_REQUEST_BLOCK:'[data-action="request-block"]',ACTION_REQUEST_UNBLOCK:'[data-action="request-unblock"]',ACTION_REQUEST_ADD_CONTACT:'[data-action="request-add-contact"]',ACTION_REQUEST_REMOVE_CONTACT:'[data-action="request-remove-contact"]',FOOTER_CONTAINER:'[data-region="content-messages-footer-container"]',MESSAGE:'[data-region="message"]',MESSAGES_CONTAINER:'[data-region="content-message-container"]',MESSAGE_TEXT_AREA:'[data-region="send-message-txt"]',SEND_MESSAGE_BUTTON:'[data-action="send-message"]'},v=function(){var a=m.loggedInUserId,b=Object.keys(m.members).filter(function(b){return a!=b});return b.length?b[0]:null},w=function(a){return{userid:a.attr("data-user-id"),fullname:a.attr("data-full-name"),profileimageurl:a.attr("data-profile-url")}},x=function(a){return a.find(u.MESSAGES_CONTAINER)},y=function(a){return Object.assign({conversation:{id:m.id,title:m.title,imageurl:m.members[v()].profileimageurl}},a)},z=function(a,b){var c=a.userid,d=k.setLoadingMembers(m,!0);return q(d).then(function(){return g.getProfile(c,b)}).then(function(b){var c=k.addMembers(m,[b,a]);return c=k.setLoadingMembers(c,!1),c=k.setTitle(c,b.fullname),q(c).then(function(){return b})})["catch"](function(a){var b=k.setLoadingMembers(m,!1);q(b),e.exception(a)})},A=function(a,b,c,d){var e=k.setLoadingMessages(m,!0);return q(e).then(function(){return g.getMessages(m.loggedInUserId,a,b+1,c,d)}).then(function(a){return a.messages}).then(function(a){return a.length>b?a=a.slice(1):n=!0,a}).then(function(a){var b=k.addMessages(m,a);return b=k.setLoadingMessages(b,!1),q(b)})["catch"](function(a){var b=k.setLoadingMessages(m,!1);return q(b),a})},B=function(a,b){return function(){var c=m.messages,d=c.length?c[c.length-1]:null;if(d){for(var e=[],f=c.length-1;f>=0;f--){var h=c[f];if(h.timeCreated!==d.timeCreated)break;e.push(h.id)}g.getMessages(m.loggedInUserId,a,0,0,b,d.timeCreated).then(function(a){return a.messages.length?a.messages.filter(function(a){return e.indexOf(parseInt(a.id,10))<0}):[]}).then(function(b){if(b.length){var c=k.addMessages(m,b);return q(c).then(function(){p.restart()}).then(function(){return C(a)})}return[]})}}},C=function(a){var b=m.loggedInUserId;return g.markAllAsRead({useridto:b,useridfrom:a}).then(function(){var b=k.markMessagesAsRead(m,m.messages);return f.publish(h.CONVERSATION_READ,a),q(b)})},D=function(a){return P(a).then(function(){var b=k.addPendingBlockUsersById(m,[a]);return q(b)})},E=function(a){var b=k.setLoadingConfirmAction(m,!0);return q(b).then(function(){return g.blockUser(m.loggedInUserId,a)}).then(function(){var b=k.blockUsersById(m,[a]);return b=k.removePendingBlockUsersById(b,[a]),b=k.setLoadingConfirmAction(b,!1),f.publish(h.CONTACT_BLOCKED,a),q(b)})},F=function(a){return P(a).then(function(){var b=k.addPendingUnblockUsersById(m,[a]);return q(b)})},G=function(a){var b=k.setLoadingConfirmAction(m,!0);return q(b).then(function(){return g.unblockUser(m.loggedInUserId,a)}).then(function(){var b=k.unblockUsersById(m,[a]);return b=k.removePendingUnblockUsersById(b,[a]),b=k.setLoadingConfirmAction(b,!1),f.publish(h.CONTACT_UNBLOCKED,a),q(b)})},H=function(a){return P(a).then(function(){var b=k.addPendingRemoveContactsById(m,[a]);return q(b)})},I=function(a){var b=k.setLoadingConfirmAction(m,!0);return q(b).then(function(){return g.deleteContacts(m.loggedInUserId,[a])}).then(function(){var b=k.removeContactsById(m,[a]);return b=k.removePendingRemoveContactsById(b,[a]),b=k.setLoadingConfirmAction(b,!1),f.publish(h.CONTACT_REMOVED,a),q(b)})},J=function(a){return P(a).then(function(){var b=k.addPendingAddContactsById(m,[a]);return q(b)})},K=function(a){var b=k.setLoadingConfirmAction(m,!0);return q(b).then(function(){return g.createContactRequest(m.loggedInUserId,a)}).then(function(){var b=k.addContactsById(m,[a]);return b=k.removePendingAddContactsById(b,[a]),b=k.setContactRequestSent(b,a),b=k.setLoadingConfirmAction(b,!1),q(b)})},L=function(a){var b=m.selectedMessageIds;return P(a).then(function(){var a=k.addPendingDeleteMessagesById(m,b);return q(a)})},M=function(){var a=m.pendingDeleteMessageIds,b=k.setLoadingConfirmAction(m,!0);return q(b).then(function(){return g.deleteMessages(m.loggedInUserId,a)}).then(function(){var b=k.removeMessagesById(m,a);b=k.removePendingDeleteMessagesById(b,a),b=k.removeSelectedMessagesById(b,a),b=k.setLoadingConfirmAction(b,!1);var c=m.messages[m.messages.length-1],d=b.messages.length?b.messages[b.messages.length-1]:null;if(d&&d.id!=c.id){var e=y(d);f.publish(h.CONVERSATION_NEW_LAST_MESSAGE,e)}else b.messages.length||f.publish(h.CONVERSATION_DELETED,b.id);return q(b)})},N=function(a){return P(a).then(function(){var a=k.setPendingDeleteConversation(m,!0);return q(a)})},O=function(){var a=k.setLoadingConfirmAction(m,!0);return q(a).then(function(){return g.deleteCoversation(m.loggedInUserId,v())}).then(function(){var a=k.removeMessages(m,m.messages);return a=k.removeSelectedMessagesById(a,m.selectedMessageIds),a=k.setPendingDeleteConversation(a,!1),a=k.setLoadingConfirmAction(a,!1),f.publish(h.CONVERSATION_DELETED,a.id),q(a)})},P=function(a){var b=m.pendingDeleteMessageIds,c=k.removePendingAddContactsById(m,[a]);return c=k.removePendingRemoveContactsById(c,[a]),c=k.removePendingUnblockUsersById(c,[a]),c=k.removePendingBlockUsersById(c,[a]),c=k.removePendingDeleteMessagesById(c,b),c=k.setPendingDeleteConversation(c,!1),q(c)},Q=function(a,b){var c=m.members[m.loggedInUserId],d=k.setSendingMessage(m,!0);return q(d).then(function(){return g.sendMessage(a,b)}).then(function(a){if(a.errormessage)throw new Error(a.errormessage);return a}).then(function(b){return{id:parseInt(b.msgid,10),fullname:c.fullname,profileimageurl:c.profileimageurl,text:b.text,timecreated:parseInt(b.timecreated,10),useridfrom:c.userid,useridto:a,isread:!0}}).then(function(a){var b=k.addMessages(m,[a]);b=k.setSendingMessage(b,!1);var c=b.messages.filter(function(b){return b.id===a.id}),d=y(c[0]);return f.publish(h.CONVERSATION_NEW_LAST_MESSAGE,d),q(b)})["catch"](function(a){var b=k.setSendingMessage(m,!1);q(b),e.exception(a)})},R=function(a){var b=m;return b=m.selectedMessageIds.indexOf(a)>-1?k.removeSelectedMessagesById(m,[a]):k.addSelectedMessagesById(m,[a]),q(b)},S=function(){return P(v()).then(function(){var a=k.removeSelectedMessagesById(m,m.selectedMessageIds);return q(a)})},T=function(a,b,c){return function(d){var e=i.buildPatch(m,d);return j.render(a,b,c,e).then(function(){m=d})}},U=function(a){return function(b,c){m.loadingConfirmAction||a(v())["catch"](e.exception),c.originalEvent.preventDefault()}},V=function(b,c){var d=a(b.target),e=d.closest(u.FOOTER_CONTAINER),f=e.find(u.MESSAGE_TEXT_AREA),g=f.val().trim();""!==g&&Q(m.id,g),c.originalEvent.preventDefault()},W=function(b,c){var d=a(b.target).closest(u.MESSAGE),f=parseInt(d.attr("data-message-id"),10);R(f)["catch"](e.exception),c.originalEvent.preventDefault()},X=function(a,b){S()["catch"](e.exception),b.originalEvent.preventDefault()},Y=[[u.ACTION_REQUEST_BLOCK,U(D)],[u.ACTION_REQUEST_UNBLOCK,U(F)],[u.ACTION_REQUEST_ADD_CONTACT,U(J)],[u.ACTION_REQUEST_REMOVE_CONTACT,U(H)],[u.ACTION_REQUEST_DELETE_CONVERSATION,U(N)],[u.ACTION_CANCEL_EDIT_MODE,X]],Z=[[u.ACTION_CANCEL_CONFIRM,U(P)],[u.ACTION_CONFIRM_BLOCK,U(E)],[u.ACTION_CONFIRM_UNBLOCK,U(G)],[u.ACTION_CONFIRM_ADD_CONTACT,U(K)],[u.ACTION_CONFIRM_REMOVE_CONTACT,U(I)],[u.ACTION_CONFIRM_DELETE_SELECTED_MESSAGES,U(M)],[u.ACTION_CONFIRM_DELETE_CONVERSATION,U(O)],[u.ACTION_REQUEST_ADD_CONTACT,U(J)],[u.MESSAGE,W]],$=[[u.SEND_MESSAGE_BUTTON,V],[u.ACTION_REQUEST_DELETE_SELECTED_MESSAGES,U(L)],[u.ACTION_REQUEST_ADD_CONTACT,U(J)],[u.ACTION_REQUEST_UNBLOCK,U(F)]],_=function(a,c,g){var i=!1,j=x(c);b.init(g),d.define(a,[d.events.activate]),d.define(c,[d.events.activate]),d.define(g,[d.events.activate]),d.define(j,[d.events.scrollTop,d.events.scrollLock]),j.on(d.events.scrollTop,function(a,b){var c=Object.keys(m.members).length>1;i||n||!c||A(m.id,s,o,r).then(function(){i=!1,o+=s})["catch"](function(a){i=!1,e.exception(a)}),b.originalEvent.preventDefault()}),Y.forEach(function(b){var c=b[0],e=b[1];a.on(d.events.activate,c,e)}),Z.forEach(function(a){var b=a[0],e=a[1];c.on(d.events.activate,b,e)}),$.forEach(function(a){var b=a[0],c=a[1];g.on(d.events.activate,b,c)}),f.subscribe(h.ROUTE_CHANGED,function(a){p&&(a.route==l.VIEW_CONVERSATION?p.restart():p.stop())})},aa=function(a,b){var d=w(a),f=d.userid,g=parseInt(a.attr("data-midnight"),10),h=k.buildInitialState(g,f,b,"");return o=0,Object.keys(m).length||(m=h),p&&p.stop(),p=new c(B(b,r),function(a){return a?2*a:t}),p.start(),q(h).then(function(){return z(d,b)}).then(function(){return A(m.id,s,o,r)}).then(function(){return o+=s}).then(function(){return C(m.id)})["catch"](e.exception)},ba=function(a,b,c,d,e){if(b.attr("data-init")){var f=m.id;f!=d&&aa(b,d)}else q=T(a,b,c),_(a,b,c),aa(b,d),b.attr("data-init",!0);switch(e){case"block":D(d);break;case"unblock":F(d);break;case"add-contact":J(d);break;case"remove-contact":H(d)}};return{show:ba}});