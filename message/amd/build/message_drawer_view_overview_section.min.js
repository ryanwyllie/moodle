define(["jquery","core/custom_interaction_events","core/notification","core/pubsub","core/str","core/templates","core/user_date","core_message/message_repository","core_message/message_drawer_events","core_message/message_drawer_router","core_message/message_drawer_routes","core_message/message_drawer_lazy_load_list","core_message/message_drawer_view_conversation_constants"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){var n={TOGGLE:'[data-region="toggle"]',CONVERSATION:"[data-conversation-id]",BLOCKED_ICON_CONTAINER:'[data-region="contact-icon-blocked"]',LAST_MESSAGE:'[data-region="last-message"]',LAST_MESSAGE_DATE:'[data-region="last-message-date"]',UNREAD_COUNT:'[data-region="unread-count"]',SECTION_TOTAL_COUNT:'[data-region="section-total-count"]',SECTION_TOTAL_COUNT_CONTAINER:'[data-region="section-total-count-container"]',SECTION_UNREAD_COUNT:'[data-region="section-unread-count"]',PLACEHOLDER_CONTAINER:'[data-region="placeholder-container"]'},o={CONVERSATIONS_LIST:"core_message/message_drawer_conversations_list",CONVERSATIONS_LIST_ITEMS_PLACEHOLDER:"core_message/message_drawer_conversations_list_items_placeholder"},p=50,q={},r=!1,s=!1,t=function(a){return l.getRoot(a).hasClass("show")},u=function(a){a.addClass("expanded")},v=function(a){a.removeClass("expanded")},w=function(b){var c=a(b).text()||b,d=c.split(/\r?\n/);c=d[0];try{JSON.parse('{"text":"'+c+'"}')}catch(e){c=JSON.stringify(c),c=c.slice(1,-1)}return c},x=function(a,b){var c=a.find(n.SECTION_TOTAL_COUNT_CONTAINER),d=c.find(n.SECTION_TOTAL_COUNT);d.text(b),c.removeClass("hidden");var e=b>20?20:b,g=Array.apply(null,Array(e)).map(function(){return!0});f.render(o.CONVERSATIONS_LIST_ITEMS_PLACEHOLDER,{placeholders:g}).then(function(b){var c=a.find(n.PLACEHOLDER_CONTAINER);c.html(b)})["catch"](function(){})},y=function(a,b){var c=a.find(n.SECTION_UNREAD_COUNT);c.text(b),b>0&&c.removeClass("hidden")},z=function(a,b,d){var e=b.map(function(a){var b=a.messages.length?a.messages[a.messages.length-1]:null,c={id:a.id,imageurl:a.imageurl,name:a.name,subname:a.subname,unreadcount:a.unreadcount,lastmessagedate:b?b.timecreated:null,sentfromcurrentuser:b?b.useridfrom==d:null,lastmessage:b?w(b.text):null};if(a.type==m.CONVERSATION_TYPES.PRIVATE){var e=a.members.reduce(function(a,b){return a||b.id==d||(a=b),a},null);c.userid=e.id,c.showonlinestatus=e.showonlinestatus,c.isonline=e.isonline,c.isblocked=e.isblocked}return a.type==m.CONVERSATION_TYPES.PUBLIC&&(c.lastsendername=a.members.reduce(function(a,c){return a||c.id!=b.useridfrom||(a=c.fullname),a},null)),c});return f.render(o.CONVERSATIONS_LIST,{conversations:e}).then(function(b){return a.append(b),b})["catch"](c.exception)},A=function(a,b,d){return function(e,f){return h.getConversations(f,a,p+1,d,b).then(function(a){var b=a.conversations;return b.length>p?b=b.slice(0,-1):l.setLoadedAll(e,!0),d+=p,b.forEach(function(a){q[a.id]=a}),b})["catch"](c.exception)}},B=function(a){return a.find(n.SECTION_TOTAL_COUNT)},C=function(a){return a.find(n.SECTION_UNREAD_COUNT)},D=function(a){if(r){var b=B(a),c=parseInt(b.text());c+=1,b.text(c)}},E=function(a){if(r){var b=B(a),c=parseInt(b.text());c-=1,b.text(c)}},F=function(a){if(s){var b=C(a),c=parseInt(b.text());c-=1,b.text(c),c<1&&b.addClass("hidden")}},G=function(a,b){return a.find('[data-conversation-id="'+b+'"]')},H=function(a,b){return a.find('[data-user-id="'+b+'"]')},I=function(a){a.find(n.BLOCKED_ICON_CONTAINER).removeClass("hidden")},J=function(a){a.find(n.BLOCKED_ICON_CONTAINER).addClass("hidden")},K=function(a,b){var c=b.messages[b.messages.length-1],d="",f=[{key:"yousender",component:"core_message"},{key:"strftimetime24",component:"core_langconfig"}];return e.get_strings(f).then(function(a){return d=a[0],g.get([{timestamp:c.timeCreated,format:a[1]}])}).then(function(a){return a[0]}).then(function(b){return a.find(n.LAST_MESSAGE_DATE).text(b).removeClass("hidden"),e.get_string("conversationlastmessage","core_message",{sender:c.fromLoggedInUser?d:c.userFrom.fullname,message:"<span class='text-muted'>"+w(c.text)+"</span>"})}).then(function(b){return a.find(n.LAST_MESSAGE).html(b)})},L=function(a,b){var d=a.find(n.CONVERSATION);if(!d.length){var e=l.getRoot(a);l.showContent(e),l.hideEmptyMessage(e)}var g=b.messages.length,h=g?b.messages[g-1]:null,i={id:b.id,name:b.name,subname:b.subname,lastmessagedate:h?h.timeCreated:null,sentfromcurrentuser:h?h.fromLoggedInUser:null,lastmessage:h?w(h.text):null,imageurl:b.imageUrl};return q[b.id]=b,f.render(o.CONVERSATIONS_LIST,{conversations:[i]}).then(function(b){var c=l.getContentContainer(a);return c.prepend(b)}).then(function(){return D(a)})["catch"](c.exception)},M=function(a,b){b.remove(),E(a);var c=a.find(n.CONVERSATION);if(!c.length){var d=l.getRoot(a);l.hideContent(d),l.showEmptyMessage(d)}},N=function(a,b){var c=b.find(n.UNREAD_COUNT);c.text("0"),c.addClass("hidden"),F(a)},O=function(c,e,f,g){var h=l.getRoot(c),m=c.find(n.TOGGLE);c.css("min-height",m.outerHeight()),c.on("show.bs.collapse",function(){u(c),l.show(h,e,z)}),c.on("hidden.bs.collapse",function(){v(c)}),d.subscribe(i.CONTACT_BLOCKED,function(a){var b=H(c,a);b.length&&I(b)}),d.subscribe(i.CONTACT_UNBLOCKED,function(a){var b=H(c,a);b.length&&J(b)}),d.subscribe(i.CONVERSATION_NEW_LAST_MESSAGE,function(a){if(!(f&&a.type!=f||g&&!a.isFavourite||!g&&a.isFavourite)){var b=a.id,d=G(c,b);d.length?K(d,a):L(c,a)}}),d.subscribe(i.CONVERSATION_DELETED,function(a){var b=G(c,a);b.length&&M(c,b)}),d.subscribe(i.CONVERSATION_READ,function(a){var b=G(c,a);b.length&&N(c,b)}),d.subscribe(i.CONVERSATION_SET_FAVOURITE,function(a){var b=null;!g||f&&f!=a.type?f==a.type&&(b=G(c,a.id),b.length&&M(c,b)):(b=G(c,a.id),b.length||L(c,a))}),d.subscribe(i.CONVERSATION_UNSET_FAVOURITE,function(a){var b=null;g?(b=G(c,a.id),b.length&&M(c,b)):f==a.type&&(b=G(c,a.id),b.length||L(c,a))}),b.define(c,[b.events.activate]),c.on(b.events.activate,n.CONVERSATION,function(b,c){var d=a(b.target).closest(n.CONVERSATION),e=d.attr("data-conversation-id"),f=q[e];j.go(k.VIEW_CONVERSATION,f),c.originalEvent.preventDefault()})},P=function(b,c,d,e,f){if(b=a(b),!b.attr("data-init")){var g=A(c,d,0);if(O(b,g,c,d),t(b)){u(b);var h=l.getRoot(b);l.show(h,g,z)}e.then(function(a){x(b,a),r=!0})["catch"](function(){}),f.then(function(a){y(b,a),r=!0})["catch"](function(){}),b.attr("data-init",!0)}};return{show:P,isVisible:t}});