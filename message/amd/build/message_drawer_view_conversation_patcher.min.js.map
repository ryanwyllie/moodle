{"version":3,"sources":["../src/message_drawer_view_conversation_patcher.js"],"names":["define","$","UserDate","Constants","sortMessagesByDay","messages","midnight","messagesByDay","reduce","carry","message","dayTimestamp","getUserMidnightForTimestamp","timeCreated","hasOwnProperty","push","Object","keys","map","timestamp","diffArrays","a","b","matchFunction","slice","missingFromA","missingFromB","matches","forEach","current","found","index","length","next","splice","findPositionInArray","array","breakFunction","before","i","candidate","isArrayEqual","sort","aLength","bLength","every","item","buildDaysPatch","daysDiff","remove","add","day","value","buildMessagesPatch","matchingDays","days","dayCurrent","dayNext","messagesDiff","messageCurrent","messageNext","id","concat","buildConversationPatch","state","newState","oldMessageIds","newMessageIds","buildHeaderPatchTypePrivate","requireAddContact","buildRequireAddContact","confirmContactRequest","buildConfirmContactRequest","oldOtherUser","getOtherUserFromState","newOtherUser","requiresAddContact","show","hasMessages","requiredAddContact","shouldRenderHeader","type","CONVERSATION_TYPES","PRIVATE","showControls","context","name","subname","totalmembercount","totalMemberCount","imageurl","imageUrl","isfavourite","isFavourite","ismuted","isMuted","showfavourite","userid","showonlinestatus","isonline","isblocked","iscontact","buildHeaderPatchTypeSelf","SELF","buildHeaderPatchTypePublic","oldMemberCount","newMemberCount","PUBLIC","buildScrollToMessagePatch","oldMessages","newMessages","previousNewest","currentNewest","previousOldest","currentOldest","buildLoadingMembersPatch","loadingMembers","buildLoadingFirstMessages","hasTriedToLoadMessages","loadingMessages","buildLoadingMessages","buildSendingMessage","sendingMessage","buildConfirmBlockUser","pendingBlockUserIds","userId","members","buildConfirmUnblockUser","pendingUnblockUserIds","buildConfirmAddContact","pendingAddContactIds","buildConfirmRemoveContact","pendingRemoveContactIds","buildConfirmDeleteSelectedMessages","oldPendingCount","pendingDeleteMessageIds","newPendingCount","canDeleteMessagesForAllUsers","buildConfirmDeleteConversation","pendingDeleteConversation","loggedInUserId","oldReceivedRequests","contactrequests","filter","request","requesteduserid","newReceivedRequests","oldRequest","newRequest","buildIsBlocked","buildIsFavourite","oldIsFavourite","newIsFavourite","buildIsMuted","oldIsMuted","newIsMuted","buildIsContact","oldContactRequests","newContactRequests","oldHasContactRequests","newHasContactRequests","buildLoadingConfirmationAction","loadingConfirmAction","buildInEditMode","oldHasSelectedMessages","selectedMessageIds","newHasSelectedMessages","numberOfMessagesHasChanged","buildSelectedMessages","oldSelectedMessages","newSelectedMessages","diff","count","requiresContactRequest","user","contactRequests","hasSentContactRequest","requirescontact","hadMessages","prevRequiresContactRequest","nextRequiresContactRequest","confirmAddContact","buildRequireUnblock","buildUnableToMessage","canmessage","buildFooterPatchTypePrivate","loadingFirstMessages","inEditMode","requireUnblock","unableToMessage","showRequireAddContact","otherUser","generateReturnValue","checkValue","successReturn","checks","result","buildFooterPatchTypePublic","buildReset","oldType","newType","oldConversationId","newConversationId","oldMemberIds","newMemberIds","membersUnchanged","buildSelfConversationMessage","buildContactRequestSent","oldSentRequests","newSentRequests","fullname","buildPatch","config","all","reset","conversation","scrollToMessage","confirmDeleteSelectedMessages","selectedMessages","header","footer","confirmBlockUser","confirmUnblockUser","confirmRemoveContact","confirmDeleteConversation","isBlocked","isContact","contactRequestSent","selfConversationMessage","patchConfig","extend","patch","key","buildFunc"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module will take 2 view states from the message_drawer_view_conversation\n * module and generate a patch that can be given to the\n * message_drawer_view_conversation_renderer module to update the UI.\n *\n * This module should never modify either state. It's purely a read only\n * module.\n *\n * @module     core_message/message_drawer_view_conversation_patcher\n * @copyright  2018 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(\n[\n    'jquery',\n    'core/user_date',\n    'core_message/message_drawer_view_conversation_constants'\n],\nfunction(\n    $,\n    UserDate,\n    Constants\n) {\n    /**\n     * Sort messages by day.\n     *\n     * @param  {Array} messages The list of messages to sort.\n     * @param  {Number} midnight User's midnight timestamp.\n     * @return {Array} messages sorted by day.\n     */\n    var sortMessagesByDay = function(messages, midnight) {\n        var messagesByDay = messages.reduce(function(carry, message) {\n            var dayTimestamp = UserDate.getUserMidnightForTimestamp(message.timeCreated, midnight);\n\n            if (carry.hasOwnProperty(dayTimestamp)) {\n                carry[dayTimestamp].push(message);\n            } else {\n                carry[dayTimestamp] = [message];\n            }\n\n            return carry;\n        }, {});\n\n        return Object.keys(messagesByDay).map(function(dayTimestamp) {\n            return {\n                timestamp: dayTimestamp,\n                messages: messagesByDay[dayTimestamp]\n            };\n        });\n    };\n\n    /**\n     * Diff 2 arrays using a match function\n     *\n     * @param  {Array} a The first array.\n     * @param  {Array} b The second array.\n     * @param  {Function} matchFunction Function used for matching array items.\n     * @return {Object} Object containing array items missing from a, array items missing from b\n     * and matches\n     */\n    var diffArrays = function(a, b, matchFunction) {\n        // Make copy of it.\n        b = b.slice();\n        var missingFromA = [];\n        var missingFromB = [];\n        var matches = [];\n\n        a.forEach(function(current) {\n            var found = false;\n            var index = 0;\n\n            for (; index < b.length; index++) {\n                var next = b[index];\n\n                if (matchFunction(current, next)) {\n                    found = true;\n                    matches.push({\n                        a: current,\n                        b: next\n                    });\n                    break;\n                }\n            }\n\n            if (found) {\n                // This day has been processed so removed it from the list.\n                b.splice(index, 1);\n            } else {\n                // If we couldn't find it in the next messages then it means\n                // it needs to be added.\n                missingFromB.push(current);\n            }\n        });\n\n        missingFromA = b;\n\n        return {\n            missingFromA: missingFromA,\n            missingFromB: missingFromB,\n            matches: matches\n        };\n    };\n\n    /**\n     * Find an element in a array based on a matching function.\n     *\n     * @param  {array} array Array to search.\n     * @param  {Function} breakFunction Function to run on array item.\n     * @return {*} The array item.\n     */\n    var findPositionInArray = function(array, breakFunction) {\n        var before = null;\n\n        for (var i = 0; i < array.length; i++) {\n            var candidate = array[i];\n\n            if (breakFunction(candidate)) {\n                return candidate;\n            }\n        }\n\n        return before;\n    };\n\n    /**\n     * Check if 2 arrays are equal.\n     *\n     * @param  {Array} a The first array.\n     * @param  {Array} b The second array.\n     * @return {Boolean} Are arrays equal.\n     */\n    var isArrayEqual = function(a, b) {\n        a.sort();\n        b.sort();\n        var aLength = a.length;\n        var bLength = b.length;\n\n        if (aLength < 1 && bLength < 1) {\n            return true;\n        }\n\n        if (aLength != bLength) {\n            return false;\n        }\n\n        return a.every(function(item, index) {\n            return item == b[index];\n        });\n    };\n\n    /**\n     * Build a patch based on days.\n     *\n     * @param  {Object} current Current list current items.\n     * @param  {Object} daysDiff Difference between current and new.\n     * @return {Object} Patch with elements to add and remove.\n     */\n    var buildDaysPatch = function(current, daysDiff) {\n        return {\n            remove: daysDiff.missingFromB,\n            add: daysDiff.missingFromA.map(function(day) {\n                // Any days left over in the \"next\" list weren't in the \"current\" list\n                // so they will need to be added.\n                var before = findPositionInArray(current, function(candidate) {\n                    return day.timestamp < candidate.timestamp;\n                });\n\n                return {\n                    before: before,\n                    value: day\n                };\n            })\n        };\n    };\n\n    /**\n     * Build the messages patch for each day.\n     *\n     * @param {Array} matchingDays Array of old and new messages sorted by day.\n     * @return {Object} patch.\n     */\n    var buildMessagesPatch = function(matchingDays) {\n        var remove = [];\n        var add = [];\n\n        matchingDays.forEach(function(days) {\n            var dayCurrent = days.a;\n            var dayNext = days.b;\n            var messagesDiff = diffArrays(dayCurrent.messages, dayNext.messages, function(messageCurrent, messageNext) {\n                return messageCurrent.id == messageNext.id;\n            });\n\n            remove = remove.concat(messagesDiff.missingFromB);\n\n            messagesDiff.missingFromA.forEach(function(message) {\n                var before = findPositionInArray(dayCurrent.messages, function(candidate) {\n                    if (message.timeCreated == candidate.timeCreated) {\n                        return message.id < candidate.id;\n                    } else {\n                        return message.timeCreated < candidate.timeCreated;\n                    }\n                });\n\n                add.push({\n                    before: before,\n                    value: message,\n                    day: dayCurrent\n                });\n            });\n        });\n\n        return {\n            add: add,\n            remove: remove\n        };\n    };\n\n    /**\n     * Build a patch for this conversation.\n     *\n     * @param  {Object} state, The current state of this conversation.\n     * @param  {Object} newState, The new state of this conversation.\n     * @return {Object} Patch with days and messsages for each day.\n     */\n    var buildConversationPatch = function(state, newState) {\n        var oldMessageIds = state.messages.map(function(message) {\n            return message.id;\n        });\n        var newMessageIds = newState.messages.map(function(message) {\n            return message.id;\n        });\n\n        if (!isArrayEqual(oldMessageIds, newMessageIds)) {\n            var current = sortMessagesByDay(state.messages, state.midnight);\n            var next = sortMessagesByDay(newState.messages, newState.midnight);\n            var daysDiff = diffArrays(current, next, function(dayCurrent, dayNext) {\n                return dayCurrent.timestamp == dayNext.timestamp;\n            });\n\n            return {\n                days: buildDaysPatch(current, daysDiff),\n                messages: buildMessagesPatch(daysDiff.matches)\n            };\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Build a patch for the header of this conversation. Check if this conversation\n     * is a group conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} patch\n     */\n    var buildHeaderPatchTypePrivate = function(state, newState) {\n        var requireAddContact = buildRequireAddContact(state, newState);\n        var confirmContactRequest = buildConfirmContactRequest(state, newState);\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n        var requiresAddContact = requireAddContact && requireAddContact.show && !requireAddContact.hasMessages;\n        var requiredAddContact = requireAddContact && !requireAddContact.show;\n        // Render the header once we've got a user.\n        var shouldRenderHeader = !oldOtherUser && newOtherUser;\n        // We should also re-render the header if the other user requires\n        // being added as a contact or if they did but no longer do.\n        shouldRenderHeader = shouldRenderHeader || requiresAddContact || requiredAddContact;\n        // Finally, we should re-render if the other user has sent this user\n        // a contact request that is waiting for approval or if it's been approved/declined.\n        shouldRenderHeader = shouldRenderHeader || confirmContactRequest !== null;\n\n        if (shouldRenderHeader) {\n            return {\n                type: Constants.CONVERSATION_TYPES.PRIVATE,\n                // We can show controls if the other user doesn't require add contact\n                // and we aren't waiting for this user to respond to a contact request.\n                showControls: !requiresAddContact && !confirmContactRequest,\n                context: {\n                    id: newState.id,\n                    name: newState.name,\n                    subname: newState.subname,\n                    totalmembercount: newState.totalMemberCount,\n                    imageurl: newState.imageUrl,\n                    isfavourite: newState.isFavourite,\n                    ismuted: newState.isMuted,\n                    // Don't show favouriting if we don't have a conversation.\n                    showfavourite: newState.id !== null,\n                    userid: newOtherUser.id,\n                    showonlinestatus: newOtherUser.showonlinestatus,\n                    isonline: newOtherUser.isonline,\n                    isblocked: newOtherUser.isblocked,\n                    iscontact: newOtherUser.iscontact\n                }\n            };\n        }\n\n        return null;\n    };\n\n    /**\n     * Build a patch for the header of this conversation. Check if this conversation\n     * is a group conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} patch\n     */\n    var buildHeaderPatchTypeSelf = function(state, newState) {\n        var shouldRenderHeader = (state.name === null && newState.name !== null);\n\n        if (shouldRenderHeader) {\n            return {\n                type: Constants.CONVERSATION_TYPES.SELF,\n                // Don't display the controls for the self-conversations.\n                showControls: false,\n                context: {\n                    id: newState.id,\n                    name: newState.name,\n                    subname: newState.subname,\n                    imageurl: newState.imageUrl,\n                    isfavourite: newState.isFavourite,\n                    // Don't show favouriting if we don't have a conversation.\n                    showfavourite: newState.id !== null,\n                    showonlinestatus: true,\n                }\n            };\n        }\n\n        return null;\n    };\n\n    /**\n     * Build a patch for the header of this conversation. Check if this conversation\n     * is a group conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} patch\n     */\n    var buildHeaderPatchTypePublic = function(state, newState) {\n        var oldMemberCount = state.totalMemberCount;\n        var newMemberCount = newState.totalMemberCount;\n\n        if (oldMemberCount != newMemberCount) {\n            return {\n                type: Constants.CONVERSATION_TYPES.PUBLIC,\n                showControls: true,\n                context: {\n                    id: newState.id,\n                    name: newState.name,\n                    subname: newState.subname,\n                    totalmembercount: newState.totalMemberCount,\n                    imageurl: newState.imageUrl,\n                    isfavourite: newState.isFavourite,\n                    ismuted: newState.isMuted,\n                    // Don't show favouriting if we don't have a conversation.\n                    showfavourite: newState.id !== null\n                }\n            };\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Find the newest or oldest message.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Number} Oldest or newest message id.\n     */\n    var buildScrollToMessagePatch = function(state, newState) {\n        var oldMessages = state.messages;\n        var newMessages = newState.messages;\n\n        if (newMessages.length < 1) {\n            return null;\n        }\n\n        if (oldMessages.length < 1) {\n            return newMessages[newMessages.length - 1].id;\n        }\n\n        var previousNewest = oldMessages[state.messages.length - 1];\n        var currentNewest = newMessages[newMessages.length - 1];\n        var previousOldest = oldMessages[0];\n        var currentOldest = newMessages[0];\n\n        if (previousNewest.id != currentNewest.id) {\n            return currentNewest.id;\n        } else if (previousOldest.id != currentOldest.id) {\n            return previousOldest.id;\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if members should be loaded.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildLoadingMembersPatch = function(state, newState) {\n        if (!state.loadingMembers && newState.loadingMembers) {\n            return true;\n        } else if (state.loadingMembers && !newState.loadingMembers) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if the messages are being loaded for the first time.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildLoadingFirstMessages = function(state, newState) {\n        if (state.hasTriedToLoadMessages === newState.hasTriedToLoadMessages) {\n            return null;\n        } else if (!newState.hasTriedToLoadMessages && newState.loadingMessages) {\n            return true;\n        } else if (newState.hasTriedToLoadMessages && !newState.loadingMessages) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if the messages are still being loaded\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildLoadingMessages = function(state, newState) {\n        if (!state.loadingMessages && newState.loadingMessages) {\n            return true;\n        } else if (state.loadingMessages && !newState.loadingMessages) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if the messages are still being send\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null} User Object if Object.\n     */\n    var buildSendingMessage = function(state, newState) {\n        if (!state.sendingMessage && newState.sendingMessage) {\n            return true;\n        } else if (state.sendingMessage && !newState.sendingMessage) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Get the user Object of user to be blocked if pending.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object|Bool|Null} User Object if Object.\n     */\n    var buildConfirmBlockUser = function(state, newState) {\n        if (newState.pendingBlockUserIds.length) {\n            // We currently only support a single user;\n            var userId = newState.pendingBlockUserIds[0];\n            return newState.members[userId];\n        } else if (state.pendingBlockUserIds.length) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Get the user Object of user to be unblocked if pending.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object|Bool|Null} User Object if Object.\n     */\n    var buildConfirmUnblockUser = function(state, newState) {\n        if (newState.pendingUnblockUserIds.length) {\n            // We currently only support a single user;\n            var userId = newState.pendingUnblockUserIds[0];\n            return newState.members[userId];\n        } else if (state.pendingUnblockUserIds.length) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Get the user Object of user to be added as contact if pending.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object|Bool|Null} User Object if Object.\n     */\n    var buildConfirmAddContact = function(state, newState) {\n        if (newState.pendingAddContactIds.length) {\n            // We currently only support a single user;\n            var userId = newState.pendingAddContactIds[0];\n            return newState.members[userId];\n        } else if (state.pendingAddContactIds.length) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Get the user Object of user to be removed as contact if pending.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object|Bool|Null} User Object if Object.\n     */\n    var buildConfirmRemoveContact = function(state, newState) {\n        if (newState.pendingRemoveContactIds.length) {\n            // We currently only support a single user;\n            var userId = newState.pendingRemoveContactIds[0];\n            return newState.members[userId];\n        } else if (state.pendingRemoveContactIds.length) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if there are any messages to be deleted.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object|Null} The conversation type and if the user can delete  the messages for all users.\n     */\n    var buildConfirmDeleteSelectedMessages = function(state, newState) {\n        var oldPendingCount = state.pendingDeleteMessageIds.length;\n        var newPendingCount = newState.pendingDeleteMessageIds.length;\n\n        if (newPendingCount && !oldPendingCount) {\n            return {\n                show: true,\n                type: newState.type,\n                canDeleteMessagesForAllUsers: newState.canDeleteMessagesForAllUsers\n            };\n        } else if (oldPendingCount && !newPendingCount) {\n            return {\n                show: false\n            };\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if there is a conversation to be deleted.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {int|Null} The conversation type to be deleted.\n     */\n    var buildConfirmDeleteConversation = function(state, newState) {\n        if (!state.pendingDeleteConversation && newState.pendingDeleteConversation) {\n            return newState.type;\n        } else if (state.pendingDeleteConversation && !newState.pendingDeleteConversation) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if there is a pending contact request to accept or decline.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildConfirmContactRequest = function(state, newState) {\n        var loggedInUserId = state.loggedInUserId;\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n        var oldReceivedRequests = !oldOtherUser ? [] : oldOtherUser.contactrequests.filter(function(request) {\n            return request.requesteduserid == loggedInUserId && request.userid == oldOtherUser.id;\n        });\n        var newReceivedRequests = !newOtherUser ? [] : newOtherUser.contactrequests.filter(function(request) {\n            return request.requesteduserid == loggedInUserId && request.userid == newOtherUser.id;\n        });\n        var oldRequest = oldReceivedRequests.length ? oldReceivedRequests[0] : null;\n        var newRequest = newReceivedRequests.length ? newReceivedRequests[0] : null;\n\n        if (!oldRequest && newRequest) {\n            return newOtherUser;\n        } else if (oldRequest && !newRequest) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if there are any changes in blocked users.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildIsBlocked = function(state, newState) {\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n\n        if (!oldOtherUser && !newOtherUser) {\n            return null;\n        } else if (!oldOtherUser && newOtherUser) {\n            return newOtherUser.isblocked ? true : null;\n        } else if (!newOtherUser && oldOtherUser) {\n            return oldOtherUser.isblocked ? false : null;\n        } else if (oldOtherUser.isblocked && !newOtherUser.isblocked) {\n            return false;\n        } else if (!oldOtherUser.isblocked && newOtherUser.isblocked) {\n            return true;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if there are any changes the conversation favourite state.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildIsFavourite = function(state, newState) {\n        var oldIsFavourite = state.isFavourite;\n        var newIsFavourite = newState.isFavourite;\n\n        if (state.id === null && newState.id === null) {\n            // The conversation isn't yet created so don't change anything.\n            return null;\n        } else if (state.id === null && newState.id !== null) {\n            // The conversation was created so we can show the add favourite button.\n            return 'show-add';\n        } else if (state.id !== null && newState.id === null) {\n            // We're changing from a created conversation to a new conversation so hide\n            // the favouriting functionality for now.\n            return 'hide';\n        } else if (oldIsFavourite == newIsFavourite) {\n            // No change.\n            return null;\n        } else if (!oldIsFavourite && newIsFavourite) {\n            return 'show-remove';\n        } else if (oldIsFavourite && !newIsFavourite) {\n            return 'show-add';\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if there are any changes the conversation muted state.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {string|null}\n     */\n    var buildIsMuted = function(state, newState) {\n        var oldIsMuted = state.isMuted;\n        var newIsMuted = newState.isMuted;\n\n        if (state.id === null && newState.id === null) {\n            // The conversation isn't yet created so don't change anything.\n            return null;\n        } else if (state.id === null && newState.id !== null) {\n            // The conversation was created so we can show the mute button.\n            return 'show-mute';\n        } else if (state.id !== null && newState.id === null) {\n            // We're changing from a created conversation to a new conversation so hide\n            // the muting functionality for now.\n            return 'hide';\n        } else if (oldIsMuted == newIsMuted) {\n            // No change.\n            return null;\n        } else if (!oldIsMuted && newIsMuted) {\n            return 'show-unmute';\n        } else if (oldIsMuted && !newIsMuted) {\n            return 'show-mute';\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if there are any changes in the contact status of the current user\n     * and other user.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildIsContact = function(state, newState) {\n        var loggedInUserId = state.loggedInUserId;\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n        var oldContactRequests = !oldOtherUser ? [] : oldOtherUser.contactrequests.filter(function(request) {\n            return (request.userid == loggedInUserId && request.requesteduserid == oldOtherUser.id) ||\n                (request.userid == oldOtherUser.id && request.requesteduserid == loggedInUserId);\n        });\n        var newContactRequests = !newOtherUser ? [] : newOtherUser.contactrequests.filter(function(request) {\n            return (request.userid == loggedInUserId && request.requesteduserid == newOtherUser.id) ||\n                (request.userid == newOtherUser.id && request.requesteduserid == loggedInUserId);\n        });\n        var oldHasContactRequests = oldContactRequests.length > 0;\n        var newHasContactRequests = newContactRequests.length > 0;\n\n        if (!oldOtherUser && !newOtherUser) {\n            return null;\n        } else if (oldHasContactRequests && newHasContactRequests) {\n            return null;\n        } else if (!oldHasContactRequests && newHasContactRequests && !newOtherUser.iscontact) {\n            return 'pending-contact';\n        } else if (!oldOtherUser && newOtherUser) {\n            return newOtherUser.iscontact ? 'contact' : null;\n        } else if (!newOtherUser && oldOtherUser) {\n            return oldOtherUser.iscontact ? 'non-contact' : null;\n        } else if (oldOtherUser.iscontact && !newOtherUser.iscontact) {\n            return newHasContactRequests ? 'pending-contact' : 'non-contact';\n        } else if (!oldOtherUser.iscontact && newOtherUser.iscontact) {\n            return 'contact';\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if a confirm action is active.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildLoadingConfirmationAction = function(state, newState) {\n        if (!state.loadingConfirmAction && newState.loadingConfirmAction) {\n            return true;\n        } else if (state.loadingConfirmAction && !newState.loadingConfirmAction) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Check if a edit mode is active.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildInEditMode = function(state, newState) {\n        var oldHasSelectedMessages = state.selectedMessageIds.length > 0;\n        var newHasSelectedMessages = newState.selectedMessageIds.length > 0;\n        var numberOfMessagesHasChanged = state.messages.length != newState.messages.length;\n\n        if (!oldHasSelectedMessages && newHasSelectedMessages) {\n            return true;\n        } else if (oldHasSelectedMessages && !newHasSelectedMessages) {\n            return false;\n        } else if (oldHasSelectedMessages && numberOfMessagesHasChanged) {\n            return true;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Build a patch for the messages selected.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} patch\n     */\n    var buildSelectedMessages = function(state, newState) {\n        var oldSelectedMessages = state.selectedMessageIds;\n        var newSelectedMessages = newState.selectedMessageIds;\n\n        if (isArrayEqual(oldSelectedMessages, newSelectedMessages)) {\n            return null;\n        }\n\n        var diff = diffArrays(oldSelectedMessages, newSelectedMessages, function(a, b) {\n            return a == b;\n        });\n\n        return {\n            count: newSelectedMessages.length,\n            add: diff.missingFromA,\n            remove: diff.missingFromB\n        };\n    };\n\n    /**\n     * Get a list of users from the state that are not the logged in user. Use to find group\n     * message members or the other user in a conversation.\n     *\n     * @param  {Object} state State\n     * @return {Array} List of users.\n     */\n    var getOtherUserFromState = function(state) {\n        return Object.keys(state.members).reduce(function(carry, userId) {\n            if (userId != state.loggedInUserId && !carry) {\n                carry = state.members[userId];\n            }\n\n            return carry;\n        }, null);\n    };\n\n    /**\n     * Check if the given user requires a contact request from the logged in user.\n     *\n     * @param  {Integer} loggedInUserId The logged in user id\n     * @param  {Object} user User record\n     * @return {Bool}\n     */\n    var requiresContactRequest = function(loggedInUserId, user) {\n        var contactRequests = user.contactrequests.filter(function(request) {\n            return request.userid == loggedInUserId || request.requesteduserid;\n        });\n        var hasSentContactRequest = contactRequests.length > 0;\n        return user.requirescontact && !user.iscontact && !hasSentContactRequest;\n    };\n\n    /**\n     * Check if other users are required to be added as contact.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} Object controlling the required to add contact dialog variables.\n     */\n    var buildRequireAddContact = function(state, newState) {\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n        var hadMessages = state.messages.length > 0;\n        var hasMessages = newState.messages.length > 0;\n        var loggedInUserId = newState.loggedInUserId;\n        var prevRequiresContactRequest = oldOtherUser && requiresContactRequest(loggedInUserId, oldOtherUser);\n        var nextRequiresContactRequest = newOtherUser && requiresContactRequest(loggedInUserId, newOtherUser);\n        var confirmAddContact = buildConfirmAddContact(state, newState);\n        var finishedAddContact = confirmAddContact === false;\n\n        // Still doing first load.\n        if (!state.hasTriedToLoadMessages && !newState.hasTriedToLoadMessages) {\n            return null;\n        }\n\n        // No users yet.\n        if (!oldOtherUser && !newOtherUser) {\n            return null;\n        }\n\n        // We've loaded a new user and they require a contact request.\n        if (!oldOtherUser && nextRequiresContactRequest) {\n            return {\n                show: true,\n                hasMessages: hasMessages,\n                user: newOtherUser\n            };\n        }\n\n        // The logged in user has completed the confirm contact request dialogue\n        // but the other user still requires a contact request which means the logged\n        // in user either declined the confirmation or it failed.\n        if (finishedAddContact && nextRequiresContactRequest) {\n            return {\n                show: true,\n                hasMessages: hasMessages,\n                user: newOtherUser\n            };\n        }\n\n        // Everything is loaded.\n        if (state.hasTriedToLoadMessages && newState.hasTriedToLoadMessages) {\n            if (!prevRequiresContactRequest && nextRequiresContactRequest) {\n                return {\n                    show: true,\n                    hasMessages: hasMessages,\n                    user: newOtherUser\n                };\n            }\n\n            if (prevRequiresContactRequest && !nextRequiresContactRequest) {\n                return {\n                    show: false,\n                    hasMessages: hasMessages\n                };\n            }\n        }\n\n        // First load just completed.\n        if (!state.hasTriedToLoadMessages && newState.hasTriedToLoadMessages) {\n            if (nextRequiresContactRequest) {\n                return {\n                    show: true,\n                    hasMessages: hasMessages,\n                    user: newOtherUser\n                };\n            }\n        }\n\n        // Being reset.\n        if (state.hasTriedToLoadMessages && !newState.hasTriedToLoadMessages) {\n            if (prevRequiresContactRequest) {\n                return {\n                    show: false,\n                    hasMessages: hadMessages\n                };\n            }\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if other users are required to be unblocked.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildRequireUnblock = function(state, newState) {\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n\n        if (!oldOtherUser && !newOtherUser) {\n            return null;\n        } else if (oldOtherUser && !newOtherUser) {\n            return oldOtherUser.isblocked ? false : null;\n        } else if (!oldOtherUser && newOtherUser) {\n            return newOtherUser.isblocked ? true : null;\n        } else if (!oldOtherUser.isblocked && newOtherUser.isblocked) {\n            return true;\n        } else if (oldOtherUser.isblocked && !newOtherUser.isblocked) {\n            return false;\n        }\n\n        return null;\n    };\n\n    /**\n     * Check if other users can be messaged.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Bool|Null}\n     */\n    var buildUnableToMessage = function(state, newState) {\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n\n        if (newState.type == Constants.CONVERSATION_TYPES.SELF) {\n            // Users always can send message themselves on self-conversations.\n            return null;\n        }\n\n        if (!oldOtherUser && !newOtherUser) {\n            return null;\n        } else if (oldOtherUser && !newOtherUser) {\n            return oldOtherUser.canmessage ? null : true;\n        } else if (!oldOtherUser && newOtherUser) {\n            return newOtherUser.canmessage ? null : true;\n        } else if (!oldOtherUser.canmessage && newOtherUser.canmessage) {\n            return false;\n        } else if (oldOtherUser.canmessage && !newOtherUser.canmessage) {\n            return true;\n        }\n\n        return null;\n    };\n\n    /**\n     * Build patch for footer information for a private conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} containing footer state type.\n     */\n    var buildFooterPatchTypePrivate = function(state, newState) {\n        var loadingFirstMessages = buildLoadingFirstMessages(state, newState);\n        var inEditMode = buildInEditMode(state, newState);\n        var requireAddContact = buildRequireAddContact(state, newState);\n        var requireUnblock = buildRequireUnblock(state, newState);\n        var unableToMessage = buildUnableToMessage(state, newState);\n        var showRequireAddContact = requireAddContact !== null ? requireAddContact.show && requireAddContact.hasMessages : null;\n        var otherUser = getOtherUserFromState(newState);\n        var generateReturnValue = function(checkValue, successReturn) {\n            if (checkValue) {\n                return successReturn;\n            } else if (checkValue !== null && !checkValue) {\n                if (!otherUser) {\n                    return {type: 'content'};\n                } else if (otherUser.isblocked) {\n                    return {type: 'unblock'};\n                } else if (newState.messages.length && requiresContactRequest(newState.loggedInUserId, otherUser)) {\n                    return {\n                        type: 'add-contact',\n                        user: otherUser\n                    };\n                } else if (!otherUser.canmessage || (otherUser.requirescontact && !otherUser.iscontact)) {\n                    return {type: 'unable-to-message'};\n                }\n            }\n\n            return null;\n        };\n\n        if (\n            loadingFirstMessages === null &&\n            inEditMode === null &&\n            requireAddContact === null &&\n            requireUnblock === null\n        ) {\n            return null;\n        }\n\n        var checks = [\n            [loadingFirstMessages, {type: 'placeholder'}],\n            [inEditMode, {type: 'edit-mode'}],\n            [unableToMessage, {type: 'unable-to-message'}],\n            [requireUnblock, {type: 'unblock'}],\n            [showRequireAddContact, {type: 'add-contact', user: otherUser}]\n        ];\n\n        for (var i = 0; i < checks.length; i++) {\n            var checkValue = checks[i][0];\n            var successReturn = checks[i][1];\n            var result = generateReturnValue(checkValue, successReturn);\n\n            if (result !== null) {\n                return result;\n            }\n        }\n\n        return {\n            type: 'content'\n        };\n    };\n\n    /**\n     * Build patch for footer information for a public conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} containing footer state type.\n     */\n    var buildFooterPatchTypePublic = function(state, newState) {\n        var loadingFirstMessages = buildLoadingFirstMessages(state, newState);\n        var inEditMode = buildInEditMode(state, newState);\n\n        if (loadingFirstMessages === null && inEditMode === null) {\n            return null;\n        }\n\n        if (loadingFirstMessages) {\n            return {type: 'placeholder'};\n        }\n\n        if (inEditMode) {\n            return {type: 'edit-mode'};\n        }\n\n        return {\n            type: 'content'\n        };\n    };\n\n    /**\n     * Check if we're viewing a different conversation. If so then we need to\n     * reset the UI.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {bool|null} If a reset needs to occur\n     */\n    var buildReset = function(state, newState) {\n        var oldType = state.type;\n        var newType = newState.type;\n        var oldConversationId = state.id;\n        var newConversationId = newState.id;\n        var oldMemberIds = Object.keys(state.members);\n        var newMemberIds = Object.keys(newState.members);\n\n        oldMemberIds.sort();\n        newMemberIds.sort();\n\n        var membersUnchanged = oldMemberIds.every(function(id, index) {\n            return id == newMemberIds[index];\n        });\n\n        if (oldType != newType) {\n            // If we've changed conversation type then we need to reset.\n            return true;\n        } else if (oldConversationId && !newConversationId) {\n            // We previously had a conversation id but no longer do. This likely means\n            // the user is viewing the conversation with someone they've never spoken to\n            // before.\n            return true;\n        } else if (oldConversationId && newConversationId && oldConversationId != newConversationId) {\n            // If we had a conversation id and it's changed then we need to reset.\n            return true;\n        } else if (!oldConversationId && !newConversationId && !membersUnchanged) {\n            // If we never had a conversation id but the members of the conversation have\n            // changed then we need to reset. This can happen if the user goes from viewing\n            // a user they've never had a conversation with to viewing a different user that\n            // they've never had a conversation with.\n            return true;\n        }\n\n        return null;\n    };\n\n    /**\n     * We should show this message always, for all the self-conversations.\n     *\n     * The message should be hidden when it's not a self-conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {bool}\n     */\n    var buildSelfConversationMessage = function(state, newState) {\n        if (state.type != newState.type) {\n            return (newState.type == Constants.CONVERSATION_TYPES.SELF);\n        }\n\n        return null;\n    };\n\n    /**\n     * We should show the contact request sent message if the user just sent\n     * a contact request to the other user and there are no messages in the\n     * conversation.\n     *\n     * The messages should be hidden when there are messages in the conversation.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {string|false|null}\n     */\n    var buildContactRequestSent = function(state, newState) {\n        var loggedInUserId = newState.loggedInUserId;\n        var oldOtherUser = getOtherUserFromState(state);\n        var newOtherUser = getOtherUserFromState(newState);\n        var oldSentRequests = !oldOtherUser ? [] : oldOtherUser.contactrequests.filter(function(request) {\n            return request.userid == loggedInUserId;\n        });\n        var newSentRequests = !newOtherUser ? [] : newOtherUser.contactrequests.filter(function(request) {\n            return request.userid == loggedInUserId;\n        });\n        var oldRequest = oldSentRequests.length > 0;\n        var newRequest = newSentRequests.length > 0;\n        var hadMessages = state.messages.length > 0;\n        var hasMessages = state.messages.length > 0;\n\n        if (!oldRequest && newRequest && !newOtherUser.iscontact && !hasMessages) {\n            return newOtherUser.fullname;\n        } else if (oldOtherUser && !oldOtherUser.iscontact && newRequest && newOtherUser.iscontact) {\n            // Contact request accepted.\n            return false;\n        } else if (oldRequest && !newRequest) {\n            return false;\n        } else if (!hadMessages && hasMessages) {\n            return false;\n        } else {\n            return null;\n        }\n    };\n\n    /**\n     * Build the full patch comparing the current state and the new state. This patch is used by\n     * the conversation renderer to render the UI on any update.\n     *\n     * @param  {Object} state The current state.\n     * @param  {Object} newState The new state.\n     * @return {Object} Patch containing all information changed.\n     */\n    var buildPatch = function(state, newState) {\n        var config = {\n            all: {\n                reset: buildReset,\n                conversation: buildConversationPatch,\n                scrollToMessage: buildScrollToMessagePatch,\n                loadingMembers: buildLoadingMembersPatch,\n                loadingFirstMessages: buildLoadingFirstMessages,\n                loadingMessages: buildLoadingMessages,\n                sendingMessage: buildSendingMessage,\n                confirmDeleteSelectedMessages: buildConfirmDeleteSelectedMessages,\n                inEditMode: buildInEditMode,\n                selectedMessages: buildSelectedMessages,\n                isFavourite: buildIsFavourite,\n                isMuted: buildIsMuted\n            }\n        };\n        // These build functions are only applicable to private conversations.\n        config[Constants.CONVERSATION_TYPES.PRIVATE] = {\n            header: buildHeaderPatchTypePrivate,\n            footer: buildFooterPatchTypePrivate,\n            confirmBlockUser: buildConfirmBlockUser,\n            confirmUnblockUser: buildConfirmUnblockUser,\n            confirmAddContact: buildConfirmAddContact,\n            confirmRemoveContact: buildConfirmRemoveContact,\n            confirmContactRequest: buildConfirmContactRequest,\n            confirmDeleteConversation: buildConfirmDeleteConversation,\n            isBlocked: buildIsBlocked,\n            isContact: buildIsContact,\n            loadingConfirmAction: buildLoadingConfirmationAction,\n            requireAddContact: buildRequireAddContact,\n            contactRequestSent: buildContactRequestSent\n        };\n        // These build functions are only applicable to public (group) conversations.\n        config[Constants.CONVERSATION_TYPES.PUBLIC] = {\n            header: buildHeaderPatchTypePublic,\n            footer: buildFooterPatchTypePublic,\n        };\n        // These build functions are only applicable to self-conversations.\n        config[Constants.CONVERSATION_TYPES.SELF] = {\n            header: buildHeaderPatchTypeSelf,\n            footer: buildFooterPatchTypePublic,\n            confirmDeleteConversation: buildConfirmDeleteConversation,\n            selfConversationMessage: buildSelfConversationMessage\n        };\n\n        var patchConfig = $.extend({}, config.all);\n        if (newState.type && newState.type in config) {\n            // Add the type specific builders to the patch config.\n            patchConfig = $.extend(patchConfig, config[newState.type]);\n        }\n\n        return Object.keys(patchConfig).reduce(function(patch, key) {\n            var buildFunc = patchConfig[key];\n            var value = buildFunc(state, newState);\n\n            if (value !== null) {\n                patch[key] = value;\n            }\n\n            return patch;\n        }, {});\n    };\n\n    return {\n        buildPatch: buildPatch\n    };\n});\n"],"file":"message_drawer_view_conversation_patcher.min.js"}