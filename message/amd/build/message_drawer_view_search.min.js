define(["jquery","core/custom_interaction_events","core/notification","core/pubsub","core/templates","core_message/message_repository","core_message/message_drawer_events"],function(a,b,c,d,e,f,g){var h=50,i=50,j=3,k={BLOCK_ICON_CONTAINER:'[data-region="block-icon-container"]',CANCEL_SEARCH_BUTTON:'[data-action="cancel-search"]',CONTACTS_CONTAINER:'[data-region="contacts-container"]',CONTACTS_LIST:'[data-region="contacts-container"] [data-region="list"]',EMPTY_MESSAGE_CONTAINER:'[data-region="empty-message-container"]',LIST:'[data-region="list"]',LOADING_ICON_CONTAINER:'[data-region="loading-icon-container"]',LOADING_PLACEHOLDER:'[data-region="loading-placeholder"]',MESSAGES_LIST:'[data-region="messages-container"] [data-region="list"]',MESSAGES_CONTAINER:'[data-region="messages-container"]',NON_CONTACTS_CONTAINER:'[data-region="non-contacts-container"]',NON_CONTACTS_LIST:'[data-region="non-contacts-container"] [data-region="list"]',SEARCH_ICON_CONTAINER:'[data-region="search-icon-container"]',SEARCH_ACTION:'[data-action="search"]',SEARCH_INPUT:'[data-region="search-input"]',SEARCH_RESULTS_CONTAINER:'[data-region="search-results-container"]',LOAD_MORE_USERS:'[data-action="load-more-users"]',LOAD_MORE_MESSAGES:'[data-action="load-more-messages"]',BUTTON_TEXT:'[data-region="button-text"]',NO_RESULTS_CONTAINTER:'[data-region="no-results-container"]'},l={CONTACTS_LIST:"core_message/message_drawer_contacts_list",NON_CONTACTS_LIST:"core_message/message_drawer_non_contacts_list",MESSAGES_LIST:"core_message/message_drawer_messages_list"},m=function(a){return parseInt(a.attr("data-users-offset"),10)},n=function(a){return parseInt(a.attr("data-messages-offset"),10)},o=function(a,b){return a.attr("data-users-offset",b)},p=function(a,b){return a.attr("data-messages-offset",b)},q=function(a){return a.attr("data-user-id")},r=function(a){return a.find(k.EMPTY_MESSAGE_CONTAINER)},s=function(a){return a.find(k.LOADING_ICON_CONTAINER)},t=function(a){return a.find(k.LOADING_PLACEHOLDER)},u=function(a){return a.find(k.SEARCH_ICON_CONTAINER)},v=function(a){return a.find(k.SEARCH_INPUT)},w=function(a){return a.find(k.SEARCH_RESULTS_CONTAINER)},x=function(a){return a.find(k.CONTACTS_CONTAINER)},y=function(a){return a.find(k.NON_CONTACTS_CONTAINER)},z=function(a){return a.find(k.MESSAGES_CONTAINER)},A=function(a){r(a).removeClass("hidden")},B=function(a){r(a).addClass("hidden")},C=function(a){s(a).removeClass("hidden")},D=function(a){s(a).addClass("hidden")},E=function(a){t(a).removeClass("hidden")},F=function(a){t(a).addClass("hidden")},G=function(a){u(a).removeClass("hidden")},H=function(a){u(a).addClass("hidden")},I=function(a){w(a).removeClass("hidden")},J=function(a){w(a).addClass("hidden")},K=function(a){v(a).prop("disabled",!0)},L=function(a){v(a).prop("disabled",!1)},M=function(a){v(a).val("")},N=function(a){a.find(k.CONTACTS_LIST).empty(),a.find(k.NON_CONTACTS_LIST).empty(),a.find(k.MESSAGES_LIST).empty(),a.find(k.NO_RESULTS_CONTAINTER).addClass("hidden"),S(a),W(a)},O=function(a,b){H(a),B(b),J(b),C(a),E(b),K(a)},P=function(a,b){G(a),B(b),I(b),D(a),F(b),L(a)},Q=function(a){var b=a.find(k.LOAD_MORE_USERS);b.prop("disabled",!0),b.find(k.BUTTON_TEXT).addClass("hidden"),b.find(k.LOADING_ICON_CONTAINER).removeClass("hidden")},R=function(a){var b=a.find(k.LOAD_MORE_USERS);b.prop("disabled",!1),b.find(k.BUTTON_TEXT).removeClass("hidden"),b.find(k.LOADING_ICON_CONTAINER).addClass("hidden")},S=function(a){a.find(k.LOAD_MORE_USERS).removeClass("hidden")},T=function(a){a.find(k.LOAD_MORE_USERS).addClass("hidden")},U=function(a){var b=a.find(k.LOAD_MORE_MESSAGES);b.prop("disabled",!0),b.find(k.BUTTON_TEXT).addClass("hidden"),b.find(k.LOADING_ICON_CONTAINER).removeClass("hidden")},V=function(a){var b=a.find(k.LOAD_MORE_MESSAGES);b.prop("disabled",!1),b.find(k.BUTTON_TEXT).removeClass("hidden"),b.find(k.LOADING_ICON_CONTAINER).addClass("hidden")},W=function(a){a.find(k.LOAD_MORE_MESSAGES).removeClass("hidden")},X=function(a){a.find(k.LOAD_MORE_MESSAGES).addClass("hidden")},Y=function(a,b){return a.find('[data-contact-user-id="'+b+'"]')},Z=function(a,b){var c=y(a),d=Y(c,b.userid);if(d.length){d.remove();var e=x(a);e.removeClass("hidden"),e.find(k.LIST).append(d)}c.find(k.LIST).children().length||c.addClass("hidden")},$=function(a,b){var c=x(a),d=Y(c,b);if(d.length){d.remove();var e=y(a);e.removeClass("hidden"),e.find(k.LIST).append(d)}c.find(k.LIST).children().length||c.addClass("hidden")},_=function(a,b){var c=Y(a,b);c.length&&c.find(k.BLOCK_ICON_CONTAINER).removeClass("hidden")},aa=function(a,b){var c=Y(a,b);c.length&&c.find(k.BLOCK_ICON_CONTAINER).addClass("hidden")},ba=function(b,c){var d=x(b),f=d.find(k.LIST);if(c.length||f.children().length)return e.render(l.CONTACTS_LIST,{contacts:c}).then(function(a){f.append(a)});var g=d.find(k.NO_RESULTS_CONTAINTER);return g.removeClass("hidden"),a.Deferred().resolve("").promise()},ca=function(b,c){var d=y(b),f=d.find(k.LIST);if(c.length||f.children().length)return e.render(l.NON_CONTACTS_LIST,{noncontacts:c}).then(function(a){f.append(a)});var g=d.find(k.NO_RESULTS_CONTAINTER);return g.removeClass("hidden"),a.Deferred().resolve("").promise()},da=function(b,c){var d=z(b),f=d.find(k.LIST);if(c.length||f.children().length)return e.render(l.MESSAGES_LIST,{messages:c}).then(function(a){f.append(a)});var g=d.find(k.NO_RESULTS_CONTAINTER);return g.removeClass("hidden"),a.Deferred().resolve("").promise()},ea=function(b,c,d,e,g){var h=!1;return Q(b),f.searchUsers(c,d,e+1,g).then(function(a){var b=a.contacts,c=a.noncontacts;return b.length<=e&&c.length<=e?(h=!0,{contacts:b,noncontacts:c}):{contacts:b.slice(0,e),noncontacts:c.slice(0,e)}}).then(function(c){return a.when(ba(b,c.contacts),ca(b,c.noncontacts))}).then(function(){o(b,g+e),R(b),h&&T(b)})["catch"](function(){R(b)})},fa=function(a,b,c,d,e){var g=!1;return U(a),f.searchMessages(b,c,d+1,e).then(function(a){var b=a.contacts;return b.length<=d?(g=!0,b):b.slice(0,d)}).then(function(b){return da(a,b)}).then(function(){p(a,e+d),V(a),g&&X(a)})["catch"](function(){V(a)})},ga=function(b,d,e){var f=q(d);return O(b,d),o(d,0),p(d,0),N(d),a.when(ea(d,f,e,j,0),fa(d,f,e,h,0)).then(function(){P(b,d)})["catch"](function(a){c.exception(a),P(b,d)})},ha=function(a,c){var e=q(c),f=v(a),j="",l=function(b,d){j=f.val().trim(),""!==j&&ga(a,c,j).then(function(){f.focus()}),d.originalEvent.preventDefault()};b.define(f,[b.events.enter]),b.define(a,[b.events.activate]),b.define(c,[b.events.activate]),f.on(b.events.enter,l),a.on(b.events.activate,k.SEARCH_ACTION,l),c.on(b.events.activate,k.LOAD_MORE_MESSAGES,function(a,b){if(""!==j){var d=n(c);fa(c,e,j,h,d)}b.originalEvent.preventDefault()}),c.on(b.events.activate,k.LOAD_MORE_USERS,function(a,b){if(""!==j){var d=m(c);ea(c,e,j,i,d)}b.originalEvent.preventDefault()}),a.on(b.events.activate,k.CANCEL_SEARCH_BUTTON,function(){M(a),A(c),G(a),J(c),D(a),F(c),o(c,0),p(c,0)}),d.subscribe(g.CONTACT_ADDED,function(a){Z(c,a)}),d.subscribe(g.CONTACT_REMOVED,function(a){$(c,a)}),d.subscribe(g.CONTACT_BLOCKED,function(a){_(c,a)}),d.subscribe(g.CONTACT_UNBLOCKED,function(a){aa(c,a)})},ia=function(a,b){b.attr("data-init")||(ha(a,b),b.attr("data-init",!0));var c=v(a);c.focus()};return{show:ia}});