'use strict';define('message_popup/message_popover_controller',['jquery','core/ajax','core/templates','core/str','core/notification','core/custom_interaction_events','core/popover_region_controller','core_message/message_repository','core/url'],function($,Ajax,Templates,Str,Notification,CustomEvents,PopoverController,MessageRepo,URL){var SELECTORS={MARK_ALL_READ_BUTTON:'[data-action="mark-all-read"]',CONTENT:'[data-region="messages"]',CONTENT_ITEM_CONTAINER:'[data-region="message-content-item-container"]',EMPTY_MESSAGE:'[data-region="empty-message"]',COUNT_CONTAINER:'[data-region="count-container"]'},MessagePopoverController=function(element){PopoverController.call(this,element),this.markAllReadButton=this.root.find(SELECTORS.MARK_ALL_READ_BUTTON),this.content=this.root.find(SELECTORS.CONTENT),this.userId=this.root.attr('data-userid'),this.limit=20,this.offset=0,this.loadedAll=!1,this.initialLoad=!1,this.unreadCount=this.root.find(SELECTORS.COUNT_CONTAINER).html()};return MessagePopoverController.prototype=Object.create(PopoverController.prototype),MessagePopoverController.prototype.constructor=MessagePopoverController,MessagePopoverController.prototype.getContent=function(){return this.content},MessagePopoverController.prototype.incrementOffset=function(){this.offset+=this.limit},MessagePopoverController.prototype.updateButtonAriaLabel=function(){this.isMenuOpen()?Str.get_string('hidemessagewindow','message').done(function(string){this.menuToggle.attr('aria-label',string)}.bind(this)):this.unreadCount?Str.get_string('showmessagewindowwithcount','message',this.unreadCount).done(function(string){this.menuToggle.attr('aria-label',string)}.bind(this)):Str.get_string('showmessagewindownonew','message').done(function(string){this.menuToggle.attr('aria-label',string)}.bind(this))},MessagePopoverController.prototype.renderUnreadCount=function(){var element=this.root.find(SELECTORS.COUNT_CONTAINER);this.unreadCount?(element.text(this.unreadCount),element.removeClass('hidden')):element.addClass('hidden')},MessagePopoverController.prototype.hideUnreadCount=function(){this.root.find(SELECTORS.COUNT_CONTAINER).addClass('hidden')},MessagePopoverController.prototype.renderMessages=function(messages,container){var promises=[];return $.each(messages,function(index,message){message.contexturl=URL.relativeUrl('/message/index.php',{user:this.userId,id:message.userid}),message.profileurl=URL.relativeUrl('/user/profile.php',{id:message.userid});var promise=Templates.render('message_popup/message_content_item',message).then(function(html,js){return{html:html,js:js}});promises.push(promise)}.bind(this)),$.when.apply($,promises).then(function(){$.each(arguments,function(index,argument){container.append(argument.html),Templates.runTemplateJS(argument.js)})})},MessagePopoverController.prototype.loadMoreMessages=function(){if(this.isLoading||this.loadedAll)return $.Deferred().resolve();this.startLoading();var request={userid:this.userId,limit:this.limit,offset:this.offset},container=this.getContent();return MessageRepo.query(request).then(function(result){var messages=result.contacts;return this.loadedAll=!messages.length||messages.length<this.limit,this.initialLoad=!0,this.updateButtonAriaLabel(),!!messages.length&&(this.incrementOffset(),this.renderMessages(messages,container))}.bind(this)).always(function(){this.stopLoading()}.bind(this))},MessagePopoverController.prototype.markAllAsRead=function(){return this.markAllReadButton.hasClass('loading')?$.Deferred().resolve():(this.markAllReadButton.addClass('loading'),MessageRepo.markAllAsRead({useridto:this.userId}).then(function(){this.unreadCount=0,this.hideUnreadCount(),this.getContent().find(SELECTORS.CONTENT_ITEM_CONTAINER).removeClass('unread')}.bind(this)).always(function(){this.markAllReadButton.removeClass('loading')}.bind(this)))},MessagePopoverController.prototype.registerEventListeners=function(){CustomEvents.define(this.root,[CustomEvents.events.keyboardActivate]),this.root.on(this.events().menuOpened,function(){this.hideUnreadCount(),this.updateButtonAriaLabel(),this.initialLoad||this.loadMoreMessages()}.bind(this)),this.root.on(this.events().menuClosed,function(){this.renderUnreadCount(),this.updateButtonAriaLabel()}.bind(this)),this.root.on(CustomEvents.events.scrollBottom,function(){this.loadMoreMessages()}.bind(this)),this.root.on(CustomEvents.events.activate,SELECTORS.MARK_ALL_READ_BUTTON,function(e,data){this.markAllAsRead(),e.stopPropagation(),data.originalEvent.preventDefault()}.bind(this)),CustomEvents.define(this.getContentContainer(),[CustomEvents.events.scrollLock]),$(document).on('messagearea:conversationselected',function(){this.unreadCount--,this.renderUnreadCount()}.bind(this))},MessagePopoverController});
//# sourceMappingURL=message_popover_controller.min.js.map
