{"version":3,"sources":["../src/usertours.js"],"names":["define","ajax","BootstrapTour","$","templates","str","log","notification","usertours","tourId","currentTour","context","init","startTour","fetchTour","addResetLink","on","e","preventDefault","resetTourState","M","util","js_pending","when","call","methodname","args","tourid","pageurl","window","location","href","render","then","response","template","startBootstrapTour","tourconfig","always","js_complete","fail","exception","ele","length","html","js","appendNodeContents","tourConfig","onEnd","endTour","eventHandlers","afterEnd","markTourComplete","afterRender","markStepShown","tourName","name","steps","map","step","element","target","reflex","moveOnClick","content","body","stepConfig","getStepConfig","getCurrentStepNumber","stepid","stepindex","error"],"mappings":"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","file":"usertours.min.js","sourcesContent":["/**\n * User tour control library.\n *\n * @module     tool_usertours/usertours\n * @class      usertours\n * @package    tool_usertours\n * @copyright  2016 Andrew Nicols <andrew@nicols.co.uk>\n */\ndefine(\n['core/ajax', 'tool_usertours/tour', 'jquery', 'core/templates', 'core/str', 'core/log', 'core/notification'],\nfunction(ajax, BootstrapTour, $, templates, str, log, notification) {\n    var usertours = {\n        tourId: null,\n\n        currentTour: null,\n\n        context: null,\n\n        /**\n         * Initialise the user tour for the current page.\n         *\n         * @method  init\n         * @param   {Number}    tourId      The ID of the tour to start.\n         * @param   {Bool}      startTour   Attempt to start the tour now.\n         * @param   {Number}    context     The context of the current page.\n         */\n        init: function(tourId, startTour, context) {\n            // Only one tour per page is allowed.\n            usertours.tourId = tourId;\n\n            usertours.context = context;\n\n            if (typeof startTour === 'undefined') {\n                startTour = true;\n            }\n\n            if (startTour) {\n                // Fetch the tour configuration.\n                usertours.fetchTour(tourId);\n            }\n\n            usertours.addResetLink();\n            // Watch for the reset link.\n            $('body').on('click', '[data-action=\"tool_usertours/resetpagetour\"]', function(e) {\n                e.preventDefault();\n                usertours.resetTourState(usertours.tourId);\n            });\n        },\n\n        /**\n         * Fetch the configuration specified tour, and start the tour when it has been fetched.\n         *\n         * @method  fetchTour\n         * @param   {Number}    tourId      The ID of the tour to start.\n         */\n        fetchTour: function(tourId) {\n            M.util.js_pending('admin_usertour_fetchTour' + tourId);\n            $.when(\n                ajax.call([\n                    {\n                        methodname: 'tool_usertours_fetch_and_start_tour',\n                        args: {\n                            tourid:     tourId,\n                            context:    usertours.context,\n                            pageurl:    window.location.href,\n                        }\n                    }\n                ])[0],\n                templates.render('tool_usertours/tourstep', {})\n            )\n            .then(function(response, template) {\n                return usertours.startBootstrapTour(tourId, template[0], response.tourconfig);\n            })\n            .always(function() {\n                M.util.js_complete('admin_usertour_fetchTour' + tourId);\n\n                return;\n            })\n            .fail(notification.exception);\n        },\n\n        /**\n         * Add a reset link to the page.\n         *\n         * @method  addResetLink\n         */\n        addResetLink: function() {\n            var ele;\n            M.util.js_pending('admin_usertour_addResetLink');\n\n            // Append the link to the most suitable place on the page\n            // with fallback to legacy selectors and finally the body\n            // if there is no better place.\n            if ($('.tool_usertours-resettourcontainer').length) {\n                ele = $('.tool_usertours-resettourcontainer');\n            } else if ($('.logininfo').length) {\n                ele = $('.logininfo');\n            } else if ($('footer').length) {\n                ele = $('footer');\n            } else {\n                ele = $('body');\n            }\n            templates.render('tool_usertours/resettour', {})\n            .then(function(html, js) {\n                templates.appendNodeContents(ele, html, js);\n\n                return;\n            })\n            .always(function() {\n                M.util.js_complete('admin_usertour_addResetLink');\n\n                return;\n            })\n            .fail();\n        },\n\n        /**\n         * Start the specified tour.\n         *\n         * @method  startBootstrapTour\n         * @param   {Number}    tourId      The ID of the tour to start.\n         * @param   {String}    template    The template to use.\n         * @param   {Object}    tourConfig  The tour configuration.\n         * @return  {Object}\n         */\n        startBootstrapTour: function(tourId, template, tourConfig) {\n            if (usertours.currentTour) {\n                // End the current tour, but disable end tour handler.\n                tourConfig.onEnd = null;\n                usertours.currentTour.endTour();\n                delete usertours.currentTour;\n            }\n\n            // Normalize for the new library.\n            tourConfig.eventHandlers = {\n                afterEnd: [usertours.markTourComplete],\n                afterRender: [usertours.markStepShown],\n            };\n\n            // Sort out the tour name.\n            tourConfig.tourName = tourConfig.name;\n            delete tourConfig.name;\n\n            // Add the template to the configuration.\n            // This enables translations of the buttons.\n            tourConfig.template = template;\n\n            tourConfig.steps = tourConfig.steps.map(function(step) {\n                if (typeof step.element !== 'undefined') {\n                    step.target = step.element;\n                    delete step.element;\n                }\n\n                if (typeof step.reflex !== 'undefined') {\n                    step.moveOnClick = !!step.reflex;\n                    delete step.reflex;\n                }\n\n                if (typeof step.content !== 'undefined') {\n                    step.body = step.content;\n                    delete step.content;\n                }\n\n                return step;\n            });\n\n            usertours.currentTour = new BootstrapTour(tourConfig);\n            return usertours.currentTour.startTour();\n        },\n\n        /**\n         * Mark the specified step as being shownd by the user.\n         *\n         * @method  markStepShown\n         */\n        markStepShown: function() {\n            var stepConfig = this.getStepConfig(this.getCurrentStepNumber());\n            $.when(\n                ajax.call([\n                    {\n                        methodname: 'tool_usertours_step_shown',\n                        args: {\n                            tourid:     usertours.tourId,\n                            context:    usertours.context,\n                            pageurl:    window.location.href,\n                            stepid:     stepConfig.stepid,\n                            stepindex:  this.getCurrentStepNumber(),\n                        }\n                    }\n                ])[0]\n            ).fail(log.error);\n        },\n\n        /**\n         * Mark the specified tour as being completed by the user.\n         *\n         * @method  markTourComplete\n         */\n        markTourComplete: function() {\n            var stepConfig = this.getStepConfig(this.getCurrentStepNumber());\n            $.when(\n                ajax.call([\n                    {\n                        methodname: 'tool_usertours_complete_tour',\n                        args: {\n                            tourid:     usertours.tourId,\n                            context:    usertours.context,\n                            pageurl:    window.location.href,\n                            stepid:     stepConfig.stepid,\n                            stepindex:  this.getCurrentStepNumber(),\n                        }\n                    }\n                ])[0]\n            ).fail(log.error);\n        },\n\n        /**\n         * Reset the state, and restart the the tour on the current page.\n         *\n         * @method  resetTourState\n         * @param   {Number}    tourId      The ID of the tour to start.\n         */\n        resetTourState: function(tourId) {\n            $.when(\n                ajax.call([\n                    {\n                        methodname: 'tool_usertours_reset_tour',\n                        args: {\n                            tourid:     tourId,\n                            context:    usertours.context,\n                            pageurl:    window.location.href,\n                        }\n                    }\n                ])[0]\n            ).then(function(response) {\n                if (response.startTour) {\n                    usertours.fetchTour(response.startTour);\n                }\n                return;\n            }).fail(notification.exception);\n        }\n    };\n\n    return /** @alias module:tool_usertours/usertours */ {\n        /**\n         * Initialise the user tour for the current page.\n         *\n         * @method  init\n         * @param   {Number}    tourId      The ID of the tour to start.\n         * @param   {Bool}      startTour   Attempt to start the tour now.\n         */\n        init: usertours.init,\n\n        /**\n         * Reset the state, and restart the the tour on the current page.\n         *\n         * @method  resetTourState\n         * @param   {Number}    tourId      The ID of the tour to restart.\n         */\n        resetTourState: usertours.resetTourState\n    };\n});\n"]}