{"version":3,"sources":["../src/tour.js"],"names":["Tour","config","init","Math","ceil","eventHandlers","reset","originalConfiguration","configure","apply","arguments","storage","window","sessionStorage","storageKey","tourName","e","hide","resetStepListeners","steps","currentStepNumber","eventName","forEach","handler","addEventHandler","resetStepDefaults","template","templateContent","checkMinimumRequirements","Error","length","loadOriginalConfiguration","stepDefaults","setStepDefaults","$","extend","element","placement","delay","moveOnClick","moveAfterTime","orphan","direction","parseInt","stepNumber","setItem","code","DOMException","QUOTA_EXCEEDED_ERR","removeItem","getCurrentStepNumber","nextStepNumber","isStepPotentiallyVisible","getStepConfig","previousStepNumber","getNextStepNumber","getPreviousStepNumber","stepConfig","isStepActuallyVisible","target","getStepTarget","is","gotoStep","endTour","_gotoStep","delayed","setTimeout","bind","fn","fireEventHandlers","renderStep","normalizeStepConfig","reflex","moveAfterClick","content","body","attachTo","attachPoint","first","data","thisEvent","call","push","listeners","node","currentStepNode","args","proxy","next","previous","closest","handleKeyDown","targetNode","parents","listener","on","off","currentStepConfig","setCurrentStepNumber","getTemplateContent","find","html","title","isFirstStep","prop","isLastStep","attr","addStepToPage","processStepListeners","clone","animationTarget","stop","zIndex","calculateZIndex","css","positionBackdrop","document","append","top","left","animate","scrollTop","calculateScrollTop","promise","then","positionStep","revealStep","isOrphan","addClass","offset","calculateStepPositionInPage","currentStepPopper","Popper","removeOnDestroy","arrowElement","modifiers","enabled","applyStyle","onLoad","fadeIn","announceStep","focus","stepId","bodyRegion","headerRegion","accessibilityShow","tabbableSelector","keyCode","hasBackdrop","activeElement","stepTarget","tabbableNodes","dialogContainer","currentIndex","filter","index","has","each","nextIndex","nextNode","focusRelevant","shiftKey","last","preventDefault","startAt","storageStartValue","getItem","storageStartAt","startTour","previousTarget","transition","destroy","fadeTime","remove","removeAttr","fadeOut","currentStepElement","accessibilityHide","viewportHeight","height","max","min","stepHeight","viewportWidth","width","stepWidth","flipBehavior","flip","behaviour","arrow","onCreate","recalculateArrowPosition","onUpdate","split","isVertical","indexOf","instance","popper","querySelector","stepElement","arrowHeight","parseFloat","getComputedStyle","arrowOffset","popperHeight","popperOffset","popperBorderWidth","popperBorderRadiusWidth","arrowPos","maxPos","minPos","newArrowPos","arrowWidth","popperWidth","background","backdrop","insertAfter","colorNode","outerWidth","outerHeight","backgroundColor","calculateInherittedBackgroundColor","targetRadius","targetPosition","calculatePosition","fader","opacity","elem","position","value","isNaN","parent","fakeNode","fakeElemColor","color","hideFunction","child","flexitourRole","hidden","siblings","parentsUntil","showFunction"],"mappings":"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","file":"tour.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Manage user tours in Moodle.\n *\n * @copyright  2018 Andrew Nicols <andrew@nicols.co.uk>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport $ from 'jquery';\nimport Popper from 'core/popper';\n\n/**\n * A Tour.\n *\n * @class Tour\n */\nexport default class Tour {\n    /**\n     * @param   {object}    config  The configuration object.\n     */\n    constructor(config) {\n        this.init(config);\n    }\n\n    /**\n     * Initialise the tour.\n     *\n     * @method  init\n     * @param   {Object}    config  The configuration object.\n     * @chainable\n     * @return {Object} this.\n     */\n    init(config) {\n        // Unset all handlers.\n        this.eventHandlers = {};\n\n        // Reset the current tour states.\n        this.reset();\n\n        // Store the initial configuration.\n        this.originalConfiguration = config || {};\n\n        // Apply configuration.\n        this.configure.apply(this, arguments);\n\n        try {\n            this.storage = window.sessionStorage;\n            this.storageKey = 'tourstate_' + this.tourName;\n        } catch (e) {\n            this.storage = false;\n            this.storageKey = '';\n        }\n\n        return this;\n    }\n\n    /**\n     * Reset the current tour state.\n     *\n     * @method  reset\n     * @chainable\n     * @return {Object} this.\n     */\n    reset() {\n        // Hide the current step.\n        this.hide();\n\n        // Unset all handlers.\n        this.eventHandlers = [];\n\n        // Unset all listeners.\n        this.resetStepListeners();\n\n        // Unset the original configuration.\n        this.originalConfiguration = {};\n\n        // Reset the current step number and list of steps.\n        this.steps = [];\n\n        // Reset the current step number.\n        this.currentStepNumber = 0;\n\n        return this;\n    }\n\n    /**\n     * Prepare tour configuration.\n     *\n     * @method  configure\n     * @param {Object} config The configuration object.\n     * @chainable\n     * @return {Object} this.\n     */\n    configure(config) {\n        if (typeof config === 'object') {\n            // Tour name.\n            if (typeof config.tourName !== 'undefined') {\n                this.tourName = config.tourName;\n            }\n\n            // Set up eventHandlers.\n            if (config.eventHandlers) {\n                for (let eventName in config.eventHandlers) {\n                    config.eventHandlers[eventName].forEach(function(handler) {\n                        this.addEventHandler(eventName, handler);\n                    }, this);\n                }\n            }\n\n            // Reset the step configuration.\n            this.resetStepDefaults(true);\n\n            // Configure the steps.\n            if (typeof config.steps === 'object') {\n                this.steps = config.steps;\n            }\n\n            if (typeof config.template !== 'undefined') {\n                this.templateContent = config.template;\n            }\n        }\n\n        // Check that we have enough to start the tour.\n        this.checkMinimumRequirements();\n\n        return this;\n    }\n\n    /**\n     * Check that the configuration meets the minimum requirements.\n     *\n     * @method  checkMinimumRequirements\n     */\n    checkMinimumRequirements() {\n        // Need a tourName.\n        if (!this.tourName) {\n            throw new Error(\"Tour Name required\");\n        }\n\n        // Need a minimum of one step.\n        if (!this.steps || !this.steps.length) {\n            throw new Error(\"Steps must be specified\");\n        }\n    }\n\n    /**\n     * Reset step default configuration.\n     *\n     * @method  resetStepDefaults\n     * @param   {Boolean}   loadOriginalConfiguration   Whether to load the original configuration supplied with the Tour.\n     * @chainable\n     * @return {Object} this.\n     */\n    resetStepDefaults(loadOriginalConfiguration) {\n        if (typeof loadOriginalConfiguration === 'undefined') {\n            loadOriginalConfiguration = true;\n        }\n\n        this.stepDefaults = {};\n        if (!loadOriginalConfiguration || typeof this.originalConfiguration.stepDefaults === 'undefined') {\n            this.setStepDefaults({});\n        } else {\n            this.setStepDefaults(this.originalConfiguration.stepDefaults);\n        }\n\n        return this;\n    }\n\n    /**\n     * Set the step defaults.\n     *\n     * @method  setStepDefaults\n     * @param   {Object}    stepDefaults                The step defaults to apply to all steps\n     * @chainable\n     * @return {Object} this.\n     */\n    setStepDefaults(stepDefaults) {\n        if (!this.stepDefaults) {\n            this.stepDefaults = {};\n        }\n        $.extend(\n            this.stepDefaults,\n            {\n                element:        '',\n                placement:      'top',\n                delay:          0,\n                moveOnClick:    false,\n                moveAfterTime:  0,\n                orphan:         false,\n                direction:      1,\n            },\n            stepDefaults\n        );\n\n        return this;\n    }\n\n    /**\n     * Retrieve the current step number.\n     *\n     * @method  getCurrentStepNumber\n     * @return  {Integer}                   The current step number\n     */\n    getCurrentStepNumber() {\n        return parseInt(this.currentStepNumber, 10);\n    }\n\n    /**\n     * Store the current step number.\n     *\n     * @method  setCurrentStepNumber\n     * @param   {Integer}   stepNumber      The current step number\n     * @chainable\n     */\n    setCurrentStepNumber(stepNumber) {\n        this.currentStepNumber = stepNumber;\n        if (this.storage) {\n            try {\n                this.storage.setItem(this.storageKey, stepNumber);\n            } catch (e) {\n                if (e.code === DOMException.QUOTA_EXCEEDED_ERR) {\n                    this.storage.removeItem(this.storageKey);\n                }\n            }\n        }\n    }\n\n    /**\n     * Get the next step number after the currently displayed step.\n     *\n     * @method  getNextStepNumber\n     * @param   {Integer}   stepNumber      The current step number\n     * @return  {Integer}    The next step number to display\n     */\n    getNextStepNumber(stepNumber) {\n        if (typeof stepNumber === 'undefined') {\n            stepNumber = this.getCurrentStepNumber();\n        }\n        let nextStepNumber = stepNumber + 1;\n\n        // Keep checking the remaining steps.\n        while (nextStepNumber <= this.steps.length) {\n            if (this.isStepPotentiallyVisible(this.getStepConfig(nextStepNumber))) {\n                return nextStepNumber;\n            }\n            nextStepNumber++;\n        }\n\n        return null;\n    }\n\n    /**\n     * Get the previous step number before the currently displayed step.\n     *\n     * @method  getPreviousStepNumber\n     * @param   {Integer}   stepNumber      The current step number\n     * @return  {Integer}    The previous step number to display\n     */\n    getPreviousStepNumber(stepNumber) {\n        if (typeof stepNumber === 'undefined') {\n            stepNumber = this.getCurrentStepNumber();\n        }\n        let previousStepNumber = stepNumber - 1;\n\n        // Keep checking the remaining steps.\n        while (previousStepNumber >= 0) {\n            if (this.isStepPotentiallyVisible(this.getStepConfig(previousStepNumber))) {\n                return previousStepNumber;\n            }\n            previousStepNumber--;\n        }\n\n        return null;\n    }\n\n    /**\n     * Is the step the final step number?\n     *\n     * @method  isLastStep\n     * @param   {Integer}   stepNumber  Step number to test\n     * @return  {Boolean}               Whether the step is the final step\n     */\n    isLastStep(stepNumber) {\n        let nextStepNumber = this.getNextStepNumber(stepNumber);\n\n        return nextStepNumber === null;\n    }\n\n    /**\n     * Is the step the first step number?\n     *\n     * @method  isFirstStep\n     * @param   {Integer}   stepNumber  Step number to test\n     * @return  {Boolean}               Whether the step is the first step\n     */\n    isFirstStep(stepNumber) {\n        let previousStepNumber = this.getPreviousStepNumber(stepNumber);\n\n        return previousStepNumber === null;\n    }\n\n    /**\n     * Is this step potentially visible?\n     *\n     * @method  isStepPotentiallyVisible\n     * @param   {Object}    stepConfig      The step configuration to normalise\n     * @return  {Boolean}               Whether the step is the potentially visible\n     */\n    isStepPotentiallyVisible(stepConfig) {\n        if (!stepConfig) {\n            // Without step config, there can be no step.\n            return false;\n        }\n\n        if (this.isStepActuallyVisible(stepConfig)) {\n            // If it is actually visible, it is already potentially visible.\n            return true;\n        }\n\n        if (typeof stepConfig.orphan !== 'undefined' && stepConfig.orphan) {\n            // Orphan steps have no target. They are always visible.\n            return true;\n        }\n\n        if (typeof stepConfig.delay !== 'undefined' && stepConfig.delay) {\n            // Only return true if the activated has not been used yet.\n            return true;\n        }\n\n        // Not theoretically, or actually visible.\n        return false;\n    }\n\n    /**\n     * Is this step actually visible?\n     *\n     * @method  isStepActuallyVisible\n     * @param   {Object}    stepConfig      The step configuration to normalise\n     * @return  {Boolean}               Whether the step is actually visible\n     */\n    isStepActuallyVisible(stepConfig) {\n        if (!stepConfig) {\n            // Without step config, there can be no step.\n            return false;\n        }\n\n        let target = this.getStepTarget(stepConfig);\n        if (target && target.length && target.is(':visible')) {\n            // Without a target, there can be no step.\n            return !!target.length;\n        }\n\n        return false;\n    }\n\n    /**\n     * Go to the next step in the tour.\n     *\n     * @method  next\n     * @chainable\n     * @return {Object} this.\n     */\n    next() {\n        return this.gotoStep(this.getNextStepNumber());\n    }\n\n    /**\n     * Go to the previous step in the tour.\n     *\n     * @method  previous\n     * @chainable\n     * @return {Object} this.\n     */\n    previous() {\n        return this.gotoStep(this.getPreviousStepNumber(), -1);\n    }\n\n    /**\n     * Go to the specified step in the tour.\n     *\n     * @method  gotoStep\n     * @param   {Integer}   stepNumber     The step number to display\n     * @param   {Integer}   direction      Next or previous step\n     * @chainable\n     * @return {Object} this.\n     */\n    gotoStep(stepNumber, direction) {\n        if (stepNumber < 0) {\n            return this.endTour();\n        }\n\n        let stepConfig = this.getStepConfig(stepNumber);\n        if (stepConfig === null) {\n            return this.endTour();\n        }\n\n        return this._gotoStep(stepConfig, direction);\n    }\n\n    _gotoStep(stepConfig, direction) {\n        if (!stepConfig) {\n            return this.endTour();\n        }\n\n        if (typeof stepConfig.delay !== 'undefined' && stepConfig.delay && !stepConfig.delayed) {\n            stepConfig.delayed = true;\n            window.setTimeout(this._gotoStep.bind(this), stepConfig.delay, stepConfig, direction);\n\n            return this;\n        } else if (!stepConfig.orphan && !this.isStepActuallyVisible(stepConfig)) {\n            let fn = direction == -1 ? 'getPreviousStepNumber' : 'getNextStepNumber';\n            return this.gotoStep(this[fn](stepConfig.stepNumber), direction);\n        }\n\n        this.hide();\n\n        this.fireEventHandlers('beforeRender', stepConfig);\n        this.renderStep(stepConfig);\n        this.fireEventHandlers('afterRender', stepConfig);\n\n        return this;\n    }\n\n    /**\n     * Fetch the normalised step configuration for the specified step number.\n     *\n     * @method  getStepConfig\n     * @param   {Integer}   stepNumber      The step number to fetch configuration for\n     * @return  {Object}                    The step configuration\n     */\n    getStepConfig(stepNumber) {\n        if (stepNumber === null || stepNumber < 0 || stepNumber >= this.steps.length) {\n            return null;\n        }\n\n        // Normalise the step configuration.\n        let stepConfig = this.normalizeStepConfig(this.steps[stepNumber]);\n\n        // Add the stepNumber to the stepConfig.\n        stepConfig = $.extend(stepConfig, {stepNumber: stepNumber});\n\n        return stepConfig;\n    }\n\n    /**\n     * Normalise the supplied step configuration.\n     *\n     * @method  normalizeStepConfig\n     * @param   {Object}    stepConfig      The step configuration to normalise\n     * @return  {Object}                    The normalised step configuration\n     */\n    normalizeStepConfig(stepConfig) {\n\n        if (typeof stepConfig.reflex !== 'undefined' && typeof stepConfig.moveAfterClick === 'undefined') {\n            stepConfig.moveAfterClick = stepConfig.reflex;\n        }\n\n        if (typeof stepConfig.element !== 'undefined' && typeof stepConfig.target === 'undefined') {\n            stepConfig.target = stepConfig.element;\n        }\n\n        if (typeof stepConfig.content !== 'undefined' && typeof stepConfig.body === 'undefined') {\n            stepConfig.body = stepConfig.content;\n        }\n\n        stepConfig = $.extend({}, this.stepDefaults, stepConfig);\n\n        stepConfig = $.extend({}, {\n            attachTo: stepConfig.target,\n            attachPoint: 'after',\n        }, stepConfig);\n\n        if (stepConfig.attachTo) {\n            stepConfig.attachTo = $(stepConfig.attachTo).first();\n        }\n\n        return stepConfig;\n    }\n\n    /**\n     * Fetch the actual step target from the selector.\n     *\n     * This should not be called until after any delay has completed.\n     *\n     * @method  getStepTarget\n     * @param   {Object}    stepConfig      The step configuration\n     * @return  {$}\n     */\n    getStepTarget(stepConfig) {\n        if (stepConfig.target) {\n            return $(stepConfig.target);\n        }\n\n        return null;\n    }\n\n    /**\n     * Fire any event handlers for the specified event.\n     *\n     * @param   {String}    eventName       The name of the event to handle\n     * @param   {Object}    data            Any data to pass to the event\n     * @chainable\n     * @return {Object} this.\n     */\n    fireEventHandlers(eventName, data) {\n        if (typeof this.eventHandlers[eventName] === 'undefined') {\n            return this;\n        }\n\n        this.eventHandlers[eventName].forEach(function(thisEvent) {\n            thisEvent.call(this, data);\n        }, this);\n\n        return this;\n    }\n\n    /**\n     * @method addEventHandler\n     * @param  {string}      eventName       The name of the event to listen for\n     * @param  {function}    handler         The event handler to call\n     * @return {Object} this.\n     */\n    addEventHandler(eventName, handler) {\n        if (typeof this.eventHandlers[eventName] === 'undefined') {\n            this.eventHandlers[eventName] = [];\n        }\n\n        this.eventHandlers[eventName].push(handler);\n\n        return this;\n    }\n\n    /**\n     * Process listeners for the step being shown.\n     *\n     * @method  processStepListeners\n     * @param   {object}    stepConfig      The configuration for the step\n     * @chainable\n     * @return {Object} this.\n     */\n    processStepListeners(stepConfig) {\n        this.listeners.push(\n            // Next/Previous buttons.\n            {\n                node: this.currentStepNode,\n                args: ['click', '[data-role=\"next\"]', $.proxy(this.next, this)],\n            },\n            {\n                node: this.currentStepNode,\n                args: ['click', '[data-role=\"previous\"]', $.proxy(this.previous, this)],\n            },\n\n            // Close and end tour buttons.\n            {\n                node: this.currentStepNode,\n                args: ['click', '[data-role=\"end\"]', $.proxy(this.endTour, this)],\n            },\n\n            // Click backdrop and hide tour.\n            {\n                node: $('[data-flexitour=\"backdrop\"]'),\n                args: ['click', $.proxy(this.hide, this)],\n            },\n\n            // Click out and hide tour without backdrop.\n            {\n                node: $('body'),\n                args: ['click', $.proxy(function(e) {\n                    // Handle click in or click out tour content,\n                    // if click out, hide tour.\n                    if (!this.currentStepNode.is(e.target) && $(e.target).closest('[data-role=\"flexitour-step\"]').length === 0) {\n                        this.hide();\n                    }\n                }, this)],\n            },\n\n            // Keypresses.\n            {\n                node: $('body'),\n                args: ['keydown', $.proxy(this.handleKeyDown, this)],\n            }\n        );\n\n\n        if (stepConfig.moveOnClick) {\n            let targetNode = this.getStepTarget(stepConfig);\n            this.listeners.push(\n                {\n                    node: targetNode,\n                    args: ['click', $.proxy(function(e) {\n                        if ($(e.target).parents('[data-flexitour=\"container\"]').length === 0) {\n                            // Ignore clicks when they are in the flexitour.\n                            window.setTimeout($.proxy(this.next, this), 500);\n                        }\n                    }, this)],\n                }\n            );\n        }\n\n        this.listeners.forEach(function(listener) {\n            listener.node.on.apply(listener.node, listener.args);\n        });\n\n        return this;\n    }\n\n    /**\n     * Reset step listeners.\n     *\n     * @method  resetStepListeners\n     * @chainable\n     * @return {Object} this.\n     */\n    resetStepListeners() {\n        // Stop listening to all external handlers.\n        if (this.listeners) {\n            this.listeners.forEach(function(listener) {\n                listener.node.off.apply(listener.node, listener.args);\n            });\n        }\n        this.listeners = [];\n\n        return this;\n    }\n\n    /**\n     * The standard step renderer.\n     *\n     * @method  renderStep\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    renderStep(stepConfig) {\n        // Store the current step configuration for later.\n        this.currentStepConfig = stepConfig;\n        this.setCurrentStepNumber(stepConfig.stepNumber);\n\n        // Fetch the template and convert it to a $ object.\n        let template = $(this.getTemplateContent());\n\n        // Title.\n        template.find('[data-placeholder=\"title\"]')\n            .html(stepConfig.title);\n\n        // Body.\n        template.find('[data-placeholder=\"body\"]')\n            .html(stepConfig.body);\n\n        // Is this the first step?\n        if (this.isFirstStep(stepConfig.stepNumber)) {\n            template.find('[data-role=\"previous\"]').prop('disabled', true);\n        } else {\n            template.find('[data-role=\"previous\"]').prop('disabled', false);\n        }\n\n        // Is this the final step?\n        if (this.isLastStep(stepConfig.stepNumber)) {\n            template.find('[data-role=\"next\"]').prop('disabled', true);\n        } else {\n            template.find('[data-role=\"next\"]').prop('disabled', false);\n        }\n\n        template.find('[data-role=\"previous\"]').attr('role', 'button');\n        template.find('[data-role=\"next\"]').attr('role', 'button');\n        template.find('[data-role=\"end\"]').attr('role', 'button');\n\n        // Replace the template with the updated version.\n        stepConfig.template = template;\n\n        // Add to the page.\n        this.addStepToPage(stepConfig);\n\n        // Process step listeners after adding to the page.\n        // This uses the currentNode.\n        this.processStepListeners(stepConfig);\n\n        return this;\n    }\n\n    /**\n     * Getter for the template content.\n     *\n     * @method  getTemplateContent\n     * @return  {$}\n     */\n    getTemplateContent() {\n        return $(this.templateContent).clone();\n    }\n\n    /**\n     * Helper to add a step to the page.\n     *\n     * @method  addStepToPage\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    addStepToPage(stepConfig) {\n        // Create the stepNode from the template data.\n        let currentStepNode = $('<span data-flexitour=\"container\"></span>')\n            .html(stepConfig.template)\n            .hide();\n\n        // The scroll animation occurs on the body or html.\n        let animationTarget = $('body, html')\n            .stop(true, true);\n\n        if (this.isStepActuallyVisible(stepConfig)) {\n            let targetNode = this.getStepTarget(stepConfig);\n\n            targetNode.data('flexitour', 'target');\n\n            let zIndex = this.calculateZIndex(targetNode);\n            if (zIndex) {\n                stepConfig.zIndex = zIndex + 1;\n            }\n\n            if (stepConfig.zIndex) {\n                currentStepNode.css('zIndex', stepConfig.zIndex + 1);\n            }\n\n            // Add the backdrop.\n            this.positionBackdrop(stepConfig);\n\n            $(document.body).append(currentStepNode);\n            this.currentStepNode = currentStepNode;\n\n            // Ensure that the step node is positioned.\n            // Some situations mean that the value is not properly calculated without this step.\n            this.currentStepNode.css({\n                top: 0,\n                left: 0,\n            });\n\n            animationTarget\n                .animate({\n                    scrollTop: this.calculateScrollTop(stepConfig),\n                }).promise().then(function() {\n                        this.positionStep(stepConfig);\n                        this.revealStep(stepConfig);\n                        return;\n                    }.bind(this));\n\n        } else if (stepConfig.orphan) {\n            stepConfig.isOrphan = true;\n\n            // This will be appended to the body instead.\n            stepConfig.attachTo = $('body').first();\n            stepConfig.attachPoint = 'append';\n\n            // Add the backdrop.\n            this.positionBackdrop(stepConfig);\n\n            // This is an orphaned step.\n            currentStepNode.addClass('orphan');\n\n            // It lives in the body.\n            $(document.body).append(currentStepNode);\n            this.currentStepNode = currentStepNode;\n\n            this.currentStepNode.offset(this.calculateStepPositionInPage());\n            this.currentStepNode.css('position', 'fixed');\n\n            this.currentStepPopper = new Popper(\n                $('body'),\n                this.currentStepNode[0], {\n                    removeOnDestroy: true,\n                    placement: stepConfig.placement + '-start',\n                    arrowElement: '[data-role=\"arrow\"]',\n                    // Empty the modifiers. We've already placed the step and don't want it moved.\n                    modifiers: {\n                        hide: {\n                            enabled: false,\n                        },\n                        applyStyle: {\n                            onLoad: null,\n                            enabled: false,\n                        },\n                    }\n                }\n            );\n\n            this.revealStep(stepConfig);\n        }\n\n        return this;\n    }\n\n    /**\n     * Make the given step visible.\n     *\n     * @method revealStep\n     * @param {Object} stepConfig The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    revealStep(stepConfig) {\n        // Fade the step in.\n        this.currentStepNode.fadeIn('', $.proxy(function() {\n                // Announce via ARIA.\n                this.announceStep(stepConfig);\n\n                // Focus on the current step Node.\n                this.currentStepNode.focus();\n                window.setTimeout($.proxy(function() {\n                    // After a brief delay, focus again.\n                    // There seems to be an issue with Jaws where it only reads the dialogue title initially.\n                    // This second focus helps it to read the full dialogue.\n                    if (this.currentStepNode) {\n                        this.currentStepNode.focus();\n                    }\n                }, this), 100);\n\n            }, this));\n\n        return this;\n    }\n\n    /**\n     * Helper to announce the step on the page.\n     *\n     * @method  announceStep\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    announceStep(stepConfig) {\n        // Setup the step Dialogue as per:\n        // * https://www.w3.org/TR/wai-aria-practices/#dialog_nonmodal\n        // * https://www.w3.org/TR/wai-aria-practices/#dialog_modal\n\n        // Generate an ID for the current step node.\n        let stepId = 'tour-step-' + this.tourName + '-' + stepConfig.stepNumber;\n        this.currentStepNode.attr('id', stepId);\n\n        let bodyRegion = this.currentStepNode.find('[data-placeholder=\"body\"]').first();\n        bodyRegion.attr('id', stepId + '-body');\n        bodyRegion.attr('role', 'document');\n\n        let headerRegion = this.currentStepNode.find('[data-placeholder=\"title\"]').first();\n        headerRegion.attr('id', stepId + '-title');\n        headerRegion.attr('aria-labelledby', stepId + '-body');\n\n        // Generally, a modal dialog has a role of dialog.\n        this.currentStepNode.attr('role', 'dialog');\n        this.currentStepNode.attr('tabindex', 0);\n        this.currentStepNode.attr('aria-labelledby', stepId + '-title');\n        this.currentStepNode.attr('aria-describedby', stepId + '-body');\n\n        // Configure ARIA attributes on the target.\n        let target = this.getStepTarget(stepConfig);\n        if (target) {\n            if (!target.attr('tabindex')) {\n                target.attr('tabindex', 0);\n            }\n\n            target\n                .data('original-describedby', target.attr('aria-describedby'))\n                .attr('aria-describedby', stepId + '-body')\n                ;\n        }\n\n        this.accessibilityShow(stepConfig);\n\n        return this;\n    }\n\n    /**\n     * Handle key down events.\n     *\n     * @method  handleKeyDown\n     * @param   {EventFacade} e\n     */\n    handleKeyDown(e) {\n        let tabbableSelector = 'a[href], link[href], [draggable=true], [contenteditable=true], ';\n        tabbableSelector += ':input:enabled, [tabindex], button:enabled';\n        switch (e.keyCode) {\n            case 27:\n                this.endTour();\n                break;\n\n            // 9 == Tab - trap focus for items with a backdrop.\n            case 9:\n                // Tab must be handled on key up only in this instance.\n                (function() {\n                    if (!this.currentStepConfig.hasBackdrop) {\n                        // Trapping tab focus is only handled for those steps with a backdrop.\n                        return;\n                    }\n\n                    // Find all tabbable locations.\n                    let activeElement = $(document.activeElement);\n                    let stepTarget = this.getStepTarget(this.currentStepConfig);\n                    let tabbableNodes = $(tabbableSelector);\n                    let dialogContainer = $('span[data-flexitour=\"container\"]');\n                    let currentIndex;\n                    // Filter out element which is not belong to target section or dialogue.\n                    if (stepTarget) {\n                        tabbableNodes = tabbableNodes.filter(function(index, element) {\n                            return stepTarget !== null\n                                && (stepTarget.has(element).length\n                                    || dialogContainer.has(element).length\n                                    || stepTarget.is(element)\n                                    || dialogContainer.is(element));\n                        });\n                    }\n\n                    // Find index of focusing element.\n                    tabbableNodes.each(function(index, element) {\n                        if (activeElement.is(element)) {\n                            currentIndex = index;\n                            return false;\n                        }\n                    });\n\n                    let nextIndex;\n                    let nextNode;\n                    let focusRelevant;\n                    if (currentIndex != void 0) {\n                        let direction = 1;\n                        if (e.shiftKey) {\n                            direction = -1;\n                        }\n                        nextIndex = currentIndex;\n                        do {\n                            nextIndex += direction;\n                            nextNode = $(tabbableNodes[nextIndex]);\n                        } while (nextNode.length && nextNode.is(':disabled') || nextNode.is(':hidden'));\n                        if (nextNode.length) {\n                            // A new f\n                            focusRelevant = nextNode.closest(stepTarget).length;\n                            focusRelevant = focusRelevant || nextNode.closest(this.currentStepNode).length;\n                        } else {\n                            // Unable to find the target somehow.\n                            focusRelevant = false;\n                        }\n                    }\n\n                    if (focusRelevant) {\n                        nextNode.focus();\n                    } else {\n                        if (e.shiftKey) {\n                            // Focus on the last tabbable node in the step.\n                            this.currentStepNode.find(tabbableSelector).last().focus();\n                        } else {\n                            if (this.currentStepConfig.isOrphan) {\n                                // Focus on the step - there is no target.\n                                this.currentStepNode.focus();\n                            } else {\n                                // Focus on the step target.\n                                stepTarget.focus();\n                            }\n                        }\n                    }\n                    e.preventDefault();\n                }).call(this);\n                break;\n        }\n    }\n\n    /**\n     * Start the current tour.\n     *\n     * @method  startTour\n     * @param   {Integer}   startAt     Which step number to start at. If not specified, starts at the last point.\n     * @chainable\n     * @return {Object} this.\n     */\n    startTour(startAt) {\n        if (this.storage && typeof startAt === 'undefined') {\n            let storageStartValue = this.storage.getItem(this.storageKey);\n            if (storageStartValue) {\n                let storageStartAt = parseInt(storageStartValue, 10);\n                if (storageStartAt <= this.steps.length) {\n                    startAt = storageStartAt;\n                }\n            }\n        }\n\n        if (typeof startAt === 'undefined') {\n            startAt = this.getCurrentStepNumber();\n        }\n\n        this.fireEventHandlers('beforeStart', startAt);\n        this.gotoStep(startAt);\n        this.fireEventHandlers('afterStart', startAt);\n\n        return this;\n    }\n\n    /**\n     * Restart the tour from the beginning, resetting the completionlag.\n     *\n     * @method  restartTour\n     * @chainable\n     * @return {Object} this.\n     */\n    restartTour() {\n        return this.startTour(0);\n    }\n\n    /**\n     * End the current tour.\n     *\n     * @method  endTour\n     * @chainable\n     * @return {Object} this.\n     */\n    endTour() {\n        this.fireEventHandlers('beforeEnd');\n\n        if (this.currentStepConfig) {\n            let previousTarget = this.getStepTarget(this.currentStepConfig);\n            if (previousTarget) {\n                if (!previousTarget.attr('tabindex')) {\n                    previousTarget.attr('tabindex', '-1');\n                }\n                previousTarget.focus();\n            }\n        }\n\n        this.hide(true);\n\n        this.fireEventHandlers('afterEnd');\n\n        return this;\n    }\n\n    /**\n     * Hide any currently visible steps.\n     *\n     * @method hide\n     * @param {Bool} transition Animate the visibility change\n     * @chainable\n     * @return {Object} this.\n     */\n    hide(transition) {\n        this.fireEventHandlers('beforeHide');\n\n        if (this.currentStepNode && this.currentStepNode.length) {\n            this.currentStepNode.hide();\n            if (this.currentStepPopper) {\n                this.currentStepPopper.destroy();\n            }\n        }\n\n        // Restore original target configuration.\n        if (this.currentStepConfig) {\n            let target = this.getStepTarget(this.currentStepConfig);\n            if (target) {\n                if (target.data('original-labelledby')) {\n                    target.attr('aria-labelledby', target.data('original-labelledby'));\n                }\n\n                if (target.data('original-describedby')) {\n                    target.attr('aria-describedby', target.data('original-describedby'));\n                }\n\n                if (target.data('original-tabindex')) {\n                    target.attr('tabindex', target.data('tabindex'));\n                }\n            }\n\n            // Clear the step configuration.\n            this.currentStepConfig = null;\n        }\n\n        let fadeTime = 0;\n        if (transition) {\n            fadeTime = 400;\n        }\n\n        // Remove the backdrop features.\n        $('[data-flexitour=\"step-background\"]').remove();\n        $('[data-flexitour=\"step-backdrop\"]').removeAttr('data-flexitour');\n        $('[data-flexitour=\"backdrop\"]').fadeOut(fadeTime, function() {\n            $(this).remove();\n        });\n\n        // Remove aria-describedby and tabindex attributes.\n        if (this.currentStepNode && this.currentStepNode.length) {\n            let stepId = this.currentStepNode.attr('id');\n            if (stepId) {\n                let currentStepElement = '[aria-describedby=\"' + stepId + '-body\"]';\n                $(currentStepElement).removeAttr('tabindex');\n                $(currentStepElement).removeAttr('aria-describedby');\n            }\n        }\n\n        // Reset the listeners.\n        this.resetStepListeners();\n\n        this.accessibilityHide();\n\n        this.fireEventHandlers('afterHide');\n\n        this.currentStepNode = null;\n        this.currentStepPopper = null;\n        return this;\n    }\n\n    /**\n     * Show the current steps.\n     *\n     * @method show\n     * @chainable\n     * @return {Object} this.\n     */\n    show() {\n        // Show the current step.\n        let startAt = this.getCurrentStepNumber();\n\n        return this.gotoStep(startAt);\n    }\n\n    /**\n     * Return the current step node.\n     *\n     * @method  getStepContainer\n     * @return  {jQuery}\n     */\n    getStepContainer() {\n        return $(this.currentStepNode);\n    }\n\n    /**\n     * Calculate scrollTop.\n     *\n     * @method  calculateScrollTop\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @return  {Number}\n     */\n    calculateScrollTop(stepConfig) {\n        let scrollTop = $(window).scrollTop();\n        let viewportHeight = $(window).height();\n        let targetNode = this.getStepTarget(stepConfig);\n\n        if (stepConfig.placement === 'top') {\n            // If the placement is top, center scroll at the top of the target.\n            scrollTop = targetNode.offset().top - (viewportHeight / 2);\n        } else if (stepConfig.placement === 'bottom') {\n            // If the placement is bottom, center scroll at the bottom of the target.\n            scrollTop = targetNode.offset().top + targetNode.height() - (viewportHeight / 2);\n        } else if (targetNode.height() <= (viewportHeight * 0.8)) {\n            // If the placement is left/right, and the target fits in the viewport, centre screen on the target\n            scrollTop = targetNode.offset().top - ((viewportHeight - targetNode.height()) / 2);\n        } else {\n            // If the placement is left/right, and the target is bigger than the viewport, set scrollTop to target.top + buffer\n            // and change step attachmentTarget to top+.\n            scrollTop = targetNode.offset().top - (viewportHeight * 0.2);\n        }\n\n        // Never scroll over the top.\n        scrollTop = Math.max(0, scrollTop);\n\n        // Never scroll beyond the bottom.\n        scrollTop = Math.min($(document).height() - viewportHeight, scrollTop);\n\n        return Math.ceil(scrollTop);\n    }\n\n    /**\n     * Calculate dialogue position for page middle.\n     *\n     * @method  calculateScrollTop\n     * @return  {Number}\n     */\n    calculateStepPositionInPage() {\n        let viewportHeight = $(window).height();\n        let stepHeight = this.currentStepNode.height();\n\n        let viewportWidth = $(window).width();\n        let stepWidth = this.currentStepNode.width();\n\n        return {\n            top: Math.ceil((viewportHeight - stepHeight) / 2),\n            left: Math.ceil((viewportWidth - stepWidth) / 2)\n        };\n    }\n\n    /**\n     * Position the step on the page.\n     *\n     * @method  positionStep\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    positionStep(stepConfig) {\n        let content = this.currentStepNode;\n        if (!content || !content.length) {\n            // Unable to find the step node.\n            return this;\n        }\n\n        let flipBehavior;\n        switch (stepConfig.placement) {\n            case 'left':\n                flipBehavior = ['left', 'right', 'top', 'bottom'];\n                break;\n            case 'right':\n                flipBehavior = ['right', 'left', 'top', 'bottom'];\n                break;\n            case 'top':\n                flipBehavior = ['top', 'bottom', 'right', 'left'];\n                break;\n            case 'bottom':\n                flipBehavior = ['bottom', 'top', 'right', 'left'];\n                break;\n            default:\n                flipBehavior = 'flip';\n                break;\n        }\n\n        let target = this.getStepTarget(stepConfig);\n        var config = {\n            placement: stepConfig.placement + '-start',\n            removeOnDestroy: true,\n            modifiers: {\n                flip: {\n                    behaviour: flipBehavior,\n                },\n                arrow: {\n                    element: '[data-role=\"arrow\"]',\n                },\n            },\n            onCreate: function(data) {\n                recalculateArrowPosition(data);\n            },\n            onUpdate: function(data) {\n                recalculateArrowPosition(data);\n            },\n        };\n\n        let recalculateArrowPosition = function(data) {\n            let placement = data.placement.split('-')[0];\n            const isVertical = ['left', 'right'].indexOf(placement) !== -1;\n            const arrowElement = data.instance.popper.querySelector('[data-role=\"arrow\"]');\n            const stepElement = $(data.instance.popper.querySelector('[data-role=\"flexitour-step\"]'));\n            if (isVertical) {\n                let arrowHeight = parseFloat(window.getComputedStyle(arrowElement).height);\n                let arrowOffset = parseFloat(window.getComputedStyle(arrowElement).top);\n                let popperHeight = parseFloat(window.getComputedStyle(data.instance.popper).height);\n                let popperOffset = parseFloat(window.getComputedStyle(data.instance.popper).top);\n                let popperBorderWidth = parseFloat(stepElement.css('borderTopWidth'));\n                let popperBorderRadiusWidth = parseFloat(stepElement.css('borderTopLeftRadius')) * 2;\n                let arrowPos = arrowOffset + (arrowHeight / 2);\n                let maxPos = popperHeight + popperOffset - popperBorderWidth - popperBorderRadiusWidth;\n                let minPos = popperOffset + popperBorderWidth + popperBorderRadiusWidth;\n                if (arrowPos >= maxPos || arrowPos <= minPos) {\n                    let newArrowPos = 0;\n                    if (arrowPos > (popperHeight / 2)) {\n                        newArrowPos = maxPos - arrowHeight;\n                    } else {\n                        newArrowPos = minPos + arrowHeight;\n                    }\n                    $(arrowElement).css('top', newArrowPos);\n                }\n            } else {\n                let arrowWidth = parseFloat(window.getComputedStyle(arrowElement).width);\n                let arrowOffset = parseFloat(window.getComputedStyle(arrowElement).left);\n                let popperWidth = parseFloat(window.getComputedStyle(data.instance.popper).width);\n                let popperOffset = parseFloat(window.getComputedStyle(data.instance.popper).left);\n                let popperBorderWidth = parseFloat(stepElement.css('borderTopWidth'));\n                let popperBorderRadiusWidth = parseFloat(stepElement.css('borderTopLeftRadius')) * 2;\n                let arrowPos = arrowOffset + (arrowWidth / 2);\n                let maxPos = popperWidth + popperOffset - popperBorderWidth - popperBorderRadiusWidth;\n                let minPos = popperOffset + popperBorderWidth + popperBorderRadiusWidth;\n                if (arrowPos >= maxPos || arrowPos <= minPos) {\n                    let newArrowPos = 0;\n                    if (arrowPos > (popperWidth / 2)) {\n                        newArrowPos = maxPos - arrowWidth;\n                    } else {\n                        newArrowPos = minPos + arrowWidth;\n                    }\n                    $(arrowElement).css('left', newArrowPos);\n                }\n            }\n        };\n\n        let background = $('[data-flexitour=\"step-background\"]');\n        if (background.length) {\n            target = background;\n        }\n        this.currentStepPopper = new Popper(target, content[0], config);\n\n        return this;\n    }\n\n    /**\n     * Add the backdrop.\n     *\n     * @method  positionBackdrop\n     * @param   {Object}    stepConfig      The step configuration of the step\n     * @chainable\n     * @return {Object} this.\n     */\n    positionBackdrop(stepConfig) {\n        if (stepConfig.backdrop) {\n            this.currentStepConfig.hasBackdrop = true;\n            let backdrop = $('<div data-flexitour=\"backdrop\"></div>');\n\n            if (stepConfig.zIndex) {\n                if (stepConfig.attachPoint === 'append') {\n                    stepConfig.attachTo.append(backdrop);\n                } else {\n                    backdrop.insertAfter(stepConfig.attachTo);\n                }\n            } else {\n                $('body').append(backdrop);\n            }\n\n            if (this.isStepActuallyVisible(stepConfig)) {\n                // The step has a visible target.\n                // Punch a hole through the backdrop.\n                let background = $('<div data-flexitour=\"step-background\"></div>');\n\n                let targetNode = this.getStepTarget(stepConfig);\n\n                let buffer = 10;\n\n                let colorNode = targetNode;\n                if (buffer) {\n                    colorNode = $('body');\n                }\n\n                background.css({\n                    width: targetNode.outerWidth() + buffer + buffer,\n                    height: targetNode.outerHeight() + buffer + buffer,\n                    left: targetNode.offset().left - buffer,\n                    top: targetNode.offset().top - buffer,\n                    backgroundColor: this.calculateInherittedBackgroundColor(colorNode),\n                });\n\n                if (targetNode.offset().left < buffer) {\n                    background.css({\n                        width: targetNode.outerWidth() + targetNode.offset().left + buffer,\n                        left: targetNode.offset().left,\n                    });\n                }\n\n                if (targetNode.offset().top < buffer) {\n                    background.css({\n                        height: targetNode.outerHeight() + targetNode.offset().top + buffer,\n                        top: targetNode.offset().top,\n                    });\n                }\n\n                let targetRadius = targetNode.css('borderRadius');\n                if (targetRadius && targetRadius !== $('body').css('borderRadius')) {\n                    background.css('borderRadius', targetRadius);\n                }\n\n                let targetPosition = this.calculatePosition(targetNode);\n                if (targetPosition === 'fixed') {\n                    background.css('top', 0);\n                } else if (targetPosition === 'absolute') {\n                    background.css('position', 'fixed');\n                }\n\n                let fader = background.clone();\n                fader.css({\n                    backgroundColor: backdrop.css('backgroundColor'),\n                    opacity: backdrop.css('opacity'),\n                });\n                fader.attr('data-flexitour', 'step-background-fader');\n\n                if (stepConfig.zIndex) {\n                    if (stepConfig.attachPoint === 'append') {\n                        stepConfig.attachTo.append(background);\n                    } else {\n                        fader.insertAfter(stepConfig.attachTo);\n                        background.insertAfter(stepConfig.attachTo);\n                    }\n                } else {\n                    $('body').append(fader);\n                    $('body').append(background);\n                }\n\n                // Add the backdrop data to the actual target.\n                // This is the part which actually does the work.\n                targetNode.attr('data-flexitour', 'step-backdrop');\n\n                if (stepConfig.zIndex) {\n                    backdrop.css('zIndex', stepConfig.zIndex);\n                    background.css('zIndex', stepConfig.zIndex + 1);\n                    targetNode.css('zIndex', stepConfig.zIndex + 2);\n                }\n\n                fader.fadeOut('2000', function() {\n                    $(this).remove();\n                });\n            }\n        }\n        return this;\n    }\n\n    /**\n     * Calculate the inheritted z-index.\n     *\n     * @method  calculateZIndex\n     * @param   {jQuery}    elem                        The element to calculate z-index for\n     * @return  {Number}                                Calculated z-index\n     */\n    calculateZIndex(elem) {\n        elem = $(elem);\n        while (elem.length && elem[0] !== document) {\n            // Ignore z-index if position is set to a value where z-index is ignored by the browser\n            // This makes behavior of this function consistent across browsers\n            // WebKit always returns auto if the element is positioned.\n            let position = elem.css(\"position\");\n            if (position === \"absolute\" || position === \"relative\" || position === \"fixed\") {\n                // IE returns 0 when zIndex is not specified\n                // other browsers return a string\n                // we ignore the case of nested elements with an explicit value of 0\n                // <div style=\"z-index: -10;\"><div style=\"z-index: 0;\"></div></div>\n                let value = parseInt(elem.css(\"zIndex\"), 10);\n                if (!isNaN(value) && value !== 0) {\n                    return value;\n                }\n            }\n            elem = elem.parent();\n        }\n\n        return 0;\n    }\n\n    /**\n     * Calculate the inheritted background colour.\n     *\n     * @method  calculateInherittedBackgroundColor\n     * @param   {jQuery}    elem                        The element to calculate colour for\n     * @return  {String}                                Calculated background colour\n     */\n    calculateInherittedBackgroundColor(elem) {\n        // Use a fake node to compare each element against.\n        let fakeNode = $('<div>').hide();\n        $('body').append(fakeNode);\n        let fakeElemColor = fakeNode.css('backgroundColor');\n        fakeNode.remove();\n\n        elem = $(elem);\n        while (elem.length && elem[0] !== document) {\n            let color = elem.css('backgroundColor');\n            if (color !== fakeElemColor) {\n                return color;\n            }\n            elem = elem.parent();\n        }\n\n        return null;\n    }\n\n    /**\n     * Calculate the inheritted position.\n     *\n     * @method  calculatePosition\n     * @param   {jQuery}    elem                        The element to calculate position for\n     * @return  {String}                                Calculated position\n     */\n    calculatePosition(elem) {\n        elem = $(elem);\n        while (elem.length && elem[0] !== document) {\n            let position = elem.css('position');\n            if (position !== 'static') {\n                return position;\n            }\n            elem = elem.parent();\n        }\n\n        return null;\n    }\n\n    /**\n     * Perform accessibility changes for step shown.\n     *\n     * This will add aria-hidden=\"true\" to all siblings and parent siblings.\n     *\n     * @method  accessibilityShow\n     */\n    accessibilityShow() {\n        let stateHolder = 'data-has-hidden';\n        let attrName = 'aria-hidden';\n        let hideFunction = function(child) {\n            let flexitourRole = child.data('flexitour');\n            if (flexitourRole) {\n                switch (flexitourRole) {\n                    case 'container':\n                    case 'target':\n                        return;\n                }\n            }\n\n            let hidden = child.attr(attrName);\n            if (!hidden) {\n                child.attr(stateHolder, true);\n                child.attr(attrName, true);\n            }\n        };\n\n        this.currentStepNode.siblings().each(function(index, node) {\n            hideFunction($(node));\n        });\n        this.currentStepNode.parentsUntil('body').siblings().each(function(index, node) {\n            hideFunction($(node));\n        });\n    }\n\n    /**\n     * Perform accessibility changes for step hidden.\n     *\n     * This will remove any newly added aria-hidden=\"true\".\n     *\n     * @method  accessibilityHide\n     */\n    accessibilityHide() {\n        let stateHolder = 'data-has-hidden';\n        let attrName = 'aria-hidden';\n        let showFunction = function(child) {\n            let hidden = child.attr(stateHolder);\n            if (typeof hidden !== 'undefined') {\n                child.removeAttr(stateHolder);\n                child.removeAttr(attrName);\n            }\n        };\n\n        $('[' + stateHolder + ']').each(function(index, node) {\n            showFunction($(node));\n        });\n    }\n}"]}