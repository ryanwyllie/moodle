{"version":3,"sources":["../src/display.js"],"names":["define","$","ajax","log","notification","templates","config","str","findDocsSection","templateSource","templateName","marker","i","sections","match","length","section","start","indexOf","offset","substr","templateLoaded","source","originalSource","get_string","done","s","text","fail","exception","docs","example","context","rawJSON","trim","parseJSON","e","debug","render","html","js","replaceNodeContents","loadTemplate","parts","split","component","shift","name","promises","call","methodname","args","template","themename","theme","includecomments","when","apply","on","templatename","data","preventDefault"],"mappings":"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","file":"display.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module adds ajax display functions to the template library page.\n *\n * @module     tool_templatelibrary/display\n * @package    tool_templatelibrary\n * @copyright  2015 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/ajax', 'core/log', 'core/notification', 'core/templates', 'core/config', 'core/str'],\n       function($, ajax, log, notification, templates, config, str) {\n\n    /**\n     * Search through a template for a template docs comment.\n     *\n     * @param {String} templateSource The raw template\n     * @param {String} templateName The name of the template used to search for docs tag\n     * @return {String|boolean} the correct comment or false\n     */\n    var findDocsSection = function(templateSource, templateName) {\n\n        if (!templateSource) {\n            return false;\n        }\n        // Find the comment section marked with @template component/template.\n        var marker = \"@template \" + templateName,\n            i = 0,\n            sections = [];\n\n        sections = templateSource.match(/{{!([\\s\\S]*?)}}/g);\n\n        // If no sections match - show the entire file.\n        if (sections !== null) {\n            for (i = 0; i < sections.length; i++) {\n                var section = sections[i];\n                var start = section.indexOf(marker);\n                if (start !== -1) {\n                    // Remove {{! and }} from start and end.\n                    var offset = start + marker.length + 1;\n                    section = section.substr(offset, section.length - 2 - offset);\n                    return section;\n                }\n            }\n        }\n        // No matching comment.\n        return false;\n    };\n\n    /**\n     * Handle a template loaded response.\n     *\n     * @param {String} templateName The template name\n     * @param {String} source The template source\n     * @param {String} originalSource The original template source (not theme overridden)\n     */\n    var templateLoaded = function(templateName, source, originalSource) {\n        str.get_string('templateselected', 'tool_templatelibrary', templateName).done(function(s) {\n            $('[data-region=\"displaytemplateheader\"]').text(s);\n        }).fail(notification.exception);\n\n        // Find the comment section marked with @template component/template.\n        var docs = findDocsSection(source, templateName);\n\n        if (docs === false) {\n            // Docs was not in theme template, try original.\n            docs = findDocsSection(originalSource, templateName);\n        }\n\n        // If we found a docs section, limit the template library to showing this section.\n        if (docs) {\n            source = docs;\n        }\n\n        $('[data-region=\"displaytemplatesource\"]').text(source);\n\n        // Now search the text for a json example.\n\n        var example = source.match(/Example context \\(json\\):([\\s\\S]*)/);\n        var context = false;\n        if (example) {\n            var rawJSON = example[1].trim();\n            try {\n                context = $.parseJSON(rawJSON);\n            } catch (e) {\n                log.debug('Could not parse json example context for template.');\n                log.debug(e);\n            }\n        }\n        if (context) {\n            templates.render(templateName, context).done(function(html, js) {\n                templates.replaceNodeContents($('[data-region=\"displaytemplateexample\"]'), html, js);\n            }).fail(notification.exception);\n        } else {\n            str.get_string('templatehasnoexample', 'tool_templatelibrary').done(function(s) {\n                $('[data-region=\"displaytemplateexample\"]').text(s);\n            }).fail(notification.exception);\n        }\n    };\n\n    /**\n     * Load the a template source from Moodle.\n     *\n     * @param {String} templateName\n     */\n    var loadTemplate = function(templateName) {\n        var parts = templateName.split('/');\n        var component = parts.shift();\n        var name = parts.shift();\n\n        var promises = ajax.call([{\n            methodname: 'core_output_load_template',\n            args: {\n                    component: component,\n                    template: name,\n                    themename: config.theme,\n                    includecomments: true\n            }\n        }, {\n            methodname: 'tool_templatelibrary_load_canonical_template',\n            args: {\n                    component: component,\n                    template: name\n            }\n        }], true, false);\n\n        // When returns a new promise that is resolved when all the passed in promises are resolved.\n        // The arguments to the done become the values of each resolved promise.\n        $.when.apply($, promises)\n            .done(function(source, originalSource) {\n              templateLoaded(templateName, source, originalSource);\n            })\n            .fail(notification.exception);\n    };\n\n    // Add the event listeners.\n    $('[data-region=\"list-templates\"]').on('click', '[data-templatename]', function(e) {\n        var templatename = $(this).data('templatename');\n        e.preventDefault();\n        loadTemplate(templatename);\n    });\n\n    // This module does not expose anything.\n    return {};\n});\n"]}