{"version":3,"sources":["../src/competencypicker.js"],"names":["define","$","Notification","Ajax","Templates","Dialogue","Str","Tree","Picker","pageContextId","singleFramework","pageContextIncludes","multiSelect","self","_eventNode","_frameworks","_reset","_pageContextId","_pageContextIncludes","_multiSelect","_frameworkId","_singleFramework","prototype","_competencies","_disallowedCompetencyIDs","_popup","_searchText","_selectedCompetencies","_onlyVisible","_afterRender","tree","_find","show","on","evt","params","selected","preventDefault","validIds","each","index","item","compId","data","valid","i","id","push","length","removeAttr","attr","change","e","target","val","_loadCompetencies","then","_refresh","bind","catch","exception","click","always","close","_trigger","competencyIds","competencyId","currentItems","slice","node","toggleItem","updateFocus","display","when","get_string","_render","title","render","_fetchCompetencies","frameworkId","searchText","call","methodname","args","searchtext","competencyframeworkid","done","competencies","addCompetencyChildren","parent","parentid","haschildren","children","comp","fail","selector","getContent","find","_getFramework","fid","frm","f","_loadFrameworks","promise","framework","sort","context","contextid","includes","onlyvisible","frameworks","type","handler","_preRender","html","replaceWith","search","setDisallowedCompetencyIDs","ids","trigger"],"mappings":"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","file":"competencypicker.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Competency picker.\n *\n * To handle 'save' events use: picker.on('save')\n * This will receive a object with either a single 'competencyId', or an array in 'competencyIds'\n * depending on the value of multiSelect.\n *\n * @package    tool_lp\n * @copyright  2015 Frédéric Massart - FMCorz.net\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery',\n        'core/notification',\n        'core/ajax',\n        'core/templates',\n        'tool_lp/dialogue',\n        'core/str',\n        'tool_lp/tree'],\n        function($, Notification, Ajax, Templates, Dialogue, Str, Tree) {\n\n    /**\n     * Competency picker class.\n     * @param {Number} pageContextId The page context ID.\n     * @param {Number|false} singleFramework The ID of the framework when limited to one.\n     * @param {String} pageContextIncludes One of 'children', 'parents', 'self'.\n     * @param {Boolean} multiSelect Support multi-select in the tree.\n     */\n    var Picker = function(pageContextId, singleFramework, pageContextIncludes, multiSelect) {\n        var self = this;\n        self._eventNode = $('<div></div>');\n        self._frameworks = [];\n        self._reset();\n\n        self._pageContextId = pageContextId;\n        self._pageContextIncludes = pageContextIncludes || 'children';\n        self._multiSelect = (typeof multiSelect === 'undefined' || multiSelect === true);\n        if (singleFramework) {\n            self._frameworkId = singleFramework;\n            self._singleFramework = true;\n        }\n    };\n\n    /** @type {Array} The competencies fetched. */\n    Picker.prototype._competencies = null;\n    /** @type {Array} The competencies that cannot be picked. */\n    Picker.prototype._disallowedCompetencyIDs = null;\n    /** @type {Node} The node we attach the events to. */\n    Picker.prototype._eventNode = null;\n    /** @type {Array} The list of frameworks fetched. */\n    Picker.prototype._frameworks = null;\n    /** @type {Number} The current framework ID. */\n    Picker.prototype._frameworkId = null;\n    /** @type {Number} The page context ID. */\n    Picker.prototype._pageContextId = null;\n    /** @type {Number} Relevant contexts inclusion. */\n    Picker.prototype._pageContextIncludes = null;\n    /** @type {Dialogue} The reference to the dialogue. */\n    Picker.prototype._popup = null;\n    /** @type {String} The string we filter the competencies with. */\n    Picker.prototype._searchText = '';\n    /** @type {Object} The competency that was selected. */\n    Picker.prototype._selectedCompetencies = null;\n    /** @type {Boolean} Whether we can browse frameworks or not. */\n    Picker.prototype._singleFramework = false;\n    /** @type {Boolean} Do we allow multi select? */\n    Picker.prototype._multiSelect = true;\n    /** @type {Boolean} Do we allow to display hidden framework? */\n    Picker.prototype._onlyVisible = true;\n\n    /**\n     * Hook to executed after the view is rendered.\n     *\n     * @method _afterRender\n     */\n    Picker.prototype._afterRender = function() {\n        var self = this;\n\n        // Initialise the tree.\n        var tree = new Tree(self._find('[data-enhance=linktree]'), self._multiSelect);\n\n        // To prevent jiggling we only show the tree after it is enhanced.\n        self._find('[data-enhance=linktree]').show();\n\n        tree.on('selectionchanged', function(evt, params) {\n            var selected = params.selected;\n            evt.preventDefault();\n            var validIds = [];\n            $.each(selected, function(index, item) {\n                var compId = $(item).data('id'),\n                    valid = true;\n\n                if (typeof compId === 'undefined') {\n                    // Do not allow picking nodes with no id.\n                    valid = false;\n                } else {\n                    $.each(self._disallowedCompetencyIDs, function(i, id) {\n                        if (id == compId) {\n                            valid = false;\n                        }\n                    });\n                }\n                if (valid) {\n                    validIds.push(compId);\n                }\n            });\n\n            self._selectedCompetencies = validIds;\n\n            // TODO Implement disabling of nodes in the tree module somehow.\n            if (!self._selectedCompetencies.length) {\n                self._find('[data-region=\"competencylinktree\"] [data-action=\"add\"]').attr('disabled', 'disabled');\n            } else {\n                self._find('[data-region=\"competencylinktree\"] [data-action=\"add\"]').removeAttr('disabled');\n            }\n        });\n\n        // Add listener for framework change.\n        if (!self._singleFramework) {\n            self._find('[data-action=\"chooseframework\"]').change(function(e) {\n                self._frameworkId = $(e.target).val();\n                self._loadCompetencies().then(self._refresh.bind(self)).catch(Notification.exception);\n            });\n        }\n\n        // Add listener for search.\n        self._find('[data-region=\"filtercompetencies\"] button').click(function(e) {\n            e.preventDefault();\n            $(e.target).attr('disabled', 'disabled');\n            self._searchText = self._find('[data-region=\"filtercompetencies\"] input').val() || '';\n            return self._refresh().always(function() {\n                $(e.target).removeAttr('disabled');\n            });\n        });\n\n        // Add listener for cancel.\n        self._find('[data-region=\"competencylinktree\"] [data-action=\"cancel\"]').click(function(e) {\n            e.preventDefault();\n            self.close();\n        });\n\n        // Add listener for add.\n        self._find('[data-region=\"competencylinktree\"] [data-action=\"add\"]').click(function(e) {\n            e.preventDefault();\n            if (!self._selectedCompetencies.length) {\n                return;\n            }\n\n            if (self._multiSelect) {\n                self._trigger('save', {competencyIds: self._selectedCompetencies});\n            } else {\n                // We checked above that the array has at least one value.\n                self._trigger('save', {competencyId: self._selectedCompetencies[0]});\n            }\n\n            self.close();\n        });\n\n        // The list of selected competencies will be modified while looping (because of the listeners above).\n        var currentItems = self._selectedCompetencies.slice(0);\n\n        $.each(currentItems, function(index, id) {\n            var node = self._find('[data-id=' + id + ']');\n            if (node.length) {\n                tree.toggleItem(node);\n                tree.updateFocus(node);\n            }\n        });\n\n    };\n\n    /**\n     * Close the dialogue.\n     *\n     * @method close\n     */\n    Picker.prototype.close = function() {\n        var self = this;\n        self._popup.close();\n        self._reset();\n    };\n\n    /**\n     * Opens the picker.\n     *\n     * @method display\n     * @return {Promise}\n     */\n    Picker.prototype.display = function() {\n        var self = this;\n        return $.when(Str.get_string('competencypicker', 'tool_lp'), self._render())\n        .then(function(title, render) {\n            self._popup = new Dialogue(\n                title,\n                render[0],\n                self._afterRender.bind(self)\n            );\n            return;\n        }).catch(Notification.exception);\n    };\n\n    /**\n     * Fetch the competencies.\n     *\n     * @param {Number} frameworkId The frameworkId.\n     * @param {String} searchText Limit the competencies to those matching the text.\n     * @method _fetchCompetencies\n     * @return {Promise}\n     */\n    Picker.prototype._fetchCompetencies = function(frameworkId, searchText) {\n        var self = this;\n\n        return Ajax.call([\n            {methodname: 'core_competency_search_competencies', args: {\n                searchtext: searchText,\n                competencyframeworkid: frameworkId\n            }}\n        ])[0].done(function(competencies) {\n          /**\n           * @param {Object} parent\n           * @param {Array} competencies\n           */\n            function addCompetencyChildren(parent, competencies) {\n                for (var i = 0; i < competencies.length; i++) {\n                    if (competencies[i].parentid == parent.id) {\n                        parent.haschildren = true;\n                        competencies[i].children = [];\n                        competencies[i].haschildren = false;\n                        parent.children[parent.children.length] = competencies[i];\n                        addCompetencyChildren(competencies[i], competencies);\n                    }\n                }\n            }\n\n            // Expand the list of competencies into a tree.\n            var i, comp;\n            var tree = [];\n            for (i = 0; i < competencies.length; i++) {\n                comp = competencies[i];\n                if (comp.parentid == \"0\") { // Loose check for now, because WS returns a string.\n                    comp.children = [];\n                    comp.haschildren = 0;\n                    tree[tree.length] = comp;\n                    addCompetencyChildren(comp, competencies);\n                }\n            }\n\n            self._competencies = tree;\n\n        }).fail(Notification.exception);\n    };\n\n    /**\n     * Find a node in the dialogue.\n     *\n     * @param {String} selector\n     * @return {JQuery}\n     * @method _find\n     */\n    Picker.prototype._find = function(selector) {\n        return $(this._popup.getContent()).find(selector);\n    };\n\n    /**\n     * Convenience method to get a framework object.\n     *\n     * @param {Number} fid The framework ID.\n     * @return {Object}\n     * @method _getFramework\n     */\n    Picker.prototype._getFramework = function(fid) {\n        var frm;\n        $.each(this._frameworks, function(i, f) {\n            if (f.id == fid) {\n                frm = f;\n                return;\n            }\n        });\n        return frm;\n    };\n\n    /**\n     * Load the competencies.\n     *\n     * @method _loadCompetencies\n     * @return {Promise}\n     */\n    Picker.prototype._loadCompetencies = function() {\n        return this._fetchCompetencies(this._frameworkId, this._searchText);\n    };\n\n    /**\n     * Load the frameworks.\n     *\n     * @method _loadFrameworks\n     * @return {Promise}\n     */\n    Picker.prototype._loadFrameworks = function() {\n        var promise,\n            self = this;\n\n        // Quit early because we already have the data.\n        if (self._frameworks.length > 0) {\n            return $.when();\n        }\n\n        if (self._singleFramework) {\n            promise = Ajax.call([\n                {methodname: 'core_competency_read_competency_framework', args: {\n                    id: this._frameworkId\n                }}\n            ])[0].then(function(framework) {\n                return [framework];\n            });\n        } else {\n            promise = Ajax.call([\n                {methodname: 'core_competency_list_competency_frameworks', args: {\n                    sort: 'shortname',\n                    context: {contextid: self._pageContextId},\n                    includes: self._pageContextIncludes,\n                    onlyvisible: self._onlyVisible\n                }}\n            ])[0];\n        }\n\n        return promise.done(function(frameworks) {\n            self._frameworks = frameworks;\n        }).fail(Notification.exception);\n    };\n\n    /**\n     * Register an event listener.\n     *\n     * @param {String} type The event type.\n     * @param {Function} handler The event listener.\n     * @method on\n     */\n    Picker.prototype.on = function(type, handler) {\n        this._eventNode.on(type, handler);\n    };\n\n    /**\n     * Hook to executed before render.\n     *\n     * @method _preRender\n     * @return {Promise}\n     */\n    Picker.prototype._preRender = function() {\n        var self = this;\n        return self._loadFrameworks().then(function() {\n            if (!self._frameworkId && self._frameworks.length > 0) {\n                self._frameworkId = self._frameworks[0].id;\n            }\n\n            // We could not set a framework ID, that probably means there are no frameworks accessible.\n            if (!self._frameworkId) {\n                self._frameworks = [];\n                return $.when();\n            }\n\n            return self._loadCompetencies();\n        });\n    };\n\n    /**\n     * Refresh the view.\n     *\n     * @method _refresh\n     * @return {Promise}\n     */\n    Picker.prototype._refresh = function() {\n        var self = this;\n        return self._render().then(function(html) {\n            self._find('[data-region=\"competencylinktree\"]').replaceWith(html);\n            self._afterRender();\n            return;\n        });\n    };\n\n    /**\n     * Render the dialogue.\n     *\n     * @method _render\n     * @return {Promise}\n     */\n    Picker.prototype._render = function() {\n        var self = this;\n        return self._preRender().then(function() {\n\n            if (!self._singleFramework) {\n                $.each(self._frameworks, function(i, framework) {\n                    if (framework.id == self._frameworkId) {\n                        framework.selected = true;\n                    } else {\n                        framework.selected = false;\n                    }\n                });\n            }\n\n            var context = {\n                competencies: self._competencies,\n                framework: self._getFramework(self._frameworkId),\n                frameworks: self._frameworks,\n                search: self._searchText,\n                singleFramework: self._singleFramework,\n            };\n\n            return Templates.render('tool_lp/competency_picker', context);\n        });\n    };\n\n    /**\n     * Reset the dialogue properties.\n     *\n     * This does not reset everything, just enough to reset the UI.\n     *\n     * @method _reset\n     */\n    Picker.prototype._reset = function() {\n        this._competencies = [];\n        this._disallowedCompetencyIDs = [];\n        this._popup = null;\n        this._searchText = '';\n        this._selectedCompetencies = [];\n    };\n\n    /**\n     * Set what competencies cannot be picked.\n     *\n     * This needs to be set after reset/close.\n     *\n     * @param {Number[]} ids The IDs.\n     * @method _setDisallowedCompetencyIDs\n     */\n    Picker.prototype.setDisallowedCompetencyIDs = function(ids) {\n        this._disallowedCompetencyIDs = ids;\n    };\n\n    /**\n     * Trigger an event.\n     *\n     * @param {String} type The type of event.\n     * @param {Object} data The data to pass to the listeners.\n     * @method _reset\n     */\n    Picker.prototype._trigger = function(type, data) {\n        this._eventNode.trigger(type, [data]);\n    };\n\n    return /** @alias module:tool_lp/competencypicker */ Picker;\n\n});\n"]}