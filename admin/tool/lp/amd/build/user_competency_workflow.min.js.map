{"version":3,"sources":["../src/user_competency_workflow.js"],"names":["define","$","Templates","Ajax","Notification","Str","Menubar","EventBase","UserCompetencyWorkflow","prototype","constructor","apply","Object","create","_nodeSelector","_cancelReviewRequest","data","call","methodname","args","userid","competencyid","then","_trigger","bind","catch","cancelReviewRequest","_cancelReviewRequestHandler","e","preventDefault","_findUserCompetencyData","target","_requestReview","requestReview","_requestReviewHandler","_startReview","startReview","_startReviewHandler","_stopReview","stopReview","_stopReviewHandler","enhanceMenubar","selector","enhance","node","parent","parents","length","Error","registerEvents","wrapper","find","click"],"mappings":"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","file":"user_competency_workflow.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * User competency workflow.\n *\n * @module     tool_lp/user_competency_workflow\n * @package    tool_lp\n * @copyright  2015 Frédéric Massart - FMCorz.net\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery',\n        'core/templates',\n        'core/ajax',\n        'core/notification',\n        'core/str',\n        'tool_lp/menubar',\n        'tool_lp/event_base'],\n        function($, Templates, Ajax, Notification, Str, Menubar, EventBase) {\n\n    /**\n     * UserCompetencyWorkflow class.\n     *\n     * @param {String} selector The node containing the buttons to switch mode.\n     */\n    var UserCompetencyWorkflow = function() {\n        EventBase.prototype.constructor.apply(this, []);\n    };\n    UserCompetencyWorkflow.prototype = Object.create(EventBase.prototype);\n\n    /** @type {String} The selector to find the user competency data. */\n    UserCompetencyWorkflow.prototype._nodeSelector = '[data-node=\"user-competency\"]';\n\n    /**\n     * Cancel a review request and refresh the view.\n     *\n     * @param  {Object} data The user competency data.\n     * @method _cancelReviewRequest\n     */\n    UserCompetencyWorkflow.prototype._cancelReviewRequest = function(data) {\n        var call = {\n            methodname: 'core_competency_user_competency_cancel_review_request',\n            args: {\n                userid: data.userid,\n                competencyid: data.competencyid\n            }\n        };\n\n        Ajax.call([call])[0].then(function() {\n            this._trigger('review-request-cancelled', data);\n            this._trigger('status-changed', data);\n        }.bind(this)).catch(function() {\n            this._trigger('error-occured', data);\n        }.bind(this));\n    };\n\n    /**\n     * Cancel a review request an refresh the view.\n     *\n     * @param  {Object} data The user competency data.\n     * @method cancelReviewRequest\n     */\n    UserCompetencyWorkflow.prototype.cancelReviewRequest = function(data) {\n        this._cancelReviewRequest(data);\n    };\n\n    /**\n     * Cancel a review request handler.\n     *\n     * @param  {Event} e The event.\n     * @method _cancelReviewRequestHandler\n     */\n    UserCompetencyWorkflow.prototype._cancelReviewRequestHandler = function(e) {\n        e.preventDefault();\n        var data = this._findUserCompetencyData($(e.target));\n        this.cancelReviewRequest(data);\n    };\n\n    /**\n     * Request a review and refresh the view.\n     *\n     * @param  {Object} data The user competency data.\n     * @method _requestReview\n     */\n    UserCompetencyWorkflow.prototype._requestReview = function(data) {\n        var call = {\n            methodname: 'core_competency_user_competency_request_review',\n            args: {\n                userid: data.userid,\n                competencyid: data.competencyid\n            }\n        };\n\n        Ajax.call([call])[0].then(function() {\n            this._trigger('review-requested', data);\n            this._trigger('status-changed', data);\n        }.bind(this)).catch(function() {\n            this._trigger('error-occured', data);\n        }.bind(this));\n    };\n\n    /**\n     * Request a review.\n     *\n     * @param  {Object} data The user competency data.\n     * @method requestReview\n     */\n    UserCompetencyWorkflow.prototype.requestReview = function(data) {\n        this._requestReview(data);\n    };\n\n    /**\n     * Request a review handler.\n     *\n     * @param  {Event} e The event.\n     * @method _requestReviewHandler\n     */\n    UserCompetencyWorkflow.prototype._requestReviewHandler = function(e) {\n        e.preventDefault();\n        var data = this._findUserCompetencyData($(e.target));\n        this.requestReview(data);\n    };\n\n    /**\n     * Start a review and refresh the view.\n     *\n     * @param  {Object} data The user competency data.\n     * @method _startReview\n     */\n    UserCompetencyWorkflow.prototype._startReview = function(data) {\n        var call = {\n            methodname: 'core_competency_user_competency_start_review',\n            args: {\n                userid: data.userid,\n                competencyid: data.competencyid\n            }\n        };\n        Ajax.call([call])[0].then(function() {\n            this._trigger('review-started', data);\n            this._trigger('status-changed', data);\n        }.bind(this)).catch(function() {\n            this._trigger('error-occured', data);\n        }.bind(this));\n    };\n\n    /**\n     * Start a review.\n     *\n     * @param  {Object} data The user competency data.\n     * @method startReview\n     */\n    UserCompetencyWorkflow.prototype.startReview = function(data) {\n        this._startReview(data);\n    };\n\n    /**\n     * Start a review handler.\n     *\n     * @param  {Event} e The event.\n     * @method _startReviewHandler\n     */\n    UserCompetencyWorkflow.prototype._startReviewHandler = function(e) {\n        e.preventDefault();\n        var data = this._findUserCompetencyData($(e.target));\n        this.startReview(data);\n    };\n\n    /**\n     * Stop a review and refresh the view.\n     *\n     * @param  {Object} data The user competency data.\n     * @method _stopReview\n     */\n    UserCompetencyWorkflow.prototype._stopReview = function(data) {\n        var call = {\n            methodname: 'core_competency_user_competency_stop_review',\n            args: {\n                userid: data.userid,\n                competencyid: data.competencyid\n            }\n        };\n\n        Ajax.call([call])[0].then(function() {\n            this._trigger('review-stopped', data);\n            this._trigger('status-changed', data);\n        }.bind(this)).catch(function() {\n            this._trigger('error-occured', data);\n        }.bind(this));\n    };\n\n    /**\n     * Stop a review.\n     *\n     * @param  {Object} data The user competency data.\n     * @method stopReview\n     */\n    UserCompetencyWorkflow.prototype.stopReview = function(data) {\n        this._stopReview(data);\n    };\n\n    /**\n     * Stop a review handler.\n     *\n     * @param  {Event} e The event.\n     * @method _stopReviewHandler\n     */\n    UserCompetencyWorkflow.prototype._stopReviewHandler = function(e) {\n        e.preventDefault();\n        var data = this._findUserCompetencyData($(e.target));\n        this.stopReview(data);\n    };\n\n    /**\n     * Enhance a menu bar.\n     *\n     * @param  {String} selector Menubar selector.\n     */\n    UserCompetencyWorkflow.prototype.enhanceMenubar = function(selector) {\n        Menubar.enhance(selector, {\n            '[data-action=\"request-review\"]': this._requestReviewHandler.bind(this),\n            '[data-action=\"cancel-review-request\"]': this._cancelReviewRequestHandler.bind(this),\n        });\n    };\n\n    /**\n     * Find the user competency data from a node.\n     *\n     * @param  {Node} node The node to search from.\n     * @return {Object} User competency data.\n     */\n    UserCompetencyWorkflow.prototype._findUserCompetencyData = function(node) {\n        var parent = node.parents(this._nodeSelector),\n            data;\n\n        if (parent.length != 1) {\n            throw new Error('The evidence node was not located.');\n        }\n\n        data = parent.data();\n        if (typeof data === 'undefined' || typeof data.userid === 'undefined' || typeof data.competencyid === 'undefined') {\n            throw new Error('User competency data could not be found.');\n        }\n\n        return data;\n    };\n\n    /**\n     * Enhance a menu bar.\n     *\n     * @param  {String} selector Menubar selector.\n     */\n    UserCompetencyWorkflow.prototype.enhanceMenubar = function(selector) {\n        Menubar.enhance(selector, {\n            '[data-action=\"request-review\"]': this._requestReviewHandler.bind(this),\n            '[data-action=\"cancel-review-request\"]': this._cancelReviewRequestHandler.bind(this),\n            '[data-action=\"start-review\"]': this._startReviewHandler.bind(this),\n            '[data-action=\"stop-review\"]': this._stopReviewHandler.bind(this),\n        });\n    };\n\n    /**\n     * Register the events in the region.\n     *\n     * @param {String} selector The base selector to search nodes in and attach events.\n     */\n    UserCompetencyWorkflow.prototype.registerEvents = function(selector) {\n        var wrapper = $(selector);\n\n        wrapper.find('[data-action=\"request-review\"]').click(this._requestReviewHandler.bind(this));\n        wrapper.find('[data-action=\"cancel-review-request\"]').click(this._cancelReviewRequestHandler.bind(this));\n        wrapper.find('[data-action=\"start-review\"]').click(this._startReviewHandler.bind(this));\n        wrapper.find('[data-action=\"stop-review\"]').click(this._stopReviewHandler.bind(this));\n    };\n\n    return /** @alias module:tool_lp/user_competency_actions */ UserCompetencyWorkflow;\n});\n"]}