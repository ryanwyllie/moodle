{"version":3,"sources":["../src/competencies.js"],"names":["define","$","notification","ajax","templates","str","Picker","dragdrop","competencies","itemid","itemtype","pagectxid","pageContextId","pickerInstance","prop","registerEvents","registerDragDrop","prototype","localthis","get_string","done","movestring","identifier","component","drag","drop","handleDrop","fail","exception","fromid","data","toid","requests","call","methodname","args","courseid","competencyidfrom","competencyidto","templateid","planid","pickCompetency","pagerender","pageregion","pageContextIncludes","self","on","e","compIds","competencyIds","each","index","compId","push","competencyid","pagecontext","contextid","length","then","context","render","html","js","replaceWith","runTemplateJS","catch","display","doDelete","deleteid","deleteHandler","message","id","competency","get_strings","key","param","shortname","strings","confirm","coursecompetencyid","target","ruleoutcome","val","click","preventDefault","closest"],"mappings":"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","file":"competencies.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Handle add/remove competency links.\n *\n * @module     tool_lp/competencies\n * @package    tool_lp\n * @copyright  2015 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery',\n        'core/notification',\n        'core/ajax',\n        'core/templates',\n        'core/str',\n        'tool_lp/competencypicker',\n        'tool_lp/dragdrop-reorder'],\n       function($, notification, ajax, templates, str, Picker, dragdrop) {\n\n    /**\n     * Constructor\n     *\n     * @param {Number} itemid\n     * @param {String} itemtype\n     * @param {Number} pagectxid\n     */\n    var competencies = function(itemid, itemtype, pagectxid) {\n        this.itemid = itemid;\n        this.itemtype = itemtype;\n        this.pageContextId = pagectxid;\n        this.pickerInstance = null;\n\n        $('[data-region=\"actions\"] button').prop('disabled', false);\n        this.registerEvents();\n        this.registerDragDrop();\n    };\n\n    /**\n     * Initialise the drag/drop code.\n     * @method registerDragDrop\n     */\n    competencies.prototype.registerDragDrop = function() {\n        var localthis = this;\n        // Init this module.\n        str.get_string('movecompetency', 'tool_lp').done(\n            function(movestring) {\n                dragdrop.dragdrop('movecompetency',\n                                  movestring,\n                                  {identifier: 'movecompetency', component: 'tool_lp'},\n                                  {identifier: 'movecompetencyafter', component: 'tool_lp'},\n                                  'drag-samenode',\n                                  'drag-parentnode',\n                                  'drag-handlecontainer',\n                                  function(drag, drop) {\n                                      localthis.handleDrop(drag, drop);\n                                  });\n            }\n        ).fail(notification.exception);\n\n    };\n\n    /**\n     * Handle a drop from a drag/drop operation.\n     *\n     * @method handleDrop\n     * @param {DOMNode} drag The dragged node.\n     * @param {DOMNode} drop The dropped on node.\n     */\n    competencies.prototype.handleDrop = function(drag, drop) {\n        var fromid = $(drag).data('id');\n        var toid = $(drop).data('id');\n        var localthis = this;\n        var requests = [];\n\n        if (localthis.itemtype == 'course') {\n            requests = ajax.call([\n                {\n                    methodname: 'core_competency_reorder_course_competency',\n                    args: {courseid: localthis.itemid, competencyidfrom: fromid, competencyidto: toid}\n                }\n            ]);\n        } else if (localthis.itemtype == 'template') {\n            requests = ajax.call([\n                {\n                    methodname: 'core_competency_reorder_template_competency',\n                    args: {templateid: localthis.itemid, competencyidfrom: fromid, competencyidto: toid}\n                }\n            ]);\n        } else if (localthis.itemtype == 'plan') {\n            requests = ajax.call([\n                {\n                    methodname: 'core_competency_reorder_plan_competency',\n                    args: {planid: localthis.itemid, competencyidfrom: fromid, competencyidto: toid}\n                }\n            ]);\n        } else {\n            return;\n        }\n\n        requests[0].fail(notification.exception);\n    };\n\n    /**\n     * Pick a competency\n     *\n     * @method pickCompetency\n     */\n    competencies.prototype.pickCompetency = function() {\n        var self = this;\n        var requests;\n        var pagerender;\n        var pageregion;\n        var pageContextIncludes;\n\n        if (!self.pickerInstance) {\n            if (self.itemtype === 'template' || self.itemtype === 'course') {\n                pageContextIncludes = 'parents';\n            }\n            self.pickerInstance = new Picker(self.pageContextId, false, pageContextIncludes);\n            self.pickerInstance.on('save', function(e, data) {\n                var compIds = data.competencyIds;\n\n                if (self.itemtype === \"course\") {\n                    requests = [];\n\n                    $.each(compIds, function(index, compId) {\n                        requests.push({\n                            methodname: 'core_competency_add_competency_to_course',\n                            args: {courseid: self.itemid, competencyid: compId}\n                        });\n                    });\n                    requests.push({\n                        methodname: 'tool_lp_data_for_course_competencies_page',\n                        args: {courseid: self.itemid}\n                    });\n\n                    pagerender = 'tool_lp/course_competencies_page';\n                    pageregion = 'coursecompetenciespage';\n\n                } else if (self.itemtype === \"template\") {\n                    requests = [];\n\n                    $.each(compIds, function(index, compId) {\n                        requests.push({\n                            methodname: 'core_competency_add_competency_to_template',\n                            args: {templateid: self.itemid, competencyid: compId}\n                        });\n                    });\n                    requests.push({\n                        methodname: 'tool_lp_data_for_template_competencies_page',\n                        args: {templateid: self.itemid, pagecontext: {contextid: self.pageContextId}}\n                    });\n                    pagerender = 'tool_lp/template_competencies_page';\n                    pageregion = 'templatecompetenciespage';\n                } else if (self.itemtype === \"plan\") {\n                    requests = [];\n\n                    $.each(compIds, function(index, compId) {\n                        requests.push({\n                            methodname: 'core_competency_add_competency_to_plan',\n                            args: {planid: self.itemid, competencyid: compId}\n                        });\n                    });\n                    requests.push({\n                         methodname: 'tool_lp_data_for_plan_page',\n                         args: {planid: self.itemid}\n                    });\n                    pagerender = 'tool_lp/plan_page';\n                    pageregion = 'plan-page';\n                }\n                ajax.call(requests)[requests.length - 1].then(function(context) {\n                    return templates.render(pagerender, context);\n                }).then(function(html, js) {\n                    $('[data-region=\"' + pageregion + '\"]').replaceWith(html);\n                    templates.runTemplateJS(js);\n                    return;\n                }).catch(notification.exception);\n            });\n        }\n\n        self.pickerInstance.display();\n    };\n\n    /**\n     * Delete the link between competency and course, template or plan. Reload the page.\n     *\n     * @method doDelete\n     * @param {int} deleteid The id of record to delete.\n     */\n    competencies.prototype.doDelete = function(deleteid) {\n        var localthis = this;\n        var requests = [],\n            pagerender = '',\n            pageregion = '';\n\n        // Delete the link and reload the page template.\n        if (localthis.itemtype == 'course') {\n            requests = ajax.call([\n                {methodname: 'core_competency_remove_competency_from_course',\n                    args: {courseid: localthis.itemid, competencyid: deleteid}},\n                {methodname: 'tool_lp_data_for_course_competencies_page',\n                    args: {courseid: localthis.itemid}}\n            ]);\n            pagerender = 'tool_lp/course_competencies_page';\n            pageregion = 'coursecompetenciespage';\n        } else if (localthis.itemtype == 'template') {\n            requests = ajax.call([\n                {methodname: 'core_competency_remove_competency_from_template',\n                    args: {templateid: localthis.itemid, competencyid: deleteid}},\n                {methodname: 'tool_lp_data_for_template_competencies_page',\n                    args: {templateid: localthis.itemid, pagecontext: {contextid: localthis.pageContextId}}}\n            ]);\n            pagerender = 'tool_lp/template_competencies_page';\n            pageregion = 'templatecompetenciespage';\n        } else if (localthis.itemtype == 'plan') {\n            requests = ajax.call([\n                {methodname: 'core_competency_remove_competency_from_plan',\n                    args: {planid: localthis.itemid, competencyid: deleteid}},\n                {methodname: 'tool_lp_data_for_plan_page',\n                    args: {planid: localthis.itemid}}\n            ]);\n            pagerender = 'tool_lp/plan_page';\n            pageregion = 'plan-page';\n        }\n\n        requests[1].done(function(context) {\n            templates.render(pagerender, context).done(function(html, js) {\n                $('[data-region=\"' + pageregion + '\"]').replaceWith(html);\n                templates.runTemplateJS(js);\n            }).fail(notification.exception);\n        }).fail(notification.exception);\n\n    };\n\n    /**\n     * Show a confirm dialogue before deleting a competency.\n     *\n     * @method deleteHandler\n     * @param {int} deleteid The id of record to delete.\n     */\n    competencies.prototype.deleteHandler = function(deleteid) {\n        var localthis = this;\n        var requests = [];\n        var message;\n\n        if (localthis.itemtype == 'course') {\n            message = 'unlinkcompetencycourse';\n        } else if (localthis.itemtype == 'template') {\n            message = 'unlinkcompetencytemplate';\n        } else if (localthis.itemtype == 'plan') {\n            message = 'unlinkcompetencyplan';\n        } else {\n            return;\n        }\n\n        requests = ajax.call([{\n            methodname: 'core_competency_read_competency',\n            args: {id: deleteid}\n        }]);\n\n        requests[0].done(function(competency) {\n            str.get_strings([\n                {key: 'confirm', component: 'moodle'},\n                {key: message, component: 'tool_lp', param: competency.shortname},\n                {key: 'confirm', component: 'moodle'},\n                {key: 'cancel', component: 'moodle'}\n            ]).done(function(strings) {\n                notification.confirm(\n                    strings[0], // Confirm.\n                    strings[1], // Unlink the competency X from the course?\n                    strings[2], // Confirm.\n                    strings[3], // Cancel.\n                    function() {\n                        localthis.doDelete(deleteid);\n                    }\n                );\n            }).fail(notification.exception);\n        }).fail(notification.exception);\n    };\n\n    /**\n     * Register the javascript event handlers for this page.\n     *\n     * @method registerEvents\n     */\n    competencies.prototype.registerEvents = function() {\n        var localthis = this;\n\n        if (localthis.itemtype == 'course') {\n            // Course completion rule handling.\n            $('[data-region=\"coursecompetenciespage\"]').on('change', 'select[data-field=\"ruleoutcome\"]', function(e) {\n                var requests = [];\n                var pagerender = 'tool_lp/course_competencies_page';\n                var pageregion = 'coursecompetenciespage';\n                var coursecompetencyid = $(e.target).data('id');\n                var ruleoutcome = $(e.target).val();\n                requests = ajax.call([\n                    {methodname: 'core_competency_set_course_competency_ruleoutcome',\n                      args: {coursecompetencyid: coursecompetencyid, ruleoutcome: ruleoutcome}},\n                    {methodname: 'tool_lp_data_for_course_competencies_page',\n                      args: {courseid: localthis.itemid}}\n                ]);\n\n                requests[1].done(function(context) {\n                    templates.render(pagerender, context).done(function(html, js) {\n                        $('[data-region=\"' + pageregion + '\"]').replaceWith(html);\n                        templates.runTemplateJS(js);\n                    }).fail(notification.exception);\n                }).fail(notification.exception);\n            });\n        }\n\n        $('[data-region=\"actions\"] button').click(function(e) {\n            e.preventDefault();\n            localthis.pickCompetency();\n        });\n        $('[data-action=\"delete-competency-link\"]').click(function(e) {\n            e.preventDefault();\n\n            var deleteid = $(e.target).closest('[data-id]').data('id');\n            localthis.deleteHandler(deleteid);\n        });\n    };\n\n    return /** @alias module:tool_lp/competencies */ competencies;\n});\n"]}