{"version":3,"sources":["../src/user_evidence_actions.js"],"names":["define","$","templates","ajax","notification","str","Menubar","PickerUserPlans","UserEvidenceActions","type","_type","_region","_evidenceNode","_template","_contextMethod","TypeError","prototype","_getContextArgs","evidenceData","self","args","id","userid","_renderView","context","render","then","newhtml","newjs","replaceNode","_callAndRefresh","calls","push","methodname","when","apply","call","arguments","length","fail","exception","_doDelete","deleteEvidence","requests","done","evidence","get_strings","key","component","param","name","strings","confirm","_deleteEvidenceHandler","e","preventDefault","data","_findEvidenceData","target","_doCreateUserEvidenceCompetency","competencyIds","each","index","competencyId","userevidenceid","competencyid","createUserEvidenceCompetency","picker","on","requestReview","display","_createUserEvidenceCompetencyHandler","_doDeleteUserEvidenceCompetency","deleteUserEvidenceCompetency","_deleteUserEvidenceCompetencyHandler","currentTarget","_doReviewUserEvidenceCompetencies","reviewUserEvidenceCompetencies","_reviewUserEvidenceCompetenciesHandler","node","parent","parentsUntil","Error","enhanceMenubar","selector","enhance","bind","registerEvents","wrapper","find","click"],"mappings":"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","file":"user_evidence_actions.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * User evidence actions.\n *\n * @module     tool_lp/user_evidence_actions\n * @package    tool_lp\n * @copyright  2015 Frédéric Massart - FMCorz.net\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery',\n        'core/templates',\n        'core/ajax',\n        'core/notification',\n        'core/str',\n        'tool_lp/menubar',\n        'tool_lp/competencypicker_user_plans'],\n        function($, templates, ajax, notification, str, Menubar, PickerUserPlans) {\n\n    /**\n     * UserEvidenceActions class.\n     *\n     * Note that presently this cannot be instantiated more than once per page.\n     *\n     * @param {String} type The type of page we're in.\n     */\n    var UserEvidenceActions = function(type) {\n        this._type = type;\n\n        if (type === 'evidence') {\n            // This is the page to view one evidence.\n            this._region = '[data-region=\"user-evidence-page\"]';\n            this._evidenceNode = '[data-region=\"user-evidence-page\"]';\n            this._template = 'tool_lp/user_evidence_page';\n            this._contextMethod = 'tool_lp_data_for_user_evidence_page';\n\n        } else if (type === 'list') {\n            // This is the page to view a list of evidence.\n            this._region = '[data-region=\"user-evidence-list\"]';\n            this._evidenceNode = '[data-region=\"user-evidence-node\"]';\n            this._template = 'tool_lp/user_evidence_list_page';\n            this._contextMethod = 'tool_lp_data_for_user_evidence_list_page';\n\n        } else {\n            throw new TypeError('Unexpected type.');\n        }\n    };\n\n    /** @type {String} Ajax method to fetch the page data from. */\n    UserEvidenceActions.prototype._contextMethod = null;\n    /** @type {String} Selector to find the node describing the evidence. */\n    UserEvidenceActions.prototype._evidenceNode = null;\n    /** @type {String} Selector mapping to the region to update. Usually similar to wrapper. */\n    UserEvidenceActions.prototype._region = null;\n    /** @type {String} Name of the template used to render the region. */\n    UserEvidenceActions.prototype._template = null;\n    /** @type {String} Type of page/region we're in. */\n    UserEvidenceActions.prototype._type = null;\n\n    /**\n     * Resolve the arguments to refresh the region.\n     *\n     * @param  {Object} evidenceData Evidence data from evidence node.\n     * @return {Object} List of arguments.\n     */\n    UserEvidenceActions.prototype._getContextArgs = function(evidenceData) {\n        var self = this,\n            args = {};\n\n        if (self._type === 'evidence') {\n            args = {\n                id: evidenceData.id\n            };\n\n        } else if (self._type === 'list') {\n            args = {\n                userid: evidenceData.userid\n            };\n        }\n\n        return args;\n    };\n\n    /**\n     * Callback to render the region template.\n     *\n     * @param {Object} context The context for the template.\n     * @return {Promise}\n     */\n    UserEvidenceActions.prototype._renderView = function(context) {\n        var self = this;\n        return templates.render(self._template, context)\n            .then(function(newhtml, newjs) {\n                templates.replaceNode($(self._region), newhtml, newjs);\n                return;\n            });\n    };\n\n    /**\n     * Call multiple ajax methods, and refresh.\n     *\n     * @param  {Array}  calls    List of Ajax calls.\n     * @param  {Object} evidenceData Evidence data from evidence node.\n     * @return {Promise}\n     */\n    UserEvidenceActions.prototype._callAndRefresh = function(calls, evidenceData) {\n        var self = this;\n        calls.push({\n            methodname: self._contextMethod,\n            args: self._getContextArgs(evidenceData)\n        });\n\n        // Apply all the promises, and refresh when the last one is resolved.\n        return $.when.apply($.when, ajax.call(calls))\n            .then(function() {\n                return self._renderView(arguments[arguments.length - 1]);\n            })\n            .fail(notification.exception);\n    };\n\n    /**\n     * Delete a plan and reload the region.\n     *\n     * @param  {Object} evidenceData Evidence data from evidence node.\n     */\n    UserEvidenceActions.prototype._doDelete = function(evidenceData) {\n        var self = this,\n            calls = [{\n                methodname: 'core_competency_delete_user_evidence',\n                args: {id: evidenceData.id}\n            }];\n        self._callAndRefresh(calls, evidenceData);\n    };\n\n    /**\n     * Delete a plan.\n     *\n     * @param  {Object} evidenceData Evidence data from evidence node.\n     */\n    UserEvidenceActions.prototype.deleteEvidence = function(evidenceData) {\n        var self = this,\n            requests;\n\n        requests = ajax.call([{\n            methodname: 'core_competency_read_user_evidence',\n            args: {id: evidenceData.id}\n        }]);\n\n        requests[0].done(function(evidence) {\n            str.get_strings([\n                {key: 'confirm', component: 'moodle'},\n                {key: 'deleteuserevidence', component: 'tool_lp', param: evidence.name},\n                {key: 'delete', component: 'moodle'},\n                {key: 'cancel', component: 'moodle'}\n            ]).done(function(strings) {\n                notification.confirm(\n                    strings[0], // Confirm.\n                    strings[1], // Delete evidence X?\n                    strings[2], // Delete.\n                    strings[3], // Cancel.\n                    function() {\n                        self._doDelete(evidenceData);\n                    }\n                );\n            }).fail(notification.exception);\n        }).fail(notification.exception);\n\n    };\n\n    /**\n     * Delete evidence handler.\n     *\n     * @param  {Event} e The event.\n     */\n    UserEvidenceActions.prototype._deleteEvidenceHandler = function(e) {\n        e.preventDefault();\n        var data = this._findEvidenceData($(e.target));\n        this.deleteEvidence(data);\n    };\n\n    /**\n     * Link a competency and reload.\n     *\n     * @param {Object} evidenceData Evidence data from evidence node.\n     * @param {Number} competencyIds The competency IDs.\n     * @param {Boolean} requestReview Send competencies to review.\n     */\n    UserEvidenceActions.prototype._doCreateUserEvidenceCompetency = function(evidenceData, competencyIds) {\n        var self = this,\n            calls = [];\n\n        $.each(competencyIds, function(index, competencyId) {\n            calls.push({\n                methodname: 'core_competency_create_user_evidence_competency',\n                args: {\n                    userevidenceid: evidenceData.id,\n                    competencyid: competencyId,\n                }\n            });\n        });\n\n        self._callAndRefresh(calls, evidenceData);\n    };\n\n    /**\n     * Create a user evidence competency.\n     *\n     * @param  {Object} evidenceData Evidence data from evidence node.\n     */\n    UserEvidenceActions.prototype.createUserEvidenceCompetency = function(evidenceData) {\n        var self = this,\n            picker = new PickerUserPlans(evidenceData.userid);\n\n        picker.on('save', function(e, data) {\n            var competencyIds = data.competencyIds;\n            self._doCreateUserEvidenceCompetency(evidenceData, competencyIds, data.requestReview);\n        });\n\n        picker.display();\n    };\n\n    /**\n     * Create user evidence competency handler.\n     *\n     * @param  {Event} e The event.\n     */\n    UserEvidenceActions.prototype._createUserEvidenceCompetencyHandler = function(e) {\n        e.preventDefault();\n        var data = this._findEvidenceData($(e.target));\n        this.createUserEvidenceCompetency(data);\n    };\n\n    /**\n     * Remove a linked competency and reload.\n     *\n     * @param {Object} evidenceData Evidence data from evidence node.\n     * @param {Number} competencyId The competency ID.\n     */\n    UserEvidenceActions.prototype._doDeleteUserEvidenceCompetency = function(evidenceData, competencyId) {\n        var self = this,\n            calls = [];\n\n        calls.push({\n            methodname: 'core_competency_delete_user_evidence_competency',\n            args: {\n                userevidenceid: evidenceData.id,\n                competencyid: competencyId,\n            }\n        });\n\n        self._callAndRefresh(calls, evidenceData);\n    };\n\n    /**\n     * Delete a user evidence competency.\n     *\n     * @param  {Object} evidenceData Evidence data from evidence node.\n     * @param  {Number} competencyId The competency ID.\n     */\n    UserEvidenceActions.prototype.deleteUserEvidenceCompetency = function(evidenceData, competencyId) {\n        this._doDeleteUserEvidenceCompetency(evidenceData, competencyId);\n    };\n\n    /**\n     * Delete user evidence competency handler.\n     *\n     * @param  {Event} e The event.\n     */\n    UserEvidenceActions.prototype._deleteUserEvidenceCompetencyHandler = function(e) {\n        var data = this._findEvidenceData($(e.currentTarget)),\n            competencyId = $(e.currentTarget).data('id');\n        e.preventDefault();\n        this.deleteUserEvidenceCompetency(data, competencyId);\n    };\n\n    /**\n     * Send request review for user evidence competencies and reload the region.\n     *\n     * @param  {Object} evidenceData Evidence data from evidence node.\n     */\n    UserEvidenceActions.prototype._doReviewUserEvidenceCompetencies = function(evidenceData) {\n        var self = this,\n            calls = [{\n                methodname: 'core_competency_request_review_of_user_evidence_linked_competencies',\n                args: {id: evidenceData.id}\n            }];\n        self._callAndRefresh(calls, evidenceData);\n    };\n\n    /**\n     * Send request review for user evidence competencies.\n     *\n     * @param  {Object} evidenceData Evidence data from evidence node.\n     */\n    UserEvidenceActions.prototype.reviewUserEvidenceCompetencies = function(evidenceData) {\n        var self = this,\n            requests;\n\n        requests = ajax.call([{\n            methodname: 'core_competency_read_user_evidence',\n            args: {id: evidenceData.id}\n        }]);\n\n        requests[0].done(function(evidence) {\n            str.get_strings([\n                {key: 'confirm', component: 'moodle'},\n                {key: 'sendallcompetenciestoreview', component: 'tool_lp', param: evidence.name},\n                {key: 'confirm', component: 'moodle'},\n                {key: 'cancel', component: 'moodle'}\n            ]).done(function(strings) {\n                notification.confirm(\n                    strings[0], // Confirm.\n                    strings[1], // Send all competencies in review for X?\n                    strings[2], // Confirm.\n                    strings[3], // Cancel.\n                    function() {\n                        self._doReviewUserEvidenceCompetencies(evidenceData);\n                    }\n                );\n            }).fail(notification.exception);\n        }).fail(notification.exception);\n\n    };\n\n    /**\n     * Send request review for user evidence competencies handler.\n     *\n     * @param  {Event} e The event.\n     */\n    UserEvidenceActions.prototype._reviewUserEvidenceCompetenciesHandler = function(e) {\n        e.preventDefault();\n        var data = this._findEvidenceData($(e.target));\n        this.reviewUserEvidenceCompetencies(data);\n    };\n\n    /**\n     * Find the evidence data from the evidence node.\n     *\n     * @param  {Node} node The node to search from.\n     * @return {Object} Evidence data.\n     */\n    UserEvidenceActions.prototype._findEvidenceData = function(node) {\n        var parent = node.parentsUntil($(this._region).parent(), this._evidenceNode),\n            data;\n\n        if (parent.length != 1) {\n            throw new Error('The evidence node was not located.');\n        }\n\n        data = parent.data();\n        if (typeof data === 'undefined' || typeof data.id === 'undefined') {\n            throw new Error('Evidence data could not be found.');\n        }\n\n        return data;\n    };\n\n    /**\n     * Enhance a menu bar.\n     *\n     * @param  {String} selector Menubar selector.\n     */\n    UserEvidenceActions.prototype.enhanceMenubar = function(selector) {\n        var self = this;\n        Menubar.enhance(selector, {\n            '[data-action=\"user-evidence-delete\"]': self._deleteEvidenceHandler.bind(self),\n            '[data-action=\"link-competency\"]': self._createUserEvidenceCompetencyHandler.bind(self),\n            '[data-action=\"send-competencies-review\"]': self._reviewUserEvidenceCompetenciesHandler.bind(self),\n        });\n    };\n\n    /**\n     * Register the events in the region.\n     *\n     * At this stage this cannot be used with enhanceMenubar or multiple handlers\n     * will be added to the same node.\n     */\n    UserEvidenceActions.prototype.registerEvents = function() {\n        var wrapper = $(this._region),\n            self = this;\n\n        wrapper.find('[data-action=\"user-evidence-delete\"]').click(self._deleteEvidenceHandler.bind(self));\n        wrapper.find('[data-action=\"link-competency\"]').click(self._createUserEvidenceCompetencyHandler.bind(self));\n        wrapper.find('[data-action=\"delete-competency-link\"]').click(self._deleteUserEvidenceCompetencyHandler.bind(self));\n        wrapper.find('[data-action=\"send-competencies-review\"]').click(self._reviewUserEvidenceCompetenciesHandler.bind(self));\n    };\n\n    return /** @alias module:tool_lp/user_evidence_actions */ UserEvidenceActions;\n});\n"]}