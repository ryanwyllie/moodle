{"version":3,"sources":["../src/data_registry.js"],"names":["define","$","Str","Ajax","Notification","Templates","ModalFactory","ModalEvents","Fragment","AddPurpose","AddCategory","SELECTORS","TREE_NODES","FORM_CONTAINER","DataRegistry","systemContextId","initContextLevel","initContextId","currentContextLevel","currentContextId","init","prototype","addpurpose","addcategory","getInstance","strings","get_strings","key","component","registerEventListeners","loadForm","submitContextFormAjax","bind","submitContextLevelFormAjax","on","ev","preventDefault","trigger","currentTarget","removeClass","addClass","contextLevel","data","contextId","window","history","pushState","removeListeners","expandContextId","expandElement","expanded","collapse","find","loadExtra","expand","off","fragmentName","fragmentArgs","formSubmitCallback","clearForm","fragment","loadFragment","done","html","js","runTemplateJS","fail","exception","Y","use","M","core_formchangechecker","reset_form_dirty_state","submitForm","e","submit","submitFormAjax","saveMethodName","formData","serialize","then","call","methodname","args","jsonformdata","JSON","stringify","alert","catch","parentNode","contextid","element","branches","length","noElements","render","after","node","text","siblings"],"mappings":"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","file":"data_registry.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Request actions.\n *\n * @module     tool_dataprivacy/data_registry\n * @package    tool_dataprivacy\n * @copyright  2018 David Monllao\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str', 'core/ajax', 'core/notification', 'core/templates', 'core/modal_factory',\n    'core/modal_events', 'core/fragment', 'tool_dataprivacy/add_purpose', 'tool_dataprivacy/add_category'],\n    function($, Str, Ajax, Notification, Templates, ModalFactory, ModalEvents, Fragment, AddPurpose, AddCategory) {\n\n        var SELECTORS = {\n            TREE_NODES: '[data-context-tree-node=1]',\n            FORM_CONTAINER: '#context-form-container',\n        };\n\n        var DataRegistry = function(systemContextId, initContextLevel, initContextId) {\n            this.systemContextId = systemContextId;\n            this.currentContextLevel = initContextLevel;\n            this.currentContextId = initContextId;\n            this.init();\n        };\n\n        /**\n         * @var {int} systemContextId\n         * @private\n         */\n        DataRegistry.prototype.systemContextId = 0;\n\n        /**\n         * @var {int} currentContextLevel\n         * @private\n         */\n        DataRegistry.prototype.currentContextLevel = 0;\n\n        /**\n         * @var {int} currentContextId\n         * @private\n         */\n        DataRegistry.prototype.currentContextId = 0;\n\n        /**\n         * @var {AddPurpose} addpurpose\n         * @private\n         */\n        DataRegistry.prototype.addpurpose = null;\n\n        /**\n         * @var {AddCategory} addcategory\n         * @private\n         */\n        DataRegistry.prototype.addcategory = null;\n\n        DataRegistry.prototype.init = function() {\n            // Add purpose and category modals always at system context.\n            this.addpurpose = AddPurpose.getInstance(this.systemContextId);\n            this.addcategory = AddCategory.getInstance(this.systemContextId);\n\n            var stringKeys = [\n                {\n                    key: 'changessaved',\n                    component: 'moodle'\n                }, {\n                    key: 'contextpurposecategorysaved',\n                    component: 'tool_dataprivacy'\n                }, {\n                    key: 'noblockstoload',\n                    component: 'tool_dataprivacy'\n                }, {\n                    key: 'noactivitiestoload',\n                    component: 'tool_dataprivacy'\n                }, {\n                    key: 'nocoursestoload',\n                    component: 'tool_dataprivacy'\n                }\n            ];\n            this.strings = Str.get_strings(stringKeys);\n\n            this.registerEventListeners();\n\n            // Load the default context level form.\n            if (this.currentContextId) {\n                this.loadForm('context_form', [this.currentContextId], this.submitContextFormAjax.bind(this));\n            } else {\n                this.loadForm('contextlevel_form', [this.currentContextLevel], this.submitContextLevelFormAjax.bind(this));\n            }\n        };\n\n        DataRegistry.prototype.registerEventListeners = function() {\n            $(SELECTORS.TREE_NODES).on('click', function(ev) {\n                ev.preventDefault();\n\n                var trigger = $(ev.currentTarget);\n\n                // Active node.\n                $(SELECTORS.TREE_NODES).removeClass('active');\n                trigger.addClass('active');\n\n                var contextLevel = trigger.data('contextlevel');\n                var contextId = trigger.data('contextid');\n                if (contextLevel) {\n                    // Context level level.\n\n                    window.history.pushState({}, null, '?contextlevel=' + contextLevel);\n\n                    // Remove previous add purpose and category listeners to avoid memory leaks.\n                    this.addpurpose.removeListeners();\n                    this.addcategory.removeListeners();\n\n                    // Load the context level form.\n                    this.currentContextLevel = contextLevel;\n                    this.loadForm('contextlevel_form', [this.currentContextLevel], this.submitContextLevelFormAjax.bind(this));\n                } else if (contextId) {\n                    // Context instance level.\n\n                    window.history.pushState({}, null, '?contextid=' + contextId);\n\n                    // Remove previous add purpose and category listeners to avoid memory leaks.\n                    this.addpurpose.removeListeners();\n                    this.addcategory.removeListeners();\n\n                    // Load the context level form.\n                    this.currentContextId = contextId;\n                    this.loadForm('context_form', [this.currentContextId], this.submitContextFormAjax.bind(this));\n                } else {\n                    // Expandable nodes.\n\n                    var expandContextId = trigger.data('expandcontextid');\n                    var expandElement = trigger.data('expandelement');\n                    var expanded = trigger.data('expanded');\n\n                    // Extra checking that there is an expandElement because we remove it after loading 0 branches.\n                    if (expandElement) {\n\n                        if (!expanded) {\n                            if (trigger.data('loaded') || !expandContextId || !expandElement) {\n                                this.expand(trigger);\n                            } else {\n\n                                trigger.find('> i').removeClass('fa-plus');\n                                trigger.find('> i').addClass('fa-circle-o-notch fa-spin');\n                                this.loadExtra(trigger, expandContextId, expandElement);\n                            }\n                        } else {\n                            this.collapse(trigger);\n                        }\n                    }\n                }\n\n            }.bind(this));\n        };\n\n        DataRegistry.prototype.removeListeners = function() {\n            $(SELECTORS.TREE_NODES).off('click');\n        };\n\n        DataRegistry.prototype.loadForm = function(fragmentName, fragmentArgs, formSubmitCallback) {\n\n            this.clearForm();\n\n            var fragment = Fragment.loadFragment('tool_dataprivacy', fragmentName, this.systemContextId, fragmentArgs);\n            fragment.done(function(html, js) {\n\n                $(SELECTORS.FORM_CONTAINER).html(html);\n                Templates.runTemplateJS(js);\n\n                this.addpurpose.registerEventListeners();\n                this.addcategory.registerEventListeners();\n\n                // We also catch the form submit event and use it to submit the form with ajax.\n                $(SELECTORS.FORM_CONTAINER).on('submit', 'form', formSubmitCallback);\n\n            }.bind(this)).fail(Notification.exception);\n        };\n\n        DataRegistry.prototype.clearForm = function() {\n            // For the previously loaded form.\n            Y.use('moodle-core-formchangechecker', function() {\n                M.core_formchangechecker.reset_form_dirty_state();\n            });\n\n            // Remove previous listeners.\n            $(SELECTORS.FORM_CONTAINER).off('submit', 'form');\n        };\n\n        /**\n         * This triggers a form submission, so that any mform elements can do final tricks before the form submission is processed.\n         *\n         * @method submitForm\n         * @param {Event} e Form submission event.\n         * @private\n         */\n        DataRegistry.prototype.submitForm = function(e) {\n            e.preventDefault();\n            $(SELECTORS.FORM_CONTAINER).find('form').submit();\n        };\n\n        DataRegistry.prototype.submitContextLevelFormAjax = function(e) {\n            this.submitFormAjax(e, 'tool_dataprivacy_set_contextlevel_form');\n        };\n\n        DataRegistry.prototype.submitContextFormAjax = function(e) {\n            this.submitFormAjax(e, 'tool_dataprivacy_set_context_form');\n        };\n\n        DataRegistry.prototype.submitFormAjax = function(e, saveMethodName) {\n            // We don't want to do a real form submission.\n            e.preventDefault();\n\n            // Convert all the form elements values to a serialised string.\n            var formData = $(SELECTORS.FORM_CONTAINER).find('form').serialize();\n            return this.strings.then(function(strings) {\n                Ajax.call([{\n                    methodname: saveMethodName,\n                    args: {jsonformdata: JSON.stringify(formData)},\n                    done: function() {\n                        Notification.alert(strings[0], strings[1]);\n                    },\n                    fail: Notification.exception\n                }]);\n                return;\n            }).catch(Notification.exception);\n\n        };\n\n        DataRegistry.prototype.loadExtra = function(parentNode, expandContextId, expandElement) {\n\n            Ajax.call([{\n                methodname: 'tool_dataprivacy_tree_extra_branches',\n                args: {\n                    contextid: expandContextId,\n                    element: expandElement,\n                },\n                done: function(data) {\n                    if (data.branches.length == 0) {\n                        this.noElements(parentNode, expandElement);\n                        return;\n                    }\n                    Templates.render('tool_dataprivacy/context_tree_branches', data)\n                        .then(function(html) {\n                            parentNode.after(html);\n                            this.removeListeners();\n                            this.registerEventListeners();\n                            this.expand(parentNode);\n                            parentNode.data('loaded', 1);\n                            return;\n                        }.bind(this))\n                        .fail(Notification.exception);\n                }.bind(this),\n                fail: Notification.exception\n            }]);\n        };\n\n        DataRegistry.prototype.noElements = function(node, expandElement) {\n            node.data('expandcontextid', '');\n            node.data('expandelement', '');\n            this.strings.then(function(strings) {\n\n                // 2 = blocks, 3 = activities, 4 = courses (although courses is not likely really).\n                var key = 2;\n                if (expandElement == 'module') {\n                    key = 3;\n                } else if (expandElement == 'course') {\n                    key = 4;\n                }\n                node.text(strings[key]);\n                return;\n            }).fail(Notification.exception);\n        };\n\n        DataRegistry.prototype.collapse = function(node) {\n            node.data('expanded', 0);\n            node.siblings('nav').addClass('hidden');\n            node.find('> i').removeClass('fa-minus');\n            node.find('> i').addClass('fa-plus');\n        };\n\n        DataRegistry.prototype.expand = function(node) {\n            node.data('expanded', 1);\n            node.siblings('nav').removeClass('hidden');\n            node.find('> i').removeClass('fa-plus');\n            // Also remove the spinning one if data was just loaded.\n            node.find('> i').removeClass('fa-circle-o-notch fa-spin');\n            node.find('> i').addClass('fa-minus');\n        };\n        return /** @alias module:tool_dataprivacy/data_registry */ {\n\n            /**\n             * Initialise the page.\n             *\n             * @param {Number} systemContextId\n             * @param {Number} initContextLevel\n             * @param {Number} initContextId\n             * @return {DataRegistry}\n             */\n            init: function(systemContextId, initContextLevel, initContextId) {\n                return new DataRegistry(systemContextId, initContextLevel, initContextId);\n            }\n        };\n    }\n);\n\n"]}