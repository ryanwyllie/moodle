{"version":3,"sources":["../src/requestactions.js"],"names":["define","$","Ajax","Notification","Str","ModalFactory","ModalEvents","Templates","ModalDataRequest","DataPrivacyEvents","showConfirmation","action","requestId","keys","wsfunction","params","approve","key","component","deny","complete","modalTitle","get_strings","then","langStrings","confirmMessage","create","title","body","type","types","SAVE_CANCEL","modal","setSaveButtonText","getRoot","on","save","handleSave","hidden","destroy","show","catch","exception","call","methodname","args","done","data","result","window","location","reload","addNotification","message","warnings","fail","ACTIONS","APPROVE_REQUEST","DENY_REQUEST","VIEW_REQUEST","MARK_COMPLETE","RequestActions","registerEvents","prototype","click","e","preventDefault","promises","when","render","templateContext","approvedeny","canmarkcomplete","typename","TYPE","large"],"mappings":"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","file":"requestactions.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Request actions.\n *\n * @module     tool_dataprivacy/requestactions\n * @package    tool_dataprivacy\n * @copyright  2018 Jun Pataleta\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/str',\n    'core/modal_factory',\n    'core/modal_events',\n    'core/templates',\n    'tool_dataprivacy/data_request_modal',\n    'tool_dataprivacy/events'],\nfunction($, Ajax, Notification, Str, ModalFactory, ModalEvents, Templates, ModalDataRequest, DataPrivacyEvents) {\n\n    /**\n     * List of action selectors.\n     *\n     * @type {{APPROVE_REQUEST: string}}\n     * @type {{DENY_REQUEST: string}}\n     * @type {{VIEW_REQUEST: string}}\n     * @type {{MARK_COMPLETE: string}}\n     */\n    var ACTIONS = {\n        APPROVE_REQUEST: '[data-action=\"approve\"]',\n        DENY_REQUEST: '[data-action=\"deny\"]',\n        VIEW_REQUEST: '[data-action=\"view\"]',\n        MARK_COMPLETE: '[data-action=\"complete\"]'\n    };\n\n    /**\n     * RequestActions class.\n     */\n    var RequestActions = function() {\n        this.registerEvents();\n    };\n\n    /**\n     * Register event listeners.\n     */\n    RequestActions.prototype.registerEvents = function() {\n        $(ACTIONS.VIEW_REQUEST).click(function(e) {\n            e.preventDefault();\n\n            var requestId = $(this).data('requestid');\n\n            // Cancel the request.\n            var params = {\n                'requestid': requestId\n            };\n\n            var request = {\n                methodname: 'tool_dataprivacy_get_data_request',\n                args: params\n            };\n\n            var promises = Ajax.call([request]);\n            $.when(promises[0]).then(function(data) {\n                if (data.result) {\n                    return data.result;\n                }\n                // Fail.\n                Notification.addNotification({\n                    message: data.warnings[0].message,\n                    type: 'error'\n                });\n                return false;\n\n            }).then(function(data) {\n                var body = Templates.render('tool_dataprivacy/request_details', data);\n                var templateContext = {\n                    approvedeny: data.approvedeny,\n                    canmarkcomplete: data.canmarkcomplete\n                };\n                return ModalFactory.create({\n                    title: data.typename,\n                    body: body,\n                    type: ModalDataRequest.TYPE,\n                    large: true,\n                    templateContext: templateContext\n                });\n\n            }).then(function(modal) {\n                // Handle approve event.\n                modal.getRoot().on(DataPrivacyEvents.approve, function() {\n                    showConfirmation(DataPrivacyEvents.approve, requestId);\n                });\n\n                // Handle deny event.\n                modal.getRoot().on(DataPrivacyEvents.deny, function() {\n                    showConfirmation(DataPrivacyEvents.deny, requestId);\n                });\n\n                // Handle send event.\n                modal.getRoot().on(DataPrivacyEvents.complete, function() {\n                    var params = {\n                        'requestid': requestId\n                    };\n                    handleSave('tool_dataprivacy_mark_complete', params);\n                });\n\n                // Handle hidden event.\n                modal.getRoot().on(ModalEvents.hidden, function() {\n                    // Destroy when hidden.\n                    modal.destroy();\n                });\n\n                // Show the modal!\n                modal.show();\n\n                return;\n\n            }).catch(Notification.exception);\n        });\n\n        $(ACTIONS.APPROVE_REQUEST).click(function(e) {\n            e.preventDefault();\n\n            var requestId = $(this).data('requestid');\n            showConfirmation(DataPrivacyEvents.approve, requestId);\n        });\n\n        $(ACTIONS.DENY_REQUEST).click(function(e) {\n            e.preventDefault();\n\n            var requestId = $(this).data('requestid');\n            showConfirmation(DataPrivacyEvents.deny, requestId);\n        });\n\n        $(ACTIONS.MARK_COMPLETE).click(function(e) {\n            e.preventDefault();\n            showConfirmation(DataPrivacyEvents.complete, $(this).data('requestid'));\n        });\n    };\n\n    /**\n     * Show the confirmation dialogue.\n     *\n     * @param {String} action The action name.\n     * @param {Number} requestId The request ID.\n     */\n    function showConfirmation(action, requestId) {\n        var keys = [];\n        var wsfunction = '';\n        var params = {\n            'requestid': requestId\n        };\n        switch (action) {\n            case DataPrivacyEvents.approve:\n                keys = [\n                    {\n                        key: 'approverequest',\n                        component: 'tool_dataprivacy'\n                    },\n                    {\n                        key: 'confirmapproval',\n                        component: 'tool_dataprivacy'\n                    }\n                ];\n                wsfunction = 'tool_dataprivacy_approve_data_request';\n                break;\n            case DataPrivacyEvents.deny:\n                keys = [\n                    {\n                        key: 'denyrequest',\n                        component: 'tool_dataprivacy'\n                    },\n                    {\n                        key: 'confirmdenial',\n                        component: 'tool_dataprivacy'\n                    }\n                ];\n                wsfunction = 'tool_dataprivacy_deny_data_request';\n                break;\n            case DataPrivacyEvents.complete:\n                keys = [\n                    {\n                        key: 'markcomplete',\n                        component: 'tool_dataprivacy'\n                    },\n                    {\n                        key: 'confirmcompletion',\n                        component: 'tool_dataprivacy'\n                    }\n                ];\n                wsfunction = 'tool_dataprivacy_mark_complete';\n                break;\n        }\n\n        var modalTitle = '';\n        Str.get_strings(keys).then(function(langStrings) {\n            modalTitle = langStrings[0];\n            var confirmMessage = langStrings[1];\n            return ModalFactory.create({\n                title: modalTitle,\n                body: confirmMessage,\n                type: ModalFactory.types.SAVE_CANCEL\n            });\n        }).then(function(modal) {\n            modal.setSaveButtonText(modalTitle);\n\n            // Handle save event.\n            modal.getRoot().on(ModalEvents.save, function() {\n                handleSave(wsfunction, params);\n            });\n\n            // Handle hidden event.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                // Destroy when hidden.\n                modal.destroy();\n            });\n\n            modal.show();\n\n            return;\n\n        }).catch(Notification.exception);\n    }\n\n    /**\n     * Calls a web service function and reloads the page on success and shows a notification.\n     * Displays an error notification, otherwise.\n     *\n     * @param {String} wsfunction The web service function to call.\n     * @param {Object} params The parameters for the web service functoon.\n     */\n    function handleSave(wsfunction, params) {\n        // Confirm the request.\n        var request = {\n            methodname: wsfunction,\n            args: params\n        };\n\n        Ajax.call([request])[0].done(function(data) {\n            if (data.result) {\n                // On success, reload the page so that the data request table will be updated.\n                // TODO: Probably in the future, better to reload the table or the target data request via AJAX.\n                window.location.reload();\n            } else {\n                // Add the notification.\n                Notification.addNotification({\n                    message: data.warnings[0].message,\n                    type: 'error'\n                });\n            }\n        }).fail(Notification.exception);\n    }\n\n    return RequestActions;\n});\n"]}