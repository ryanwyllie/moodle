{"version":3,"sources":["../src/actions.js"],"names":["define","$","ajax","templates","notification","str","url","Y","ModalFactory","ModalEvents","KeyCodes","CSS","EDITINPROGRESS","SECTIONDRAGGABLE","EDITINGMOVE","SELECTOR","ACTIVITYLI","ACTIONAREA","ACTIVITYACTION","MENU","TOGGLE","SECTIONLI","SECTIONACTIONMENU","ADDSECTIONS","use","courseformatselector","M","course","format","get_section_selector","getModuleId","element","id","Moodle","core_course","util","cm","getId","Node","get","getModuleName","name","getName","addActivitySpinner","activity","addClass","actionarea","find","spinner","add_spinner","show","addSectionSpinner","sectionelement","addSectionLightbox","lightbox","add_lightbox","removeSpinner","delay","window","setTimeout","removeClass","hide","removeLightbox","initActionMenu","elementid","openmenu","coursebase","invoke_function","core","actionmenu","newDOMNode","one","toggle","simulate","focusActionItem","elementId","action","mainelement","selector","is","focus","findNextFocusable","mainElement","tabables","isInside","foundElement","each","contains","editModule","moduleElement","cmid","target","keepopen","attr","promises","call","methodname","args","sectionreturn","closest","when","apply","done","data","elementToFocus","replaceWith","index","trigger","Event","ajaxreturn","fail","ex","e","exception","isDefaultPrevented","refreshModule","activityElement","replaceActivityHtmlWith","confirmDeleteModule","onconfirm","modtypename","match","modulename","get_string","pluginname","get_strings","key","param","type","s","confirm","confirmEditSection","message","replaceActionItem","actionitem","image","stringname","stringcomponent","titlestr","titlecomponent","newaction","stringRequests","component","push","then","strings","html","title","renderPix","pixhtml","catch","defaultEditSectionHandler","sectionElement","actionItem","courseformat","modules","i","section_availability","first","oldmarker","oldActionItem","activityHTML","editSection","sectionid","dataencoded","parseJSON","register_module","set_visibility_resource_ui","getDOMNode","initCoursePage","on","keyCode","moduleId","preventDefault","sectionId","strNumberSections","modalTitle","modalBody","create","types","SAVE_CANCEL","body","modal","numSections","getBody","addSections","parseInt","val","document","location","setSaveButtonText","getRoot","shown","select","enter","save","replaceSectionActionItem"],"mappings":"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","file":"actions.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Various actions on modules and sections in the editing mode - hiding, duplicating, deleting, etc.\n *\n * @module     core_course/actions\n * @package    core\n * @copyright  2016 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.3\n */\ndefine(['jquery', 'core/ajax', 'core/templates', 'core/notification', 'core/str', 'core/url', 'core/yui',\n        'core/modal_factory', 'core/modal_events', 'core/key_codes'],\n    function($, ajax, templates, notification, str, url, Y, ModalFactory, ModalEvents, KeyCodes) {\n        var CSS = {\n            EDITINPROGRESS: 'editinprogress',\n            SECTIONDRAGGABLE: 'sectiondraggable',\n            EDITINGMOVE: 'editing_move'\n        };\n        var SELECTOR = {\n            ACTIVITYLI: 'li.activity',\n            ACTIONAREA: '.actions',\n            ACTIVITYACTION: 'a.cm-edit-action',\n            MENU: '.moodle-actionmenu[data-enhance=moodle-core-actionmenu]',\n            TOGGLE: '.toggle-display,.dropdown-toggle',\n            SECTIONLI: 'li.section',\n            SECTIONACTIONMENU: '.section_action_menu',\n            ADDSECTIONS: '#changenumsections [data-add-sections]'\n        };\n\n        Y.use('moodle-course-coursebase', function() {\n            var courseformatselector = M.course.format.get_section_selector();\n            if (courseformatselector) {\n                SELECTOR.SECTIONLI = courseformatselector;\n            }\n        });\n\n        /**\n         * Wrapper for Y.Moodle.core_course.util.cm.getId\n         *\n         * @param {JQuery} element\n         * @returns {Integer}\n         */\n        var getModuleId = function(element) {\n            var id;\n            Y.use('moodle-course-util', function(Y) {\n                id = Y.Moodle.core_course.util.cm.getId(Y.Node(element.get(0)));\n            });\n            return id;\n        };\n\n        /**\n         * Wrapper for Y.Moodle.core_course.util.cm.getName\n         *\n         * @param {JQuery} element\n         * @returns {String}\n         */\n        var getModuleName = function(element) {\n            var name;\n            Y.use('moodle-course-util', function(Y) {\n                name = Y.Moodle.core_course.util.cm.getName(Y.Node(element.get(0)));\n            });\n            return name;\n        };\n\n        /**\n         * Wrapper for M.util.add_spinner for an activity\n         *\n         * @param {JQuery} activity\n         * @returns {Node}\n         */\n        var addActivitySpinner = function(activity) {\n            activity.addClass(CSS.EDITINPROGRESS);\n            var actionarea = activity.find(SELECTOR.ACTIONAREA).get(0);\n            if (actionarea) {\n                var spinner = M.util.add_spinner(Y, Y.Node(actionarea));\n                spinner.show();\n                return spinner;\n            }\n            return null;\n        };\n\n        /**\n         * Wrapper for M.util.add_spinner for a section\n         *\n         * @param {JQuery} sectionelement\n         * @returns {Node}\n         */\n        var addSectionSpinner = function(sectionelement) {\n            sectionelement.addClass(CSS.EDITINPROGRESS);\n            var actionarea = sectionelement.find(SELECTOR.SECTIONACTIONMENU).get(0);\n            if (actionarea) {\n                var spinner = M.util.add_spinner(Y, Y.Node(actionarea));\n                spinner.show();\n                return spinner;\n            }\n            return null;\n        };\n\n        /**\n         * Wrapper for M.util.add_lightbox\n         *\n         * @param {JQuery} sectionelement\n         * @returns {Node}\n         */\n        var addSectionLightbox = function(sectionelement) {\n            var lightbox = M.util.add_lightbox(Y, Y.Node(sectionelement.get(0)));\n            lightbox.show();\n            return lightbox;\n        };\n\n        /**\n         * Removes the spinner element\n         *\n         * @param {JQuery} element\n         * @param {Node} spinner\n         * @param {Number} delay\n         */\n        var removeSpinner = function(element, spinner, delay) {\n            window.setTimeout(function() {\n                element.removeClass(CSS.EDITINPROGRESS);\n                if (spinner) {\n                    spinner.hide();\n                }\n            }, delay);\n        };\n\n        /**\n         * Removes the lightbox element\n         *\n         * @param {Node} lightbox lighbox YUI element returned by addSectionLightbox\n         * @param {Number} delay\n         */\n        var removeLightbox = function(lightbox, delay) {\n            if (lightbox) {\n                window.setTimeout(function() {\n                    lightbox.hide();\n                }, delay);\n            }\n        };\n\n        /**\n         * Initialise action menu for the element (section or module)\n         *\n         * @param {String} elementid CSS id attribute of the element\n         * @param {Boolean} openmenu whether to open menu - this can be used when re-initiating menu after indent action was pressed\n         */\n        var initActionMenu = function(elementid, openmenu) {\n            // Initialise action menu in the new activity.\n            Y.use('moodle-course-coursebase', function() {\n                M.course.coursebase.invoke_function('setup_for_resource', '#' + elementid);\n            });\n            if (M.core.actionmenu && M.core.actionmenu.newDOMNode) {\n                M.core.actionmenu.newDOMNode(Y.one('#' + elementid));\n            }\n            // Open action menu if the original element had data-keepopen.\n            if (openmenu) {\n                // We must use YUI click simulate here so the toggle works in Clean theme. This toggle is not\n                // needed in Boost because we use standard bootstrapbase action menu.\n                var toggle = Y.one('#' + elementid + ' ' + SELECTOR.MENU).one(SELECTOR.TOGGLE);\n                if (toggle && toggle.simulate) {\n                    toggle.simulate('click');\n                }\n            }\n        };\n\n        /**\n         * Returns focus to the element that was clicked or \"Edit\" link if element is no longer visible.\n         *\n         * @param {String} elementId CSS id attribute of the element\n         * @param {String} action data-action property of the element that was clicked\n         */\n        var focusActionItem = function(elementId, action) {\n            var mainelement = $('#' + elementId);\n            var selector = '[data-action=' + action + ']';\n            if (action === 'groupsseparate' || action === 'groupsvisible' || action === 'groupsnone') {\n                // New element will have different data-action.\n                selector = '[data-action=groupsseparate],[data-action=groupsvisible],[data-action=groupsnone]';\n            }\n            if (mainelement.find(selector).is(':visible')) {\n                mainelement.find(selector).focus();\n            } else {\n                // Element not visible, focus the \"Edit\" link.\n                mainelement.find(SELECTOR.MENU).find(SELECTOR.TOGGLE).focus();\n            }\n        };\n\n        /**\n         * Find next <a> after the element\n         *\n         * @param {JQuery} mainElement element that is about to be deleted\n         * @returns {JQuery}\n         */\n        var findNextFocusable = function(mainElement) {\n            var tabables = $(\"a:visible\");\n            var isInside = false;\n            var foundElement = null;\n            tabables.each(function() {\n                if ($.contains(mainElement[0], this)) {\n                    isInside = true;\n                } else if (isInside) {\n                    foundElement = this;\n                    return false; // Returning false in .each() is equivalent to \"break;\" inside the loop in php.\n                }\n            });\n            return foundElement;\n        };\n\n        /**\n         * Performs an action on a module (moving, deleting, duplicating, hiding, etc.)\n         *\n         * @param {JQuery} moduleElement activity element we perform action on\n         * @param {Number} cmid\n         * @param {JQuery} target the element (menu item) that was clicked\n         */\n        var editModule = function(moduleElement, cmid, target) {\n            var keepopen = target.attr('data-keepopen'),\n                    action = target.attr('data-action');\n            var spinner = addActivitySpinner(moduleElement);\n            var promises = ajax.call([{\n                methodname: 'core_course_edit_module',\n                args: {id: cmid,\n                    action: action,\n                    sectionreturn: target.attr('data-sectionreturn') ? target.attr('data-sectionreturn') : 0\n                }\n            }], true);\n\n            var lightbox;\n            if (action === 'duplicate') {\n                lightbox = addSectionLightbox(target.closest(SELECTOR.SECTIONLI));\n            }\n            $.when.apply($, promises)\n                .done(function(data) {\n                    var elementToFocus = findNextFocusable(moduleElement);\n                    moduleElement.replaceWith(data);\n                    // Initialise action menu for activity(ies) added as a result of this.\n                    $('<div>' + data + '</div>').find(SELECTOR.ACTIVITYLI).each(function(index) {\n                        initActionMenu($(this).attr('id'), keepopen);\n                        if (index === 0) {\n                            focusActionItem($(this).attr('id'), action);\n                            elementToFocus = null;\n                        }\n                    });\n                    // In case of activity deletion focus the next focusable element.\n                    if (elementToFocus) {\n                        elementToFocus.focus();\n                    }\n                    // Remove spinner and lightbox with a delay.\n                    removeSpinner(moduleElement, spinner, 400);\n                    removeLightbox(lightbox, 400);\n                    // Trigger event that can be observed by course formats.\n                    moduleElement.trigger($.Event('coursemoduleedited', {ajaxreturn: data, action: action}));\n                }).fail(function(ex) {\n                    // Remove spinner and lightbox.\n                    removeSpinner(moduleElement, spinner);\n                    removeLightbox(lightbox);\n                    // Trigger event that can be observed by course formats.\n                    var e = $.Event('coursemoduleeditfailed', {exception: ex, action: action});\n                    moduleElement.trigger(e);\n                    if (!e.isDefaultPrevented()) {\n                        notification.exception(ex);\n                    }\n                });\n        };\n\n        /**\n         * Requests html for the module via WS core_course_get_module and updates the module on the course page\n         *\n         * Used after d&d of the module to another section\n         *\n         * @param {JQuery} activityElement\n         * @param {Number} cmid\n         * @param {Number} sectionreturn\n         */\n        var refreshModule = function(activityElement, cmid, sectionreturn) {\n            var spinner = addActivitySpinner(activityElement);\n            var promises = ajax.call([{\n                methodname: 'core_course_get_module',\n                args: {id: cmid, sectionreturn: sectionreturn}\n            }], true);\n\n            $.when.apply($, promises)\n                .done(function(data) {\n                    removeSpinner(activityElement, spinner, 400);\n                    replaceActivityHtmlWith(data);\n                }).fail(function() {\n                    removeSpinner(activityElement, spinner);\n                });\n        };\n\n        /**\n         * Displays the delete confirmation to delete a module\n         *\n         * @param {JQuery} mainelement activity element we perform action on\n         * @param {function} onconfirm function to execute on confirm\n         */\n        var confirmDeleteModule = function(mainelement, onconfirm) {\n            var modtypename = mainelement.attr('class').match(/modtype_([^\\s]*)/)[1];\n            var modulename = getModuleName(mainelement);\n\n            str.get_string('pluginname', modtypename).done(function(pluginname) {\n                var plugindata = {\n                    type: pluginname,\n                    name: modulename\n                };\n                str.get_strings([\n                    {key: 'confirm'},\n                    {key: modulename === null ? 'deletechecktype' : 'deletechecktypename', param: plugindata},\n                    {key: 'yes'},\n                    {key: 'no'}\n                ]).done(function(s) {\n                        notification.confirm(s[0], s[1], s[2], s[3], onconfirm);\n                    }\n                );\n            });\n        };\n\n        /**\n         * Displays the delete confirmation to delete a section\n         *\n         * @param {String} message confirmation message\n         * @param {function} onconfirm function to execute on confirm\n         */\n        var confirmEditSection = function(message, onconfirm) {\n            str.get_strings([\n                {key: 'confirm'}, // TODO link text\n                {key: 'yes'},\n                {key: 'no'}\n            ]).done(function(s) {\n                    notification.confirm(s[0], message, s[1], s[2], onconfirm);\n                }\n            );\n        };\n\n        /**\n         * Replaces an action menu item with another one (for example Show->Hide, Set marker->Remove marker)\n         *\n         * @param {JQuery} actionitem\n         * @param {String} image new image name (\"i/show\", \"i/hide\", etc.)\n         * @param {String} stringname new string for the action menu item\n         * @param {String} stringcomponent\n         * @param {String} titlestr string for \"title\" attribute (if different from stringname)\n         * @param {String} titlecomponent\n         * @param {String} newaction new value for data-action attribute of the link\n         * @return {Promise} promise which is resolved when the replacement has completed\n         */\n        var replaceActionItem = function(actionitem, image, stringname,\n                                           stringcomponent, titlestr, titlecomponent, newaction) {\n\n\n            var stringRequests = [{key: stringname, component: stringcomponent}];\n            if (titlestr) {\n                stringRequests.push({key: titlestr, component: titlecomponent});\n            }\n\n            return str.get_strings(stringRequests).then(function(strings) {\n                actionitem.find('span.menu-action-text').html(strings[0]);\n                actionitem.attr('title', strings[0]);\n\n                var title = '';\n                if (titlestr) {\n                    title = strings[1];\n                    actionitem.attr('title', title);\n                }\n                return templates.renderPix(image, 'core', title);\n            }).then(function(pixhtml) {\n                actionitem.find('.icon').replaceWith(pixhtml);\n                actionitem.attr('data-action', newaction);\n                return;\n            }).catch(notification.exception);\n        };\n\n        /**\n         * Default post-processing for section AJAX edit actions.\n         *\n         * This can be overridden in course formats by listening to event coursesectionedited:\n         *\n         * $('body').on('coursesectionedited', 'li.section', function(e) {\n         *     var action = e.action,\n         *         sectionElement = $(e.target),\n         *         data = e.ajaxreturn;\n         *     // ... Do some processing here.\n         *     e.preventDefault(); // Prevent default handler.\n         * });\n         *\n         * @param {JQuery} sectionElement\n         * @param {JQuery} actionItem\n         * @param {Object} data\n         * @param {String} courseformat\n         */\n        var defaultEditSectionHandler = function(sectionElement, actionItem, data, courseformat) {\n            var action = actionItem.attr('data-action');\n            if (action === 'hide' || action === 'show') {\n                if (action === 'hide') {\n                    sectionElement.addClass('hidden');\n                    replaceActionItem(actionItem, 'i/show',\n                        'showfromothers', 'format_' + courseformat, null, null, 'show');\n                } else {\n                    sectionElement.removeClass('hidden');\n                    replaceActionItem(actionItem, 'i/hide',\n                        'hidefromothers', 'format_' + courseformat, null, null, 'hide');\n                }\n                // Replace the modules with new html (that indicates that they are now hidden or not hidden).\n                if (data.modules !== undefined) {\n                    for (var i in data.modules) {\n                        replaceActivityHtmlWith(data.modules[i]);\n                    }\n                }\n                // Replace the section availability information.\n                if (data.section_availability !== undefined) {\n                    sectionElement.find('.section_availability').first().replaceWith(data.section_availability);\n                }\n            } else if (action === 'setmarker') {\n                var oldmarker = $(SELECTOR.SECTIONLI + '.current'),\n                    oldActionItem = oldmarker.find(SELECTOR.SECTIONACTIONMENU + ' ' + 'a[data-action=removemarker]');\n                oldmarker.removeClass('current');\n                replaceActionItem(oldActionItem, 'i/marker',\n                    'highlight', 'core', 'markthistopic', 'core', 'setmarker');\n                sectionElement.addClass('current');\n                replaceActionItem(actionItem, 'i/marked',\n                    'highlightoff', 'core', 'markedthistopic', 'core', 'removemarker');\n            } else if (action === 'removemarker') {\n                sectionElement.removeClass('current');\n                replaceActionItem(actionItem, 'i/marker',\n                    'highlight', 'core', 'markthistopic', 'core', 'setmarker');\n            }\n        };\n\n        /**\n         * Replaces the course module with the new html (used to update module after it was edited or its visibility was changed).\n         *\n         * @param {String} activityHTML\n         */\n        var replaceActivityHtmlWith = function(activityHTML) {\n            $('<div>' + activityHTML + '</div>').find(SELECTOR.ACTIVITYLI).each(function() {\n                // Extract id from the new activity html.\n                var id = $(this).attr('id');\n                // Find the existing element with the same id and replace its contents with new html.\n                $(SELECTOR.ACTIVITYLI + '#' + id).replaceWith(activityHTML);\n                // Initialise action menu.\n                initActionMenu(id, false);\n            });\n        };\n\n        /**\n         * Performs an action on a module (moving, deleting, duplicating, hiding, etc.)\n         *\n         * @param {JQuery} sectionElement section element we perform action on\n         * @param {Nunmber} sectionid\n         * @param {JQuery} target the element (menu item) that was clicked\n         * @param {String} courseformat\n         */\n        var editSection = function(sectionElement, sectionid, target, courseformat) {\n            var action = target.attr('data-action'),\n                sectionreturn = target.attr('data-sectionreturn') ? target.attr('data-sectionreturn') : 0;\n            var spinner = addSectionSpinner(sectionElement);\n            var promises = ajax.call([{\n                methodname: 'core_course_edit_section',\n                args: {id: sectionid, action: action, sectionreturn: sectionreturn}\n            }], true);\n\n            var lightbox = addSectionLightbox(sectionElement);\n            $.when.apply($, promises)\n                .done(function(dataencoded) {\n                    var data = $.parseJSON(dataencoded);\n                    removeSpinner(sectionElement, spinner);\n                    removeLightbox(lightbox);\n                    sectionElement.find(SELECTOR.SECTIONACTIONMENU).find(SELECTOR.TOGGLE).focus();\n                    // Trigger event that can be observed by course formats.\n                    var e = $.Event('coursesectionedited', {ajaxreturn: data, action: action});\n                    sectionElement.trigger(e);\n                    if (!e.isDefaultPrevented()) {\n                        defaultEditSectionHandler(sectionElement, target, data, courseformat);\n                    }\n                }).fail(function(ex) {\n                    // Remove spinner and lightbox.\n                    removeSpinner(sectionElement, spinner);\n                    removeLightbox(lightbox);\n                    // Trigger event that can be observed by course formats.\n                    var e = $.Event('coursesectioneditfailed', {exception: ex, action: action});\n                    sectionElement.trigger(e);\n                    if (!e.isDefaultPrevented()) {\n                        notification.exception(ex);\n                    }\n                });\n        };\n\n        // Register a function to be executed after D&D of an activity.\n        Y.use('moodle-course-coursebase', function() {\n            M.course.coursebase.register_module({\n                // Ignore camelcase eslint rule for the next line because it is an expected name of the callback.\n                // eslint-disable-next-line camelcase\n                set_visibility_resource_ui: function(args) {\n                    var mainelement = $(args.element.getDOMNode());\n                    var cmid = getModuleId(mainelement);\n                    if (cmid) {\n                        var sectionreturn = mainelement.find('.' + CSS.EDITINGMOVE).attr('data-sectionreturn');\n                        refreshModule(mainelement, cmid, sectionreturn);\n                    }\n                }\n            });\n        });\n\n        return /** @alias module:core_course/actions */ {\n\n            /**\n             * Initialises course page\n             *\n             * @method init\n             * @param {String} courseformat name of the current course format (for fetching strings)\n             */\n            initCoursePage: function(courseformat) {\n\n                // Add a handler for course module actions.\n                $('body').on('click keypress', SELECTOR.ACTIVITYLI + ' ' +\n                        SELECTOR.ACTIVITYACTION + '[data-action]', function(e) {\n                    if (e.type === 'keypress' && e.keyCode !== 13) {\n                        return;\n                    }\n                    var actionItem = $(this),\n                        moduleElement = actionItem.closest(SELECTOR.ACTIVITYLI),\n                        action = actionItem.attr('data-action'),\n                        moduleId = getModuleId(moduleElement);\n                    switch (action) {\n                        case 'moveleft':\n                        case 'moveright':\n                        case 'delete':\n                        case 'duplicate':\n                        case 'hide':\n                        case 'stealth':\n                        case 'show':\n                        case 'groupsseparate':\n                        case 'groupsvisible':\n                        case 'groupsnone':\n                            break;\n                        default:\n                            // Nothing to do here!\n                            return;\n                    }\n                    if (!moduleId) {\n                        return;\n                    }\n                    e.preventDefault();\n                    if (action === 'delete') {\n                        // Deleting requires confirmation.\n                        confirmDeleteModule(moduleElement, function() {\n                            editModule(moduleElement, moduleId, actionItem);\n                        });\n                    } else {\n                        editModule(moduleElement, moduleId, actionItem);\n                    }\n                });\n\n                // Add a handler for section show/hide actions.\n                $('body').on('click keypress', SELECTOR.SECTIONLI + ' ' +\n                            SELECTOR.SECTIONACTIONMENU + '[data-sectionid] ' +\n                            'a[data-action]', function(e) {\n                    if (e.type === 'keypress' && e.keyCode !== 13) {\n                        return;\n                    }\n                    var actionItem = $(this),\n                        sectionElement = actionItem.closest(SELECTOR.SECTIONLI),\n                        sectionId = actionItem.closest(SELECTOR.SECTIONACTIONMENU).attr('data-sectionid');\n                    e.preventDefault();\n                    if (actionItem.attr('data-confirm')) {\n                        // Action requires confirmation.\n                        confirmEditSection(actionItem.attr('data-confirm'), function() {\n                            editSection(sectionElement, sectionId, actionItem, courseformat);\n                        });\n                    } else {\n                        editSection(sectionElement, sectionId, actionItem, courseformat);\n                    }\n                });\n\n                // Add a handler for \"Add sections\" link to ask for a number of sections to add.\n                str.get_string('numberweeks').done(function(strNumberSections) {\n                    var trigger = $(SELECTOR.ADDSECTIONS),\n                        modalTitle = trigger.attr('data-add-sections');\n                    var modalBody = $('<div><label for=\"add_section_numsections\"></label> ' +\n                        '<input id=\"add_section_numsections\" type=\"number\" min=\"1\" value=\"1\"></div>');\n                    modalBody.find('label').html(strNumberSections);\n                    ModalFactory.create({\n                        title: modalTitle,\n                        type: ModalFactory.types.SAVE_CANCEL,\n                        body: modalBody.html()\n                    }, trigger)\n                    .done(function(modal) {\n                        var numSections = $(modal.getBody()).find('#add_section_numsections'),\n                        addSections = function() {\n                            // Check if value of the \"Number of sections\" is a valid positive integer and redirect\n                            // to adding a section script.\n                            if ('' + parseInt(numSections.val()) === numSections.val() && parseInt(numSections.val()) >= 1) {\n                                document.location = trigger.attr('href') + '&numsections=' + parseInt(numSections.val());\n                            }\n                        };\n                        modal.setSaveButtonText(modalTitle);\n                        modal.getRoot().on(ModalEvents.shown, function() {\n                            // When modal is shown focus and select the input and add a listener to keypress of \"Enter\".\n                            numSections.focus().select().on('keydown', function(e) {\n                                if (e.keyCode === KeyCodes.enter) {\n                                    addSections();\n                                }\n                            });\n                        });\n                        modal.getRoot().on(ModalEvents.save, function(e) {\n                            // When modal \"Add\" button is pressed.\n                            e.preventDefault();\n                            addSections();\n                        });\n                    });\n                });\n            },\n\n            /**\n             * Replaces a section action menu item with another one (for example Show->Hide, Set marker->Remove marker)\n             *\n             * This method can be used by course formats in their listener to the coursesectionedited event\n             *\n             * @param {JQuery} sectionelement\n             * @param {String} selector CSS selector inside the section element, for example \"a[data-action=show]\"\n             * @param {String} image new image name (\"i/show\", \"i/hide\", etc.)\n             * @param {String} stringname new string for the action menu item\n             * @param {String} stringcomponent\n             * @param {String} titlestr string for \"title\" attribute (if different from stringname)\n             * @param {String} titlecomponent\n             * @param {String} newaction new value for data-action attribute of the link\n             */\n            replaceSectionActionItem: function(sectionelement, selector, image, stringname,\n                                                    stringcomponent, titlestr, titlecomponent, newaction) {\n                var actionitem = sectionelement.find(SELECTOR.SECTIONACTIONMENU + ' ' + selector);\n                replaceActionItem(actionitem, image, stringname, stringcomponent, titlestr, titlecomponent, newaction);\n            }\n        };\n    });\n"]}