{"version":3,"sources":["../src/completion_override.js"],"names":["define","$","Ajax","Str","ModalFactory","ModalEvents","Notification","CustomEvents","Templates","userFullName","triggerElement","getIconKeyFromState","state","tracking","setOverride","override","render","then","html","append","call","methodname","args","results","completionState","tooltipKey","get_string","stateString","params","date","user","attr","activity","titleString","completionTracking","renderPix","oppositeState","find","remove","data","userid","cmid","children","replaceWith","catch","exception","userConfirm","e","originalEvent","preventDefault","stopPropagation","currentTarget","elemData","split","newstate","newStateStr","get_strings","key","component","strings","param","create","type","types","CONFIRM","title","body","modal","getRoot","on","yes","hidden","focus","destroy","show","init","fullName","each","index","element","events","activate"],"mappings":"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","file":"completion_override.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AMD module to handle overriding activity completion status.\n *\n * @module     report_progress/completion_override\n * @package    report_progress\n * @copyright  2016 onwards Eiz Eddin Al Katrib <eiz@barasoft.co.uk>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/ajax', 'core/str', 'core/modal_factory', 'core/modal_events', 'core/notification',\n        'core/custom_interaction_events', 'core/templates'],\n    function($, Ajax, Str, ModalFactory, ModalEvents, Notification, CustomEvents, Templates) {\n\n        /**\n         * @type {String} the full name of the current user.\n         * @private\n         */\n        var userFullName;\n\n        /**\n         * @type {JQuery} JQuery object containing the element (completion link) that was most recently activated.\n         * @private\n         */\n        var triggerElement;\n\n        /**\n         * Helper function to get the pix icon key based on the completion state.\n         * @method getIconDescriptorFromState\n         * @param {number} state The current completion state.\n         * @param {string} tracking The completion tracking type, either 'manual' or 'auto'.\n         * @return {string} the key for the respective icon.\n         * @private\n         */\n        var getIconKeyFromState = function(state, tracking) {\n            return state > 0 ? 'i/completion-' + tracking + '-y-override' : 'i/completion-' + tracking + '-n-override';\n        };\n\n        /**\n         * Handles the confirmation of an override change, calling the web service to update it.\n         * @method setOverride\n         * @param {Object} override the override data\n         * @private\n         */\n        var setOverride = function(override) {\n            // Generate a loading spinner while we're working.\n            Templates.render('core/loading', {}).then(function(html) {\n                // Append the loading spinner to the trigger element.\n                triggerElement.append(html);\n\n                // Update the completion status override.\n                return Ajax.call([{\n                    methodname: 'core_completion_override_activity_completion_status',\n                    args: override\n                }])[0];\n            }).then(function(results) {\n                var completionState = (results.state > 0) ? 1 : 0;\n\n                // Now, build the new title string, get the new icon, and update the DOM.\n                var tooltipKey = completionState ? 'completion-y-override' : 'completion-n-override';\n                Str.get_string(tooltipKey, 'completion', userFullName).then(function(stateString) {\n                    var params = {\n                        state: stateString,\n                        date: '',\n                        user: triggerElement.attr('data-userfullname'),\n                        activity: triggerElement.attr('data-activityname')\n                    };\n                    return Str.get_string('progress-title', 'completion', params);\n                }).then(function(titleString) {\n                    var completionTracking = triggerElement.attr('data-completiontracking');\n                    return Templates.renderPix(getIconKeyFromState(completionState, completionTracking), 'core', titleString);\n                }).then(function(html) {\n                    var oppositeState = completionState > 0 ? 0 : 1;\n                    triggerElement.find('.loading-icon').remove();\n                    triggerElement.data('changecompl', override.userid + '-' + override.cmid + '-' + oppositeState);\n                    triggerElement.attr('data-changecompl', override.userid + '-' + override.cmid + '-' + oppositeState);\n                    triggerElement.children(\"img\").replaceWith(html);\n                    return;\n                }).catch(Notification.exception);\n\n                return;\n            }).catch(Notification.exception);\n        };\n\n        /**\n         * Handler for activation of a completion status button element.\n         * @method userConfirm\n         * @param {Event} e the CustomEvents event (CustomEvents.events.activate in this case)\n         * @param {Object} data an object containing the original event (click, keydown, etc.).\n         * @private\n         */\n        var userConfirm = function(e, data) {\n            data.originalEvent.preventDefault();\n            data.originalEvent.stopPropagation();\n            e.preventDefault();\n            e.stopPropagation();\n\n            triggerElement = $(e.currentTarget);\n            var elemData = triggerElement.data('changecompl').split('-');\n            var override = {\n                userid: elemData[0],\n                cmid: elemData[1],\n                newstate: elemData[2]\n            };\n            var newStateStr = (override.newstate == 1) ? 'completion-y' : 'completion-n';\n\n            Str.get_strings([\n                {key: newStateStr, component: 'completion'}\n            ]).then(function(strings) {\n                return Str.get_strings([\n                    {key: 'confirm', component: 'moodle'},\n                    {key: 'areyousureoverridecompletion', component: 'completion', param: strings[0]}\n                ]);\n            }).then(function(strings) {\n                // Create a yes/no modal.\n                return ModalFactory.create({\n                    type: ModalFactory.types.CONFIRM,\n                    title: strings[0],\n                    body: strings[1],\n                });\n            }).then(function(modal) {\n                // Now set up the handlers for the confirmation or cancellation of the modal, and show it.\n\n                // Confirmation only.\n                modal.getRoot().on(ModalEvents.yes, function() {\n                    setOverride(override);\n                });\n\n                // Confirming, closing, or cancelling will destroy the modal and return focus to the trigger element.\n                modal.getRoot().on(ModalEvents.hidden, function() {\n                    triggerElement.focus();\n                    modal.destroy();\n                });\n\n                // Display.\n                modal.show();\n                return;\n            }).catch(Notification.exception);\n        };\n\n        /**\n         * Init this module which allows activity completion state to be changed via ajax.\n         * @method init\n         * @param {string} fullName The current user's full name.\n         * @private\n         */\n        var init = function(fullName) {\n            userFullName = fullName;\n\n            // Register the click, space and enter events as activators for the trigger element.\n            $('#completion-progress a.changecompl').each(function(index, element) {\n                CustomEvents.define(element, [CustomEvents.events.activate]);\n            });\n\n            // Set the handler on the parent element (the table), but filter so the callback is only called for <a> type children\n            // having the '.changecompl' class. The <a> element can then be accessed in the callback via e.currentTarget.\n            $('#completion-progress').on(CustomEvents.events.activate, \"a.changecompl\", function(e, data) {\n                userConfirm(e, data);\n            });\n        };\n\n        return /** @alias module:report_progress/completion_override */ {\n            init: init\n        };\n    });\n"]}