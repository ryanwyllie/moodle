'use strict';define('report_progress/completion_override',['jquery','core/ajax','core/str','core/modal_factory','core/modal_events','core/notification','core/custom_interaction_events','core/templates'],function($,Ajax,Str,ModalFactory,ModalEvents,Notification,CustomEvents,Templates){var userFullName,triggerElement,getIconKeyFromState=function(state,tracking){return 0<state?'i/completion-'+tracking+'-y-override':'i/completion-'+tracking+'-n-override'},setOverride=function(override){Templates.render('core/loading',{}).then(function(html){return triggerElement.append(html),Ajax.call([{methodname:'core_completion_override_activity_completion_status',args:override}])[0]}).then(function(results){var completionState=0<results.state?1:0,tooltipKey=completionState?'completion-y-override':'completion-n-override';Str.get_string(tooltipKey,'completion',userFullName).then(function(stateString){var params={state:stateString,date:'',user:triggerElement.attr('data-userfullname'),activity:triggerElement.attr('data-activityname')};return Str.get_string('progress-title','completion',params)}).then(function(titleString){var completionTracking=triggerElement.attr('data-completiontracking');return Templates.renderPix(getIconKeyFromState(completionState,completionTracking),'core',titleString)}).then(function(html){var oppositeState=0<completionState?0:1;return triggerElement.find('.loading-icon').remove(),triggerElement.data('changecompl',override.userid+'-'+override.cmid+'-'+oppositeState),triggerElement.attr('data-changecompl',override.userid+'-'+override.cmid+'-'+oppositeState),void triggerElement.children('img').replaceWith(html)}).catch(Notification.exception)}).catch(Notification.exception)},userConfirm=function(e,data){data.originalEvent.preventDefault(),data.originalEvent.stopPropagation(),e.preventDefault(),e.stopPropagation(),triggerElement=$(e.currentTarget);var elemData=triggerElement.data('changecompl').split('-'),override={userid:elemData[0],cmid:elemData[1],newstate:elemData[2]},newStateStr=1==override.newstate?'completion-y':'completion-n';Str.get_strings([{key:newStateStr,component:'completion'}]).then(function(strings){return Str.get_strings([{key:'confirm',component:'moodle'},{key:'areyousureoverridecompletion',component:'completion',param:strings[0]}])}).then(function(strings){return ModalFactory.create({type:ModalFactory.types.CONFIRM,title:strings[0],body:strings[1]})}).then(function(modal){return modal.getRoot().on(ModalEvents.yes,function(){setOverride(override)}),modal.getRoot().on(ModalEvents.hidden,function(){triggerElement.focus(),modal.destroy()}),void modal.show()}).catch(Notification.exception)};return{init:function init(fullName){userFullName=fullName,$('#completion-progress a.changecompl').each(function(index,element){CustomEvents.define(element,[CustomEvents.events.activate])}),$('#completion-progress').on(CustomEvents.events.activate,'a.changecompl',function(e,data){userConfirm(e,data)})}}});
//# sourceMappingURL=completion_override.min.js.map
