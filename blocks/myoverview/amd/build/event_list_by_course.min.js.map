{"version":3,"sources":["../src/event_list_by_course.js"],"names":["define","$","EventList","EventsRepository","SELECTORS","EVENTS_BY_COURSE_CONTAINER","EVENT_LIST_CONTAINER","load","root","courseBlocks","find","length","eventList","first","midnight","attr","limit","courseIds","map","get","coursesPromise","queryByCourses","courseids","starttime","each","index","container","courseId","eventListContainer","rootSelector","promise","Deferred","done","result","events","courseGroup","groupedbycourse","filter","group","courseid","resolve","fail","e","reject","init"],"mappings":"aAuBAA,+CACA,CACI,QADJ,CAEI,6BAFJ,CAGI,6CAHJ,CADA,CAMA,SAASC,CAAT,CAAYC,SAAZ,CAAuBC,gBAAvB,CAAyC,IAIjCC,WAAY,CACZC,2BAA4B,yCADhB,CAEZC,qBAAsB,sCAFV,CAJqB,CAejCC,KAAO,SAASC,IAAT,CAAe,CACtB,GAAIC,cAAeD,KAAKE,IAAL,CAAUN,UAAUC,0BAApB,CAAnB,CAEA,GAAKI,aAAaE,MAAlB,KAIIC,WAAYH,aAAaC,IAAb,CAAkBN,UAAUE,oBAA5B,EAAkDO,KAAlD,EAJhB,CAKIC,SAAWF,UAAUG,IAAV,CAAe,eAAf,CALf,CAOIC,MAAQJ,UAAUG,IAAV,CAAe,YAAf,CAPZ,CAQIE,UAAYR,aAAaS,GAAb,CAAiB,UAAW,CACxC,MAAOjB,GAAE,IAAF,EAAQc,IAAR,CAAa,gBAAb,CACV,CAFe,EAEbI,GAFa,EARhB,CAeIC,eAAiBjB,iBAAiBkB,cAAjB,CAAgC,CACjDC,UAAWL,SADsC,CAEjDM,UAXYT,gBASqC,CAGjDE,MAAOA,KAH0C,CAAhC,CAfrB,CAsBAP,aAAae,IAAb,CAAkB,SAASC,KAAT,CAAgBC,SAAhB,CAA2B,CACzCA,UAAYzB,EAAEyB,SAAF,CAD6B,IAErCC,UAAWD,UAAUX,IAAV,CAAe,gBAAf,CAF0B,CAGrCa,mBAAqBF,UAAUhB,IAAV,CAAeR,UAAU2B,YAAzB,CAHgB,CAIrCC,QAAU7B,EAAE8B,QAAF,EAJ2B,CASzCX,eAAeY,IAAf,CAAoB,SAASC,MAAT,CAAiB,IAC7BC,QAAS,EADoB,CAI7BC,YAAcF,OAAOG,eAAP,CAAuBC,MAAvB,CAA8B,SAASC,KAAT,CAAgB,CAC5D,MAAOA,OAAMC,QAAN,EAAkBZ,QAC5B,CAFiB,CAJe,CAQ7BQ,YAAYxB,MARiB,GAS7BuB,OAASC,YAAY,CAAZ,EAAeD,MATK,EAYjCJ,QAAQU,OAAR,CAAgB,CAACN,OAAQA,MAAT,CAAhB,CACH,CAbD,EAaGO,IAbH,CAaQ,SAASC,CAAT,CAAY,CAChBZ,QAAQa,MAAR,CAAeD,CAAf,CACH,CAfD,CATyC,CA4BzCxC,UAAUK,IAAV,CAAeqB,kBAAf,CAAmCE,OAAnC,CACH,CA7BD,CAtBA,CAoDH,CAtEoC,CAwErC,MAAO,CACHc,KAAM,cAASpC,IAAT,CAAe,CACjBA,KAAOP,EAAEO,IAAF,CADU,CAEjBD,KAAKC,IAAL,CACH,CAJE,CAMV,CApFD,C","file":"event_list_by_course.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript to load and render the list of calendar events grouping by course.\n *\n * @module     block_myoverview/events_by_course_list\n * @package    block_myoverview\n * @copyright  2016 Simey Lameze <simey@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(\n[\n    'jquery',\n    'block_myoverview/event_list',\n    'block_myoverview/calendar_events_repository'\n],\nfunction($, EventList, EventsRepository) {\n\n    var SECONDS_IN_DAY = 60 * 60 * 24;\n\n    var SELECTORS = {\n        EVENTS_BY_COURSE_CONTAINER: '[data-region=\"course-events-container\"]',\n        EVENT_LIST_CONTAINER: '[data-region=\"event-list-container\"]',\n    };\n\n    /**\n     * Loop through course events containers and load calendar events for that course.\n     *\n     * @method load\n     * @param {Object} root The root element of sort by course list.\n     */\n    var load = function(root) {\n        var courseBlocks = root.find(SELECTORS.EVENTS_BY_COURSE_CONTAINER);\n\n        if (!courseBlocks.length) {\n            return;\n        }\n\n        var eventList = courseBlocks.find(SELECTORS.EVENT_LIST_CONTAINER).first();\n        var midnight = eventList.attr('data-midnight');\n        var startTime = midnight - (14 * SECONDS_IN_DAY);\n        var limit = eventList.attr('data-limit');\n        var courseIds = courseBlocks.map(function() {\n            return $(this).attr('data-course-id');\n        }).get();\n\n        // Load the first set of events for each course in a single request.\n        // We want to avoid sending an individual request for each course because\n        // there could be lots of them.\n        var coursesPromise = EventsRepository.queryByCourses({\n            courseids: courseIds,\n            starttime: startTime,\n            limit: limit\n        });\n\n        // Load the events into each course block.\n        courseBlocks.each(function(index, container) {\n            container = $(container);\n            var courseId = container.attr('data-course-id');\n            var eventListContainer = container.find(EventList.rootSelector);\n            var promise = $.Deferred();\n\n            // Once all of the course events have been loaded then we need\n            // to extract just the ones relevant to this course block and\n            // hand them to the event list to render.\n            coursesPromise.done(function(result) {\n                var events = [];\n                // Get this course block's events from the collection returned\n                // from the server.\n                var courseGroup = result.groupedbycourse.filter(function(group) {\n                    return group.courseid == courseId;\n                });\n\n                if (courseGroup.length) {\n                    events = courseGroup[0].events;\n                }\n\n                promise.resolve({events: events});\n            }).fail(function(e) {\n                promise.reject(e);\n            });\n\n            // Provide the event list with a promise that will be resolved\n            // when we have received the events from the server.\n            EventList.load(eventListContainer, promise);\n        });\n    };\n\n    return {\n        init: function(root) {\n            root = $(root);\n            load(root);\n        }\n    };\n});\n"]}