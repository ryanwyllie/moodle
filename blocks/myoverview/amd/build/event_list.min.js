'use strict';define('block_myoverview/event_list',['jquery','core/notification','core/templates','core/custom_interaction_events','block_myoverview/calendar_events_repository'],function($,Notification,Templates,CustomEvents,CalendarEventsRepository){var SELECTORS={EMPTY_MESSAGE:'[data-region="empty-message"]',ROOT:'[data-region="event-list-container"]',EVENT_LIST:'[data-region="event-list"]',EVENT_LIST_CONTENT:'[data-region="event-list-content"]',EVENT_LIST_GROUP_CONTAINER:'[data-region="event-list-group-container"]',LOADING_ICON_CONTAINER:'[data-region="loading-icon-container"]',VIEW_MORE_BUTTON:'[data-action="view-more"]'},TEMPLATES={EVENT_LIST_ITEMS:'block_myoverview/event-list-items',COURSE_EVENT_LIST_ITEMS:'block_myoverview/course-event-list-items'},setLoadedAll=function(root){root.attr('data-loaded-all',!0)},hasLoadedAll=function(root){return!!root.attr('data-loaded-all')},startLoading=function(root){var loadingIcon=root.find(SELECTORS.LOADING_ICON_CONTAINER),viewMoreButton=root.find(SELECTORS.VIEW_MORE_BUTTON);root.addClass('loading'),loadingIcon.removeClass('hidden'),viewMoreButton.prop('disabled',!0)},stopLoading=function(root){var loadingIcon=root.find(SELECTORS.LOADING_ICON_CONTAINER),viewMoreButton=root.find(SELECTORS.VIEW_MORE_BUTTON);root.removeClass('loading'),loadingIcon.addClass('hidden'),hasLoadedAll(root)||viewMoreButton.prop('disabled',!1)},isLoading=function(root){return root.hasClass('loading')},setHasContent=function(root){root.attr('data-has-events',!0)},hasContent=function(root){return!!root.attr('data-has-events')},updateContentVisibility=function(root,eventCount){eventCount?setHasContent(root):!hasContent(root)&&hideContent(root)},hideContent=function(root){root.find(SELECTORS.EVENT_LIST_CONTENT).addClass('hidden'),root.find(SELECTORS.EMPTY_MESSAGE).removeClass('hidden')},renderGroup=function(group,calendarEvents,templateName){return group.removeClass('hidden'),Templates.render(templateName,{events:calendarEvents}).done(function(html,js){Templates.appendNodeContents(group.find(SELECTORS.EVENT_LIST),html,js)})},timeUntilEvent=function(timestamp,event){var orderTime=event.timesort||0;return orderTime-timestamp},eventBelongsInContainer=function(root,event,container){var todayTime=root.attr('data-midnight'),timeUntilContainerStart=+container.attr('data-start-day')*86400,timeUntilContainerEnd=+container.attr('data-end-day')*86400,timeUntilEventNeedsAction=timeUntilEvent(todayTime,event);return''===container.attr('data-end-day')?timeUntilContainerStart<=timeUntilEventNeedsAction:timeUntilContainerStart<=timeUntilEventNeedsAction&&timeUntilEventNeedsAction<timeUntilContainerEnd},getFilterCallbackForContainer=function(root,container){return function(event){return eventBelongsInContainer(root,event,$(container))}},render=function(root,calendarEvents){var renderCount=0,templateName=TEMPLATES.EVENT_LIST_ITEMS;return root.attr('data-course-id')&&(templateName=TEMPLATES.COURSE_EVENT_LIST_ITEMS),$.when.apply($,$.map(root.find(SELECTORS.EVENT_LIST_GROUP_CONTAINER),function(container){var events=calendarEvents.filter(getFilterCallbackForContainer(root,container));return events.length?(renderCount+=events.length,renderGroup($(container),events,templateName)):null})).then(function(){return renderCount})},load=function(root,promise){root=$(root);var limit=+root.attr('data-limit'),courseId=+root.attr('data-course-id'),lastId=root.attr('data-last-id'),midnight=root.attr('data-midnight');if(isLoading(root))return $.Deferred().resolve();if(startLoading(root),'undefined'==typeof promise){var args={starttime:midnight-1209600,limit:limit};lastId&&(args.aftereventid=lastId),courseId?(args.courseid=courseId,promise=CalendarEventsRepository.queryByCourse(args)):promise=CalendarEventsRepository.queryByTime(args)}return promise.then(function(result){if(!result.events.length)return setLoadedAll(root),0;var calendarEvents=result.events;return root.attr('data-last-id',calendarEvents[calendarEvents.length-1].id),calendarEvents.length<limit&&setLoadedAll(root),render(root,calendarEvents).then(function(renderCount){return renderCount<calendarEvents.length&&setLoadedAll(root),calendarEvents.length})}).then(function(eventCount){return updateContentVisibility(root,eventCount)}).fail(Notification.exception).always(function(){stopLoading(root)})},registerEventListeners=function(root){CustomEvents.define(root,[CustomEvents.events.activate]),root.on(CustomEvents.events.activate,SELECTORS.VIEW_MORE_BUTTON,function(){load(root)})};return{init:function init(root){root=$(root),load(root),registerEventListeners(root)},registerEventListeners:registerEventListeners,load:load,rootSelector:SELECTORS.ROOT}});
//# sourceMappingURL=event_list.min.js.map
