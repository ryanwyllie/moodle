define(["jquery","core/notification","core/templates","core/custom_interaction_events","block_myoverview/calendar_events_repository"],function(a,b,c,d,e){var f=86400,g={EMPTY_MESSAGE:'[data-region="empty-message"]',EVENT_LIST:'[data-region="event-list"]',EVENT_LIST_CONTENT:'[data-region="event-list-content"]',EVENT_LIST_GROUP_CONTAINER:'[data-region="event-list-group-container"]',LOADING_ICON_CONTAINER:'[data-region="loading-icon-container"]',VIEW_MORE_BUTTON:'[data-action="view-more"]'},h=function(a){a.attr("data-loaded-all",!0)},i=function(a){return!!a.attr("data-loaded-all")},j=function(a){var b=a.find(g.LOADING_ICON_CONTAINER),c=a.find(g.VIEW_MORE_BUTTON);a.addClass("loading"),b.removeClass("hidden"),c.prop("disabled",!0)},k=function(a){var b=a.find(g.LOADING_ICON_CONTAINER),c=a.find(g.VIEW_MORE_BUTTON);a.removeClass("loading"),b.addClass("hidden"),i(a)||c.prop("disabled",!1)},l=function(a){return a.hasClass("loading")},m=function(a){a.attr("data-has-events",!0)},n=function(a){return!!a.attr("data-has-events")},o=function(a,b){b?m(a):n(a)||p(a)},p=function(a){a.find(g.EVENT_LIST_CONTENT).addClass("hidden"),a.find(g.EMPTY_MESSAGE).removeClass("hidden")},q=function(a,b){return a.removeClass("hidden"),c.render("block_myoverview/event-list-items",{events:b}).done(function(b,d){c.appendNodeContents(a.find(g.EVENT_LIST),b,d)})},r=function(a,b){var c=b.timesort||0;return c-a},s=function(a,b){var c=Math.floor((new Date).setHours(0,0,0,0)/1e3),d=+b.attr("data-start-day")*f,e=+b.attr("data-end-day")*f,g=r(c,a);return e?d<=g&&g<e:d<=g},t=function(b){return function(c){return s(c,a(b))}},u=function(b,c){var d=0;return a.when.apply(a,a.map(b.find(g.EVENT_LIST_GROUP_CONTAINER),function(b){var e=c.filter(t(b));return e.length?(d+=e.length,q(a(b),e)):null})).then(function(){return d})},v=function(c){c=a(c);var d=+c.attr("data-limit"),f=+c.attr("data-course-id"),g=c.attr("data-last-id")?c.attr("data-last-id"):void 0,i=new Date,m=Math.floor(i.setHours(0,0,0,0)/1e3);if(l(c))return a.Deferred().resolve();j(c);var n=null;return n=f?e.queryFromTimeByCourse(f,m,d,g):e.queryFromTime(m,d,g),n.then(function(a){return a.events}).then(function(a){return(!a.length||a.length<d)&&h(c),a.length?(c.attr("data-last-id",a[a.length-1].id),u(c,a).then(function(b){o(c,a.length),b<a.length&&h(c)})):void o(c,a.length)}).fail(b.exception).always(function(){k(c)})},w=function(a){d.define(a,[d.events.activate]),a.one(d.events.activate,g.VIEW_MORE_BUTTON,function(){v(a)})};return{init:function(b){b=a(b),v(b),w(b)},registerEventListeners:w,load:v}});