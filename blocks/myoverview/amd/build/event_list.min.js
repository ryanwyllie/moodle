define(["jquery","core/notification","core/templates","core/custom_interaction_events","block_myoverview/calendar_events_repository"],function(a,b,c,d,e){var f=86400,g={EVENT_LIST:'[data-region="event-list"]',EVENT_LIST_GROUP_CONTAINER:'[data-region="event-list-group-container"]',LOADING_ICON_CONTAINER:'[data-region="loading-icon-container"]',VIEW_MORE_BUTTON:'[data-action="view-more"]'},h=function(a){a.attr("data-loaded-all",!0)},i=function(a){return!!a.attr("data-loaded-all")},j=function(a){var b=a.find(g.LOADING_ICON_CONTAINER),c=a.find(g.VIEW_MORE_BUTTON);a.addClass("loading"),b.removeClass("hidden"),c.prop("disabled",!0)},k=function(a){var b=a.find(g.LOADING_ICON_CONTAINER),c=a.find(g.VIEW_MORE_BUTTON);a.removeClass("loading"),b.addClass("hidden"),i(a)||c.prop("disabled",!1)},l=function(a){return a.hasClass("loading")},m=function(a,b){return a.removeClass("hidden"),c.render("block_myoverview/event-list-items",{events:b}).done(function(b,d){c.appendNodeContents(a.find(g.EVENT_LIST),b,d)})},n=function(a,b,c,d){var e=d.orderTime||0,g=a+b*f;if(c){var h=a+c*f;return e>=g&&e<h}return e>=g},o=function(b,c){var d=[],e=new Date,f=Math.floor(e.setHours(0,0,0,0)/1e3),h=b.find(g.EVENT_LIST_GROUP_CONTAINER),i=0;return h.each(function(){var b=a(this),e=+b.attr("data-start-day"),g=+b.attr("data-end-day")||0,h=c.filter(function(a){return n(f,e,g,a)});h.length&&(i+=h.length,d.push(m(b,h)))}),a.when.apply(null,d).then(function(){return i})},p=function(c){c=a(c);var d=+c.attr("data-limit"),f=+c.attr("data-offset"),g=new Date,i=Math.floor(g.setHours(0,0,0,0)/1e3);return l(c)?a.Deferred().resolve():(j(c),e.queryFromTime(i,d,f).then(function(a){if((!a.length||a.length<d)&&h(c),a.length)return c.attr("data-offset",f+a.length),o(c,a).then(function(b){b<a.length&&h(c)})}).fail(b.exception).always(function(){k(c)}))},q=function(a){d.define(a,[d.events.activate]),a.on(d.events.activate,g.VIEW_MORE_BUTTON,function(){p(a)})};return{init:function(b){b=a(b),p(b),q(b)},load:p,registerEventListeners:q}});