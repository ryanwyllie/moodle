'use strict';define('core/tag',['jquery','core/ajax','core/templates','core/notification','core/str','core/modal_factory','core/modal_events'],function($,ajax,templates,notification,str,ModalFactory,ModalEvents){return{initTagindexPage:function initTagindexPage(){$('body').delegate('.tagarea[data-ta] a[data-quickload=1]','click',function(e){e.preventDefault();var target=$(this),query=target[0].search.replace(/^\?/,''),tagarea=target.closest('.tagarea[data-ta]'),args=query.split('&').reduce(function(s,c){var t=c.split('=');return s[t[0]]=decodeURIComponent(t[1]),s},{}),promises=ajax.call([{methodname:'core_tag_get_tagindex',args:{tagindex:args}}],!0);$.when.apply($,promises).done(function(data){templates.render('core_tag/index',data).done(function(html){tagarea.replaceWith(html)})})})},initManagePage:function initManagePage(){$('body').on('updated','[data-inplaceeditable]',function(e){if(str.get_string('selecttag','core_tag',e.ajaxreturn.value).then(function(s){return $('label[for="tagselect'+e.ajaxreturn.itemid+'"]').html(s)}).fail(notification.exception),str.get_string('now').done(function(s){$(e.target).closest('tr').find('td.col-timemodified').html(s)}),'tagflag'===e.ajaxreturn.itemtype){var row=$(e.target).closest('tr');'0'===e.ajaxreturn.value?row.removeClass('flagged-tag'):row.addClass('flagged-tag')}}),$('.tag-management-table').delegate('a.tagdelete','click',function(e){e.preventDefault();var href=$(this).attr('href');str.get_strings([{key:'delete'},{key:'confirmdeletetag',component:'tag'},{key:'yes'},{key:'no'}]).done(function(s){notification.confirm(s[0],s[1],s[2],s[3],function(){window.location.href=href})})}),$('#tag-management-delete').click(function(e){var form=$(this).closest('form').get(0),cnt=$(form).find('input[type=checkbox]:checked').length;if(cnt){var tempElement=$('<input type=\'hidden\'/>').attr('name',this.name);e.preventDefault(),str.get_strings([{key:'delete'},{key:'confirmdeletetags',component:'tag'},{key:'yes'},{key:'no'}]).done(function(s){notification.confirm(s[0],s[1],s[2],s[3],function(){tempElement.appendTo(form),form.submit()})})}}),$('#tag-management-combine').click(function(e){e.preventDefault();var form=$(this).closest('form').get(0),tags=$(form).find('input[type=checkbox]:checked');if(1>=tags.length)return void str.get_strings([{key:'combineselected',component:'tag'},{key:'selectmultipletags',component:'tag'},{key:'ok'}]).done(function(s){notification.alert(s[0],s[1],s[2])});var tempElement=$('<input type=\'hidden\'/>').attr('name',this.name),saveButtonText='',tagOptions=[];tags.each(function(){var tagid=$(this).val(),tagname=$('.inplaceeditable[data-itemtype=tagname][data-itemid='+tagid+']').attr('data-value');tagOptions.push({id:tagid,name:tagname})}),str.get_strings([{key:'combineselected',component:'tag'},{key:'continue'}]).then(function(langStrings){var modalTitle=langStrings[0];saveButtonText=langStrings[1];return ModalFactory.create({title:modalTitle,body:templates.render('core_tag/combine_tags',{tags:tagOptions}),type:ModalFactory.types.SAVE_CANCEL})}).then(function(modal){return modal.setSaveButtonText(saveButtonText),modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault(),tempElement.appendTo(form);var maintag=$('input[name=maintag]:checked','#combinetags_form').val();$('<input type=\'hidden\'/>').attr('name','maintag').attr('value',maintag).appendTo(form),form.submit()}),modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy()}),modal.show(),void $('#combinetags_form input[type=radio]').first().focus().prop('checked',!0)}).catch(notification.exception)}),$('body').on('updatefailed','[data-inplaceeditable][data-itemtype=tagname]',function(e){var exception=e.exception,newvalue=e.newvalue,tagid=$(e.target).attr('data-itemid');'namesalreadybeeingused'===exception.errorcode&&(e.preventDefault(),str.get_strings([{key:'nameuseddocombine',component:'tag'},{key:'yes'},{key:'cancel'}]).done(function(s){notification.confirm(e.message,s[0],s[1],s[2],function(){window.location.href=window.location.href+'&newname='+encodeURIComponent(newvalue)+'&tagid='+encodeURIComponent(tagid)+'&action=renamecombine&sesskey='+M.cfg.sesskey})}))}),$('body').on('click','a[data-action=addstandardtag]',function(e){e.preventDefault();var saveButtonText='';str.get_strings([{key:'addotags',component:'tag'},{key:'continue'}]).then(function(langStrings){var modalTitle=langStrings[0];saveButtonText=langStrings[1];var templateContext={actionurl:window.location.href,sesskey:M.cfg.sesskey};return ModalFactory.create({title:modalTitle,body:templates.render('core_tag/add_tags',templateContext),type:ModalFactory.types.SAVE_CANCEL})}).then(function(modal){return modal.setSaveButtonText(saveButtonText),modal.getRoot().on(ModalEvents.save,function(e){var tagsInput=$(e.currentTarget).find('#id_tagslist'),name=tagsInput.val().trim();tagsInput.val(name);var tagsForm=$('#addtags_form');return tagsForm.on('submit',function(e){var form=$('#addtags_form');!1===form[0].checkValidity()&&(e.preventDefault(),e.stopPropagation()),form.addClass('was-validated'),$('[data-region="tagslistinput"]').addClass('error');var errorMessage=$('#id_tagslist_error_message');errorMessage.removeAttr('hidden'),errorMessage.addClass('help-block')}),tagsForm.submit(),!1}),modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy()}),void modal.show()}).catch(notification.exception)})},initManageCollectionsPage:function initManageCollectionsPage(){$('body').on('updated','[data-inplaceeditable]',function(e){var areaid,collid,isenabled,ajaxreturn=e.ajaxreturn;'core_tag'===ajaxreturn.component&&'tagareaenable'===ajaxreturn.itemtype&&(areaid=$(this).attr('data-itemid'),$('.tag-collections-table ul[data-collectionid] li[data-areaid='+areaid+']').hide(),isenabled=ajaxreturn.value,'1'===isenabled?($(this).closest('tr').removeClass('dimmed_text'),collid=$(this).closest('tr').find('[data-itemtype="tagareacollection"]').attr('data-value'),$('.tag-collections-table ul[data-collectionid='+collid+'] li[data-areaid='+areaid+']').show()):$(this).closest('tr').addClass('dimmed_text')),'core_tag'===ajaxreturn.component&&'tagareacollection'===ajaxreturn.itemtype&&(areaid=$(this).attr('data-itemid'),$('.tag-collections-table ul[data-collectionid] li[data-areaid='+areaid+']').hide(),collid=$(this).attr('data-value'),isenabled=$(this).closest('tr').find('[data-itemtype="tagareaenable"]').attr('data-value'),'1'===isenabled&&$('.tag-collections-table ul[data-collectionid='+collid+'] li[data-areaid='+areaid+']').show())}),$('body').on('click','.addtagcoll > a',function(e){e.preventDefault();var href=$(this).attr('data-url'),saveButtonText='';str.get_strings([{key:'addtagcoll',component:'tag'},{key:'create'}]).then(function(langStrings){var modalTitle=langStrings[0];saveButtonText=langStrings[1];var templateContext={actionurl:href,sesskey:M.cfg.sesskey};return ModalFactory.create({title:modalTitle,body:templates.render('core_tag/add_tag_collection',templateContext),type:ModalFactory.types.SAVE_CANCEL})}).then(function(modal){return modal.setSaveButtonText(saveButtonText),modal.getRoot().on(ModalEvents.save,function(e){var collectionInput=$(e.currentTarget).find('#addtagcoll_name'),name=collectionInput.val().trim();collectionInput.val(name);var form=$('#addtagcoll_form');return form.on('submit',function(e){!1===form[0].checkValidity()&&(e.preventDefault(),e.stopPropagation()),form.addClass('was-validated'),$('[data-region="addtagcoll_nameinput"]').addClass('error');var errorMessage=$('#id_addtagcoll_name_error_message');errorMessage.removeAttr('hidden'),errorMessage.addClass('help-block')}),form.submit(),!1}),modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy()}),void modal.show()}).catch(notification.exception)}),$('body').on('click','.tag-collections-table .action_delete',function(e){e.preventDefault();var href=$(this).attr('data-url')+'&sesskey='+M.cfg.sesskey;str.get_strings([{key:'delete'},{key:'suredeletecoll',component:'tag',param:$(this).attr('data-collname')},{key:'yes'},{key:'no'}]).done(function(s){notification.confirm(s[0],s[1],s[2],s[3],function(){window.location.href=href})})})}}});
//# sourceMappingURL=tag.min.js.map
