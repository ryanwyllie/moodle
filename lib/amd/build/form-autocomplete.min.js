'use strict';define('core/form-autocomplete',['jquery','core/log','core/str','core/templates','core/notification'],function($,log,str,templates,notification){var KEYS={DOWN:40,ENTER:13,SPACE:32,ESCAPE:27,COMMA:44,UP:38},uniqueId=$.now(),activateSelection=function(index,state){var selectionElement=$(document.getElementById(state.selectionId)),length=selectionElement.children('[aria-selected=true]').length;for(index%=length;0>index;)index+=length;var element=$(selectionElement.children('[aria-selected=true]').get(index)),itemId=state.selectionId+'-'+index;selectionElement.children().attr('data-active-selection',!1).attr('id',''),element.attr('data-active-selection',!0).attr('id',itemId),selectionElement.attr('aria-activedescendant',itemId)},updateSelectionList=function(options,state,originalSelect){var items=[],newSelection=$(document.getElementById(state.selectionId)),activeId=newSelection.attr('aria-activedescendant'),activeValue=!1;activeId&&(activeValue=$(document.getElementById(activeId)).attr('data-value')),originalSelect.children('option').each(function(index,ele){if($(ele).prop('selected')){var label;label=$(ele).data('html')?$(ele).data('html'):$(ele).html(),items.push({label:label,value:$(ele).attr('value')})}});var context=$.extend({items:items},options,state);templates.render('core/form_autocomplete_selection',context).done(function(newHTML){newSelection.empty().append($(newHTML).html()),!1!==activeValue&&newSelection.children('[aria-selected=true]').each(function(index,ele){$(ele).attr('data-value')===activeValue&&activateSelection(index,state)})}).fail(notification.exception)},notifyChange=function(originalSelect){'undefined'!=typeof M.core_formchangechecker&&M.core_formchangechecker.set_form_changed(),originalSelect.change()},deselectItem=function(options,state,item,originalSelect){var selectedItemValue=$(item).attr('data-value');options.multiple&&originalSelect.children('option').each(function(index,ele){$(ele).attr('value')==selectedItemValue&&($(ele).prop('selected',!1),$(ele).attr('data-iscustom')&&$(ele).remove())}),updateSelectionList(options,state,originalSelect),notifyChange(originalSelect)},activateItem=function(index,state){var inputElement=$(document.getElementById(state.inputId)),suggestionsElement=$(document.getElementById(state.suggestionsId)),length=suggestionsElement.children('[aria-hidden=false]').length;for(index%=length;0>index;)index+=length;var element=$(suggestionsElement.children('[aria-hidden=false]').get(index)),globalIndex=$(suggestionsElement.children('[role=option]')).index(element),itemId=state.suggestionsId+'-'+globalIndex;suggestionsElement.children().attr('aria-selected',!1).attr('id',''),element.attr('aria-selected',!0).attr('id',itemId),inputElement.attr('aria-activedescendant',itemId);var scrollPos=element.offset().top-suggestionsElement.offset().top+suggestionsElement.scrollTop()-suggestionsElement.height()/2;suggestionsElement.animate({scrollTop:scrollPos},100)},activateNextItem=function(state){var suggestionsElement=$(document.getElementById(state.suggestionsId)),element=suggestionsElement.children('[aria-selected=true]'),current=suggestionsElement.children('[aria-hidden=false]').index(element);activateItem(current+1,state)},activatePreviousSelection=function(state){var selectionsElement=$(document.getElementById(state.selectionId)),element=selectionsElement.children('[data-active-selection=true]');if(!element)return void activateSelection(0,state);var current=selectionsElement.children('[aria-selected=true]').index(element);activateSelection(current-1,state)},activateNextSelection=function(state){var selectionsElement=$(document.getElementById(state.selectionId)),element=selectionsElement.children('[data-active-selection=true]');if(!element)return void activateSelection(0,state);var current=selectionsElement.children('[aria-selected=true]').index(element);activateSelection(current+1,state)},activatePreviousItem=function(state){var suggestionsElement=$(document.getElementById(state.suggestionsId)),element=suggestionsElement.children('[aria-selected=true]'),current=suggestionsElement.children('[aria-hidden=false]').index(element);activateItem(current-1,state)},closeSuggestions=function(state){var inputElement=$(document.getElementById(state.inputId)),suggestionsElement=$(document.getElementById(state.suggestionsId));inputElement.attr('aria-expanded',!1).attr('aria-activedescendant',state.selectionId),suggestionsElement.hide().attr('aria-hidden',!0)},updateSuggestions=function(options,state,query,originalSelect){var inputElement=$(document.getElementById(state.inputId)),suggestionsElement=$(document.getElementById(state.suggestionsId)),matchingElements=!1,suggestions=[];originalSelect.children('option').each(function(index,option){!0!==$(option).prop('selected')&&(suggestions[suggestions.length]={label:option.innerHTML,value:$(option).attr('value')})});var searchquery=state.caseSensitive?query:query.toLocaleLowerCase(),context=$.extend({options:suggestions},options,state);templates.render('core/form_autocomplete_suggestions',context).done(function(newHTML){suggestionsElement.replaceWith(newHTML),suggestionsElement=$(document.getElementById(state.suggestionsId)),suggestionsElement.show().attr('aria-hidden',!1),suggestionsElement.children().each(function(index,node){node=$(node),options.caseSensitive&&-1<node.text().indexOf(searchquery)||!options.caseSensitive&&-1<node.text().toLocaleLowerCase().indexOf(searchquery)?(node.show().attr('aria-hidden',!1),matchingElements=!0):node.hide().attr('aria-hidden',!0)}),inputElement.attr('aria-expanded',!0),originalSelect.attr('data-notice')?suggestionsElement.html(originalSelect.attr('data-notice')):matchingElements?!options.tags&&activateItem(0,state):str.get_string('nosuggestions','form').done(function(nosuggestionsstr){suggestionsElement.html(nosuggestionsstr)})}).fail(notification.exception)},createItem=function(options,state,originalSelect){var inputElement=$(document.getElementById(state.inputId)),query=inputElement.val(),tags=query.split(','),found=!1;$.each(tags,function(tagindex,tag){if(tag=tag.trim(),''!==tag&&(options.multiple||originalSelect.children('option').prop('selected',!1),originalSelect.children('option').each(function(index,ele){$(ele).attr('value')==tag&&(found=!0,$(ele).prop('selected',!0))}),!found)){var option=$('<option>');option.append(tag),option.attr('value',tag),originalSelect.append(option),option.prop('selected',!0),option.attr('data-iscustom',!0)}}),updateSelectionList(options,state,originalSelect),notifyChange(originalSelect),inputElement.val(''),closeSuggestions(state)},selectCurrentItem=function(options,state,originalSelect){var inputElement=$(document.getElementById(state.inputId)),suggestionsElement=$(document.getElementById(state.suggestionsId)),selectedItemValue=suggestionsElement.children('[aria-selected=true]').attr('data-value');options.multiple||originalSelect.children('option').prop('selected',!1),originalSelect.children('option').each(function(index,ele){$(ele).attr('value')==selectedItemValue&&$(ele).prop('selected',!0)}),updateSelectionList(options,state,originalSelect),notifyChange(originalSelect),options.closeSuggestionsOnSelect?(inputElement.val(''),closeSuggestions(state)):(inputElement.focus(),updateSuggestions(options,state,inputElement.val(),originalSelect))},updateAjax=function(e,options,state,originalSelect,ajaxHandler){M.util.js_pending('form-autocomplete-updateajax');var query=$(e.currentTarget).val();ajaxHandler.transport(options.selector,query,function(results){var processedResults=ajaxHandler.processResults(options.selector,results),existingValues=[];if(originalSelect.children('option').each(function(optionIndex,option){option=$(option),option.prop('selected')?existingValues.push(option.attr('value')+''):option.remove()}),!options.multiple&&0===originalSelect.children('option').length){var option=$('<option>');originalSelect.append(option)}$.isArray(processedResults)?($.each(processedResults,function(resultIndex,result){if(-1===existingValues.indexOf(result.value+'')){var option=$('<option>');option.append(result.label),option.attr('value',result.value),originalSelect.append(option)}}),originalSelect.attr('data-notice','')):originalSelect.attr('data-notice',processedResults),updateSuggestions(options,state,'',originalSelect),M.util.js_complete('form-autocomplete-updateajax')},function(error){M.util.js_complete('form-autocomplete-updateajax'),notification.exception(error)})},addNavigation=function(options,state,originalSelect){var inputElement=$(document.getElementById(state.inputId));if(inputElement.on('keydown',function(e){var pendingKey='form-autocomplete-addnav-'+state.inputId+'-'+e.keyCode;switch(M.util.js_pending(pendingKey),e.keyCode){case KEYS.DOWN:return options.showSuggestions?('true'===inputElement.attr('aria-expanded')?activateNextItem(state):!inputElement.val()&&options.ajax?require([options.ajax],function(ajaxHandler){updateAjax(e,options,state,originalSelect,ajaxHandler)}):updateSuggestions(options,state,inputElement.val(),originalSelect),e.preventDefault(),M.util.js_complete(pendingKey),!1):(M.util.js_complete(pendingKey),!0);case KEYS.UP:return activatePreviousItem(state),e.preventDefault(),M.util.js_complete(pendingKey),!1;case KEYS.ENTER:var suggestionsElement=$(document.getElementById(state.suggestionsId));return'true'===inputElement.attr('aria-expanded')&&0<suggestionsElement.children('[aria-selected=true]').length?selectCurrentItem(options,state,originalSelect):options.tags&&createItem(options,state,originalSelect),e.preventDefault(),M.util.js_complete(pendingKey),!1;case KEYS.ESCAPE:return'true'===inputElement.attr('aria-expanded')&&closeSuggestions(state),e.preventDefault(),M.util.js_complete(pendingKey),!1;}return M.util.js_complete(pendingKey),!0}),inputElement.on('keypress',function(e){var pendingKey='form-autocomplete-keypress-'+e.keyCode;return(M.util.js_pending(pendingKey),e.keyCode===KEYS.COMMA)?(options.tags&&createItem(options,state,originalSelect),e.preventDefault(),M.util.js_complete(pendingKey),!1):(M.util.js_complete(pendingKey),!0)}),inputElement.on('behat:set-value',function(){var suggestionsElement=$(document.getElementById(state.suggestionsId));M.util.js_pending('form-autocomplete-behat'),'true'===inputElement.attr('aria-expanded')&&0<suggestionsElement.children('[aria-selected=true]').length?selectCurrentItem(options,state,originalSelect):options.tags&&createItem(options,state,originalSelect),M.util.js_complete('form-autocomplete-behat')}),inputElement.on('blur',function(){M.util.js_pending('form-autocomplete-blur'),window.setTimeout(function(){var focusElement=$(document.activeElement);focusElement.attr('id')!=inputElement.attr('id')&&(options.tags&&createItem(options,state,originalSelect),closeSuggestions(state)),M.util.js_complete('form-autocomplete-blur')},500)}),options.showSuggestions){var arrowElement=$(document.getElementById(state.downArrowId));arrowElement.on('click',function(e){M.util.js_pending('form-autocomplete-show-suggestions'),inputElement.focus(),!inputElement.val()&&options.ajax?require([options.ajax],function(ajaxHandler){updateAjax(e,options,state,originalSelect,ajaxHandler)}):updateSuggestions(options,state,inputElement.val(),originalSelect),M.util.js_complete('form-autocomplete-show-suggestions')})}var suggestionsElement=$(document.getElementById(state.suggestionsId));suggestionsElement.parent().on('click','[role=option]',function(e){M.util.js_pending('form-autocomplete-parent');var element=$(e.currentTarget).closest('[role=option]'),suggestionsElement=$(document.getElementById(state.suggestionsId)),current=suggestionsElement.children('[aria-hidden=false]').index(element);activateItem(current,state),selectCurrentItem(options,state,originalSelect),M.util.js_complete('form-autocomplete-parent')});var selectionElement=$(document.getElementById(state.selectionId));selectionElement.on('click','[role=listitem]',function(e){M.util.js_pending('form-autocomplete-clicks');var item=$(e.currentTarget);deselectItem(options,state,item,originalSelect),M.util.js_complete('form-autocomplete-clicks')}),selectionElement.on('keydown',function(e){var pendingKey='form-autocomplete-keydown-'+e.keyCode;switch(M.util.js_pending(pendingKey),e.keyCode){case KEYS.DOWN:return activateNextSelection(state),e.preventDefault(),M.util.js_complete(pendingKey),!1;case KEYS.UP:return activatePreviousSelection(state),e.preventDefault(),M.util.js_complete(pendingKey),!1;case KEYS.SPACE:case KEYS.ENTER:var selectedItem=$(document.getElementById(state.selectionId)).children('[data-active-selection=true]');return selectedItem&&(deselectItem(options,state,selectedItem,originalSelect),e.preventDefault()),M.util.js_complete(pendingKey),!1;}return M.util.js_complete(pendingKey),!0}),options.showSuggestions&&(options.ajax?require([options.ajax],function(ajaxHandler){var throttleTimeout=null,handler=function(e){updateAjax(e,options,state,originalSelect,ajaxHandler),M.util.js_complete('autocomplete-throttledhandler')},throttledHandler=function(e){null===throttleTimeout?M.util.js_pending('autocomplete-throttledhandler'):(window.clearTimeout(throttleTimeout),throttleTimeout=null),throttleTimeout=window.setTimeout(handler.bind(this,e),300)};inputElement.on('input',throttledHandler)}):inputElement.on('input',function(e){var query=$(e.currentTarget).val(),last=$(e.currentTarget).data('last-value');last!==query&&updateSuggestions(options,state,query,originalSelect),$(e.currentTarget).data('last-value',query)}))};return{enhance:function enhance(selector,tags,ajax,placeholder,caseSensitive,showSuggestions,noSelectionString,closeSuggestionsOnSelect){var options={selector:selector,tags:!1,ajax:!1,placeholder:placeholder,caseSensitive:!1,showSuggestions:!0,noSelectionString:noSelectionString},pendingKey='autocomplete-setup-'+selector;M.util.js_pending(pendingKey),'undefined'!=typeof tags&&(options.tags=tags),'undefined'!=typeof ajax&&(options.ajax=ajax),'undefined'!=typeof caseSensitive&&(options.caseSensitive=caseSensitive),'undefined'!=typeof showSuggestions&&(options.showSuggestions=showSuggestions),'undefined'==typeof noSelectionString&&str.get_string('noselection','form').done(function(result){options.noSelectionString=result}).fail(notification.exception);var originalSelect=$(selector);if(!originalSelect)return log.debug('Selector not found: '+selector),M.util.js_complete(pendingKey),!1;originalSelect.css('visibility','hidden').attr('aria-hidden',!0);var state={selectId:originalSelect.attr('id'),inputId:'form_autocomplete_input-'+uniqueId,suggestionsId:'form_autocomplete_suggestions-'+uniqueId,selectionId:'form_autocomplete_selection-'+uniqueId,downArrowId:'form_autocomplete_downarrow-'+uniqueId};uniqueId++,options.multiple=originalSelect.attr('multiple'),options.closeSuggestionsOnSelect='undefined'==typeof closeSuggestionsOnSelect?!options.multiple:closeSuggestionsOnSelect;var originalLabel=$('[for='+state.selectId+']'),suggestions=[];originalSelect.children('option').each(function(index,option){suggestions[index]={label:option.innerHTML,value:$(option).attr('value')}});var context=$.extend({},options,state);context.options=suggestions,context.items=[];var renderInput=templates.render('core/form_autocomplete_input',context),renderDatalist=templates.render('core/form_autocomplete_suggestions',context),renderSelection=templates.render('core/form_autocomplete_selection',context);return $.when(renderInput,renderDatalist,renderSelection).then(function(input,suggestions,selection){originalSelect.hide(),originalSelect.after(suggestions),originalSelect.after(input),originalSelect.after(selection),originalLabel.attr('for',state.inputId),addNavigation(options,state,originalSelect);var suggestionsElement=$(document.getElementById(state.suggestionsId));return suggestionsElement.hide().attr('aria-hidden',!0),updateSelectionList(options,state,originalSelect),M.util.js_complete(pendingKey),!0}).fail(function(error){M.util.js_complete(pendingKey),notification.exception(error)})}}});
//# sourceMappingURL=form-autocomplete.min.js.map
