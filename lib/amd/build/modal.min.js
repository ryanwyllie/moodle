'use strict';var _typeof='function'==typeof Symbol&&'symbol'==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&'function'==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?'symbol':typeof obj};define('core/modal',['jquery','core/templates','core/notification','core/key_codes','core/custom_interaction_events','core/modal_backdrop','core/event','core/modal_events'],function($,Templates,Notification,KeyCodes,CustomEvents,ModalBackdrop,Event,ModalEvents){var backdropPromise,SELECTORS={CONTAINER:'[data-region="modal-container"]',MODAL:'[data-region="modal"]',HEADER:'[data-region="header"]',TITLE:'[data-region="title"]',BODY:'[data-region="body"]',FOOTER:'[data-region="footer"]',HIDE:'[data-action="hide"]',DIALOG:'[role=dialog]',MENU_BAR:'[role=menubar]',HAS_Z_INDEX:'.moodle-has-zindex',CAN_RECEIVE_FOCUS:'input:not([type="hidden"]), a[href], button, textarea, select, [tabindex]'},TEMPLATES={LOADING:'core/loading',BACKDROP:'core/modal_backdrop'},modalCounter=0,Modal=function(root){this.root=$(root),this.modal=this.root.find(SELECTORS.MODAL),this.header=this.modal.find(SELECTORS.HEADER),this.title=this.header.find(SELECTORS.TITLE),this.body=this.modal.find(SELECTORS.BODY),this.footer=this.modal.find(SELECTORS.FOOTER),this.hiddenSiblings=[],this.isAttached=!1,this.bodyJS=null,this.footerJS=null,this.modalCount=modalCounter++,this.root.is(SELECTORS.CONTAINER)||Notification.exception({message:'Element is not a modal container'}),this.modal.length||Notification.exception({message:'Container does not contain a modal'}),this.header.length||Notification.exception({message:'Modal is missing a header region'}),this.title.length||Notification.exception({message:'Modal header is missing a title region'}),this.body.length||Notification.exception({message:'Modal is missing a body region'}),this.footer.length||Notification.exception({message:'Modal is missing a footer region'}),this.registerEventListeners()};return Modal.prototype.attachToDOM=function(){this.isAttached||($('body').append(this.root),this.bodyJS&&(Templates.runTemplateJS(this.bodyJS),this.bodyJS=null),this.footerJS&&(Templates.runTemplateJS(this.footerJS),this.footerJS=null),this.isAttached=!0)},Modal.prototype.countOtherVisibleModals=function(){var count=0;return $('body').find(SELECTORS.CONTAINER).each(function(index,element){element=$(element),!this.root.is(element)&&element.hasClass('show')&&count++}.bind(this)),count},Modal.prototype.getBackdrop=function(){return backdropPromise||(backdropPromise=Templates.render(TEMPLATES.BACKDROP,{}).then(function(html){var element=$(html);return new ModalBackdrop(element)}).fail(Notification.exception)),backdropPromise},Modal.prototype.getRoot=function(){return this.root},Modal.prototype.getModal=function(){return this.modal},Modal.prototype.getTitle=function(){return this.title},Modal.prototype.getBody=function(){return this.body},Modal.prototype.getFooter=function(){return this.footer},Modal.prototype.getModalCount=function(){return this.modalCount},Modal.prototype.setTitle=function(value){var title=this.getTitle();this.asyncSet(value,title.html.bind(title))},Modal.prototype.setBody=function(value){var body=this.getBody();if('string'==typeof value)body.html(value),Event.notifyFilterContentUpdated(body),this.getRoot().trigger(ModalEvents.bodyRendered,this);else{var jsPendingId='amd-modal-js-pending-id-'+this.getModalCount();M.util.js_pending(jsPendingId);var contentPromise=null;if(body.css('overflow','hidden'),'pending'==value.state()){var height=body.innerHeight();100>height&&(height=100),body.animate({height:height+'px'},150),body.html(''),contentPromise=Templates.render(TEMPLATES.LOADING,{}).then(function(html){var loadingIcon=$(html).hide();return body.html(loadingIcon),loadingIcon.fadeIn(150),$.when(loadingIcon.promise(),value)}).then(function(loadingIcon){return loadingIcon.fadeOut(100).promise()}).then(function(){return value})}else contentPromise=value;contentPromise.then(function(html,js){var result=null;if(this.isVisible()){body.css('opacity',0);var currentHeight=body.innerHeight();body.html(html),body.css('height','');var newHeight=body.innerHeight();body.css('height',currentHeight+'px'),result=body.animate({height:newHeight+'px',opacity:1},{duration:150,queue:!1}).promise()}else body.html(html);return js&&(this.isAttached?Templates.runTemplateJS(js):this.bodyJS=js),Event.notifyFilterContentUpdated(body),this.getRoot().trigger(ModalEvents.bodyRendered,this),result}.bind(this)).fail(Notification.exception).always(function(){return body.css('height',''),body.css('overflow',''),body.css('opacity',''),void M.util.js_complete(jsPendingId)}).fail(Notification.exception)}},Modal.prototype.setFooter=function(value){this.showFooter();var footer=this.getFooter();'string'==typeof value?footer.html(value):Templates.render(TEMPLATES.LOADING,{}).done(function(html){footer.html(html),value.done(function(html,js){footer.html(html),js&&(this.isAttached?Templates.runTemplateJS(js):this.footerJS=js)}.bind(this))}.bind(this))},Modal.prototype.hasFooterContent=function(){return!!this.getFooter().children().length},Modal.prototype.hideFooter=function(){this.getFooter().addClass('hidden')},Modal.prototype.showFooter=function(){this.getFooter().removeClass('hidden')},Modal.prototype.setLarge=function(){this.isLarge()||this.getModal().addClass('modal-lg')},Modal.prototype.isLarge=function(){return this.getModal().hasClass('modal-lg')},Modal.prototype.setSmall=function(){this.isSmall()||this.getModal().removeClass('modal-lg')},Modal.prototype.isSmall=function(){return!this.getModal().hasClass('modal-lg')},Modal.prototype.calculateZIndex=function(){var items=$(SELECTORS.DIALOG+', '+SELECTORS.MENU_BAR+', '+SELECTORS.HAS_Z_INDEX),zIndex=parseInt(this.root.css('z-index'));return items.each(function(index,item){item=$(item);var itemZIndex=item.css('z-index')?parseInt(item.css('z-index')):0;itemZIndex>zIndex&&(zIndex=itemZIndex)}),zIndex},Modal.prototype.isVisible=function(){return this.root.hasClass('show')},Modal.prototype.hasFocus=function(){var target=$(document.activeElement);return this.root.is(target)||this.root.has(target).length},Modal.prototype.hasTransitions=function(){return this.getRoot().hasClass('fade')},Modal.prototype.show=function(){this.isVisible()||(this.hasFooterContent()?this.showFooter():this.hideFooter(),!this.isAttached&&this.attachToDOM(),this.getBackdrop().done(function(backdrop){var currentIndex=this.calculateZIndex(),newIndex=currentIndex+2;this.root.css('z-index',newIndex),backdrop.setZIndex(newIndex-1),backdrop.show(),this.root.removeClass('hide').addClass('show'),this.accessibilityShow(),this.getModal().focus(),$('body').addClass('modal-open'),this.root.trigger(ModalEvents.shown,this)}.bind(this)))},Modal.prototype.hide=function(){this.isVisible()&&this.getBackdrop().done(function(backdrop){this.countOtherVisibleModals()||(backdrop.hide(),$('body').removeClass('modal-open'));var currentIndex=parseInt(this.root.css('z-index'));this.root.css('z-index',''),backdrop.setZIndex(currentIndex-3),this.accessibilityHide(),this.hasTransitions()?this.getRoot().one('transitionend webkitTransitionEnd oTransitionEnd',function(){this.getRoot().removeClass('show').addClass('hide')}.bind(this)):this.getRoot().removeClass('show').addClass('hide'),this.root.trigger(ModalEvents.hidden,this)}.bind(this))},Modal.prototype.destroy=function(){this.root.remove(),this.root.trigger(ModalEvents.destroyed,this)},Modal.prototype.accessibilityShow=function(){$('body').children().each(function(index,child){if(!this.root.is(child)){child=$(child);var hidden=child.attr('aria-hidden');'true'!==hidden&&(child.data('previous-aria-hidden',hidden),this.hiddenSiblings.push(child),child.attr('aria-hidden','true'))}}.bind(this)),this.root.attr('aria-hidden','false')},Modal.prototype.accessibilityHide=function(){this.root.attr('aria-hidden','true'),$.each(this.hiddenSiblings,function(index,sibling){sibling=$(sibling);var previousValue=sibling.data('previous-aria-hidden');'undefined'==typeof previousValue?sibling.removeAttr('aria-hidden'):sibling.attr('aria-hidden',previousValue)}),this.hiddenSiblings=[]},Modal.prototype.handleTabLock=function(e){if(this.hasFocus()){var target=$(document.activeElement),focusableElements=this.modal.find(SELECTORS.CAN_RECEIVE_FOCUS),firstFocusable=focusableElements.first(),lastFocusable=focusableElements.last();target.is(firstFocusable)&&e.shiftKey?(lastFocusable.focus(),e.preventDefault()):target.is(lastFocusable)&&!e.shiftKey&&(firstFocusable.focus(),e.preventDefault())}},Modal.prototype.registerEventListeners=function(){this.getRoot().on('keydown',function(e){this.isVisible()&&(e.keyCode==KeyCodes.tab?this.handleTabLock(e):e.keyCode==KeyCodes.escape&&this.hide())}.bind(this)),this.getRoot().click(function(e){$(e.target).closest(SELECTORS.MODAL).length||this.hide()}.bind(this)),CustomEvents.define(this.getModal(),[CustomEvents.events.activate]),this.getModal().on(CustomEvents.events.activate,SELECTORS.HIDE,function(e,data){this.hide(),data.originalEvent.preventDefault()}.bind(this))},Modal.prototype.asyncSet=function(value,setFunction){var p=value;return'object'===('undefined'==typeof value?'undefined':_typeof(value))&&value.hasOwnProperty('then')||(p=$.Deferred(),p.resolve(value)),p.then(function(content){setFunction(content)}).fail(Notification.exception),p},Modal});
//# sourceMappingURL=modal.min.js.map
