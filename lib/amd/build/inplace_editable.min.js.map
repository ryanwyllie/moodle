{"version":3,"sources":["../src/inplace_editable.js"],"names":["define","$","ajax","templates","notification","str","cfg","url","autocomplete","on","e","type","keyCode","stopImmediatePropagation","preventDefault","target","mainelement","closest","addSpinner","element","addClass","spinner","find","length","show","attr","imageUrl","append","removeSpinner","removeClass","hide","updateValue","value","pendingId","join","M","util","js_pending","call","methodname","args","itemid","component","itemtype","done","data","oldvalue","render","html","js","newelement","replaceNode","focus","trigger","ajaxreturn","js_complete","fail","ex","Event","exception","newvalue","isDefaultPrevented","turnEditingOff","el","off","removeAttr","turnEditingOffEverywhere","each","uniqueId","prefix","idlength","i","uniqid","Math","floor","random","turnEditingOnText","get_string","s","instr","inputelement","lbl","select","behatsiterunning","val","turnEditingOnToggle","turnEditingOnSelect","options","key","turnEditingOnAutocomplete","attributes","saveelement","cancelelement","multiple","JSON","parse","then","renderPix","enhance","tags","placeholder","caseSensitive","showSuggestions","noSelectionString","stringify","empty","turnEditingOn","parseJSON"],"mappings":"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","file":"inplace_editable.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * AJAX helper for the inline editing a value.\n *\n * This script is automatically included from template core/inplace_editable\n * It registers a click-listener on [data-inplaceeditablelink] link (the \"inplace edit\" icon),\n * then replaces the displayed value with an input field. On \"Enter\" it sends a request\n * to web service core_update_inplace_editable, which invokes the specified callback.\n * Any exception thrown by the web service (or callback) is displayed as an error popup.\n *\n * @module     core/inplace_editable\n * @package    core\n * @copyright  2016 Marina Glancy\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery',\n        'core/ajax',\n        'core/templates',\n        'core/notification',\n        'core/str',\n        'core/config',\n        'core/url',\n        'core/form-autocomplete'],\n        function($, ajax, templates, notification, str, cfg, url, autocomplete) {\n\n    $('body').on('click keypress', '[data-inplaceeditable] [data-inplaceeditablelink]', function(e) {\n        if (e.type === 'keypress' && e.keyCode !== 13) {\n            return;\n        }\n        e.stopImmediatePropagation();\n        e.preventDefault();\n        var target = $(this),\n            mainelement = target.closest('[data-inplaceeditable]');\n\n        var addSpinner = function(element) {\n            element.addClass('updating');\n            var spinner = element.find('img.spinner');\n            if (spinner.length) {\n                spinner.show();\n            } else {\n                spinner = $('<img/>')\n                        .attr('src', url.imageUrl('i/loading_small'))\n                        .addClass('spinner').addClass('smallicon')\n                    ;\n                element.append(spinner);\n            }\n        };\n\n        var removeSpinner = function(element) {\n            element.removeClass('updating');\n            element.find('img.spinner').hide();\n        };\n\n        var updateValue = function(mainelement, value) {\n            var pendingId = [\n                    mainelement.attr('data-itemid'),\n                    mainelement.attr('data-component'),\n                    mainelement.attr('data-itemtype'),\n                ].join('-');\n            M.util.js_pending(pendingId);\n\n            addSpinner(mainelement);\n            ajax\n                .call([{\n                    methodname: 'core_update_inplace_editable',\n                    args: {\n                        itemid: mainelement.attr('data-itemid'),\n                        component: mainelement.attr('data-component'),\n                        itemtype: mainelement.attr('data-itemtype'),\n                        value: value\n                    },\n                    done: function(data) {\n                        var oldvalue = mainelement.attr('data-value');\n                        templates.render('core/inplace_editable', data).done(function(html, js) {\n                            var newelement = $(html);\n                            templates.replaceNode(mainelement, newelement, js);\n                            newelement.find('[data-inplaceeditablelink]').focus();\n                            newelement.trigger({type: 'updated', ajaxreturn: data, oldvalue: oldvalue});\n                            M.util.js_complete(pendingId);\n                        });\n                    },\n                    fail: function(ex) {\n                        var e = $.Event('updatefailed', {\n                                exception: ex,\n                                newvalue: value\n                            });\n                        removeSpinner(mainelement);\n                        M.util.js_complete(pendingId);\n                        mainelement.trigger(e);\n                        if (!e.isDefaultPrevented()) {\n                            notification.exception(ex);\n                        }\n                    }\n                }], true);\n        };\n\n        var turnEditingOff = function(el) {\n            el.find('input').off();\n            el.find('select').off();\n            el.html(el.attr('data-oldcontent'));\n            el.removeAttr('data-oldcontent');\n            el.removeClass('inplaceeditingon');\n            el.find('[data-inplaceeditablelink]').focus();\n        };\n\n        var turnEditingOffEverywhere = function() {\n            $('span.inplaceeditable.inplaceeditingon').each(function() {\n                turnEditingOff($(this));\n            });\n        };\n\n        var uniqueId = function(prefix, idlength) {\n            var uniqid = prefix,\n                i;\n            for (i = 0; i < idlength; i++) {\n                uniqid += String(Math.floor(Math.random() * 10));\n            }\n            // Make sure this ID is not already taken by an existing element.\n            if ($(\"#\" + uniqid).length === 0) {\n                return uniqid;\n            }\n            return uniqueId(prefix, idlength);\n        };\n\n        var turnEditingOnText = function(el) {\n            str.get_string('edittitleinstructions').done(function(s) {\n                var instr = $('<span class=\"editinstructions\">' + s + '</span>').\n                        attr('id', uniqueId('id_editinstructions_', 20)),\n                    inputelement = $('<input type=\"text\"/>').\n                        attr('id', uniqueId('id_inplacevalue_', 20)).\n                        attr('value', el.attr('data-value')).\n                        attr('aria-describedby', instr.attr('id')).\n                        addClass('ignoredirty').\n                        addClass('form-control'),\n                    lbl = $('<label class=\"accesshide\">' + mainelement.attr('data-editlabel') + '</label>').\n                        attr('for', inputelement.attr('id'));\n                el.html('').append(instr).append(lbl).append(inputelement);\n\n                inputelement.focus();\n                inputelement.select();\n                inputelement.on('keyup keypress focusout', function(e) {\n                    if (cfg.behatsiterunning && e.type === 'focusout') {\n                        // Behat triggers focusout too often.\n                        return;\n                    }\n                    if (e.type === 'keypress' && e.keyCode === 13) {\n                        // We need 'keypress' event for Enter because keyup/keydown would catch Enter that was\n                        // pressed in other fields.\n                        var val = inputelement.val();\n                        turnEditingOff(el);\n                        updateValue(el, val);\n                    }\n                    if ((e.type === 'keyup' && e.keyCode === 27) || e.type === 'focusout') {\n                        // We need 'keyup' event for Escape because keypress does not work with Escape.\n                        turnEditingOff(el);\n                    }\n                });\n            });\n        };\n\n        var turnEditingOnToggle = function(el, newvalue) {\n            turnEditingOff(el);\n            updateValue(el, newvalue);\n        };\n\n        var turnEditingOnSelect = function(el, options) {\n            var i,\n                inputelement = $('<select></select>').\n                    attr('id', uniqueId('id_inplacevalue_', 20)).\n                    addClass('custom-select'),\n                lbl = $('<label class=\"accesshide\">' + mainelement.attr('data-editlabel') + '</label>')\n                    .attr('for', inputelement.attr('id'));\n            for (i in options) {\n                inputelement\n                    .append($('<option>')\n                    .attr('value', options[i].key)\n                    .html(options[i].value));\n            }\n            inputelement.val(el.attr('data-value'));\n\n            el.html('')\n                .append(lbl)\n                .append(inputelement);\n\n            inputelement.focus();\n            inputelement.select();\n            inputelement.on('keyup change focusout', function(e) {\n                if (cfg.behatsiterunning && e.type === 'focusout') {\n                    // Behat triggers focusout too often.\n                    return;\n                }\n                if (e.type === 'change') {\n                    var val = inputelement.val();\n                    turnEditingOff(el);\n                    updateValue(el, val);\n                }\n                if ((e.type === 'keyup' && e.keyCode === 27) || e.type === 'focusout') {\n                    // We need 'keyup' event for Escape because keypress does not work with Escape.\n                    turnEditingOff(el);\n                }\n            });\n        };\n\n        var turnEditingOnAutocomplete = function(el, args) {\n            var i,\n                inputelement = $('<select></select>').\n                    attr('id', uniqueId('id_inplacevalue_', 20)).\n                    addClass('form-autocomplete-original-select').\n                    addClass('custom-select'),\n                lbl = $('<label class=\"accesshide\">' + mainelement.attr('data-editlabel') + '</label>')\n                    .attr('for', inputelement.attr('id')),\n                options = args.options,\n                attributes = args.attributes,\n                saveelement = $('<a href=\"#\"></a>'),\n                cancelelement = $('<a href=\"#\"></a>');\n\n            for (i in options) {\n                inputelement\n                    .append($('<option>')\n                    .attr('value', options[i].key)\n                    .html(options[i].value));\n            }\n            if (attributes.multiple) {\n                inputelement.attr('multiple', 'true');\n            }\n            inputelement.val(JSON.parse(el.attr('data-value')));\n\n            str.get_string('savechanges', 'core').then(function(s) {\n                return templates.renderPix('e/save', 'core', s);\n            }).then(function(html) {\n                saveelement.append(html);\n                return;\n            }).fail(notification.exception);\n\n            str.get_string('cancel', 'core').then(function(s) {\n                return templates.renderPix('e/cancel', 'core', s);\n            }).then(function(html) {\n                cancelelement.append(html);\n                return;\n            }).fail(notification.exception);\n\n            el.html('')\n                .append(lbl)\n                .append(inputelement)\n                .append(saveelement)\n                .append(cancelelement);\n\n            inputelement.focus();\n            inputelement.select();\n            autocomplete.enhance(inputelement,\n                                 attributes.tags,\n                                 attributes.ajax,\n                                 attributes.placeholder,\n                                 attributes.caseSensitive,\n                                 attributes.showSuggestions,\n                                 attributes.noSelectionString)\n                .then(function() {\n                // Focus on the enhanced combobox.\n                el.find('[role=combobox]').focus();\n                // Stop eslint nagging.\n                return;\n            }).fail(notification.exception);\n\n            inputelement.on('keyup', function(e) {\n                if ((e.type === 'keyup' && e.keyCode === 27) || e.type === 'focusout') {\n                    // We need 'keyup' event for Escape because keypress does not work with Escape.\n                    turnEditingOff(el);\n                }\n            });\n            saveelement.on('click', function(e) {\n                var val = JSON.stringify(inputelement.val());\n                // We need to empty the node to destroy all event handlers etc.\n                inputelement.empty();\n                turnEditingOff(el);\n                updateValue(el, val);\n                e.preventDefault();\n            });\n            cancelelement.on('click', function(e) {\n                // We need to empty the node to destroy all event handlers etc.\n                inputelement.empty();\n                turnEditingOff(el);\n                e.preventDefault();\n            });\n        };\n\n        var turnEditingOn = function(el) {\n            el.addClass('inplaceeditingon');\n            el.attr('data-oldcontent', el.html());\n\n            var type = el.attr('data-type');\n            var options = el.attr('data-options');\n\n            if (type === 'toggle') {\n                turnEditingOnToggle(el, options);\n            } else if (type === 'select') {\n                turnEditingOnSelect(el, $.parseJSON(options));\n            } else if (type === 'autocomplete') {\n                turnEditingOnAutocomplete(el, $.parseJSON(options));\n            } else {\n                turnEditingOnText(el);\n            }\n        };\n\n        // Turn editing on for the current element and register handler for Enter/Esc keys.\n        turnEditingOffEverywhere();\n        turnEditingOn(mainelement);\n\n    });\n\n    return {};\n});\n"]}