'use strict';define('core/tree',['jquery'],function($){var SELECTORS={ITEM:'[role=treeitem]',GROUP:'[role=treeitem]:has([role=group]), [role=treeitem][aria-owns], [role=treeitem][data-requires-ajax=true]',CLOSED_GROUP:'[role=treeitem]:has([role=group])[aria-expanded=false], [role=treeitem][aria-owns][aria-expanded=false], [role=treeitem][data-requires-ajax=true][aria-expanded=false]',FIRST_ITEM:'[role=treeitem]:first',VISIBLE_ITEM:'[role=treeitem]:visible',UNLOADED_AJAX_ITEM:'[role=treeitem][data-requires-ajax=true][data-loaded=false][aria-expanded=true]'},Tree=function(selector,selectCallback){this.treeRoot=$(selector),this.treeRoot.data('activeItem',null),this.selectCallback=selectCallback,this.keys={tab:9,enter:13,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,asterisk:106},this.initialiseNodes(this.treeRoot),this.setActiveItem(this.treeRoot.find(SELECTORS.FIRST_ITEM)),this.refreshVisibleItemsCache(),this.bindEventHandlers()};return Tree.prototype.refreshVisibleItemsCache=function(){this.treeRoot.data('visibleItems',this.treeRoot.find(SELECTORS.VISIBLE_ITEM))},Tree.prototype.getVisibleItems=function(){return this.treeRoot.data('visibleItems')},Tree.prototype.setActiveItem=function(item){var currentActive=this.treeRoot.data('activeItem');item===currentActive||(currentActive&&(currentActive.attr('tabindex','-1'),currentActive.attr('aria-selected','false')),item.attr('tabindex','0'),item.attr('aria-selected','true'),this.treeRoot.data('activeItem',item),'function'==typeof this.selectCallback&&this.selectCallback(item))},Tree.prototype.isGroupItem=function(item){return item.is(SELECTORS.GROUP)},Tree.prototype.getGroupFromItem=function(item){return this.treeRoot.find('#'+item.attr('aria-owns'))||item.children('[role=group]')},Tree.prototype.isGroupCollapsed=function(item){return'false'===item.attr('aria-expanded')},Tree.prototype.isGroupCollapsible=function(item){return'false'!==item.attr('data-collapsible')},Tree.prototype.initialiseNodes=function(node){this.removeAllFromTabOrder(node),this.setAriaSelectedFalseOnItems(node);var thisTree=this;node.find(SELECTORS.UNLOADED_AJAX_ITEM).each(function(){var unloadedNode=$(this);thisTree.collapseGroup(unloadedNode),thisTree.expandGroup(unloadedNode)})},Tree.prototype.removeAllFromTabOrder=function(node){node.find('*').attr('tabindex','-1'),this.getGroupFromItem($(node)).find('*').attr('tabindex','-1')},Tree.prototype.setAriaSelectedFalseOnItems=function(node){node.find(SELECTORS.ITEM).attr('aria-selected','false')},Tree.prototype.expandAllGroups=function(){var thisTree=this;this.treeRoot.find(SELECTORS.CLOSED_GROUP).each(function(){var groupNode=$(this);thisTree.expandGroup($(this)).done(function(){thisTree.expandAllChildGroups(groupNode)})})},Tree.prototype.expandAllChildGroups=function(item){var thisTree=this;this.getGroupFromItem(item).find(SELECTORS.CLOSED_GROUP).each(function(){var groupNode=$(this);thisTree.expandGroup($(this)).done(function(){thisTree.expandAllChildGroups(groupNode)})})},Tree.prototype.expandGroup=function(item){var promise=$.Deferred();if(!('false'!==item.attr('data-expandable')&&this.isGroupCollapsed(item)))promise.resolve();else if('true'===item.attr('data-requires-ajax')&&'true'!==item.attr('data-loaded')){item.attr('data-loaded',!1);var moduleName=item.closest('[data-ajax-loader]').attr('data-ajax-loader'),thisTree=this;item.addClass('loading'),require([moduleName],function(loader){loader.load(item).done(function(){item.attr('data-loaded',!0),thisTree.initialiseNodes(item),thisTree.finishExpandingGroup(item),item.removeClass('loading'),promise.resolve()})})}else this.finishExpandingGroup(item),promise.resolve();return promise},Tree.prototype.finishExpandingGroup=function(item){var group=this.getGroupFromItem(item);group.attr('aria-hidden','false'),item.attr('aria-expanded','true'),this.refreshVisibleItemsCache()},Tree.prototype.collapseGroup=function(item){if(this.isGroupCollapsible(item)&&!this.isGroupCollapsed(item)){var group=this.getGroupFromItem(item);group.attr('aria-hidden','true'),item.attr('aria-expanded','false'),this.refreshVisibleItemsCache()}},Tree.prototype.toggleGroup=function(item){'true'===item.attr('aria-expanded')?this.collapseGroup(item):this.expandGroup(item)},Tree.prototype.handleKeyDown=function(item,e){var currentIndex=this.getVisibleItems().index(item);if(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey&&e.keyCode!=this.keys.tab)return!0;switch(e.keyCode){case this.keys.home:return this.getVisibleItems().first().focus(),e.stopPropagation(),!1;case this.keys.end:return this.getVisibleItems().last().focus(),e.stopPropagation(),!1;case this.keys.enter:{var links=item.children('a').length?item.children('a'):item.children().not(SELECTORS.GROUP).find('a');return links.length?window.location.href=links.first().attr('href'):this.isGroupItem(item)&&this.toggleGroup(item,!0),e.stopPropagation(),!1}case this.keys.space:return this.isGroupItem(item)&&this.toggleGroup(item,!0),e.stopPropagation(),!1;case this.keys.left:{var focusParent=function(tree){tree.getVisibleItems().filter(function(){return tree.getGroupFromItem($(this)).has(item).length}).focus()};return this.isGroupItem(item)?this.isGroupCollapsed(item)?focusParent(this):this.collapseGroup(item):focusParent(this),e.stopPropagation(),!1}case this.keys.right:return this.isGroupItem(item)&&(this.isGroupCollapsed(item)?this.expandGroup(item):this.getGroupFromItem(item).find(SELECTORS.ITEM).first().focus()),e.stopPropagation(),!1;case this.keys.up:{if(0<currentIndex){var prev=this.getVisibleItems().eq(currentIndex-1);prev.focus()}return e.stopPropagation(),!1}case this.keys.down:{if(currentIndex<this.getVisibleItems().length-1){var next=this.getVisibleItems().eq(currentIndex+1);next.focus()}return e.stopPropagation(),!1}case this.keys.asterisk:return this.expandAllGroups(),e.stopPropagation(),!1;}return!0},Tree.prototype.handleClick=function(item,e){return!!(e.altKey||e.ctrlKey||e.shiftKey||e.metaKey)||(item.focus(),this.isGroupItem(item)&&this.toggleGroup(item),e.stopPropagation(),!0)},Tree.prototype.handleFocus=function(item,e){return this.setActiveItem(item),e.stopPropagation(),!0},Tree.prototype.bindEventHandlers=function(){var thisObj=this;this.treeRoot.on({click:function click(e){return thisObj.handleClick($(this),e)},keydown:function keydown(e){return thisObj.handleKeyDown($(this),e)},focus:function focus(e){return thisObj.handleFocus($(this),e)}},SELECTORS.ITEM)},Tree});
//# sourceMappingURL=tree.min.js.map
