'use strict';define('core/templates',['core/mustache','jquery','core/ajax','core/str','core/notification','core/url','core/config','core/localstorage','core/icon_system','core/event','core/yui','core/log','core/truncate','core/user_date'],function(mustache,$,ajax,str,notification,coreurl,config,storage,IconSystem,event,Y,Log,Truncate,UserDate){var uniqInstances=0,templateCache={},templatePromises={},iconSystem={},Renderer=function(){this.requiredStrings=[],this.requiredJS=[],this.requiredDates=[],this.currentThemeName=''};Renderer.prototype.requiredStrings=null,Renderer.prototype.requiredDates=[],Renderer.prototype.requiredJS=null,Renderer.prototype.currentThemeName='',Renderer.prototype.getTemplate=function(templateName){var parts=templateName.split('/'),component=parts.shift(),name=parts.shift(),searchKey=this.currentThemeName+'/'+templateName;if(searchKey in templatePromises)return templatePromises[searchKey];var cached=storage.get('core_template/'+searchKey);if(cached)return templateCache[searchKey]=cached,templatePromises[searchKey]=$.Deferred().resolve(cached).promise(),templatePromises[searchKey];var promises=ajax.call([{methodname:'core_output_load_template',args:{component:component,template:name,themename:this.currentThemeName}}],!0,!1);return templatePromises[searchKey]=promises[0].then(function(templateSource){return templateCache[searchKey]=templateSource,storage.set('core_template/'+searchKey,templateSource),templateSource}),templatePromises[searchKey]},Renderer.prototype.partialHelper=function(name){var searchKey=this.currentThemeName+'/'+name;return searchKey in templateCache||notification.exception(new Error('Failed to pre-fetch the template: '+name)),templateCache[searchKey]},Renderer.prototype.renderIcon=function(key,component,title){var modulename=config.iconsystemmodule,ready=$.Deferred();return require([modulename],function(System){var system=new System;system instanceof IconSystem?(iconSystem=system,system.init().then(ready.resolve).catch(notification.exception)):ready.reject('Invalid icon system specified'+config.iconsystemmodule)}),ready.then(function(iconSystem){return this.getTemplate(iconSystem.getTemplateName())}.bind(this)).then(function(template){return iconSystem.renderIcon(key,component,title,template)})},Renderer.prototype.pixHelper=function(context,sectionText,helper){var parts=sectionText.split(','),key='',component='',text='';0<parts.length&&(key=helper(parts.shift().trim(),context)),0<parts.length&&(component=helper(parts.shift().trim(),context)),0<parts.length&&(text=helper(parts.join(',').trim(),context));var templateName=iconSystem.getTemplateName(),searchKey=this.currentThemeName+'/'+templateName,template=templateCache[searchKey];return key=key.replace(/&#x2F;/gi,'/'),iconSystem.renderIcon(key,component,text,template)},Renderer.prototype.jsHelper=function(context,sectionText,helper){return this.requiredJS.push(helper(sectionText,context)),''},Renderer.prototype.stringHelper=function(context,sectionText,helper){var parts=sectionText.split(','),key='',component='',param='';0<parts.length&&(key=parts.shift().trim()),0<parts.length&&(component=parts.shift().trim()),0<parts.length&&(param=parts.join(',').trim()),''!==param&&(param=helper(param,context)),0===param.indexOf('{')&&0!==param.indexOf('{{')&&(param=JSON.parse(param));var index=this.requiredStrings.length;return this.requiredStrings.push({key:key,component:component,param:param}),'[[_s'+index+']]'},Renderer.prototype.quoteHelper=function(context,sectionText,helper){var content=helper(sectionText.trim(),context);return content=content.replace('"','\\"').replace(/([\{\}]{2,3})/g,'{{=<% %>=}}$1<%={{ }}=%>'),'"'+content+'"'},Renderer.prototype.shortenTextHelper=function(context,sectionText,helper){var regex=/(.*?),(.*)/,parts=sectionText.match(regex),length=parts[1].trim(),text=parts[2].trim(),content=helper(text,context);return Truncate.truncate(content,{length:length,words:!0,ellipsis:'...'})},Renderer.prototype.userDateHelper=function(context,sectionText,helper){var regex=/(.*?),(.*)/,parts=sectionText.match(regex),timestamp=helper(parts[1].trim(),context),format=helper(parts[2].trim(),context),index=this.requiredDates.length;return this.requiredDates.push({timestamp:timestamp,format:format}),'[[_t_'+index+']]'},Renderer.prototype.viewStoreHelper=function(context,sectionText,helper){return helper(sectionText)},Renderer.prototype.componentHelper=function(context,sectionText){return'<div react-component=\'MustacheComponent\' template=\''+sectionText.trim()+'\'></div>'},Renderer.prototype.addHelpers=function(context,themeName){this.currentThemeName=themeName,this.requiredStrings=[],this.requiredJS=[],context.uniqid=uniqInstances++,context.str=function(){return this.stringHelper.bind(this,context)}.bind(this),context.pix=function(){return this.pixHelper.bind(this,context)}.bind(this),context.js=function(){return this.jsHelper.bind(this,context)}.bind(this),context.quote=function(){return this.quoteHelper.bind(this,context)}.bind(this),context.shortentext=function(){return this.shortenTextHelper.bind(this,context)}.bind(this),context.userdate=function(){return this.userDateHelper.bind(this,context)}.bind(this),context.viewstore=function(){return this.viewStoreHelper.bind(this,context)}.bind(this),context.component=function(){return this.componentHelper.bind(this,context)}.bind(this),context.globals={config:config},context.currentTheme=themeName},Renderer.prototype.getJS=function(){var js='';return 0<this.requiredJS.length&&(js=this.requiredJS.join(';\n')),js},Renderer.prototype.treatStringsInContent=function(content,strings){var treated,index,strIndex,walker,char,strFinal,pattern=/\[\[_s\d+\]\]/;do{for(treated='',index=content.search(pattern);-1<index;){treated+=content.substring(0,index),content=content.substr(index),strIndex='',walker=4,char=content.substr(walker,1);do strIndex+=char,walker++,char=content.substr(walker,1);while(']'!=char);strFinal=strings[parseInt(strIndex,10)],'undefined'==typeof strFinal&&(Log.debug('Could not find string for pattern [[_s'+strIndex+']].'),strFinal=''),treated+=strFinal,content=content.substr(6+strIndex.length),index=content.search(pattern)}content=treated+content,index=content.search(pattern)}while(-1<index);return content},Renderer.prototype.treatDatesInContent=function(content,dates){return dates.forEach(function(date,index){var re=new RegExp('\\[\\[_t_'+index+'\\]\\]','g');content=content.replace(re,date)}),content},Renderer.prototype.doRender=function(templateSource,context,themeName){this.currentThemeName=themeName;var iconTemplate=iconSystem.getTemplateName();return this.getTemplate(iconTemplate).then(function(){this.addHelpers(context,themeName);var result=mustache.render(templateSource,context,this.partialHelper.bind(this));return $.Deferred().resolve(result.trim(),this.getJS()).promise()}.bind(this)).then(function(html,js){return 0<this.requiredStrings.length?str.get_strings(this.requiredStrings).then(function(strings){return this.requiredDates=this.requiredDates.map(function(date){return{timestamp:this.treatStringsInContent(date.timestamp,strings),format:this.treatStringsInContent(date.format,strings)}}.bind(this)),html=this.treatStringsInContent(html,strings),js=this.treatStringsInContent(js,strings),$.Deferred().resolve(html,js).promise()}.bind(this)):$.Deferred().resolve(html,js).promise()}.bind(this)).then(function(html,js){return 0<this.requiredDates.length?UserDate.get(this.requiredDates).then(function(dates){return html=this.treatDatesInContent(html,dates),js=this.treatDatesInContent(js,dates),$.Deferred().resolve(html,js).promise()}.bind(this)):$.Deferred().resolve(html,js).promise()}.bind(this))};var runTemplateJS=function(source){if(''!==source.trim()){var newscript=$('<script>').attr('type','text/javascript').html(source);$('head').append(newscript)}},domReplace=function(element,newHTML,newJS,replaceChildNodes){var replaceNode=$(element);if(replaceNode.length){var newNodes=$(newHTML),yuiNodes=null;replaceChildNodes?(yuiNodes=new Y.NodeList(replaceNode.children().get()),yuiNodes.destroy(!0),replaceNode.empty(),replaceNode.append(newNodes)):(yuiNodes=new Y.NodeList(replaceNode.get()),yuiNodes.destroy(!0),replaceNode.replaceWith(newNodes)),runTemplateJS(newJS),event.notifyFilterContentUpdated(newNodes)}};Renderer.prototype.scanForPartials=function(templateSource){var tokens=mustache.parse(templateSource),partials=[],findPartial=function(tokens,partials){var i,token;for(i=0;i<tokens.length;i++)token=tokens[i],('>'==token[0]||'<'==token[0])&&partials.push(token[1]),4<token.length&&findPartial(token[4],partials)};return findPartial(tokens,partials),partials},Renderer.prototype.cachePartials=function(templateName){return this.getTemplate(templateName).then(function(templateSource){var i,partials=this.scanForPartials(templateSource),fetchThemAll=[];for(i=0;i<partials.length;i++){var searchKey=this.currentThemeName+'/'+partials[i];searchKey in templatePromises?fetchThemAll.push(templatePromises[searchKey]):fetchThemAll.push(this.cachePartials(partials[i]))}return $.when.apply($,fetchThemAll).then(function(){return templateSource})}.bind(this))},Renderer.prototype.render=function(templateName,context,themeName){'undefined'==typeof themeName&&(themeName=config.theme),this.currentThemeName=themeName;var modulename=config.iconsystemmodule,ready=$.Deferred();return require([modulename],function(System){var system=new System;system instanceof IconSystem?(iconSystem=system,system.init().then(ready.resolve).catch(notification.exception)):ready.reject('Invalid icon system specified'+config.iconsystem)}),ready.then(function(){return this.cachePartials(templateName)}.bind(this)).then(function(templateSource){return this.doRender(templateSource,context,themeName)}.bind(this))};var domPrepend=function(element,html,js){var node=$(element);node.length&&(node.prepend(html),runTemplateJS(js),event.notifyFilterContentUpdated(node))},domAppend=function(element,html,js){var node=$(element);node.length&&(node.append(html),runTemplateJS(js),event.notifyFilterContentUpdated(node))};return{render:function render(templateName,context,themeName){var renderer=new Renderer;return renderer.render(templateName,context,themeName)},renderPix:function renderPix(key,component,title){var renderer=new Renderer;return renderer.renderIcon(key,component,title)},runTemplateJS:runTemplateJS,replaceNodeContents:function replaceNodeContents(element,newHTML,newJS){domReplace(element,newHTML,newJS,!0)},replaceNode:function replaceNode(element,newHTML,newJS){domReplace(element,newHTML,newJS,!1)},prependNodeContents:function prependNodeContents(element,html,js){domPrepend(element,html,js)},appendNodeContents:function appendNodeContents(element,html,js){domAppend(element,html,js)},getTemplateSource:function getTemplateSource(templateName){var renderer=new Renderer;return renderer.cachePartials(templateName)},syncRender:function syncRender(templateSource,context){var renderer=new Renderer;return mustache.render(templateSource,context,renderer.partialHelper.bind(renderer))},addHelpers:function addHelpers(context){var renderer=new Renderer;return renderer.addHelpers(context),context}}});
//# sourceMappingURL=templates.min.js.map
