{"version":3,"sources":["../src/permissionmanager.js"],"names":["define","$","config","notification","templates","Y","contextid","contextname","adminurl","overideableroles","SELECTORS","ADDROLE","REMOVEROLE","UNPROHIBIT","rolesloadedevent","Event","panel","loadOverideableRoles","params","getroles","sesskey","post","done","data","trigger","err","exception","fail","jqXHR","status","error","changePermissions","row","roleid","action","M","cfg","capability","templatedata","rolename","imageurl","util","image_url","spanclass","linkclass","icon","find","first","closest","remove","render","content","insertBefore","allowedLink","hide","handleAddRole","e","preventDefault","use","one","link","currentTarget","confirmationDetails","cap","context","message","get_string","core","dialogue","draggable","modal","closeButton","width","set","i","existingrolelinks","roles","disabled","disable","filter","length","roledetails","push","show","delegate","handleRemoveRole","questionDetails","role","confirm","initialize","args","body"],"mappings":"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","file":"permissionmanager.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n/*\n * @package    core\n * @class      permissionmanager\n * @copyright  2015 Martin Mastny <mastnym@vscht.cz>\n * @since      3.0\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\n /**\n  * @module admin/permissionmanager\n  */\ndefine(['jquery', 'core/config', 'core/notification', 'core/templates', 'core/yui'],\n    function($, config, notification, templates, Y) {\n\n     /**\n      * Used CSS selectors\n      * @access private\n      */\n    var SELECTORS = {\n        ADDROLE: 'a.allowlink, a.prohibitlink',\n        REMOVEROLE: 'a.preventlink, a.unprohibitlink',\n        UNPROHIBIT: 'a.unprohibitlink'\n        };\n    var rolesloadedevent = $.Event('rolesloaded');\n    var contextid;\n    var contextname;\n    var adminurl;\n    var overideableroles;\n    var panel = null;\n\n    /**\n     * Load all possible roles, which could be assigned from server\n     *\n     * @access private\n     * @method loadOverideableRoles\n     */\n    var loadOverideableRoles = function() {\n        var params = {\n            contextid: contextid,\n            getroles: 1,\n            sesskey: config.sesskey\n        };\n\n        // Need to tell jQuery to expect JSON as the content type may not be correct (MDL-55041).\n        $.post(adminurl + 'roles/ajax.php', params, null, 'json')\n            .done(function(data) {\n              try {\n                  overideableroles = data;\n                  loadOverideableRoles = function() {\n                      $('body').trigger(rolesloadedevent);\n                  };\n                  loadOverideableRoles();\n              } catch (err) {\n                  notification.exception(err);\n              }\n            })\n            .fail(function(jqXHR, status, error) {\n                notification.exception(error);\n            });\n    };\n\n    /**\n     * Perform the UI changes after server change\n     *\n     * @access private\n     * @method changePermissions\n     * @param {JQuery} row\n     * @param {int} roleid\n     * @param {string} action\n     */\n    var changePermissions = function(row, roleid, action) {\n        var params = {\n            contextid: contextid,\n            roleid: roleid,\n            sesskey: M.cfg.sesskey,\n            action: action,\n            capability: row.data('name')\n        };\n        $.post(adminurl + 'roles/ajax.php', params, null, 'json')\n        .done(function(data) {\n            var action = data;\n            try {\n                var templatedata = {rolename: overideableroles[roleid],\n                                    roleid: roleid,\n                                    adminurl: adminurl,\n                                    imageurl: M.util.image_url('t/delete', 'moodle')\n                                    };\n                switch (action) {\n                    case 'allow':\n                        templatedata.spanclass = 'allowed';\n                        templatedata.linkclass = 'preventlink';\n                        templatedata.action = 'prevent';\n                        templatedata.icon = 't/delete';\n                        break;\n                    case 'prohibit':\n                        templatedata.spanclass = 'forbidden';\n                        templatedata.linkclass = 'unprohibitlink';\n                        templatedata.action = 'unprohibit';\n                        templatedata.icon = 't/delete';\n                        break;\n                    case 'prevent':\n                        row.find('a[data-role-id=\"' + roleid + '\"]').first().closest('.allowed').remove();\n                        return;\n                    case 'unprohibit':\n                        row.find('a[data-role-id=\"' + roleid + '\"]').first().closest('.forbidden').remove();\n                        return;\n                    default:\n                        return;\n                }\n                templates.render('core/permissionmanager_role', templatedata)\n                .done(function(content) {\n                    if (action == 'allow') {\n                        $(content).insertBefore(row.find('.allowmore:first'));\n                    } else if (action == 'prohibit') {\n                        $(content).insertBefore(row.find('.prohibitmore:first'));\n                        // Remove allowed link\n                        var allowedLink = row.find('.allowedroles').first().find('a[data-role-id=\"' + roleid + '\"]');\n                        if (allowedLink) {\n                            allowedLink.first().closest('.allowed').remove();\n                        }\n                    }\n                    panel.hide();\n                })\n                .fail(notification.exception);\n            } catch (err) {\n                notification.exception(err);\n            }\n        })\n        .fail(function(jqXHR, status, error) {\n            notification.exception(error);\n        });\n    };\n\n    /**\n     * Prompts user for selecting a role which is permitted\n     *\n     * @access private\n     * @method handleAddRole\n     * @param {event} e\n     */\n    var handleAddRole = function(e) {\n        e.preventDefault();\n\n        // TODO: MDL-57778 Convert to core/modal.\n        Y.use('moodle-core-notification-dialogue', function() {\n            $('body').one('rolesloaded', function() {\n                var link = $(e.currentTarget);\n                var action = link.data('action');\n                var row = link.closest('tr.rolecap');\n                var confirmationDetails = {\n                    cap: row.data('humanname'),\n                    context: contextname\n                };\n                var message = M.util.get_string('role' + action + 'info', 'core_role', confirmationDetails);\n                if (panel === null) {\n                    panel = new M.core.dialogue({\n                        draggable: true,\n                        modal: true,\n                        closeButton: true,\n                        width: '450px'\n                    });\n                }\n                panel.set('headerContent', M.util.get_string('role' + action + 'header', 'core_role'));\n\n                var i, existingrolelinks;\n\n                var roles = [];\n                switch (action) {\n                    case 'allow':\n                        existingrolelinks = row.find(SELECTORS.REMOVEROLE);\n                        break;\n                    case 'prohibit':\n                        existingrolelinks = row.find(SELECTORS.UNPROHIBIT);\n                        break;\n                }\n                for (i in overideableroles) {\n                    var disabled = '';\n                    var disable = existingrolelinks.filter(\"[data-role-id='\" + i + \"']\").length;\n                    if (disable) {\n                        disabled = 'disabled';\n                    }\n                    var roledetails = {roleid: i, rolename: overideableroles[i], disabled: disabled};\n                    roles.push(roledetails);\n                }\n\n                templates.render('core/permissionmanager_panelcontent', {message: message, roles: roles})\n                .done(function(content) {\n                    panel.set('bodyContent', content);\n                    panel.show();\n                    $('div.role_buttons').delegate('input', 'click', function(e) {\n                        var roleid = $(e.currentTarget).data('role-id');\n                        changePermissions(row, roleid, action);\n                    });\n                })\n                .fail(notification.exception);\n\n            });\n        });\n        loadOverideableRoles();\n    };\n\n    /**\n     * Prompts user when removing permission\n     *\n     * @access private\n     * @method handleRemoveRole\n     * @param {event} e\n     */\n    var handleRemoveRole = function(e) {\n        e.preventDefault();\n        $('body').one('rolesloaded', function() {\n            var link = $(e.currentTarget);\n            var action = link.data('action');\n            var roleid = link.data('role-id');\n            var row = link.closest('tr.rolecap');\n            var questionDetails = {\n                role: overideableroles[roleid],\n                cap: row.data('humanname'),\n                context: contextname\n            };\n\n            notification.confirm(M.util.get_string('confirmunassigntitle', 'core_role'),\n                M.util.get_string('confirmrole' + action, 'core_role', questionDetails),\n                M.util.get_string('confirmunassignyes', 'core_role'),\n                M.util.get_string('confirmunassignno', 'core_role'),\n                function() {\n                   changePermissions(row, roleid, action);\n                }\n            );\n         });\n        loadOverideableRoles();\n    };\n\n    return /** @alias module:core/permissionmanager */ {\n        /**\n         * Initialize permissionmanager\n         * @access public\n         * @param {Object} args\n         */\n        initialize: function(args) {\n            contextid = args.contextid;\n            contextname = args.contextname;\n            adminurl = args.adminurl;\n            var body = $('body');\n            body.delegate(SELECTORS.ADDROLE, 'click', handleAddRole);\n            body.delegate(SELECTORS.REMOVEROLE, 'click', handleRemoveRole);\n        }\n    };\n});\n"]}