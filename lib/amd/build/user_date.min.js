'use strict';define('core/user_date',['jquery','core/ajax','core/sessionstorage','core/config'],function($,Ajax,Storage,Config){var promisesCache={},getKey=function(request){var language=$('html').attr('lang').replace(/-/g,'_');return'core_user_date/'+language+'/'+Config.usertimezone+'/'+request.timestamp+'/'+request.format},getFromLocalStorage=function(key){return Storage.get(key)},addToLocalStorage=function(key,value){Storage.set(key,value)},inPromisesCache=function(key){return'undefined'!=typeof promisesCache[key]},getFromPromisesCache=function(key){return promisesCache[key]},addToPromisesCache=function(key,promise){promisesCache[key]=promise},loadDatesFromServer=function(dates){var args=dates.map(function(data){return{timestamp:data.timestamp,format:data.format}}),request={methodname:'core_get_user_dates',args:{contextid:Config.contextid,timestamps:args}};return Ajax.call([request],!0,!0)[0].then(function(results){results.dates.forEach(function(value,index){var date=dates[index],key=getKey(date);addToLocalStorage(key,value),date.deferred.resolve(value)})}).catch(function(ex){dates.forEach(function(date){date.deferred.reject(ex)})})};return{get:function get(requests){var ajaxRequests=[],promises=[];return requests.forEach(function(request){var key=getKey(request);if(inPromisesCache(key))promises.push(getFromPromisesCache(key));else{var deferred=$.Deferred(),cached=getFromLocalStorage(key);cached?deferred.resolve(cached):(request.deferred=deferred,ajaxRequests.push(request)),addToPromisesCache(key,deferred.promise()),promises.push(deferred.promise())}}),ajaxRequests.length&&loadDatesFromServer(ajaxRequests),$.when.apply($,promises).then(function(){return 1===arguments.length?[arguments[0]]:Array.apply(null,arguments)})}}});
//# sourceMappingURL=user_date.min.js.map
