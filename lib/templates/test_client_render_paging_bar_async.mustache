<div class="row">
    <h2>Client render paging bar async</h2>
    <p>These pages do a simulated async request to load the content from a server.
        Each page will only send the request the first time that the page is loaded.
        After that the page can be shown without sending any further requests.</p>
    <div class="col-sm-6 span6" id="paging-bar-async-container">
    </div>
    <div class="col-sm-6 span5" id="paging-bar-async-button-container">
        <h3>Click the button below to resolve the async request</h3>
        <button type="button" class="btn btn-primary">Resolve request</button>
    </div>
</div>
{{#js}}
require(
[
    'jquery',
    'core/templates',
    'core/paged_content_factory'
],
function(
    $,
    Templates,
    PagedContentFactory
) {
    var container = $('#paging-bar-async-container');
    var buttonContainer = $('#paging-bar-async-button-container');
    var button = buttonContainer.find('button');
    var contentItems = [];
    for (var i = 1; i <= 30; i++) {
        contentItems.push(`Async list item ${i}`);
    }
    var userPromise = null;

    PagedContentFactory.createWithTotalAndLimit(
        30,
        10,
        function(pagesData) {
            buttonContainer.removeClass('hidden');
            userPromise = $.Deferred();

            var contentToRender = [];
            pagesData.forEach(function(pageData) {
                var begin = pageData.offset;
                var end = pageData.limit ? begin + pageData.limit : contentItems.length;
                var items = contentItems.slice(begin, end);
                contentToRender.push(items);
            });

            var promises = [];

            contentToRender.forEach(function(itemSet) {
                var card = $('<div><div class="card"><div class="card-body"></div></div></div>');
                var cardBody = card.find('.card-body');
                itemSet.forEach(function(item) {
                    cardBody.append(`<p>${item}</p>`);
                });
                var promise = $.Deferred();
                promises.push(promise);

                userPromise.then(function() {
                    promise.resolve(card.html(), '');
                });
            });

            return promises;
        }
    )
    .then(function(html, js) {
        Templates.replaceNodeContents(container, html, js);
    })

    button.click(function() {
        if (userPromise) {
            userPromise.resolve();
        }

        buttonContainer.addClass('hidden');
    });
}
);
{{/js}}
