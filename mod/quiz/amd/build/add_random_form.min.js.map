{"version":3,"sources":["../src/add_random_form.js"],"names":["define","$","RandomQuestionFormPreview","SELECTORS","PREVIEW_CONTAINER","CATEGORY_FORM_ELEMENT","SUBCATEGORY_FORM_ELEMENT","TAG_IDS_FORM_ELEMENT","getCategorySelectValue","form","find","val","getCategoryId","valueString","values","split","isTopLevelCategorySelected","topCategories","selectedValue","indexOf","shouldIncludeSubcategories","is","getTagIds","map","value","parts","reloadQuestionPreview","contextId","previewContainer","reload","isInterestingElement","element","closest","length","addEventListeners","reloadTimerId","on","e","target","showLoadingIcon","clearTimeout","setTimeout","init","formId"],"mappings":"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","file":"add_random_form.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript for the add_random_form class.\n *\n * @module    mod_quiz/add_random_form\n * @package   mod_quiz\n * @copyright 2018 Ryan Wyllie <ryan@moodle.com>\n * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(\n    [\n        'jquery',\n        'mod_quiz/random_question_form_preview'\n    ],\n    function(\n        $,\n        RandomQuestionFormPreview\n    ) {\n\n    // Wait 2 seconds before reloading the question set just in case\n    // the user is still changing the criteria.\n    var RELOAD_DELAY = 2000;\n    var SELECTORS = {\n        PREVIEW_CONTAINER: '[data-region=\"random-question-preview-container\"]',\n        CATEGORY_FORM_ELEMENT: '[name=\"category\"]',\n        SUBCATEGORY_FORM_ELEMENT: '[name=\"includesubcategories\"]',\n        TAG_IDS_FORM_ELEMENT: '[name=\"fromtags[]\"]'\n    };\n\n    /**\n     * Get the selected category value from the form.\n     *\n     * @param {jquery} form The form element.\n     * @return {string} The category value.\n     */\n    var getCategorySelectValue = function(form) {\n        return form.find(SELECTORS.CATEGORY_FORM_ELEMENT).val();\n    };\n\n    /**\n     * Get the category id from the form.\n     *\n     * @param {jquery} form The form element.\n     * @return {string} The category id.\n     */\n    var getCategoryId = function(form) {\n        // The value string is the category id and category context id joined\n        // by a comma.\n        var valueString = getCategorySelectValue(form);\n        // Split the two ids.\n        var values = valueString.split(',');\n        // Return just the category id.\n        return values[0];\n    };\n\n    /**\n     * Check if a top level category is selected in the form.\n     *\n     * @param {jquery} form The form element.\n     * @param {string[]} topCategories List of top category values (matching the select box values)\n     * @return {bool}\n     */\n    var isTopLevelCategorySelected = function(form, topCategories) {\n        var selectedValue = getCategorySelectValue(form);\n        return (topCategories.indexOf(selectedValue) > -1);\n    };\n\n    /**\n     * Check if the form indicates we should include include subcategories in\n     * the filter.\n     *\n     * @param {jquery} form The form element.\n     * @param {string[]} topCategories List of top category values (matching the select box values)\n     * @return {bool}\n     */\n    var shouldIncludeSubcategories = function(form, topCategories) {\n        if (isTopLevelCategorySelected(form, topCategories)) {\n            return true;\n        } else {\n            return form.find(SELECTORS.SUBCATEGORY_FORM_ELEMENT).is(':checked');\n        }\n    };\n\n    /**\n     * Get the tag ids for the selected tags in the form.\n     *\n     * @param {jquery} form The form element.\n     * @return {string[]} The tag ids.\n     */\n    var getTagIds = function(form) {\n        var values = form.find(SELECTORS.TAG_IDS_FORM_ELEMENT).val();\n        return values.map(function(value) {\n            // The tag element value is the tag id and tag name joined\n            // by a comma. So we need to split them to get the tag id.\n            var parts = value.split(',');\n            return parts[0];\n        });\n    };\n\n    /**\n     * Reload the preview section with a new set of filters.\n     *\n     * @param {jquery} form The form element.\n     * @param {int} contextId The current context id.\n     * @param {string[]} topCategories List of top category values (matching the select box values)\n     */\n    var reloadQuestionPreview = function(form, contextId, topCategories) {\n        var previewContainer = form.find(SELECTORS.PREVIEW_CONTAINER);\n        RandomQuestionFormPreview.reload(\n            previewContainer,\n            getCategoryId(form),\n            shouldIncludeSubcategories(form, topCategories),\n            getTagIds(form),\n            contextId\n        );\n    };\n\n    /**\n     * Is this an element we're interested in listening to changes on.\n     *\n     * @param {jquery} element The element to check.\n     * @return {bool}\n     */\n    var isInterestingElement = function(element) {\n        if (element.closest(SELECTORS.CATEGORY_FORM_ELEMENT).length > 0) {\n            return true;\n        }\n\n        if (element.closest(SELECTORS.SUBCATEGORY_FORM_ELEMENT).length > 0) {\n            return true;\n        }\n\n        if (element.closest(SELECTORS.TAG_IDS_FORM_ELEMENT).length > 0) {\n            return true;\n        }\n\n        return false;\n    };\n\n    /**\n     * Listen for changes to any of the interesting elements and reload the form\n     * preview with the new filter values if they are changed.\n     *\n     * The reload is delayed for a small amount of time (see RELOAD_DELAY) in case\n     * the user is actively editing the form. This allows us to avoid having to\n     * send multiple requests to the server on each change.\n     *\n     * Instead we can just send a single request when the user appears to have\n     * finished editing the form.\n     *\n     * @param {jquery} form The form element.\n     * @param {int} contextId The current context id.\n     * @param {string[]} topCategories List of top category values (matching the select box values)\n     */\n    var addEventListeners = function(form, contextId, topCategories) {\n        var reloadTimerId = null;\n\n        form.on('change', function(e) {\n            // Only reload the preview when elements that will change the result\n            // are modified.\n            if (!isInterestingElement($(e.target))) {\n                return;\n            }\n\n            // Show the loading icon to let the user know that the preview\n            // will be updated after their actions.\n            RandomQuestionFormPreview.showLoadingIcon(form);\n\n            if (reloadTimerId) {\n                // Reset the timer each time the form is modified.\n                clearTimeout(reloadTimerId);\n            }\n\n            // Don't immediately reload the question preview section just\n            // in case the user is still modifying the form. We don't want to\n            // spam reload requests.\n            reloadTimerId = setTimeout(function() {\n                reloadQuestionPreview(form, contextId, topCategories);\n            }, RELOAD_DELAY);\n        });\n    };\n\n    /**\n     * Trigger the first load of the preview section and then listen for modifications\n     * to the form to reload the preview with new filter values.\n     *\n     * @param {jquery} formId The form element id.\n     * @param {int} contextId The current context id.\n     * @param {string[]} topCategories List of top category values (matching the select box values)\n     */\n    var init = function(formId, contextId, topCategories) {\n        var form = $('#' + formId);\n\n        reloadQuestionPreview(form, contextId, topCategories);\n        addEventListeners(form, contextId, topCategories);\n    };\n\n    return {\n        init: init\n    };\n});\n"]}