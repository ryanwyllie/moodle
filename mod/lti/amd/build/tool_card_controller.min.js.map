{"version":3,"sources":["../src/tool_card_controller.js"],"names":["define","$","ajax","notification","templates","toolType","ltiEvents","KEYS","str","SELECTORS","DELETE_BUTTON","NAME_ELEMENT","DESCRIPTION_ELEMENT","CAPABILITIES_CONTAINER","ACTIVATE_BUTTON","getDeleteButton","element","find","getNameElement","getDescriptionElement","getActivateButton","hasActivateButton","length","getCapabilitiesContainer","hasCapabilitiesContainer","getTypeId","attr","clearAllAnnouncements","removeClass","startLoading","addClass","stopLoading","announceSuccess","promise","Deferred","setTimeout","resolve","announceFailure","deleteType","typeId","get_strings","key","component","done","strs","confirm","delete","remove","fail","exception","always","error","reject","setValueSnapshot","value","getValueSnapshot","snapshotDescription","descriptionElement","hasClass","description","text","trim","updateDescription","snapshotVal","update","id","type","snapshotName","nameElement","name","updateName","setStatusActive","state","constants","configured","then","toolTypeData","render","renderResult","html","js","replaceNode","catch","displayCapabilitiesApproval","hideCapabilitiesApproval","activateToolType","registerEventListeners","deleteButton","click","e","preventDefault","keypress","metaKey","shiftKey","altKey","ctrlKey","keyCode","ENTER","SPACE","focus","blur","activateButton","capabilitiesContainer","on","CAPABILITIES_AGREE","CAPABILITIES_DECLINE","init"],"mappings":"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","file":"tool_card_controller.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Controls all of the behaviour and interaction with a tool type card. These are\n * listed on the LTI tool type management page.\n *\n * See template: mod_lti/tool_card\n *\n * @module     mod_lti/tool_card_controller\n * @class      tool_card_controller\n * @package    mod_lti\n * @copyright  2015 Ryan Wyllie <ryan@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/ajax', 'core/notification', 'core/templates', 'mod_lti/tool_type', 'mod_lti/events', 'mod_lti/keys',\n        'core/str'],\n        function($, ajax, notification, templates, toolType, ltiEvents, KEYS, str) {\n\n    var SELECTORS = {\n        DELETE_BUTTON: '.delete',\n        NAME_ELEMENT: '.name',\n        DESCRIPTION_ELEMENT: '.description',\n        CAPABILITIES_CONTAINER: '.capabilities-container',\n        ACTIVATE_BUTTON: '.tool-card-footer a.activate',\n    };\n\n    // Timeout in seconds.\n    var ANNOUNCEMENT_TIMEOUT = 2000;\n\n    /**\n     * Return the delete button element.\n     *\n     * @method getDeleteButton\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     * @return {JQuery} jQuery object\n     */\n    var getDeleteButton = function(element) {\n        return element.find(SELECTORS.DELETE_BUTTON);\n    };\n\n    /**\n     * Return the element representing the tool type name.\n     *\n     * @method getNameElement\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     * @return {JQuery} jQuery object\n     */\n    var getNameElement = function(element) {\n        return element.find(SELECTORS.NAME_ELEMENT);\n    };\n\n    /**\n     * Return the element representing the tool type description.\n     *\n     * @method getDescriptionElement\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     * @return {JQuery} jQuery object\n     */\n    var getDescriptionElement = function(element) {\n        return element.find(SELECTORS.DESCRIPTION_ELEMENT);\n    };\n\n    /**\n     * Return the activate button for the type.\n     *\n     * @method getActivateButton\n     * @private\n     * @param {Object} element jQuery object representing the tool card.\n     * @return {Object} jQuery object\n     */\n    var getActivateButton = function(element) {\n        return element.find(SELECTORS.ACTIVATE_BUTTON);\n    };\n\n    /**\n     * Checks if the type card has an activate button.\n     *\n     * @method hasActivateButton\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     * @return {Boolean} true if has active buton\n     */\n    var hasActivateButton = function(element) {\n        return getActivateButton(element).length ? true : false;\n    };\n\n    /**\n     * Return the element that contains the capabilities approval for\n     * the user.\n     *\n     * @method getCapabilitiesContainer\n     * @private\n     * @param {Object} element jQuery object representing the tool card.\n     * @return {Object} The element\n     */\n    var getCapabilitiesContainer = function(element) {\n        return element.find(SELECTORS.CAPABILITIES_CONTAINER);\n    };\n\n    /**\n     * Checks if the tool type has capabilities that need approval. If it\n     * does then the container will be present.\n     *\n     * @method hasCapabilitiesContainer\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     * @return {Boolean} true if has capbilities.\n     */\n    var hasCapabilitiesContainer = function(element) {\n        return getCapabilitiesContainer(element).length ? true : false;\n    };\n\n    /**\n     * Get the type id.\n     *\n     * @method getTypeId\n     * @private\n     * @param {Object} element jQuery object representing the tool card.\n     * @return {String} Type ID\n     */\n    var getTypeId = function(element) {\n        return element.attr('data-type-id');\n    };\n\n    /**\n     * Stop any announcement currently visible on the card.\n     *\n     * @method clearAllAnnouncements\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     */\n    var clearAllAnnouncements = function(element) {\n        element.removeClass('announcement loading success fail capabilities');\n    };\n\n    /**\n     * Show the loading announcement.\n     *\n     * @method startLoading\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     */\n    var startLoading = function(element) {\n        clearAllAnnouncements(element);\n        element.addClass('announcement loading');\n    };\n\n    /**\n     * Hide the loading announcement.\n     *\n     * @method stopLoading\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     */\n    var stopLoading = function(element) {\n        element.removeClass('announcement loading');\n    };\n\n    /**\n     * Show the success announcement. The announcement is only\n     * visible for 2 seconds.\n     *\n     * @method announceSuccess\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     * @return {Promise} jQuery Deferred object\n     */\n    var announceSuccess = function(element) {\n        var promise = $.Deferred();\n\n        clearAllAnnouncements(element);\n        element.addClass('announcement success');\n        setTimeout(function() {\n            element.removeClass('announcement success');\n            promise.resolve();\n        }, ANNOUNCEMENT_TIMEOUT);\n\n        return promise;\n    };\n\n    /**\n     * Show the failure announcement. The announcement is only\n     * visible for 2 seconds.\n     *\n     * @method announceFailure\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     * @return {Promise} jQuery Deferred object\n     */\n    var announceFailure = function(element) {\n        var promise = $.Deferred();\n\n        clearAllAnnouncements(element);\n        element.addClass('announcement fail');\n        setTimeout(function() {\n            element.removeClass('announcement fail');\n            promise.resolve();\n        }, ANNOUNCEMENT_TIMEOUT);\n\n        return promise;\n    };\n\n    /**\n     * Delete the tool type from the Moodle server. Triggers a success\n     * or failure announcement depending on the result.\n     *\n     * @method deleteType\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     * @return {Promise} jQuery Deferred object\n     */\n    var deleteType = function(element) {\n        var promise = $.Deferred();\n        var typeId = getTypeId(element);\n        startLoading(element);\n\n        if (typeId === \"\") {\n            return $.Deferred().resolve();\n        }\n\n        str.get_strings([\n                {\n                    key: 'delete',\n                    component: 'mod_lti'\n                },\n                {\n                    key: 'delete_confirmation',\n                    component: 'mod_lti'\n                },\n                {\n                    key: 'delete',\n                    component: 'mod_lti'\n                },\n                {\n                    key: 'cancel',\n                    component: 'core'\n                },\n            ])\n            .done(function(strs) {\n                    notification.confirm(strs[0], strs[1], strs[2], strs[3], function() {\n                            toolType.delete(typeId)\n                                .done(function() {\n                                        stopLoading(element);\n                                        announceSuccess(element)\n                                            .done(function() {\n                                                    element.remove();\n                                                })\n                                            .fail(notification.exception)\n                                            .always(function() {\n                                                    // Always resolve because even if the announcement fails the type was deleted.\n                                                    promise.resolve();\n                                                });\n                                    })\n                                .fail(function(error) {\n                                        announceFailure(element);\n                                        promise.reject(error);\n                                    });\n                        }, function() {\n                                stopLoading(element);\n                                promise.resolve();\n                            });\n                })\n            .fail(function(error) {\n                    stopLoading(element);\n                    notification.exception(error);\n                    promise.reject(error);\n                });\n\n        return promise;\n    };\n\n    /**\n     * Save a given value in a data attribute on the element.\n     *\n     * @method setValueSnapshot\n     * @private\n     * @param {JQuery} element jQuery object representing the element.\n     * @param {String} value to be saved.\n     */\n    var setValueSnapshot = function(element, value) {\n        element.attr('data-val-snapshot', value);\n    };\n\n    /**\n     * Return the saved value from the element.\n     *\n     * @method getValueSnapshot\n     * @private\n     * @param {JQuery} element jQuery object representing the element.\n     * @return {String} the saved value.\n     */\n    var getValueSnapshot = function(element) {\n        return element.attr('data-val-snapshot');\n    };\n\n    /**\n     * Save the current value of the tool description.\n     *\n     * @method snapshotDescription\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     */\n    var snapshotDescription = function(element) {\n        var descriptionElement = getDescriptionElement(element);\n\n        if (descriptionElement.hasClass('loading')) {\n            return;\n        }\n\n        var description = descriptionElement.text().trim();\n        setValueSnapshot(descriptionElement, description);\n    };\n\n    /**\n     * Send a request to update the description value for this tool\n     * in the Moodle server.\n     *\n     * @method updateDescription\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     * @return {Promise} jQuery Deferred object\n     */\n    var updateDescription = function(element) {\n        var typeId = getTypeId(element);\n\n        // Return early if we don't have an id because it's\n        // required to save the changes.\n        if (typeId === \"\") {\n            return $.Deferred().resolve();\n        }\n\n        var descriptionElement = getDescriptionElement(element);\n\n        // Return early if we're already saving a value.\n        if (descriptionElement.hasClass('loading')) {\n            return $.Deferred().resolve();\n        }\n\n        var description = descriptionElement.text().trim();\n        var snapshotVal = getValueSnapshot(descriptionElement);\n\n        // If the value hasn't change then don't bother sending the\n        // update request.\n        if (snapshotVal == description) {\n            return $.Deferred().resolve();\n        }\n\n        descriptionElement.addClass('loading');\n\n        var promise = toolType.update({id: typeId, description: description});\n\n        promise.done(function(type) {\n            descriptionElement.removeClass('loading');\n            // Make sure the text is updated with the description from the\n            // server, just in case the update didn't work.\n            descriptionElement.text(type.description);\n        }).fail(notification.exception);\n\n        // Probably need to handle failures better so that we can revert\n        // the value in the input for the user.\n        promise.fail(function() {\n          descriptionElement.removeClass('loading');\n        });\n\n        return promise;\n    };\n\n    /**\n     * Save the current value of the tool name.\n     *\n     * @method snapshotName\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     */\n    var snapshotName = function(element) {\n        var nameElement = getNameElement(element);\n\n        if (nameElement.hasClass('loading')) {\n            return;\n        }\n\n        var name = nameElement.text().trim();\n        setValueSnapshot(nameElement, name);\n    };\n\n    /**\n     * Send a request to update the name value for this tool\n     * in the Moodle server.\n     *\n     * @method updateName\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     * @return {Promise} jQuery Deferred object\n     */\n    var updateName = function(element) {\n        var typeId = getTypeId(element);\n\n        // Return if we don't have an id.\n        if (typeId === \"\") {\n            return $.Deferred().resolve();\n        }\n\n        var nameElement = getNameElement(element);\n\n        // Return if we're already saving.\n        if (nameElement.hasClass('loading')) {\n            return $.Deferred().resolve();\n        }\n\n        var name = nameElement.text().trim();\n        var snapshotVal = getValueSnapshot(nameElement);\n\n        // If the value hasn't change then don't bother sending the\n        // update request.\n        if (snapshotVal == name) {\n            return $.Deferred().resolve();\n        }\n\n        nameElement.addClass('loading');\n        var promise = toolType.update({id: typeId, name: name});\n\n        promise.done(function(type) {\n            nameElement.removeClass('loading');\n            // Make sure the text is updated with the name from the\n            // server, just in case the update didn't work.\n            nameElement.text(type.name);\n        });\n\n        // Probably need to handle failures better so that we can revert\n        // the value in the input for the user.\n        promise.fail(function() {\n          nameElement.removeClass('loading');\n        });\n\n        return promise;\n    };\n\n    /**\n     * Send a request to update the state for this tool to be configured (active)\n     * in the Moodle server. A success or failure announcement is triggered depending\n     * on the result.\n     *\n     * @method setStatusActive\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     * @return {Promise} jQuery Deferred object\n     */\n    var setStatusActive = function(element) {\n        var id = getTypeId(element);\n\n        // Return if we don't have an id.\n        if (id === \"\") {\n            return $.Deferred().resolve();\n        }\n\n        startLoading(element);\n\n        var promise = toolType.update({\n            id: id,\n            state: toolType.constants.state.configured\n        });\n\n        promise.then(function(toolTypeData) {\n            stopLoading(element);\n            announceSuccess(element);\n            return toolTypeData;\n        }).then(function(toolTypeData) {\n            return templates.render('mod_lti/tool_card', toolTypeData);\n        }).then(function(renderResult) {\n            var html = renderResult[0];\n            var js = renderResult[1];\n\n            templates.replaceNode(element, html, js);\n            return;\n        }).catch(function() {\n            stopLoading(element);\n            announceFailure(element);\n        });\n\n        return promise;\n    };\n\n    /**\n     * Show the capabilities approval screen to show which groups of data this\n     * type requires access to in Moodle (if any).\n     *\n     * @method displayCapabilitiesApproval\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     */\n    var displayCapabilitiesApproval = function(element) {\n        element.addClass('announcement capabilities');\n    };\n\n    /**\n     * Hide the capabilities approval screen.\n     *\n     * @method hideCapabilitiesApproval\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     */\n    var hideCapabilitiesApproval = function(element) {\n        element.removeClass('announcement capabilities');\n    };\n\n    /**\n     * The user wishes to activate this tool so show them the capabilities that\n     * they need to agree to or if there are none then set the tool type's state\n     * to active.\n     *\n     * @method activateToolType\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     */\n    var activateToolType = function(element) {\n        if (hasCapabilitiesContainer(element)) {\n            displayCapabilitiesApproval(element);\n        } else {\n            setStatusActive(element);\n        }\n    };\n\n    /**\n     * Sets up the listeners for user interaction on this tool type card.\n     *\n     * @method registerEventListeners\n     * @private\n     * @param {JQuery} element jQuery object representing the tool card.\n     */\n    var registerEventListeners = function(element) {\n        var deleteButton = getDeleteButton(element);\n        deleteButton.click(function(e) {\n            e.preventDefault();\n            deleteType(element);\n        });\n        deleteButton.keypress(function(e) {\n            if (!e.metaKey && !e.shiftKey && !e.altKey && !e.ctrlKey) {\n                if (e.keyCode == KEYS.ENTER || e.keyCode == KEYS.SPACE) {\n                    e.preventDefault();\n                    deleteButton.click();\n                }\n            }\n        });\n\n        var descriptionElement = getDescriptionElement(element);\n        descriptionElement.focus(function(e) {\n            e.preventDefault();\n            // Save a copy of the current value for the description so that\n            // we can check if the user has changed it before sending a request to\n            // the server.\n            snapshotDescription(element);\n        });\n        descriptionElement.blur(function(e) {\n            e.preventDefault();\n            updateDescription(element);\n        });\n        descriptionElement.keypress(function(e) {\n            if (!e.metaKey && !e.shiftKey && !e.altKey && !e.ctrlKey) {\n                if (e.keyCode == KEYS.ENTER) {\n                    e.preventDefault();\n                    descriptionElement.blur();\n                }\n            }\n        });\n\n        var nameElement = getNameElement(element);\n        nameElement.focus(function(e) {\n            e.preventDefault();\n            // Save a copy of the current value for the name so that\n            // we can check if the user has changed it before sending a request to\n            // the server.\n            snapshotName(element);\n        });\n        nameElement.blur(function(e) {\n            e.preventDefault();\n            updateName(element);\n        });\n        nameElement.keypress(function(e) {\n            if (!e.metaKey && !e.shiftKey && !e.altKey && !e.ctrlKey) {\n                if (e.keyCode == KEYS.ENTER) {\n                    e.preventDefault();\n                    nameElement.blur();\n                }\n            }\n        });\n\n        // Only pending tool type cards have an activate button.\n        if (hasActivateButton(element)) {\n            var activateButton = getActivateButton(element);\n            activateButton.click(function(e) {\n                e.preventDefault();\n                activateToolType(element);\n            });\n            activateButton.keypress(function(e) {\n                if (!e.metaKey && !e.shiftKey && !e.altKey && !e.ctrlKey) {\n                    if (e.keyCode == KEYS.ENTER || e.keyCode == KEYS.SPACE) {\n                        e.preventDefault();\n                        activateButton.click();\n                    }\n                }\n            });\n        }\n\n        if (hasCapabilitiesContainer(element)) {\n            var capabilitiesContainer = getCapabilitiesContainer(element);\n\n            capabilitiesContainer.on(ltiEvents.CAPABILITIES_AGREE, function() {\n                setStatusActive(element);\n            });\n\n            capabilitiesContainer.on(ltiEvents.CAPABILITIES_DECLINE, function() {\n                hideCapabilitiesApproval(element);\n            });\n        }\n    };\n\n    return /** @alias module:mod_lti/tool_card_controller */ {\n\n        /**\n         * Initialise this module.\n         *\n         * @param {JQuery} element jQuery object representing the tool card.\n         */\n        init: function(element) {\n            registerEventListeners(element);\n        }\n    };\n});\n"]}