'use strict';define('mod_lti/tool_configure_controller',['jquery','core/ajax','core/notification','core/templates','mod_lti/events','mod_lti/keys','mod_lti/tool_type','mod_lti/tool_proxy','core/str'],function($,ajax,notification,templates,ltiEvents,KEYS,toolType,toolProxy,str){var SELECTORS={EXTERNAL_REGISTRATION_CONTAINER:'#external-registration-container',EXTERNAL_REGISTRATION_PAGE_CONTAINER:'#external-registration-page-container',CARTRIDGE_REGISTRATION_CONTAINER:'#cartridge-registration-container',CARTRIDGE_REGISTRATION_FORM:'#cartridge-registration-form',ADD_TOOL_FORM:'#add-tool-form',TOOL_LIST_CONTAINER:'#tool-list-container',TOOL_CREATE_BUTTON:'#tool-create-button',REGISTRATION_CHOICE_CONTAINER:'#registration-choice-container',TOOL_URL:'#tool-url'},getToolCreateButton=function(){return $(SELECTORS.TOOL_CREATE_BUTTON)},getToolListContainer=function(){return $(SELECTORS.TOOL_LIST_CONTAINER)},getExternalRegistrationContainer=function(){return $(SELECTORS.EXTERNAL_REGISTRATION_CONTAINER)},getCartridgeRegistrationContainer=function(){return $(SELECTORS.CARTRIDGE_REGISTRATION_CONTAINER)},getRegistrationChoiceContainer=function(){return $(SELECTORS.REGISTRATION_CHOICE_CONTAINER)},getToolURL=function(){return $(SELECTORS.TOOL_URL).val()},hideExternalRegistration=function(){getExternalRegistrationContainer().addClass('hidden')},hideCartridgeRegistration=function(){getCartridgeRegistrationContainer().addClass('hidden')},hideRegistrationChoices=function(){getRegistrationChoiceContainer().addClass('hidden')},showExternalRegistration=function(){hideCartridgeRegistration(),hideRegistrationChoices(),getExternalRegistrationContainer().removeClass('hidden'),screenReaderAnnounce(getExternalRegistrationContainer())},showCartridgeRegistration=function(url){hideExternalRegistration(),hideRegistrationChoices(),getCartridgeRegistrationContainer().removeClass('hidden'),getCartridgeRegistrationContainer().find(SELECTORS.CARTRIDGE_REGISTRATION_FORM).attr('data-cartridge-url',url),screenReaderAnnounce(getCartridgeRegistrationContainer())},showRegistrationChoices=function(){hideExternalRegistration(),hideCartridgeRegistration(),getRegistrationChoiceContainer().removeClass('hidden'),screenReaderAnnounce(getRegistrationChoiceContainer())},screenReaderAnnounce=function(element){var children=element.children().detach();children.appendTo(element)},hideToolList=function(){getToolListContainer().addClass('hidden')},showToolList=function(){getToolListContainer().removeClass('hidden')},showRegistrationFeedback=function(data){var type=data.error?'error':'success';notification.addNotification({message:data.message,type:type})},startLoading=function(element){element.addClass('loading')},stopLoading=function(element){element.removeClass('loading')},reloadToolList=function(){var promise=$.Deferred(),container=getToolListContainer();startLoading(container),$.when(toolType.query(),toolProxy.query({orphanedonly:!0})).done(function(types,proxies){templates.render('mod_lti/tool_list',{tools:types,proxies:proxies}).done(function(html,js){container.empty(),container.append(html),templates.runTemplateJS(js),promise.resolve()}).fail(promise.reject)}).fail(promise.reject),promise.fail(notification.exception).always(function(){stopLoading(container)})},addTool=function(){var url=$.trim(getToolURL());if(''===url)return $.Deferred().resolve();var toolButton=getToolCreateButton();startLoading(toolButton);var promise=toolType.isCartridge(url);return promise.always(function(){stopLoading(toolButton)}),promise.done(function(result){result.iscartridge?($(SELECTORS.TOOL_URL).val(''),$(document).trigger(ltiEvents.START_CARTRIDGE_REGISTRATION,url)):$(document).trigger(ltiEvents.START_EXTERNAL_REGISTRATION,{url:url})}),promise.fail(function(){str.get_string('errorbadurl','mod_lti').done(function(s){$(document).trigger(ltiEvents.REGISTRATION_FEEDBACK,{message:s,error:!0})}).fail(notification.exception)}),promise},registerEventListeners=function(){$(document).on(ltiEvents.NEW_TOOL_TYPE,function(){reloadToolList()}),$(document).on(ltiEvents.START_EXTERNAL_REGISTRATION,function(){showExternalRegistration(),$(SELECTORS.TOOL_URL).val(''),hideToolList()}),$(document).on(ltiEvents.STOP_EXTERNAL_REGISTRATION,function(){showToolList(),showRegistrationChoices()}),$(document).on(ltiEvents.START_CARTRIDGE_REGISTRATION,function(event,url){showCartridgeRegistration(url)}),$(document).on(ltiEvents.STOP_CARTRIDGE_REGISTRATION,function(){getCartridgeRegistrationContainer().find(SELECTORS.CARTRIDGE_REGISTRATION_FORM).removeAttr('data-cartridge-url'),showRegistrationChoices()}),$(document).on(ltiEvents.REGISTRATION_FEEDBACK,function(event,data){showRegistrationFeedback(data)});var form=$(SELECTORS.ADD_TOOL_FORM);form.submit(function(e){e.preventDefault(),addTool()})};return{init:function init(){registerEventListeners(),reloadToolList()}}});
//# sourceMappingURL=tool_configure_controller.min.js.map
