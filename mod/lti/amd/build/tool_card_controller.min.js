'use strict';define('mod_lti/tool_card_controller',['jquery','core/ajax','core/notification','core/templates','mod_lti/tool_type','mod_lti/events','mod_lti/keys','core/str'],function($,ajax,notification,templates,toolType,ltiEvents,KEYS,str){var SELECTORS={DELETE_BUTTON:'.delete',NAME_ELEMENT:'.name',DESCRIPTION_ELEMENT:'.description',CAPABILITIES_CONTAINER:'.capabilities-container',ACTIVATE_BUTTON:'.tool-card-footer a.activate'},getDeleteButton=function(element){return element.find(SELECTORS.DELETE_BUTTON)},getNameElement=function(element){return element.find(SELECTORS.NAME_ELEMENT)},getDescriptionElement=function(element){return element.find(SELECTORS.DESCRIPTION_ELEMENT)},getActivateButton=function(element){return element.find(SELECTORS.ACTIVATE_BUTTON)},hasActivateButton=function(element){return!!getActivateButton(element).length},getCapabilitiesContainer=function(element){return element.find(SELECTORS.CAPABILITIES_CONTAINER)},hasCapabilitiesContainer=function(element){return!!getCapabilitiesContainer(element).length},getTypeId=function(element){return element.attr('data-type-id')},clearAllAnnouncements=function(element){element.removeClass('announcement loading success fail capabilities')},startLoading=function(element){clearAllAnnouncements(element),element.addClass('announcement loading')},stopLoading=function(element){element.removeClass('announcement loading')},announceSuccess=function(element){var promise=$.Deferred();return clearAllAnnouncements(element),element.addClass('announcement success'),setTimeout(function(){element.removeClass('announcement success'),promise.resolve()},2000),promise},announceFailure=function(element){var promise=$.Deferred();return clearAllAnnouncements(element),element.addClass('announcement fail'),setTimeout(function(){element.removeClass('announcement fail'),promise.resolve()},2000),promise},deleteType=function(element){var promise=$.Deferred(),typeId=getTypeId(element);return(startLoading(element),''===typeId)?$.Deferred().resolve():(str.get_strings([{key:'delete',component:'mod_lti'},{key:'delete_confirmation',component:'mod_lti'},{key:'delete',component:'mod_lti'},{key:'cancel',component:'core'}]).done(function(strs){notification.confirm(strs[0],strs[1],strs[2],strs[3],function(){toolType.delete(typeId).done(function(){stopLoading(element),announceSuccess(element).done(function(){element.remove()}).fail(notification.exception).always(function(){promise.resolve()})}).fail(function(error){announceFailure(element),promise.reject(error)})},function(){stopLoading(element),promise.resolve()})}).fail(function(error){stopLoading(element),notification.exception(error),promise.reject(error)}),promise)},setValueSnapshot=function(element,value){element.attr('data-val-snapshot',value)},getValueSnapshot=function(element){return element.attr('data-val-snapshot')},snapshotDescription=function(element){var descriptionElement=getDescriptionElement(element);if(!descriptionElement.hasClass('loading')){var description=descriptionElement.text().trim();setValueSnapshot(descriptionElement,description)}},updateDescription=function(element){var typeId=getTypeId(element);if(''===typeId)return $.Deferred().resolve();var descriptionElement=getDescriptionElement(element);if(descriptionElement.hasClass('loading'))return $.Deferred().resolve();var description=descriptionElement.text().trim(),snapshotVal=getValueSnapshot(descriptionElement);if(snapshotVal==description)return $.Deferred().resolve();descriptionElement.addClass('loading');var promise=toolType.update({id:typeId,description:description});return promise.done(function(type){descriptionElement.removeClass('loading'),descriptionElement.text(type.description)}).fail(notification.exception),promise.fail(function(){descriptionElement.removeClass('loading')}),promise},snapshotName=function(element){var nameElement=getNameElement(element);if(!nameElement.hasClass('loading')){var name=nameElement.text().trim();setValueSnapshot(nameElement,name)}},updateName=function(element){var typeId=getTypeId(element);if(''===typeId)return $.Deferred().resolve();var nameElement=getNameElement(element);if(nameElement.hasClass('loading'))return $.Deferred().resolve();var name=nameElement.text().trim(),snapshotVal=getValueSnapshot(nameElement);if(snapshotVal==name)return $.Deferred().resolve();nameElement.addClass('loading');var promise=toolType.update({id:typeId,name:name});return promise.done(function(type){nameElement.removeClass('loading'),nameElement.text(type.name)}),promise.fail(function(){nameElement.removeClass('loading')}),promise},setStatusActive=function(element){var id=getTypeId(element);if(''===id)return $.Deferred().resolve();startLoading(element);var promise=toolType.update({id:id,state:toolType.constants.state.configured});return promise.then(function(toolTypeData){return stopLoading(element),announceSuccess(element),toolTypeData}).then(function(toolTypeData){return templates.render('mod_lti/tool_card',toolTypeData)}).then(function(renderResult){var html=renderResult[0],js=renderResult[1];templates.replaceNode(element,html,js)}).catch(function(){stopLoading(element),announceFailure(element)}),promise},displayCapabilitiesApproval=function(element){element.addClass('announcement capabilities')},hideCapabilitiesApproval=function(element){element.removeClass('announcement capabilities')},activateToolType=function(element){hasCapabilitiesContainer(element)?displayCapabilitiesApproval(element):setStatusActive(element)},registerEventListeners=function(element){var deleteButton=getDeleteButton(element);deleteButton.click(function(e){e.preventDefault(),deleteType(element)}),deleteButton.keypress(function(e){e.metaKey||e.shiftKey||e.altKey||e.ctrlKey||e.keyCode!=KEYS.ENTER&&e.keyCode!=KEYS.SPACE||(e.preventDefault(),deleteButton.click())});var descriptionElement=getDescriptionElement(element);descriptionElement.focus(function(e){e.preventDefault(),snapshotDescription(element)}),descriptionElement.blur(function(e){e.preventDefault(),updateDescription(element)}),descriptionElement.keypress(function(e){e.metaKey||e.shiftKey||e.altKey||e.ctrlKey||e.keyCode!=KEYS.ENTER||(e.preventDefault(),descriptionElement.blur())});var nameElement=getNameElement(element);if(nameElement.focus(function(e){e.preventDefault(),snapshotName(element)}),nameElement.blur(function(e){e.preventDefault(),updateName(element)}),nameElement.keypress(function(e){e.metaKey||e.shiftKey||e.altKey||e.ctrlKey||e.keyCode!=KEYS.ENTER||(e.preventDefault(),nameElement.blur())}),hasActivateButton(element)){var activateButton=getActivateButton(element);activateButton.click(function(e){e.preventDefault(),activateToolType(element)}),activateButton.keypress(function(e){e.metaKey||e.shiftKey||e.altKey||e.ctrlKey||e.keyCode!=KEYS.ENTER&&e.keyCode!=KEYS.SPACE||(e.preventDefault(),activateButton.click())})}if(hasCapabilitiesContainer(element)){var capabilitiesContainer=getCapabilitiesContainer(element);capabilitiesContainer.on(ltiEvents.CAPABILITIES_AGREE,function(){setStatusActive(element)}),capabilitiesContainer.on(ltiEvents.CAPABILITIES_DECLINE,function(){hideCapabilitiesApproval(element)})}};return{init:function init(element){registerEventListeners(element)}}});
//# sourceMappingURL=tool_card_controller.min.js.map
