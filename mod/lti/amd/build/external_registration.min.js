'use strict';define('mod_lti/external_registration',['jquery','core/ajax','core/notification','core/templates','mod_lti/events','mod_lti/tool_proxy','mod_lti/tool_type','mod_lti/keys','core/str'],function($,ajax,notification,templates,ltiEvents,toolProxy,toolType,KEYS,str){var SELECTORS={EXTERNAL_REGISTRATION_CONTAINER:'#external-registration-page-container',EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER:'#external-registration-template-container',EXTERNAL_REGISTRATION_CANCEL_BUTTON:'#cancel-external-registration',TOOL_TYPE_CAPABILITIES_CONTAINER:'#tool-type-capabilities-container',TOOL_TYPE_CAPABILITIES_TEMPLATE_CONTAINER:'#tool-type-capabilities-template-container',CAPABILITIES_AGREE_CONTAINER:'.capabilities-container'},getExternalRegistrationCancelButton=function(){return $(SELECTORS.EXTERNAL_REGISTRATION_CANCEL_BUTTON)},getExternalRegistrationContainer=function(){return $(SELECTORS.EXTERNAL_REGISTRATION_CONTAINER)},getExternalRegistrationTemplateContainer=function(){return $(SELECTORS.EXTERNAL_REGISTRATION_TEMPLATE_CONTAINER)},getToolTypeCapabilitiesContainer=function(){return $(SELECTORS.TOOL_TYPE_CAPABILITIES_CONTAINER)},getToolTypeCapabilitiesTemplateContainer=function(){return $(SELECTORS.TOOL_TYPE_CAPABILITIES_TEMPLATE_CONTAINER)},startLoadingCapabilitiesContainer=function(){getToolTypeCapabilitiesContainer().addClass('loading')},stopLoadingCapabilitiesContainer=function(){getToolTypeCapabilitiesContainer().removeClass('loading')},startLoadingCancel=function(){getExternalRegistrationCancelButton().addClass('loading')},stopLoadingCancel=function(){getExternalRegistrationCancelButton().removeClass('loading')},hideToolTypeCapabilitiesContainer=function(){getToolTypeCapabilitiesContainer().addClass('hidden')},showToolTypeCapabilitiesContainer=function(){getToolTypeCapabilitiesContainer().removeClass('hidden')},hideExternalRegistrationContent=function(){getExternalRegistrationContainer().addClass('hidden')},showExternalRegistrationContent=function(){getExternalRegistrationContainer().removeClass('hidden')},setToolProxyId=function(id){var button=getExternalRegistrationCancelButton();button.attr('data-tool-proxy-id',id)},getToolProxyId=function(){var button=getExternalRegistrationCancelButton();return button.attr('data-tool-proxy-id')},clearToolProxyId=function(){var button=getExternalRegistrationCancelButton();button.removeAttr('data-tool-proxy-id')},hasToolProxyId=function(){return!!getToolProxyId()},hasCreatedToolProxy=function(){var button=getExternalRegistrationCancelButton();return button.attr('data-tool-proxy-new')&&hasToolProxyId()},setProxyAsNew=function(){var button=getExternalRegistrationCancelButton();return button.attr('data-tool-proxy-new','new')},setProxyAsOld=function(){var button=getExternalRegistrationCancelButton();return button.removeAttr('data-tool-proxy-new')},getRegistrationRequest=function(id){return ajax.call([{methodname:'mod_lti_get_tool_proxy_registration_request',args:{id:id}}])[0]},cancelRegistration=function(){startLoadingCancel();var promise=$.Deferred();if(hasCreatedToolProxy()){var id=getToolProxyId();toolProxy.delete(id).done(function(){promise.resolve()}).fail(function(failure){promise.reject(failure)})}else promise.resolve();return promise.done(function(){finishExternalRegistration(),stopLoadingCancel()}).fail(function(failure){notification.exception(failure),finishExternalRegistration(),stopLoadingCancel(),str.get_string('failedtodeletetoolproxy','mod_lti').done(function(s){$(document).trigger(ltiEvents.REGISTRATION_FEEDBACK,{message:s,error:!0})}).fail(notification.exception)}),promise},renderExternalRegistrationWindow=function(registrationRequest){var promise=templates.render('mod_lti/tool_proxy_registration_form',registrationRequest);return promise.done(function(html,js){var container=getExternalRegistrationTemplateContainer();container.append(html),templates.runTemplateJS(js),container.find('form').submit(),showExternalRegistrationContent()}).fail(notification.exception),promise},setTypeStatusActive=function(typeData){return toolType.update({id:typeData.id,state:toolType.constants.state.configured})},promptForToolTypeCapabilitiesAgreement=function(typeData){var promise=$.Deferred();return templates.render('mod_lti/tool_type_capabilities_agree',typeData).done(function(html,js){var container=getToolTypeCapabilitiesTemplateContainer();hideExternalRegistrationContent(),showToolTypeCapabilitiesContainer(),templates.replaceNodeContents(container,html,js);var choiceContainer=container.find(SELECTORS.CAPABILITIES_AGREE_CONTAINER);choiceContainer.on(ltiEvents.CAPABILITIES_AGREE,function(){startLoadingCapabilitiesContainer(),setTypeStatusActive(typeData).always(function(){stopLoadingCapabilitiesContainer(),container.empty(),promise.resolve()})}),choiceContainer.on(ltiEvents.CAPABILITIES_DECLINE,function(){container.empty(),promise.resolve()})}).fail(promise.reject),promise.done(function(){hideToolTypeCapabilitiesContainer()}).fail(notification.exception),promise},createAndRegisterToolProxy=function(url){var promise=$.Deferred();return url&&''!==url?toolProxy.create({regurl:url}).done(function(result){setProxyAsNew(),promise=registerProxy(result.id)}).fail(function(exception){cancelRegistration();var feedback={message:exception.message,error:!0};$(document).trigger(ltiEvents.REGISTRATION_FEEDBACK,feedback),promise.reject(exception)}):promise.resolve(),promise},registerProxy=function(id){var promise=$.Deferred();return setToolProxyId(id),getRegistrationRequest(id).done(function(registrationRequest){renderExternalRegistrationWindow(registrationRequest).done(function(){promise.resolve()}).fail(promise.fail)}).fail(promise.fail),promise},finishExternalRegistration=function(){hasToolProxyId()&&clearToolProxyId(),setProxyAsOld(!1),hideExternalRegistrationContent();var container=getExternalRegistrationTemplateContainer();container.empty(),$(document).trigger(ltiEvents.STOP_EXTERNAL_REGISTRATION)},registerEventListeners=function(){$(document).on(ltiEvents.START_EXTERNAL_REGISTRATION,function(event,data){data&&(data.url&&createAndRegisterToolProxy(data.url),data.proxyid&&registerProxy(data.proxyid))});var cancelExternalRegistrationButton=getExternalRegistrationCancelButton();cancelExternalRegistrationButton.click(function(e){e.preventDefault(),cancelRegistration()}),cancelExternalRegistrationButton.keypress(function(e){e.metaKey||e.shiftKey||e.altKey||e.ctrlKey||e.keyCode!=KEYS.ENTER&&e.keyCode!=KEYS.SPACE||(e.preventDefault(),cancelRegistration())}),window.triggerExternalRegistrationComplete=function(data){var promise=$.Deferred(),feedback={message:'',error:!1};if('success'!=data.status)feedback.message=data.error,feedback.error=!0,promise.done(function(){cancelRegistration().always(function(){$(document).trigger(ltiEvents.REGISTRATION_FEEDBACK,feedback)})}).fail(notification.exception),promise.resolve();else if(str.get_string('successfullycreatedtooltype','mod_lti').done(function(s){feedback.message=s}).fail(notification.exception),promise.done(function(){finishExternalRegistration(),$(document).trigger(ltiEvents.REGISTRATION_FEEDBACK,feedback),$(document).trigger(ltiEvents.NEW_TOOL_TYPE)}).fail(notification.exception),hasCreatedToolProxy()){var proxyId=getToolProxyId();toolType.getFromToolProxyId(proxyId).done(function(types){if(types&&types.length){var typeData=types[0];typeData.hascapabilitygroups?promptForToolTypeCapabilitiesAgreement(typeData).always(function(){promise.resolve()}):promise.resolve()}else promise.resolve()}).fail(function(){promise.resolve()})}return promise}};return{init:function init(){registerEventListeners()}}});
//# sourceMappingURL=external_registration.min.js.map
