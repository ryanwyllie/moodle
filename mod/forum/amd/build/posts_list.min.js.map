{"version":3,"sources":["../src/posts_list.js"],"names":["define","$","Templates","Notification","Selectors","InPageReply","EVENTS","IN_PAGE_REPLY_VISIBILITY_CHANGE","registerEventListeners","root","inpageReplyConfig","on","post","inpageReplyLink","e","preventDefault","window","location","hash","url","href","split","history","pushState","document","title","currentTarget","postContainer","closest","postContainerChildren","children","not","repliesContainer","postContentContainer","find","forumCoreContent","currentSubject","forumSubject","inpageReplyContainer","filter","length","first","inpageReplyContent","currentAuthorName","authorName","text","context","extend","postid","data","attr","sesskey","M","cfg","parentsubject","html","parentauthorname","canreplyprivately","postformat","CONTENT_FORMATS","MOODLE","render","template","then","js","appendNodeContents","form","trigger","slideToggle","focus","fail","exception","isVisible","init","newPostConfig","events"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is the highest level module for the calendar. It is\n * responsible for initialising all of the components required for\n * the calendar to run. It also coordinates the interaction between\n * components by listening for and responding to different events\n * triggered within the calendar UI.\n *\n * @module     mod_forum/posts_list\n * @package    mod_forum\n * @copyright  2019 Peter Dias\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n        'jquery',\n        'core/templates',\n        'core/notification',\n        'mod_forum/selectors',\n        'mod_forum/inpage_reply',\n    ], function(\n        $,\n        Templates,\n        Notification,\n        Selectors,\n        InPageReply\n    ) {\n\n    var EVENTS = {\n        IN_PAGE_REPLY_VISIBILITY_CHANGE: 'mod-forum-in-page-reply-visibility-change'\n    };\n\n    var registerEventListeners = function(root, inpageReplyConfig) {\n        root.on('click', Selectors.post.inpageReplyLink, function(e) {\n            e.preventDefault();\n            // After adding a reply a url hash is being generated that scrolls (points) to the newly added reply.\n            // The hash being present causes this scrolling behavior to the particular reply to persists even when\n            // another, non-related in-page replay link is being clicked which ultimately causes a bad user experience.\n            // A particular solution for this problem would be changing the browser's history state when a url hash is\n            // present.\n            if (window.location.hash) {\n                // Remove the fragment identifier from the url.\n                var url = window.location.href.split('#')[0];\n                history.pushState({}, document.title, url);\n            }\n\n            var currentTarget = $(e.currentTarget);\n            var postContainer = currentTarget.closest(Selectors.post.post);\n            var postContainerChildren = postContainer.children().not(Selectors.post.repliesContainer);\n            var postContentContainer = postContainerChildren.find(Selectors.post.forumCoreContent);\n            var currentSubject = postContentContainer.find(Selectors.post.forumSubject);\n            // Is one of the immediate container chilren the inpage reply container?\n            var inpageReplyContainer = postContainerChildren.filter(Selectors.post.inpageReplyContainer);\n            if (!inpageReplyContainer.length) {\n                // If not then find the first instance of it that isn't in the list of replies.\n                inpageReplyContainer = postContainerChildren.find(Selectors.post.inpageReplyContainer).first();\n            }\n\n            if (!inpageReplyContainer.find(Selectors.post.inpageReplyContent).length) {\n                var currentAuthorName = postContentContainer.find(Selectors.post.authorName).text();\n                var context = $.extend({\n                    postid: postContainer.data('post-id'),\n                    \"reply_url\": currentTarget.attr('href'),\n                    sesskey: M.cfg.sesskey,\n                    parentsubject: currentSubject.html(),\n                    parentauthorname: currentAuthorName,\n                    canreplyprivately: currentTarget.data('can-reply-privately'),\n                    postformat: InPageReply.CONTENT_FORMATS.MOODLE\n                }, inpageReplyConfig.context);\n\n                Templates.render(inpageReplyConfig.template, context)\n                    .then(function(html, js) {\n                        return Templates.appendNodeContents(inpageReplyContainer, html, js);\n                    })\n                    .then(function() {\n                        var form = inpageReplyContainer.find(Selectors.post.inpageReplyContent);\n                        form.attr('aria-hidden', 'false');\n                        form.trigger(EVENTS.IN_PAGE_REPLY_VISIBILITY_CHANGE, true);\n\n                        return form.slideToggle(200, function() {\n                            form.find('textarea').focus();\n                        });\n                    })\n                    .fail(Notification.exception);\n            } else {\n                var form = inpageReplyContainer.find(Selectors.post.inpageReplyContent);\n                var isVisible = form.attr('aria-hidden') == 'false';\n\n                if (isVisible) {\n                    // Going from visible to hidden.\n                    form.attr('aria-hidden', 'true');\n                    form.trigger(EVENTS.IN_PAGE_REPLY_VISIBILITY_CHANGE, false);\n                } else {\n                    // Going from hidden to visible.\n                    form.attr('aria-hidden', 'false');\n                    form.trigger(EVENTS.IN_PAGE_REPLY_VISIBILITY_CHANGE, true);\n                }\n\n                form.slideToggle(200, function() {\n                    if (!isVisible) {\n                        // Going from hidden to visible.\n                        form.find('textarea').focus();\n                    }\n                });\n            }\n        });\n    };\n\n    return {\n        init: function(root, inpageReplyConfig, newPostConfig) {\n            inpageReplyConfig = inpageReplyConfig ? inpageReplyConfig : {};\n            inpageReplyConfig.template = inpageReplyConfig.template ? inpageReplyConfig.template : 'mod_forum/inpage_reply';\n            inpageReplyConfig.context = inpageReplyConfig.context ? inpageReplyConfig.context : {};\n\n            registerEventListeners(root, inpageReplyConfig);\n            InPageReply.init(root, newPostConfig);\n        },\n        events: EVENTS\n    };\n});\n"],"file":"posts_list.min.js"}