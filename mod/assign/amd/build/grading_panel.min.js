'use strict';define('mod_assign/grading_panel',['jquery','core/yui','core/notification','core/templates','core/fragment','core/ajax','core/str','mod_assign/grading_form_change_checker','mod_assign/grading_events'],function($,Y,notification,templates,fragment,ajax,str,checker,GradingEvents){var GradingPanel=function(selector){this._regionSelector=selector,this._region=$(selector),this._userCache=[],this.registerEventListeners()};return GradingPanel.prototype._regionSelector=null,GradingPanel.prototype._lastUserId=0,GradingPanel.prototype._lastAttemptNumber=-1,GradingPanel.prototype._region=null,GradingPanel.prototype.nextUserId=null,GradingPanel.prototype.nextUser=!1,GradingPanel.prototype._niceReplaceNodeContents=function(node,html,js){var promise=$.Deferred();return node.fadeOut('fast',function(){templates.replaceNodeContents(node,html,js),node.fadeIn('fast',function(){promise.resolve()})}),promise.promise()},GradingPanel.prototype._saveFormState=function(){'undefined'!=typeof window.tinyMCE&&window.tinyMCE.triggerSave();var checked=$('[data-region="grading-actions-form"] [name="sendstudentnotifications"]').prop('checked');$('.gradeform [name="sendstudentnotifications"]').val(checked)},GradingPanel.prototype._submitForm=function(event,nextUserId,nextUser){var form=$(this._region.find('form.gradeform'));$('[data-region="overlay"]').show(),form.trigger('save-form-state');var data=form.serialize(),assignmentid=this._region.attr('data-assignmentid');ajax.call([{methodname:'mod_assign_submit_grading_form',args:{assignmentid:assignmentid,userid:this._lastUserId,jsonformdata:JSON.stringify(data)},done:this._handleFormSubmissionResponse.bind(this,data,nextUserId,nextUser),fail:notification.exception}])},GradingPanel.prototype._handleFormSubmissionResponse=function(formdata,nextUserId,nextUser,response){'undefined'==typeof nextUserId&&(nextUserId=this._lastUserId),response.length?$(document).trigger('reset',[this._lastUserId,formdata]):(str.get_strings([{key:'changessaved',component:'core'},{key:'gradechangessaveddetail',component:'mod_assign'}]).done(function(strs){notification.alert(strs[0],strs[1])}).fail(notification.exception),Y.use('moodle-core-formchangechecker',function(){M.core_formchangechecker.reset_form_dirty_state()}),nextUserId==this._lastUserId?$(document).trigger('reset',nextUserId):nextUser?$(document).trigger('done-saving-show-next',!0):$(document).trigger('user-changed',nextUserId)),$('[data-region="overlay"]').hide()},GradingPanel.prototype._resetForm=function(e,userid,formdata){var event=$.Event('custom');'undefined'==typeof userid&&(userid=this._lastUserId),this._lastUserId=0,this._refreshGradingPanel(event,userid,formdata)},GradingPanel.prototype._chooseAttempt=function(e){var link=$(e.target),submissionsId=link.data('submissions'),submissionsform=$(document.getElementById(submissionsId)),formcopy=submissionsform.clone(),formhtml=formcopy.wrap($('<form/>')).html();str.get_strings([{key:'viewadifferentattempt',component:'mod_assign'},{key:'view',component:'core'},{key:'cancel',component:'core'}]).done(function(strs){notification.confirm(strs[0],formhtml,strs[1],strs[2],function(){var attemptnumber=$('input:radio[name=\'select-attemptnumber\']:checked').val();this._refreshGradingPanel(null,this._lastUserId,'',attemptnumber)}.bind(this))}.bind(this)).fail(notification.exception)},GradingPanel.prototype._addPopoutButtons=function(selector){var region=$(selector);templates.render('mod_assign/popout_button',{}).done(function(html){var parents=region.find('[data-fieldtype="filemanager"],[data-fieldtype="editor"],[data-fieldtype="grading"]').closest('.fitem');parents.addClass('has-popout').find('label').parent().append(html),region.on('click','[data-region="popout-button"]',this._togglePopout.bind(this))}.bind(this)).fail(notification.exception)},GradingPanel.prototype._togglePopout=function(event){event.preventDefault();var container=$(event.target).closest('.fitem');container.hasClass('popout')?$('.popout').removeClass('popout'):($('.popout').removeClass('popout'),container.addClass('popout'),container.addClass('moodle-has-zindex'))},GradingPanel.prototype._refreshGradingPanel=function(event,userid,submissiondata,attemptnumber){var contextid=this._region.attr('data-contextid');'undefined'==typeof submissiondata&&(submissiondata=''),'undefined'==typeof attemptnumber&&(attemptnumber=-1),this._lastUserId==userid&&this._lastAttemptNumber==attemptnumber&&''===submissiondata||(this._lastUserId=userid,this._lastAttemptNumber=attemptnumber,$(document).trigger('start-loading-user'),window.M.util.js_pending('mod-assign-loading-user'),templates.render('mod_assign/loading',{}).done(function(html,js){this._niceReplaceNodeContents(this._region,html,js).done(function(){if(0<userid){this._region.show();var params={userid:userid,attemptnumber:attemptnumber,jsonformdata:JSON.stringify(submissiondata)};fragment.loadFragment('mod_assign','gradingpanel',contextid,params).done(function(html,js){this._niceReplaceNodeContents(this._region,html,js).done(function(){checker.saveFormState('[data-region="grade-panel"] .gradeform'),$(document).on('editor-content-restored',function(){checker.saveFormState('[data-region="grade-panel"] .gradeform')}),$('[data-region="attempt-chooser"]').on('click',this._chooseAttempt.bind(this)),this._addPopoutButtons('[data-region="grade-panel"] .gradeform'),$(document).trigger('finish-loading-user'),window.M.util.js_complete('mod-assign-loading-user')}.bind(this)).fail(notification.exception)}.bind(this)).fail(notification.exception),$('[data-region="review-panel"]').show()}else this._region.hide(),$('[data-region="review-panel"]').hide(),$(document).trigger('finish-loading-user'),window.M.util.js_complete('mod-assign-loading-user')}.bind(this))}.bind(this)).fail(notification.exception))},GradingPanel.prototype._getNextUser=function(event,data){this.nextUserId=data.nextUserId,this.nextUser=data.nextUser},GradingPanel.prototype._handleSaveAndShowNext=function(){this._submitForm(null,this.nextUserId,this.nextUser)},GradingPanel.prototype.getPanelElement=function(){return $('[data-region="grade-panel"]')},GradingPanel.prototype.collapsePanel=function(){this.getPanelElement().addClass('collapsed')},GradingPanel.prototype.expandPanel=function(){this.getPanelElement().removeClass('collapsed')},GradingPanel.prototype.registerEventListeners=function(){var docElement=$(document),region=$(this._region);region.on('submit','form',function(e){e.preventDefault()}),docElement.on('next-user',this._getNextUser.bind(this)),docElement.on('user-changed',this._refreshGradingPanel.bind(this)),docElement.on('save-changes',this._submitForm.bind(this)),docElement.on('save-and-show-next',this._handleSaveAndShowNext.bind(this)),docElement.on('reset',this._resetForm.bind(this)),docElement.on('save-form-state',this._saveFormState.bind(this)),docElement.on(GradingEvents.COLLAPSE_GRADE_PANEL,function(){this.collapsePanel()}.bind(this)),docElement.on(GradingEvents.COLLAPSE_REVIEW_PANEL,function(){this.expandPanel()}.bind(this)),docElement.on(GradingEvents.EXPAND_GRADE_PANEL,function(){this.expandPanel()}.bind(this))},GradingPanel});
//# sourceMappingURL=grading_panel.min.js.map
