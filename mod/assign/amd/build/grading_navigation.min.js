'use strict';define('mod_assign/grading_navigation',['jquery','core/notification','core/str','core/form-autocomplete','core/ajax','mod_assign/grading_form_change_checker'],function($,notification,str,autocomplete,ajax,checker){var GradingNavigation=function(selector){this._regionSelector=selector,this._region=$(selector),this._filters=[],this._users=[],this._filteredUsers=[],this._loadAllUsers(),this._region.find('[data-action="previous-user"]').on('click',this._handlePreviousUser.bind(this)),this._region.find('[data-action="next-user"]').on('click',this._handleNextUser.bind(this)),this._region.find('[data-action="change-user"]').on('change',this._handleChangeUser.bind(this)),this._region.find('[data-region="user-filters"]').on('click',this._toggleExpandFilters.bind(this)),$(document).on('user-changed',this._refreshSelector.bind(this)),$(document).on('done-saving-show-next',this._handleNextUser.bind(this));var toggleLink=this._region.find('[data-region="user-filters"]'),configPanel=$(document.getElementById(toggleLink.attr('aria-controls')));configPanel.on('change','[type="checkbox"]',this._filterChanged.bind(this));var userid=$('[data-region="grading-navigation-panel"]').data('first-userid');userid&&this._selectUserById(userid),str.get_string('changeuser','mod_assign').done(function(s){autocomplete.enhance('[data-action=change-user]',!1,'mod_assign/participant_selector',s)}).fail(notification.exception),$(document).bind('start-loading-user',function(){this._isLoading=!0}.bind(this)),$(document).bind('finish-loading-user',function(){this._isLoading=!1}.bind(this))};return GradingNavigation.prototype._isLoading=!1,GradingNavigation.prototype._regionSelector=null,GradingNavigation.prototype._filters=null,GradingNavigation.prototype._users=null,GradingNavigation.prototype._region=null,GradingNavigation.prototype._loadAllUsers=function(){var select=this._region.find('[data-action=change-user]'),assignmentid=select.attr('data-assignmentid'),groupid=select.attr('data-groupid');ajax.call([{methodname:'mod_assign_list_participants',args:{assignid:assignmentid,groupid:groupid,filter:'',onlyids:!0},done:this._usersLoaded.bind(this),fail:notification.exception}])},GradingNavigation.prototype._usersLoaded=function(users){if(this._filteredUsers=this._users=users,this._users.length){var toggleLink=this._region.find('[data-region="user-filters"]'),configPanel=$(document.getElementById(toggleLink.attr('aria-controls')));configPanel.find('[type="checkbox"]').trigger('change')}else this._selectNoUser();this._triggerNextUserEvent()},GradingNavigation.prototype._checkClickOutsideConfigureFilters=function(event){var configPanel=this._region.find('[data-region="configure-filters"]');if(!configPanel.is(event.target)&&0===configPanel.has(event.target).length){var toggleLink=this._region.find('[data-region="user-filters"]');configPanel.hide(),configPanel.attr('aria-hidden','true'),toggleLink.attr('aria-expanded','false'),$(document).unbind('click.mod_assign_grading_navigation')}},GradingNavigation.prototype._filterChanged=function(event){var name=$(event.target).attr('name'),key=name.split('_').pop(),enabled=$(event.target).prop('checked');if(enabled)-1==this._filters.indexOf(key)&&(this._filters[this._filters.length]=key);else{var index=this._filters.indexOf(key);-1!=index&&this._filters.splice(index,1)}var filterlist=[];this._region.find('[data-region="configure-filters"]').find('[type="checkbox"]').each(function(idx,ele){$(ele).prop('checked')&&(filterlist[filterlist.length]=$(ele).closest('label').text())}),filterlist.length?this._region.find('[data-region="user-filters"] span').text(filterlist.join(', ')):str.get_string('nofilters','mod_assign').done(function(s){this._region.find('[data-region="user-filters"] span').text(s)}.bind(this)).fail(notification.exception);var select=this._region.find('[data-action=change-user]'),userid=select.attr('data-selected'),foundIndex=0;this._filteredUsers=[],$.each(this._users,function(index,user){var show=!0;$.each(this._filters,function(filterindex,filter){'submitted'==filter?'0'==user.submitted&&(show=!1):'notsubmitted'==filter?'1'==user.submitted&&(show=!1):'requiregrading'==filter?'0'==user.requiregrading&&(show=!1):'grantedextension'==filter&&'0'==user.grantedextension&&(show=!1)}),show&&(this._filteredUsers[this._filteredUsers.length]=user,userid==user.id&&(foundIndex=this._filteredUsers.length-1))}.bind(this)),this._filteredUsers.length?this._selectUserById(this._filteredUsers[foundIndex].id):this._selectNoUser(),this._triggerNextUserEvent()},GradingNavigation.prototype._selectNoUser=function(){this._isLoading||(checker.checkFormForChanges('[data-region="grade-panel"] .gradeform')?str.get_strings([{key:'unsavedchanges',component:'mod_assign'},{key:'unsavedchangesquestion',component:'mod_assign'},{key:'saveandcontinue',component:'mod_assign'},{key:'cancel',component:'core'}]).done(function(strs){notification.confirm(strs[0],strs[1],strs[2],strs[3],function(){$(document).trigger('save-changes',-1)})}):$(document).trigger('user-changed',-1))},GradingNavigation.prototype._selectUserById=function(userid){var select=this._region.find('[data-action=change-user]'),useridnumber=parseInt(userid,10);this._isLoading||(checker.checkFormForChanges('[data-region="grade-panel"] .gradeform')?str.get_strings([{key:'unsavedchanges',component:'mod_assign'},{key:'unsavedchangesquestion',component:'mod_assign'},{key:'saveandcontinue',component:'mod_assign'},{key:'cancel',component:'core'}]).done(function(strs){notification.confirm(strs[0],strs[1],strs[2],strs[3],function(){$(document).trigger('save-changes',useridnumber)})}):(select.attr('data-selected',userid),!isNaN(useridnumber)&&0<useridnumber&&$(document).trigger('user-changed',userid)))},GradingNavigation.prototype._toggleExpandFilters=function(event){event.preventDefault();var toggleLink=$(event.target).closest('[data-region="user-filters"]'),expanded='true'==toggleLink.attr('aria-expanded'),configPanel=$(document.getElementById(toggleLink.attr('aria-controls')));expanded?(configPanel.hide(),configPanel.attr('aria-hidden','true'),toggleLink.attr('aria-expanded','false'),$(document).unbind('click.mod_assign_grading_navigation')):(configPanel.css('display','inline-block'),configPanel.attr('aria-hidden','false'),toggleLink.attr('aria-expanded','true'),event.stopPropagation(),$(document).on('click.mod_assign_grading_navigation',this._checkClickOutsideConfigureFilters.bind(this)))},GradingNavigation.prototype._handlePreviousUser=function(e){e.preventDefault();var select=this._region.find('[data-action=change-user]'),currentUserId=select.attr('data-selected'),i=0,currentIndex=0;for(i=0;i<this._filteredUsers.length;i++)if(this._filteredUsers[i].id==currentUserId){currentIndex=i;break}var count=this._filteredUsers.length,newIndex=currentIndex-1;0>newIndex&&(newIndex=count-1),count&&this._selectUserById(this._filteredUsers[newIndex].id)},GradingNavigation.prototype._handleNextUser=function(e,saved){e.preventDefault();var select=this._region.find('[data-action=change-user]'),currentUserId=select.attr('data-selected'),i=0,currentIndex=0;for(i=0;i<this._filteredUsers.length;i++)if(this._filteredUsers[i].id==currentUserId){currentIndex=i;break}var count=this._filteredUsers.length,newIndex=(currentIndex+1)%count;if(saved&&count){var userid=this._filteredUsers[newIndex].id,useridnumber=parseInt(userid,10);select.attr('data-selected',userid),!isNaN(useridnumber)&&0<useridnumber&&$(document).trigger('user-changed',userid)}else count&&this._selectUserById(this._filteredUsers[newIndex].id)},GradingNavigation.prototype._refreshCount=function(){var select=this._region.find('[data-action=change-user]'),userid=select.attr('data-selected'),i=0,currentIndex=0;if(isNaN(userid)||0>=userid)this._region.find('[data-region="user-count"]').hide();else{for(this._region.find('[data-region="user-count"]').show(),i=0;i<this._filteredUsers.length;i++)if(this._filteredUsers[i].id==userid){currentIndex=i;break}var count=this._filteredUsers.length;count&&(currentIndex+=1);var param={x:currentIndex,y:count};str.get_string('xofy','mod_assign',param).done(function(s){this._region.find('[data-region="user-count-summary"]').text(s)}.bind(this)).fail(notification.exception)}},GradingNavigation.prototype._refreshSelector=function(event,userid){var select=this._region.find('[data-action=change-user]');userid=parseInt(userid,10),!isNaN(userid)&&0<userid&&select.attr('data-selected',userid),this._refreshCount()},GradingNavigation.prototype._triggerNextUserEvent=function(){1<this._filteredUsers.length?$(document).trigger('next-user',{nextUserId:null,nextUser:!0}):$(document).trigger('next-user',{nextUser:!1})},GradingNavigation.prototype._handleChangeUser=function(){var select=this._region.find('[data-action=change-user]'),userid=parseInt(select.val(),10);this._isLoading||(checker.checkFormForChanges('[data-region="grade-panel"] .gradeform')?str.get_strings([{key:'unsavedchanges',component:'mod_assign'},{key:'unsavedchangesquestion',component:'mod_assign'},{key:'saveandcontinue',component:'mod_assign'},{key:'cancel',component:'core'}]).done(function(strs){notification.confirm(strs[0],strs[1],strs[2],strs[3],function(){$(document).trigger('save-changes',userid)})}):!isNaN(userid)&&0<userid&&(select.attr('data-selected',userid),$(document).trigger('user-changed',userid)))},GradingNavigation});
//# sourceMappingURL=grading_navigation.min.js.map
