{"version":3,"sources":["../src/grading_navigation_user_info.js"],"names":["define","$","notification","ajax","templates","UserInfo","selector","_regionSelector","_region","_userCache","document","on","_refreshUserInfo","bind","prototype","_lastUserId","_getAssignmentId","attr","event","userid","promise","Deferred","render","done","html","js","fadeOut","replaceNodeContents","fadeIn","fail","exception","resolve","assignmentId","requests","call","methodname","args","assignid","embeduser","participant","hasOwnProperty","reject","context","identityfields","data","split","identity","courseid","user","each","i","k","hasidentity","push","join","profileimageurl"],"mappings":"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","file":"grading_navigation_user_info.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript controller for the \"User summary\" panel at the top of the page.\n *\n * @module     mod_assign/grading_navigation_user_info\n * @package    mod_assign\n * @class      UserInfo\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      3.1\n */\ndefine(['jquery', 'core/notification', 'core/ajax', 'core/templates'], function($, notification, ajax, templates) {\n\n    /**\n     * UserInfo class.\n     *\n     * @class UserInfo\n     * @param {String} selector The selector for the page region containing the user navigation.\n     */\n    var UserInfo = function(selector) {\n        this._regionSelector = selector;\n        this._region = $(selector);\n        this._userCache = {};\n\n        $(document).on('user-changed', this._refreshUserInfo.bind(this));\n    };\n\n    /** @type {String} Selector for the page region containing the user navigation. */\n    UserInfo.prototype._regionSelector = null;\n\n    /** @type {Array} Cache of user info contexts. */\n    UserInfo.prototype._userCache = null;\n\n    /** @type {JQuery} JQuery node for the page region containing the user navigation. */\n    UserInfo.prototype._region = null;\n\n    /** @type {Integer} Remember the last user id to prevent unnessecary reloads. */\n    UserInfo.prototype._lastUserId = 0;\n\n    /**\n     * Get the assignment id\n     *\n     * @private\n     * @method _getAssignmentId\n     * @return {Integer} assignment id\n     */\n    UserInfo.prototype._getAssignmentId = function() {\n        return this._region.attr('data-assignmentid');\n    };\n\n    /**\n     * Get the user context - re-render the template in the page.\n     *\n     * @private\n     * @method _refreshUserInfo\n     * @param {Event} event\n     * @param {Number} userid\n     */\n    UserInfo.prototype._refreshUserInfo = function(event, userid) {\n        var promise = $.Deferred();\n\n        // Skip reloading if it is the same user.\n        if (this._lastUserId == userid) {\n            return;\n        }\n        this._lastUserId = userid;\n\n        // First insert the loading template.\n        templates.render('mod_assign/loading', {}).done(function(html, js) {\n            // Update the page.\n            this._region.fadeOut(\"fast\", function() {\n                templates.replaceNodeContents(this._region, html, js);\n                this._region.fadeIn(\"fast\");\n            }.bind(this));\n\n            if (userid < 0) {\n                // Render the template.\n                templates.render('mod_assign/grading_navigation_no_users', {}).done(function(html, js) {\n                    // Update the page.\n                    this._region.fadeOut(\"fast\", function() {\n                        templates.replaceNodeContents(this._region, html, js);\n                        this._region.fadeIn(\"fast\");\n                    }.bind(this));\n                }.bind(this)).fail(notification.exception);\n                return;\n            }\n\n            if (typeof this._userCache[userid] !== \"undefined\") {\n                promise.resolve(this._userCache[userid]);\n            } else {\n                // Load context from ajax.\n                var assignmentId = this._getAssignmentId();\n                var requests = ajax.call([{\n                    methodname: 'mod_assign_get_participant',\n                    args: {\n                        userid: userid,\n                        assignid: assignmentId,\n                        embeduser: true\n                    }\n                }]);\n\n                requests[0].done(function(participant) {\n                    if (!participant.hasOwnProperty('id')) {\n                        promise.reject('No users');\n                    } else {\n                        this._userCache[userid] = participant;\n                        promise.resolve(this._userCache[userid]);\n                    }\n                }.bind(this)).fail(notification.exception);\n            }\n\n            promise.done(function(context) {\n                var identityfields = $('[data-showuseridentity]').data('showuseridentity').split(','),\n                    identity = [];\n                // Render the template.\n                context.courseid = $('[data-region=\"grading-navigation-panel\"]').attr('data-courseid');\n\n                if (context.user) {\n                    // Build a string for the visible identity fields listed in showuseridentity config setting.\n                    $.each(identityfields, function(i, k) {\n                        if (typeof context.user[k] !== 'undefined' && context.user[k] !== '') {\n                            context.hasidentity = true;\n                            identity.push(context.user[k]);\n                        }\n                    });\n                    context.identity = identity.join(', ');\n\n                    // Add profile image url to context.\n                    if (context.user.profileimageurl) {\n                        context.profileimageurl = context.user.profileimageurl;\n                    }\n                }\n\n                templates.render('mod_assign/grading_navigation_user_summary', context).done(function(html, js) {\n                    // Update the page.\n                    this._region.fadeOut(\"fast\", function() {\n                        templates.replaceNodeContents(this._region, html, js);\n                        this._region.fadeIn(\"fast\");\n                    }.bind(this));\n                }.bind(this)).fail(notification.exception);\n            }.bind(this)).fail(function() {\n                // Render the template.\n                templates.render('mod_assign/grading_navigation_no_users', {}).done(function(html, js) {\n                    // Update the page.\n                    this._region.fadeOut(\"fast\", function() {\n                        templates.replaceNodeContents(this._region, html, js);\n                        this._region.fadeIn(\"fast\");\n                    }.bind(this));\n                }.bind(this)).fail(notification.exception);\n            }\n            .bind(this));\n        }.bind(this)).fail(notification.exception);\n    };\n\n    return UserInfo;\n});\n"]}