define("qtype_ddimageortext/form",["jquery","core/dragdrop"],function(a,b){"use strict";var c=Math.round,d=Math.floor,e=Math.max,f={maxBgImageSize:null,maxDragImageSize:null,fp:null,init:function init(b,c){f.maxBgImageSize=b;f.maxDragImageSize=c;f.fp=f.filePickers();a("#id_previewareaheader").append("<div class=\"ddarea\">  <div class=\"droparea\">    <img class=\"dropbackground\" />    <div class=\"dropzones\"></div>  </div>  <div class=\"dragitems\"></div></div>");f.updateVisibilityOfFilePickers();f.setOptionsForDragItemSelectors();f.setupEventHandlers();f.waitForFilePickerToInitialise()},waitForFilePickerToInitialise:function waitForFilePickerToInitialise(){if(null===f.fp.file("bgimage").href){setTimeout(f.waitForFilePickerToInitialise,1e3);return}M.util.js_pending("dragDropToImageForm");a("form.mform").on("change",".filepickerhidden",function(){M.util.js_pending("dragDropToImageForm");f.loadPreviewImage()});f.loadPreviewImage()},loadPreviewImage:function loadPreviewImage(){a("fieldset#id_previewareaheader .dropbackground").one("load",f.afterPreviewImageLoaded).attr("src",f.fp.file("bgimage").href)},afterPreviewImageLoaded:function afterPreviewImageLoaded(){var b=a("fieldset#id_previewareaheader .dropbackground");f.constrainImageSize(b,f.maxBgImageSize);f.createDropZones();M.util.js_complete("dragDropToImageForm")},constrainImageSize:function constrainImageSize(a,b){var c=e(a.width()/b.width,a.height()/b.height);if(1<c){a.css("width",d(a.width()/c))}a.addClass("constrained")},createDropZones:function createDropZones(){var b=a(".dropzones");b.empty();var c=f.fp.file("bgimage").href;if(null===c){return}for(var d=f.form.getFormValue("nodropzone",[]),e=0,g;e<d;e++){g=f.form.getFormValue("drops",[e,"choice"]);if("0"===g){continue}g=g-1;var h=f.form.getFormValue("drags",[g,"draggroup"]),i=f.form.getFormValue("draglabel",[g]);if("image"===f.form.getFormValue("drags",[g,"dragitemtype"])){var j=f.fp.file("dragitem["+g+"]").href;if(null===j){continue}b.append("<img class=\"droppreview group"+h+" drop"+e+"\" src=\""+j+"\" alt=\""+i+"\" data-drop-no=\""+e+"\">")}else if(""!==i){b.append("<div class=\"droppreview group"+h+" drop"+e+"\"  data-drop-no=\""+e+"\">"+i+"</div>")}}f.waitForAllDropImagesToBeLoaded()},waitForAllDropImagesToBeLoaded:function waitForAllDropImagesToBeLoaded(){var b=a(".dropzones img").not(function(a,b){return f.imageIsLoaded(b)});if(0<b.length){setTimeout(function(){f.waitForAllDropImagesToBeLoaded()},100);return}f.updateDropZones()},imageIsLoaded:function imageIsLoaded(a){return a.complete&&0!==a.naturalHeight},updateDropZones:function updateDropZones(){var b=f.fp.file("bgimage").href;if(null===b){return}for(var c=a("fieldset#id_previewareaheader .dropbackground").offset(),d=f.form.getFormValue("nodropzone",[]),e=0,g;e<d;e++){g=a(".dropzones .drop"+e);if(0===g.length){continue}var h=f.form.getFormValue("drops",[e,"choice"])-1;g.offset({left:c.left+parseInt(f.form.getFormValue("drops",[e,"xleft"])),top:c.top+parseInt(f.form.getFormValue("drops",[e,"ytop"]))});var i=f.form.getFormValue("draglabel",[h]);if(g.is("img")){g.attr("alt",i)}else{g.html(i)}}a(".dropzones .droppreview").css("padding","0");for(var j=a("select.draggroup").first().find("option").length,k=1;k<=j;k++){f.resizeAllDragsAndDropsInGroup(k)}},resizeAllDragsAndDropsInGroup:function resizeAllDragsAndDropsInGroup(b){var f=a(".dropzones .droppreview.group"+b),g=0,h=0;f.each(function(a,b){var c=Math.ceil;g=e(g,c(b.offsetWidth));h=e(h,c(b.offsetHeight))});g+=10;h+=10;f.each(function(b,e){var f=c((g-e.offsetWidth)/2),i=d((h-e.offsetHeight)/2);a(e).css({"padding-left":f+"px","padding-right":g-e.offsetWidth-f+"px","padding-top":i+"px","padding-bottom":h-e.offsetHeight-i+"px"})})},setupEventHandlers:function setupEventHandlers(){a("fieldset#id_draggableitemheader").on("change input","input, select",function(b){var c=a(b.target).closest("select, input");if(c.hasClass("dragitemtype")){f.updateVisibilityOfFilePickers()}f.setOptionsForDragItemSelectors();if(c.is(".dragitemtype, .draggroup")){f.createDropZones()}else if(c.is(".draglabel")){f.updateDropZones()}});a("fieldset#id_dropzoneheader").on("change input","input, select",function(b){var c=a(b.target).closest("select, input");if(c.is("select")){f.createDropZones()}else{f.updateDropZones()}});a("fieldset#id_previewareaheader").on("mousedown touchstart",".droppreview",function(a){f.dragStart(a)});a(window).on("resize",function(){f.updateDropZones()})},updateVisibilityOfFilePickers:function updateVisibilityOfFilePickers(){for(var b=f.form.getFormValue("noitems",[]),c=0,d;c<b;c++){d=a("input#id_dragitem_"+c).closest(".fitem_ffilepicker");if("image"===f.form.getFormValue("drags",[c,"dragitemtype"])){d.show()}else{d.hide()}}},setOptionsForDragItemSelectors:function setOptionsForDragItemSelectors(){for(var b={0:""},c=f.form.getFormValue("noitems",[]),d=f.form.getFormValue("nodropzone",[]),e=0;e<c;e++){var g=f.form.getFormValue("draglabel",[e]),h=f.fp.file(f.form.toNameWithIndex("dragitem",[e]));if("image"===f.form.getFormValue("drags",[e,"dragitemtype"])&&null!==h.name){b[e+1]=e+1+". "+g+" ("+h.name+")"}else if(""!==g){b[e+1]=e+1+". "+g}}for(var i=0;i<d;i++){var j=a("#id_drops_"+i+"_choice"),k=j.val();j.find("option").remove();for(var l in b){if(!b.hasOwnProperty(l)){continue}j.append("<option value=\""+l+"\">"+b[l]+"</option>");var m=j.find("option[value=\""+l+"\"]");if(parseInt(l)===parseInt(k)){m.attr("selected",!0)}else if(f.isItemUsed(parseInt(l))){m.attr("disabled",!0)}}}},isItemUsed:function isItemUsed(b){if(0===b){return!1}if(f.form.getFormValue("drags",[b-1,"infinite"])){return!1}return 0!==a("fieldset#id_dropzoneheader select").filter(function(c,d){return parseInt(a(d).val())===b}).length},dragStart:function dragStart(c){var d=a(c.target).closest(".droppreview"),e=b.prepare(c);if(!e.start){return}b.start(c,d,function(a,b,c){f.dragMove(c)},function(){f.dragEnd()})},dragMove:function dragMove(b){var d=Math.min,g=a("fieldset#id_previewareaheader .dropbackground"),h=g.offset(),i=b.data("dropNo"),j=b.offset(),k=c(j.left-h.left),l=c(j.top-h.top);k=e(0,d(k,g.width()-b.width()-10));l=e(0,d(l,g.height()-b.height()-10));f.form.setFormValue("drops",[i,"xleft"],k);f.form.setFormValue("drops",[i,"ytop"],l)},dragEnd:function dragEnd(){f.updateDropZones()},form:{toNameWithIndex:function toNameWithIndex(a,b){for(var c=a,d=0;d<b.length;d++){c=c+"["+b[d]+"]"}return c},getEl:function getEl(b,c){var d=a("form.mform")[0];return d.elements[this.toNameWithIndex(b,c)]},getFormValue:function getFormValue(a,b){var c=this.getEl(a,b);if(!c.type){c=c[c.length-1]}if("checkbox"===c.type){return c.checked}else{return c.value}},setFormValue:function setFormValue(a,b,c){var d=this.getEl(a,b);if("checkbox"===d.type){d.checked=c}else{d.value=c}}},filePickers:function filePickers(){var b,c;if(void 0===b){b={};c={};var d=a("form.mform input.filepickerhidden");d.each(function(a,d){b[d.value]=d.name;c[d.name]=d.parentNode})}return{file:function file(b){var d=a(c[b]),e=d.find("div.filepicker-filelist a");if(e.length){return{href:e.get(0).href,name:e.get(0).innerHTML}}else{return{href:null,name:null}}},name:function name(a){return b[a]}}}};return{init:f.init}});
//# sourceMappingURL=form.min.js.map
