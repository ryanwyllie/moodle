'use strict';define('core_user/status_field',['core/templates','jquery','core/str','core/config','core/notification','core/modal_factory','core/modal_events','core/fragment','core/ajax'],function(Template,$,Str,Config,Notification,ModalFactory,ModalEvents,Fragment,Ajax){var SELECTORS={EDIT_ENROLMENT:'[data-action="editenrolment"]',SHOW_DETAILS:'[data-action="showdetails"]',UNENROL:'[data-action="unenrol"]'},StatusFieldActions=function(options){this.contextid=options.contextid,this.courseid=options.courseid,this.bindEditEnrol(),this.bindUnenrol(),this.bindStatusDetails()};return StatusFieldActions.prototype.courseid=0,StatusFieldActions.prototype.bindEditEnrol=function(){var statusFieldInstsance=this;$(SELECTORS.EDIT_ENROLMENT).click(function(e){e.preventDefault();var clickedEditTrigger=$(this),parentContainer=clickedEditTrigger.parent(),fullname=parentContainer.data('fullname'),ueid=clickedEditTrigger.attr('rel');$.when(Str.get_string('edituserenrolment','enrol',fullname)).then(function(modalTitle){return ModalFactory.create({large:!0,title:modalTitle,type:ModalFactory.types.SAVE_CANCEL})}).done(function(modal){modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault(),statusFieldInstsance.submitEditFormAjax(modal)}),modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy()}),modal.setBody(statusFieldInstsance.getBody(ueid)),modal.show()}).fail(Notification.exception)})},StatusFieldActions.prototype.bindUnenrol=function(){var statusFieldInstsance=this;$(SELECTORS.UNENROL).click(function(e){e.preventDefault();var unenrolLink=$(this),parentContainer=unenrolLink.parent(),strings=[{key:'unenrol',component:'enrol'},{key:'unenrolconfirm',component:'enrol',param:{user:parentContainer.data('fullname'),course:parentContainer.data('coursename'),enrolinstancename:parentContainer.data('enrolinstancename')}}],deleteModalPromise=ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL});$.when(Str.get_strings(strings),deleteModalPromise).done(function(results,modal){var title=results[0],confirmMessage=results[1];modal.setTitle(title),modal.setBody(confirmMessage),modal.setSaveButtonText(title),modal.getRoot().on(ModalEvents.save,function(){var unenrolParams={ueid:$(unenrolLink).attr('rel')};e.preventDefault(),statusFieldInstsance.submitUnenrolFormAjax(modal,unenrolParams)}),modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy()}),modal.show()}).fail(Notification.exception)})},StatusFieldActions.prototype.bindStatusDetails=function(){$(SELECTORS.SHOW_DETAILS).click(function(e){e.preventDefault();var detailsButton=$(this),parentContainer=detailsButton.parent(),context={fullname:parentContainer.data('fullname'),coursename:parentContainer.data('coursename'),enrolinstancename:parentContainer.data('enrolinstancename'),status:parentContainer.data('status'),statusclass:parentContainer.find('span').attr('class'),timestart:parentContainer.data('timestart'),timeend:parentContainer.data('timeend')},editEnrolLink=detailsButton.next(SELECTORS.EDIT_ENROLMENT);editEnrolLink.length&&(context.editenrollink=$('<div>').append(editEnrolLink.clone()).html());var modalStringsPromise=Str.get_strings([{key:'enroldetails',component:'enrol'}]),modalPromise=ModalFactory.create({large:!0,type:ModalFactory.types.CANCEL});$.when(modalStringsPromise,modalPromise).done(function(strings,modal){var modalBodyPromise=Template.render('core_user/status_details',context);modal.setTitle(strings[0]),modal.setBody(modalBodyPromise),editEnrolLink.length&&modal.getRoot().on('click',SELECTORS.EDIT_ENROLMENT,function(e){e.preventDefault(),modal.hide(),$(editEnrolLink).trigger('click')}),modal.show(),modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy()})}).fail(Notification.exception)})},StatusFieldActions.prototype.submitEditFormAjax=function(modal){var statusFieldInstsance=this,form=modal.getRoot().find('form'),ueid=$(form).find('[name="ue"]').val(),status=$(form).find('[name="status"]').val(),params={courseid:this.courseid,ueid:ueid,status:status},timeStartEnabled=$(form).find('[name="timestart[enabled]"]');if(timeStartEnabled.is(':checked')){var timeStartYear=$(form).find('[name="timestart[year]"]').val(),timeStartMonth=$(form).find('[name="timestart[month]"]').val()-1,timeStartDay=$(form).find('[name="timestart[day]"]').val(),timeStartHour=$(form).find('[name="timestart[hour]"]').val(),timeStartMinute=$(form).find('[name="timestart[minute]"]').val(),timeStart=new Date(timeStartYear,timeStartMonth,timeStartDay,timeStartHour,timeStartMinute);params.timestart=timeStart.getTime()/1e3}var timeEndEnabled=$(form).find('[name="timeend[enabled]"]');if(timeEndEnabled.is(':checked')){var timeEndYear=$(form).find('[name="timeend[year]"]').val(),timeEndMonth=$(form).find('[name="timeend[month]"]').val()-1,timeEndDay=$(form).find('[name="timeend[day]"]').val(),timeEndHour=$(form).find('[name="timeend[hour]"]').val(),timeEndMinute=$(form).find('[name="timeend[minute]"]').val(),timeEnd=new Date(timeEndYear,timeEndMonth,timeEndDay,timeEndHour,timeEndMinute);params.timeend=timeEnd.getTime()/1e3}Ajax.call([{methodname:'core_enrol_edit_user_enrolment',args:params}])[0].done(function(data){if(data.result)modal.hide(),'undefined'!=typeof window.M.core_formchangechecker&&window.M.core_formchangechecker.reset_form_dirty_state(),window.location.reload();else{var formData=JSON.stringify(form.serialize());modal.setBody(statusFieldInstsance.getBody(ueid,formData))}}).fail(Notification.exception)},StatusFieldActions.prototype.submitUnenrolFormAjax=function(modal,unenrolParams){Ajax.call([{methodname:'core_enrol_unenrol_user_enrolment',args:unenrolParams}])[0].done(function(data){data.result?(modal.hide(),'undefined'!=typeof window.M.core_formchangechecker&&window.M.core_formchangechecker.reset_form_dirty_state(),window.location.reload()):Notification.alert(data.errors[0].key,data.errors[0].message)}).fail(Notification.exception)},StatusFieldActions.prototype.getBody=function(ueid,formData){var params={ueid:ueid};return'undefined'!=typeof formData&&(params.formdata=formData),Fragment.loadFragment('enrol','user_enrolment_form',this.contextid,params).fail(Notification.exception)},{init:function init(config){new StatusFieldActions(config)}}});
//# sourceMappingURL=status_field.min.js.map
