'use strict';define('core_user/participants',['jquery','core/str','core/modal_factory','core/modal_events','core/templates','core/notification','core/ajax'],function($,Str,ModalFactory,ModalEvents,Templates,Notification,Ajax){var SELECTORS={BULKACTIONSELECT:'#formactionid',BULKUSERCHECKBOXES:'input.usercheckbox',BULKUSERNOSCHECKBOXES:'input.usercheckbox[value=\'0\']',BULKUSERSELECTEDCHECKBOXES:'input.usercheckbox:checked',BULKACTIONFORM:'#participantsform',CHECKALLBUTTON:'#checkall',CHECKALLNOSBUTTON:'#checkallnos',CHECKALLONPAGEBUTTON:'#checkallonpage',CHECKNONEBUTTON:'#checknone'},Participants=function(options){this.courseId=options.courseid,this.noteStateNames=options.noteStateNames,this.stateHelpIcon=options.stateHelpIcon,this.attachEventListeners()};return Participants.prototype.modal=null,Participants.prototype.courseId=-1,Participants.prototype.noteStateNames={},Participants.prototype.stateHelpIcon='',Participants.prototype.attachEventListeners=function(){$(SELECTORS.BULKACTIONSELECT).on('change',function(e){var action=$(e.target).val();if(-1!==action.indexOf('#')){e.preventDefault();var ids=[];$(SELECTORS.BULKUSERSELECTEDCHECKBOXES).each(function(index,ele){var name=$(ele).attr('name'),id=name.replace('user','');ids.push(id)}),'#messageselect'==action?this.showSendMessage(ids).fail(Notification.exception):'#addgroupnote'==action&&this.showAddNote(ids).fail(Notification.exception),$(SELECTORS.BULKACTIONSELECT+' option[value=""]').prop('selected','selected')}else''!==action&&(0<$(SELECTORS.BULKUSERSELECTEDCHECKBOXES).length?$(SELECTORS.BULKACTIONFORM).submit():$(SELECTORS.BULKACTIONSELECT+' option[value=""]').prop('selected','selected'))}.bind(this)),$(SELECTORS.CHECKALLBUTTON).on('click',function(){var showallink=$(this).data('showallink');showallink&&(window.location=showallink)}),$(SELECTORS.CHECKALLNOSBUTTON).on('click',function(){$(SELECTORS.BULKUSERNOSCHECKBOXES).prop('checked',!0)}),$(SELECTORS.CHECKALLONPAGEBUTTON).on('click',function(){$(SELECTORS.BULKUSERCHECKBOXES).prop('checked',!0)}),$(SELECTORS.CHECKNONEBUTTON).on('click',function(){$(SELECTORS.BULKUSERCHECKBOXES).prop('checked',!1)})},Participants.prototype.showAddNote=function(users){if(0==users.length)return $.Deferred().resolve().promise();var states=[];for(var key in this.noteStateNames)'draft'===key?states.push({value:'personal',label:this.noteStateNames[key]}):'public'===key?states.push({value:'course',label:this.noteStateNames[key],selected:1}):'site'===key?states.push({value:key,label:this.noteStateNames[key]}):void 0;var context={stateNames:states,stateHelpIcon:this.stateHelpIcon},titlePromise=null;return titlePromise=1==users.length?Str.get_string('addbulknotesingle','core_notes'):Str.get_string('addbulknote','core_notes',users.length),$.when(ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,body:Templates.render('core_user/add_bulk_note',context)}),titlePromise).then(function(modal,title){return this.modal=modal,this.modal.setTitle(title),this.modal.setSaveButtonText(title),this.modal.getRoot().on(ModalEvents.hidden,function(){var notification=$('#user-notifications [role=alert]');notification.length?notification.focus():$(SELECTORS.BULKACTIONSELECT).focus(),this.modal.getRoot().remove()}.bind(this)),this.modal.getRoot().on(ModalEvents.save,this.submitAddNote.bind(this,users)),this.modal.show(),this.modal}.bind(this))},Participants.prototype.submitAddNote=function(users){var noteText=this.modal.getRoot().find('form textarea').val(),publishState=this.modal.getRoot().find('form select').val(),notes=[],i=0;for(i=0;i<users.length;i++)notes.push({userid:users[i],text:noteText,courseid:this.courseId,publishstate:publishState});return Ajax.call([{methodname:'core_notes_create_notes',args:{notes:notes}}])[0].then(function(noteIds){return 1==noteIds.length?Str.get_string('addbulknotedonesingle','core_notes'):Str.get_string('addbulknotedone','core_notes',noteIds.length)}).then(function(msg){return Notification.addNotification({message:msg,type:'success'}),!0}).catch(Notification.exception)},Participants.prototype.showSendMessage=function(users){if(0==users.length)return $.Deferred().resolve().promise();var titlePromise=null;return titlePromise=1==users.length?Str.get_string('sendbulkmessagesingle','core_message'):Str.get_string('sendbulkmessage','core_message',users.length),$.when(ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,body:Templates.render('core_user/send_bulk_message',{})}),titlePromise).then(function(modal,title){return this.modal=modal,this.modal.setTitle(title),this.modal.setSaveButtonText(title),this.modal.getRoot().on(ModalEvents.hidden,function(){$(SELECTORS.BULKACTIONSELECT).focus(),this.modal.getRoot().remove()}.bind(this)),this.modal.getRoot().on(ModalEvents.save,this.submitSendMessage.bind(this,users)),this.modal.show(),this.modal}.bind(this))},Participants.prototype.submitSendMessage=function(users){var messageText=this.modal.getRoot().find('form textarea').val(),messages=[],i=0;for(i=0;i<users.length;i++)messages.push({touserid:users[i],text:messageText});return Ajax.call([{methodname:'core_message_send_instant_messages',args:{messages:messages}}])[0].then(function(messageIds){return 1==messageIds.length?Str.get_string('sendbulkmessagesentsingle','core_message'):Str.get_string('sendbulkmessagesent','core_message',messageIds.length)}).then(function(msg){return Notification.addNotification({message:msg,type:'success'}),!0}).catch(Notification.exception)},{init:function init(options){return new Participants(options)}}});
//# sourceMappingURL=participants.min.js.map
