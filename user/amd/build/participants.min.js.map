{"version":3,"sources":["../src/participants.js"],"names":["define","$","Str","ModalFactory","ModalEvents","Templates","Notification","Ajax","SELECTORS","BULKACTIONSELECT","BULKUSERCHECKBOXES","BULKUSERNOSCHECKBOXES","BULKUSERSELECTEDCHECKBOXES","BULKACTIONFORM","CHECKALLBUTTON","CHECKALLNOSBUTTON","CHECKALLONPAGEBUTTON","CHECKNONEBUTTON","Participants","options","courseId","courseid","noteStateNames","stateHelpIcon","attachEventListeners","prototype","modal","on","e","action","target","val","indexOf","preventDefault","ids","each","index","ele","name","attr","id","replace","push","showSendMessage","fail","exception","showAddNote","prop","length","submit","bind","showallink","data","window","location","users","Deferred","resolve","promise","states","key","value","label","selected","context","stateNames","titlePromise","get_string","when","create","type","types","SAVE_CANCEL","body","render","then","title","setTitle","setSaveButtonText","getRoot","hidden","notification","focus","remove","save","submitAddNote","show","noteText","find","publishState","notes","i","userid","text","publishstate","call","methodname","args","noteIds","msg","addNotification","message","catch","submitSendMessage","messageText","messages","touserid","messageIds"],"mappings":"aAwBAA,gCAAO,CAAC,QAAD,CAAW,UAAX,CAAuB,oBAAvB,CAA6C,mBAA7C,CAAkE,gBAAlE,CAAoF,mBAApF,CAAyG,WAAzG,CAAP,CACQ,SAASC,CAAT,CAAYC,GAAZ,CAAiBC,YAAjB,CAA+BC,WAA/B,CAA4CC,SAA5C,CAAuDC,YAAvD,CAAqEC,IAArE,CAA2E,IAE3EC,WAAY,CACZC,iBAAkB,eADN,CAEZC,mBAAoB,oBAFR,CAGZC,sBAAuB,iCAHX,CAIZC,2BAA4B,4BAJhB,CAKZC,eAAgB,mBALJ,CAMZC,eAAgB,WANJ,CAOZC,kBAAmB,cAPP,CAQZC,qBAAsB,iBARV,CASZC,gBAAiB,YATL,CAF+D,CAoB3EC,aAAe,SAASC,OAAT,CAAkB,CAEjC,KAAKC,QAAL,CAAgBD,QAAQE,QAFS,CAGjC,KAAKC,cAAL,CAAsBH,QAAQG,cAHG,CAIjC,KAAKC,aAAL,CAAqBJ,QAAQI,aAJI,CAMjC,KAAKC,oBAAL,EACH,CA3B8E,CA0S/E,MAxQAN,cAAaO,SAAb,CAAuBC,KAAvB,CAA+B,IAwQ/B,CAlQAR,aAAaO,SAAb,CAAuBL,QAAvB,CAAkC,CAAC,CAkQnC,CA5PAF,aAAaO,SAAb,CAAuBH,cAAvB,CAAwC,EA4PxC,CAtPAJ,aAAaO,SAAb,CAAuBF,aAAvB,CAAuC,EAsPvC,CA9OAL,aAAaO,SAAb,CAAuBD,oBAAvB,CAA8C,UAAW,CACrDvB,EAAEO,UAAUC,gBAAZ,EAA8BkB,EAA9B,CAAiC,QAAjC,CAA2C,SAASC,CAAT,CAAY,CACnD,GAAIC,QAAS5B,EAAE2B,EAAEE,MAAJ,EAAYC,GAAZ,EAAb,CACA,GAA4B,CAAC,CAAzB,UAAOC,OAAP,CAAe,GAAf,CAAJ,CAAgC,CAC5BJ,EAAEK,cAAF,EAD4B,CAG5B,GAAIC,KAAM,EAAV,CACAjC,EAAEO,UAAUI,0BAAZ,EAAwCuB,IAAxC,CAA6C,SAASC,KAAT,CAAgBC,GAAhB,CAAqB,IAC1DC,MAAOrC,EAAEoC,GAAF,EAAOE,IAAP,CAAY,MAAZ,CADmD,CAE1DC,GAAKF,KAAKG,OAAL,CAAa,MAAb,CAAqB,EAArB,CAFqD,CAG9DP,IAAIQ,IAAJ,CAASF,EAAT,CACH,CAJD,CAJ4B,CAUd,gBAAV,QAVwB,CAWxB,KAAKG,eAAL,CAAqBT,GAArB,EAA0BU,IAA1B,CAA+BtC,aAAauC,SAA5C,CAXwB,CAYP,eAAV,QAZiB,EAaxB,KAAKC,WAAL,CAAiBZ,GAAjB,EAAsBU,IAAtB,CAA2BtC,aAAauC,SAAxC,CAbwB,CAe5B5C,EAAEO,UAAUC,gBAAV,CAA6B,mBAA/B,EAAoDsC,IAApD,CAAyD,UAAzD,CAAqE,UAArE,CACH,CAhBD,IAgBsB,EAAX,SAhBX,GAiByD,CAAjD,GAAEvC,UAAUI,0BAAZ,EAAwCoC,MAjBhD,CAkBQ/C,EAAEO,UAAUK,cAAZ,EAA4BoC,MAA5B,EAlBR,CAoBQhD,EAAEO,UAAUC,gBAAV,CAA6B,mBAA/B,EAAoDsC,IAApD,CAAyD,UAAzD,CAAqE,UAArE,CApBR,CAuBH,CAzB0C,CAyBzCG,IAzByC,CAyBpC,IAzBoC,CAA3C,CADqD,CA4BrDjD,EAAEO,UAAUM,cAAZ,EAA4Ba,EAA5B,CAA+B,OAA/B,CAAwC,UAAW,CAC/C,GAAIwB,YAAalD,EAAE,IAAF,EAAQmD,IAAR,CAAa,YAAb,CAAjB,CACID,UAF2C,GAG3CE,OAAOC,QAAP,CAAkBH,UAHyB,CAKlD,CALD,CA5BqD,CAmCrDlD,EAAEO,UAAUO,iBAAZ,EAA+BY,EAA/B,CAAkC,OAAlC,CAA2C,UAAW,CAClD1B,EAAEO,UAAUG,qBAAZ,EAAmCoC,IAAnC,CAAwC,SAAxC,IACH,CAFD,CAnCqD,CAsCrD9C,EAAEO,UAAUQ,oBAAZ,EAAkCW,EAAlC,CAAqC,OAArC,CAA8C,UAAW,CACrD1B,EAAEO,UAAUE,kBAAZ,EAAgCqC,IAAhC,CAAqC,SAArC,IACH,CAFD,CAtCqD,CA0CrD9C,EAAEO,UAAUS,eAAZ,EAA6BU,EAA7B,CAAgC,OAAhC,CAAyC,UAAW,CAChD1B,EAAEO,UAAUE,kBAAZ,EAAgCqC,IAAhC,CAAqC,SAArC,IACH,CAFD,CAGH,CAiMD,CAvLA7B,aAAaO,SAAb,CAAuBqB,WAAvB,CAAqC,SAASS,KAAT,CAAgB,CAEjD,GAAoB,CAAhB,QAAMP,MAAV,CAEI,MAAO/C,GAAEuD,QAAF,GAAaC,OAAb,GAAuBC,OAAvB,EAAP,CAGJ,GAAIC,QAAS,EAAb,CACA,IAAK,GAAIC,IAAT,GAAgB,MAAKtC,cAArB,CAEa,OAFb,GACYsC,GADZ,CAGYD,OAAOjB,IAAP,CAAY,CAACmB,MAAO,UAAR,CAAoBC,MAAO,KAAKxC,cAAL,CAAoBsC,GAApB,CAA3B,CAAZ,CAHZ,CAKa,QALb,GACYA,GADZ,CAMYD,OAAOjB,IAAP,CAAY,CAACmB,MAAO,QAAR,CAAkBC,MAAO,KAAKxC,cAAL,CAAoBsC,GAApB,CAAzB,CAAmDG,SAAU,CAA7D,CAAZ,CANZ,CAQa,MARb,GACYH,GADZ,CASYD,OAAOjB,IAAP,CAAY,CAACmB,MAAOD,GAAR,CAAaE,MAAO,KAAKxC,cAAL,CAAoBsC,GAApB,CAApB,CAAZ,CATZ,QARiD,GAsB7CI,SAAU,CAACC,WAAYN,MAAb,CAAqBpC,cAAe,KAAKA,aAAzC,CAtBmC,CAuB7C2C,aAAe,IAvB8B,CA8BjD,MALIA,aAKJ,CANoB,CAAhB,QAAMlB,MAMV,CALmB9C,IAAIiE,UAAJ,CAAe,mBAAf,CAAoC,YAApC,CAKnB,CAHmBjE,IAAIiE,UAAJ,CAAe,aAAf,CAA8B,YAA9B,CAA4CZ,MAAMP,MAAlD,CAGnB,CAAO/C,EAAEmE,IAAF,CACHjE,aAAakE,MAAb,CAAoB,CAChBC,KAAMnE,aAAaoE,KAAb,CAAmBC,WADT,CAEhBC,KAAMpE,UAAUqE,MAAV,CAAiB,yBAAjB,CAA4CV,OAA5C,CAFU,CAApB,CADG,CAKHE,YALG,EAMLS,IANK,CAMA,SAASjD,KAAT,CAAgBkD,KAAhB,CAAuB,CAqB1B,MAnBA,MAAKlD,KAAL,CAAaA,KAmBb,CAlBA,KAAKA,KAAL,CAAWmD,QAAX,CAAoBD,KAApB,CAkBA,CAjBA,KAAKlD,KAAL,CAAWoD,iBAAX,CAA6BF,KAA7B,CAiBA,CAdA,KAAKlD,KAAL,CAAWqD,OAAX,GAAqBpD,EAArB,CAAwBvB,YAAY4E,MAApC,CAA4C,UAAW,CACnD,GAAIC,cAAehF,EAAE,kCAAF,CAAnB,CACIgF,aAAajC,MAFkC,CAG/CiC,aAAaC,KAAb,EAH+C,CAK/CjF,EAAEO,UAAUC,gBAAZ,EAA8ByE,KAA9B,EAL+C,CAOnD,KAAKxD,KAAL,CAAWqD,OAAX,GAAqBI,MAArB,EACH,CAR2C,CAQ1CjC,IAR0C,CAQrC,IARqC,CAA5C,CAcA,CAJA,KAAKxB,KAAL,CAAWqD,OAAX,GAAqBpD,EAArB,CAAwBvB,YAAYgF,IAApC,CAA0C,KAAKC,aAAL,CAAmBnC,IAAnB,CAAwB,IAAxB,CAA8BK,KAA9B,CAA1C,CAIA,CAFA,KAAK7B,KAAL,CAAW4D,IAAX,EAEA,CAAO,KAAK5D,KACf,CAtBM,CAsBLwB,IAtBK,CAsBA,IAtBA,CANA,CA6BV,CA4HD,CAlHAhC,aAAaO,SAAb,CAAuB4D,aAAvB,CAAuC,SAAS9B,KAAT,CAAgB,IAC/CgC,UAAW,KAAK7D,KAAL,CAAWqD,OAAX,GAAqBS,IAArB,CAA0B,eAA1B,EAA2CzD,GAA3C,EADoC,CAE/C0D,aAAe,KAAK/D,KAAL,CAAWqD,OAAX,GAAqBS,IAArB,CAA0B,aAA1B,EAAyCzD,GAAzC,EAFgC,CAG/C2D,MAAQ,EAHuC,CAI/CC,EAAI,CAJ2C,CAMnD,IAAKA,EAAI,CAAT,CAAYA,EAAIpC,MAAMP,MAAtB,CAA8B2C,GAA9B,CACID,MAAMhD,IAAN,CAAW,CAACkD,OAAQrC,MAAMoC,CAAN,CAAT,CAAmBE,KAAMN,QAAzB,CAAmClE,SAAU,KAAKD,QAAlD,CAA4D0E,aAAcL,YAA1E,CAAX,EAGJ,MAAOlF,MAAKwF,IAAL,CAAU,CAAC,CACdC,WAAY,yBADE,CAEdC,KAAM,CAACP,MAAOA,KAAR,CAFQ,CAAD,CAAV,EAGH,CAHG,EAGAf,IAHA,CAGK,SAASuB,OAAT,CAAkB,OACJ,EAAlB,UAAQlD,MADc,CAEf9C,IAAIiE,UAAJ,CAAe,uBAAf,CAAwC,YAAxC,CAFe,CAIfjE,IAAIiE,UAAJ,CAAe,iBAAf,CAAkC,YAAlC,CAAgD+B,QAAQlD,MAAxD,CAEd,CATM,EASJ2B,IATI,CASC,SAASwB,GAAT,CAAc,CAKlB,MAJA7F,cAAa8F,eAAb,CAA6B,CACzBC,QAASF,GADgB,CAEzB7B,KAAM,SAFmB,CAA7B,CAIA,GACH,CAfM,EAeJgC,KAfI,CAeEhG,aAAauC,SAff,CAgBV,CAwFD,CA9EA3B,aAAaO,SAAb,CAAuBkB,eAAvB,CAAyC,SAASY,KAAT,CAAgB,CAErD,GAAoB,CAAhB,QAAMP,MAAV,CAEI,MAAO/C,GAAEuD,QAAF,GAAaC,OAAb,GAAuBC,OAAvB,EAAP,CAEJ,GAAIQ,cAAe,IAAnB,CAOA,MALIA,aAKJ,CANoB,CAAhB,QAAMlB,MAMV,CALmB9C,IAAIiE,UAAJ,CAAe,uBAAf,CAAwC,cAAxC,CAKnB,CAHmBjE,IAAIiE,UAAJ,CAAe,iBAAf,CAAkC,cAAlC,CAAkDZ,MAAMP,MAAxD,CAGnB,CAAO/C,EAAEmE,IAAF,CACHjE,aAAakE,MAAb,CAAoB,CAChBC,KAAMnE,aAAaoE,KAAb,CAAmBC,WADT,CAEhBC,KAAMpE,UAAUqE,MAAV,CAAiB,6BAAjB,CAAgD,EAAhD,CAFU,CAApB,CADG,CAKHR,YALG,EAMLS,IANK,CAMA,SAASjD,KAAT,CAAgBkD,KAAhB,CAAuB,CAiB1B,MAfA,MAAKlD,KAAL,CAAaA,KAeb,CAbA,KAAKA,KAAL,CAAWmD,QAAX,CAAoBD,KAApB,CAaA,CAZA,KAAKlD,KAAL,CAAWoD,iBAAX,CAA6BF,KAA7B,CAYA,CATA,KAAKlD,KAAL,CAAWqD,OAAX,GAAqBpD,EAArB,CAAwBvB,YAAY4E,MAApC,CAA4C,UAAW,CACnD/E,EAAEO,UAAUC,gBAAZ,EAA8ByE,KAA9B,EADmD,CAEnD,KAAKxD,KAAL,CAAWqD,OAAX,GAAqBI,MAArB,EACH,CAH2C,CAG1CjC,IAH0C,CAGrC,IAHqC,CAA5C,CASA,CAJA,KAAKxB,KAAL,CAAWqD,OAAX,GAAqBpD,EAArB,CAAwBvB,YAAYgF,IAApC,CAA0C,KAAKmB,iBAAL,CAAuBrD,IAAvB,CAA4B,IAA5B,CAAkCK,KAAlC,CAA1C,CAIA,CAFA,KAAK7B,KAAL,CAAW4D,IAAX,EAEA,CAAO,KAAK5D,KACf,CAlBM,CAkBLwB,IAlBK,CAkBA,IAlBA,CANA,CAyBV,CAwCD,CA7BAhC,aAAaO,SAAb,CAAuB8E,iBAAvB,CAA2C,SAAShD,KAAT,CAAgB,IAEnDiD,aAAc,KAAK9E,KAAL,CAAWqD,OAAX,GAAqBS,IAArB,CAA0B,eAA1B,EAA2CzD,GAA3C,EAFqC,CAInD0E,SAAW,EAJwC,CAKnDd,EAAI,CAL+C,CAOvD,IAAKA,EAAI,CAAT,CAAYA,EAAIpC,MAAMP,MAAtB,CAA8B2C,GAA9B,CACIc,SAAS/D,IAAT,CAAc,CAACgE,SAAUnD,MAAMoC,CAAN,CAAX,CAAqBE,KAAMW,WAA3B,CAAd,EAGJ,MAAOjG,MAAKwF,IAAL,CAAU,CAAC,CACdC,WAAY,oCADE,CAEdC,KAAM,CAACQ,SAAUA,QAAX,CAFQ,CAAD,CAAV,EAGH,CAHG,EAGA9B,IAHA,CAGK,SAASgC,UAAT,CAAqB,OACJ,EAArB,aAAW3D,MADc,CAElB9C,IAAIiE,UAAJ,CAAe,2BAAf,CAA4C,cAA5C,CAFkB,CAIlBjE,IAAIiE,UAAJ,CAAe,qBAAf,CAAsC,cAAtC,CAAsDwC,WAAW3D,MAAjE,CAEd,CATM,EASJ2B,IATI,CASC,SAASwB,GAAT,CAAc,CAKlB,MAJA7F,cAAa8F,eAAb,CAA6B,CACzBC,QAASF,GADgB,CAEzB7B,KAAM,SAFmB,CAA7B,CAIA,GACH,CAfM,EAeJgC,KAfI,CAeEhG,aAAauC,SAff,CAgBV,CAED,CAAmD,CAU/C,KAAQ,cAAS1B,OAAT,CAAkB,CACtB,MAAO,IAAID,aAAJ,CAAiBC,OAAjB,CACV,CAZ8C,CActD,CAzTD,C","file":"participants.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Some UI stuff for participants page.\n * This is also used by the report/participants/index.php because it has the same functionality.\n *\n * @module     core_user/participants\n * @package    core_user\n * @copyright  2017 Damyon Wiese\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['jquery', 'core/str', 'core/modal_factory', 'core/modal_events', 'core/templates', 'core/notification', 'core/ajax'],\n        function($, Str, ModalFactory, ModalEvents, Templates, Notification, Ajax) {\n\n    var SELECTORS = {\n        BULKACTIONSELECT: \"#formactionid\",\n        BULKUSERCHECKBOXES: \"input.usercheckbox\",\n        BULKUSERNOSCHECKBOXES: \"input.usercheckbox[value='0']\",\n        BULKUSERSELECTEDCHECKBOXES: \"input.usercheckbox:checked\",\n        BULKACTIONFORM: \"#participantsform\",\n        CHECKALLBUTTON: \"#checkall\",\n        CHECKALLNOSBUTTON: \"#checkallnos\",\n        CHECKALLONPAGEBUTTON: \"#checkallonpage\",\n        CHECKNONEBUTTON: \"#checknone\"\n    };\n\n    /**\n     * Constructor\n     *\n     * @param {Object} options Object containing options. Contextid is required.\n     * Each call to templates.render gets it's own instance of this class.\n     */\n    var Participants = function(options) {\n\n        this.courseId = options.courseid;\n        this.noteStateNames = options.noteStateNames;\n        this.stateHelpIcon = options.stateHelpIcon;\n\n        this.attachEventListeners();\n    };\n    // Class variables and functions.\n\n    /**\n     * @var {Modal} modal\n     * @private\n     */\n    Participants.prototype.modal = null;\n\n    /**\n     * @var {int} courseId\n     * @private\n     */\n    Participants.prototype.courseId = -1;\n\n    /**\n     * @var {Object} noteStateNames\n     * @private\n     */\n    Participants.prototype.noteStateNames = {};\n\n    /**\n     * @var {String} stateHelpIcon\n     * @private\n     */\n    Participants.prototype.stateHelpIcon = \"\";\n\n    /**\n     * Private method\n     *\n     * @method attachEventListeners\n     * @private\n     */\n    Participants.prototype.attachEventListeners = function() {\n        $(SELECTORS.BULKACTIONSELECT).on('change', function(e) {\n            var action = $(e.target).val();\n            if (action.indexOf('#') !== -1) {\n                e.preventDefault();\n\n                var ids = [];\n                $(SELECTORS.BULKUSERSELECTEDCHECKBOXES).each(function(index, ele) {\n                    var name = $(ele).attr('name');\n                    var id = name.replace('user', '');\n                    ids.push(id);\n                });\n\n                if (action == '#messageselect') {\n                    this.showSendMessage(ids).fail(Notification.exception);\n                } else if (action == '#addgroupnote') {\n                    this.showAddNote(ids).fail(Notification.exception);\n                }\n                $(SELECTORS.BULKACTIONSELECT + ' option[value=\"\"]').prop('selected', 'selected');\n            } else if (action !== '') {\n                if ($(SELECTORS.BULKUSERSELECTEDCHECKBOXES).length > 0) {\n                    $(SELECTORS.BULKACTIONFORM).submit();\n                } else {\n                    $(SELECTORS.BULKACTIONSELECT + ' option[value=\"\"]').prop('selected', 'selected');\n                }\n            }\n        }.bind(this));\n\n        $(SELECTORS.CHECKALLBUTTON).on('click', function() {\n            var showallink = $(this).data('showallink');\n            if (showallink) {\n                window.location = showallink;\n            }\n        });\n\n        $(SELECTORS.CHECKALLNOSBUTTON).on('click', function() {\n            $(SELECTORS.BULKUSERNOSCHECKBOXES).prop('checked', true);\n        });\n        $(SELECTORS.CHECKALLONPAGEBUTTON).on('click', function() {\n            $(SELECTORS.BULKUSERCHECKBOXES).prop('checked', true);\n        });\n\n        $(SELECTORS.CHECKNONEBUTTON).on('click', function() {\n            $(SELECTORS.BULKUSERCHECKBOXES).prop('checked', false);\n        });\n    };\n\n    /**\n     * Show the add note popup\n     *\n     * @method showAddNote\n     * @private\n     * @param {int[]} users\n     * @return {Promise}\n     */\n    Participants.prototype.showAddNote = function(users) {\n\n        if (users.length == 0) {\n            // Nothing to do.\n            return $.Deferred().resolve().promise();\n        }\n\n        var states = [];\n        for (var key in this.noteStateNames) {\n            switch (key) {\n                case 'draft':\n                    states.push({value: 'personal', label: this.noteStateNames[key]});\n                    break;\n                case 'public':\n                    states.push({value: 'course', label: this.noteStateNames[key], selected: 1});\n                    break;\n                case 'site':\n                    states.push({value: key, label: this.noteStateNames[key]});\n                    break;\n            }\n        }\n\n        var context = {stateNames: states, stateHelpIcon: this.stateHelpIcon};\n        var titlePromise = null;\n        if (users.length == 1) {\n            titlePromise = Str.get_string('addbulknotesingle', 'core_notes');\n        } else {\n            titlePromise = Str.get_string('addbulknote', 'core_notes', users.length);\n        }\n\n        return $.when(\n            ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                body: Templates.render('core_user/add_bulk_note', context)\n            }),\n            titlePromise\n        ).then(function(modal, title) {\n            // Keep a reference to the modal.\n            this.modal = modal;\n            this.modal.setTitle(title);\n            this.modal.setSaveButtonText(title);\n\n            // We want to focus on the action select when the dialog is closed.\n            this.modal.getRoot().on(ModalEvents.hidden, function() {\n                var notification = $('#user-notifications [role=alert]');\n                if (notification.length) {\n                    notification.focus();\n                } else {\n                    $(SELECTORS.BULKACTIONSELECT).focus();\n                }\n                this.modal.getRoot().remove();\n            }.bind(this));\n\n            this.modal.getRoot().on(ModalEvents.save, this.submitAddNote.bind(this, users));\n\n            this.modal.show();\n\n            return this.modal;\n        }.bind(this));\n    };\n\n    /**\n     * Add a note to this list of users.\n     *\n     * @method submitAddNote\n     * @private\n     * @param {int[]} users\n     * @return {Promise}\n     */\n    Participants.prototype.submitAddNote = function(users) {\n        var noteText = this.modal.getRoot().find('form textarea').val();\n        var publishState = this.modal.getRoot().find('form select').val();\n        var notes = [],\n            i = 0;\n\n        for (i = 0; i < users.length; i++) {\n            notes.push({userid: users[i], text: noteText, courseid: this.courseId, publishstate: publishState});\n        }\n\n        return Ajax.call([{\n            methodname: 'core_notes_create_notes',\n            args: {notes: notes}\n        }])[0].then(function(noteIds) {\n            if (noteIds.length == 1) {\n                return Str.get_string('addbulknotedonesingle', 'core_notes');\n            } else {\n                return Str.get_string('addbulknotedone', 'core_notes', noteIds.length);\n            }\n        }).then(function(msg) {\n            Notification.addNotification({\n                message: msg,\n                type: \"success\"\n            });\n            return true;\n        }).catch(Notification.exception);\n    };\n\n    /**\n     * Show the send message popup.\n     *\n     * @method showSendMessage\n     * @private\n     * @param {int[]} users\n     * @return {Promise}\n     */\n    Participants.prototype.showSendMessage = function(users) {\n\n        if (users.length == 0) {\n            // Nothing to do.\n            return $.Deferred().resolve().promise();\n        }\n        var titlePromise = null;\n        if (users.length == 1) {\n            titlePromise = Str.get_string('sendbulkmessagesingle', 'core_message');\n        } else {\n            titlePromise = Str.get_string('sendbulkmessage', 'core_message', users.length);\n        }\n\n        return $.when(\n            ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                body: Templates.render('core_user/send_bulk_message', {})\n            }),\n            titlePromise\n        ).then(function(modal, title) {\n            // Keep a reference to the modal.\n            this.modal = modal;\n\n            this.modal.setTitle(title);\n            this.modal.setSaveButtonText(title);\n\n            // We want to focus on the action select when the dialog is closed.\n            this.modal.getRoot().on(ModalEvents.hidden, function() {\n                $(SELECTORS.BULKACTIONSELECT).focus();\n                this.modal.getRoot().remove();\n            }.bind(this));\n\n            this.modal.getRoot().on(ModalEvents.save, this.submitSendMessage.bind(this, users));\n\n            this.modal.show();\n\n            return this.modal;\n        }.bind(this));\n    };\n\n    /**\n     * Send a message to these users.\n     *\n     * @method submitSendMessage\n     * @private\n     * @param {int[]} users\n     * @param {Event} e Form submission event.\n     * @return {Promise}\n     */\n    Participants.prototype.submitSendMessage = function(users) {\n\n        var messageText = this.modal.getRoot().find('form textarea').val();\n\n        var messages = [],\n            i = 0;\n\n        for (i = 0; i < users.length; i++) {\n            messages.push({touserid: users[i], text: messageText});\n        }\n\n        return Ajax.call([{\n            methodname: 'core_message_send_instant_messages',\n            args: {messages: messages}\n        }])[0].then(function(messageIds) {\n            if (messageIds.length == 1) {\n                return Str.get_string('sendbulkmessagesentsingle', 'core_message');\n            } else {\n                return Str.get_string('sendbulkmessagesent', 'core_message', messageIds.length);\n            }\n        }).then(function(msg) {\n            Notification.addNotification({\n                message: msg,\n                type: \"success\"\n            });\n            return true;\n        }).catch(Notification.exception);\n    };\n\n    return /** @alias module:core_user/participants */ {\n        // Public variables and functions.\n\n        /**\n         * Initialise the unified user filter.\n         *\n         * @method init\n         * @param {Object} options - List of options.\n         * @return {Participants}\n         */\n        'init': function(options) {\n            return new Participants(options);\n        }\n    };\n});\n"]}