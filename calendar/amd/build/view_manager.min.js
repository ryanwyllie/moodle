'use strict';define('core_calendar/view_manager',['jquery','core/templates','core/str','core/notification','core_calendar/repository','core_calendar/events','core_calendar/selectors','core/modal_factory','core/modal_events','core_calendar/summary_modal'],function($,Templates,Str,Notification,CalendarRepository,CalendarEvents,CalendarSelectors,ModalFactory,ModalEvents,SummaryModal){var registerEventListeners=function(root){root=$(root),root.on('click',CalendarSelectors.links.eventLink,function(e){var eventLink,target=$(e.target),eventId=null;eventLink=target.is(CalendarSelectors.actions.viewEvent)?target:target.closest(CalendarSelectors.actions.viewEvent),eventId=eventLink.length?eventLink.data('eventId'):target.find(CalendarSelectors.actions.viewEvent).data('eventId'),eventId&&(e.preventDefault(),e.stopPropagation(),renderEventSummaryModal(eventId))}),root.on('click',CalendarSelectors.links.navLink,function(e){var wrapper=root.find(CalendarSelectors.wrapper),view=wrapper.data('view'),courseId=wrapper.data('courseid'),categoryId=wrapper.data('categoryid'),link=$(e.currentTarget);'month'===view?(changeMonth(root,link.attr('href'),link.data('year'),link.data('month'),courseId,categoryId),e.preventDefault()):'day'===view&&(changeDay(root,link.attr('href'),link.data('year'),link.data('month'),link.data('day'),courseId,categoryId),e.preventDefault())})},refreshMonthContent=function(root,year,month,courseid,categoryid,target){startLoading(root),target=target||root.find(CalendarSelectors.wrapper),M.util.js_pending([root.get('id'),year,month,courseid].join('-'));var includenavigation=root.data('includenavigation'),mini=root.data('mini');return CalendarRepository.getCalendarMonthData(year,month,courseid,categoryid,includenavigation,mini).then(function(context){return Templates.render(root.attr('data-template'),context)}).then(function(html,js){return Templates.replaceNode(target,html,js)}).then(function(){$('body').trigger(CalendarEvents.viewUpdated)}).always(function(){return M.util.js_complete([root.get('id'),year,month,courseid].join('-')),stopLoading(root)}).fail(Notification.exception)},changeMonth=function(root,url,year,month,courseid,categoryid){return refreshMonthContent(root,year,month,courseid,categoryid).then(function(){return url.length&&'#'!==url&&window.history.pushState({},'',url),arguments}).then(function(){return $('body').trigger(CalendarEvents.monthChanged,[year,month,courseid,categoryid]),arguments})},refreshDayContent=function(root,year,month,day,courseid,categoryId,target){startLoading(root),target=target||root.find(CalendarSelectors.wrapper),M.util.js_pending([root.get('id'),year,month,day,courseid,categoryId].join('-'));var includenavigation=root.data('includenavigation');return CalendarRepository.getCalendarDayData(year,month,day,courseid,categoryId,includenavigation).then(function(context){return Templates.render(root.attr('data-template'),context)}).then(function(html,js){return Templates.replaceNode(target,html,js)}).then(function(){$('body').trigger(CalendarEvents.viewUpdated)}).always(function(){return M.util.js_complete([root.get('id'),year,month,day,courseid,categoryId].join('-')),stopLoading(root)}).fail(Notification.exception)},changeDay=function(root,url,year,month,day,courseId,categoryId){return refreshDayContent(root,year,month,day,courseId,categoryId).then(function(){return url.length&&'#'!==url&&window.history.pushState({},'',url),arguments}).then(function(){return $('body').trigger(CalendarEvents.dayChanged,[year,month,day,courseId,categoryId]),arguments})},startLoading=function(root){var loadingIconContainer=root.find(CalendarSelectors.containers.loadingIcon);loadingIconContainer.removeClass('hidden')},stopLoading=function(root){var loadingIconContainer=root.find(CalendarSelectors.containers.loadingIcon);loadingIconContainer.addClass('hidden')},normaliseEventType=function(eventType){return'user'===eventType?'user':'site'===eventType?'site':'group'===eventType?'group':'category'===eventType?'category':'course'},getEventTypeClassFromType=function(eventType){return'calendar_event_'+normaliseEventType(eventType)},renderEventSummaryModal=function(eventId){var typeClass='';CalendarRepository.getEventById(eventId).then(function(getEventResponse){if(!getEventResponse.event)throw new Error('Error encountered while trying to fetch calendar event with ID: '+eventId);var eventData=getEventResponse.event;return typeClass=getEventTypeClassFromType(eventData.eventtype),getEventType(eventData.eventtype).then(function(eventType){return eventData.eventtype=eventType,eventData})}).then(function(eventData){var modalParams={title:eventData.name,type:SummaryModal.TYPE,body:Templates.render('core_calendar/event_summary_body',eventData),templateContext:{canedit:eventData.canedit,candelete:eventData.candelete,headerclasses:typeClass,isactionevent:eventData.isactionevent,url:eventData.url}};return ModalFactory.create(modalParams)}).done(function(modal){modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy()}),modal.show()}).fail(Notification.exception)},getEventType=function(eventType){var lang='type'+normaliseEventType(eventType);return Str.get_string(lang,'core_calendar').then(function(langStr){return langStr})};return{init:function init(root){registerEventListeners(root)},reloadCurrentMonth:function reloadCurrentMonth(root,courseId,categoryId){var year=root.find(CalendarSelectors.wrapper).data('year'),month=root.find(CalendarSelectors.wrapper).data('month');return'undefined'==typeof courseId&&(courseId=root.find(CalendarSelectors.wrapper).data('courseid')),'undefined'==typeof categoryId&&(categoryId=root.find(CalendarSelectors.wrapper).data('categoryid')),refreshMonthContent(root,year,month,courseId,categoryId)},changeMonth:changeMonth,refreshMonthContent:refreshMonthContent,reloadCurrentDay:function reloadCurrentDay(root,courseId,categoryId){var wrapper=root.find(CalendarSelectors.wrapper),year=wrapper.data('year'),month=wrapper.data('month'),day=wrapper.data('day');return courseId||(courseId=root.find(CalendarSelectors.wrapper).data('courseid')),'undefined'==typeof categoryId&&(categoryId=root.find(CalendarSelectors.wrapper).data('categoryid')),refreshDayContent(root,year,month,day,courseId,categoryId)},changeDay:changeDay,refreshDayContent:refreshDayContent,reloadCurrentUpcoming:function reloadCurrentUpcoming(root,courseId,categoryId){startLoading(root);var target=root.find(CalendarSelectors.wrapper);return'undefined'==typeof courseId&&(courseId=root.find(CalendarSelectors.wrapper).data('courseid')),'undefined'==typeof categoryId&&(categoryId=root.find(CalendarSelectors.wrapper).data('categoryid')),CalendarRepository.getCalendarUpcomingData(courseId,categoryId).then(function(context){return Templates.render(root.attr('data-template'),context)}).then(function(html,js){return Templates.replaceNode(target,html,js)}).then(function(){$('body').trigger(CalendarEvents.viewUpdated)}).always(function(){return stopLoading(root)}).fail(Notification.exception)}}});
//# sourceMappingURL=view_manager.min.js.map
