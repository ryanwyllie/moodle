{"version":3,"sources":["../src/calendar.js"],"names":["define","$","Ajax","Str","Templates","Notification","CustomEvents","ModalEvents","ModalFactory","ModalEventForm","SummaryModal","CalendarRepository","CalendarEvents","CalendarViewManager","CalendarCrud","CalendarSelectors","SELECTORS","ROOT","DAY","NEW_EVENT_BUTTON","DAY_CONTENT","LOADING_ICON","VIEW_DAY_LINK","CALENDAR_MONTH_WRAPPER","TODAY","handleMoveEvent","e","eventId","originElement","destinationElement","originTimestamp","destinationTimestamp","attr","render","then","html","js","find","addClass","appendNodeContents","updateEventStartDay","trigger","eventMoved","always","destinationLoadingElement","removeClass","replaceNode","originLoadingElement","fail","exception","registerCalendarEventListeners","root","eventFormModalPromise","body","on","created","reloadCurrentMonth","deleted","updated","editActionEvent","url","window","location","assign","moveEvent","registerEditListeners","registerEventListeners","elements","courseSelector","selectElement","courseId","val","eventFormPromise","registerEventFormModal","contextId","data","target","is","startTime","modal","wrapper","closest","setCourseId","categoryId","setCategoryId","setContextId","setStartTime","show","preventDefault","init"],"mappings":"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","file":"calendar.min.js","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * This module is the highest level module for the calendar. It is\n * responsible for initialising all of the components required for\n * the calendar to run. It also coordinates the interaction between\n * components by listening for and responding to different events\n * triggered within the calendar UI.\n *\n * @module     core_calendar/calendar\n * @package    core_calendar\n * @copyright  2017 Simey Lameze <simey@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\n            'jquery',\n            'core/ajax',\n            'core/str',\n            'core/templates',\n            'core/notification',\n            'core/custom_interaction_events',\n            'core/modal_events',\n            'core/modal_factory',\n            'core_calendar/modal_event_form',\n            'core_calendar/summary_modal',\n            'core_calendar/repository',\n            'core_calendar/events',\n            'core_calendar/view_manager',\n            'core_calendar/crud',\n            'core_calendar/selectors',\n        ],\n        function(\n            $,\n            Ajax,\n            Str,\n            Templates,\n            Notification,\n            CustomEvents,\n            ModalEvents,\n            ModalFactory,\n            ModalEventForm,\n            SummaryModal,\n            CalendarRepository,\n            CalendarEvents,\n            CalendarViewManager,\n            CalendarCrud,\n            CalendarSelectors\n        ) {\n\n    var SELECTORS = {\n        ROOT: \"[data-region='calendar']\",\n        DAY: \"[data-region='day']\",\n        NEW_EVENT_BUTTON: \"[data-action='new-event-button']\",\n        DAY_CONTENT: \"[data-region='day-content']\",\n        LOADING_ICON: '.loading-icon',\n        VIEW_DAY_LINK: \"[data-action='view-day-link']\",\n        CALENDAR_MONTH_WRAPPER: \".calendarwrapper\",\n        TODAY: '.today',\n    };\n\n    /**\n     * Handler for the drag and drop move event. Provides a loading indicator\n     * while the request is sent to the server to update the event start date.\n     *\n     * Triggers a eventMoved calendar javascript event if the event was successfully\n     * updated.\n     *\n     * @param {event} e The calendar move event\n     * @param {int} eventId The event id being moved\n     * @param {object|null} originElement The jQuery element for where the event is moving from\n     * @param {object} destinationElement The jQuery element for where the event is moving to\n     */\n    var handleMoveEvent = function(e, eventId, originElement, destinationElement) {\n        var originTimestamp = null;\n        var destinationTimestamp = destinationElement.attr('data-day-timestamp');\n\n        if (originElement) {\n            originTimestamp = originElement.attr('data-day-timestamp');\n        }\n\n        // If the event has actually changed day.\n        if (!originElement || originTimestamp != destinationTimestamp) {\n            Templates.render('core/loading', {})\n                .then(function(html, js) {\n                    // First we show some loading icons in each of the days being affected.\n                    destinationElement.find(SELECTORS.DAY_CONTENT).addClass('hidden');\n                    Templates.appendNodeContents(destinationElement, html, js);\n\n                    if (originElement) {\n                        originElement.find(SELECTORS.DAY_CONTENT).addClass('hidden');\n                        Templates.appendNodeContents(originElement, html, js);\n                    }\n                    return;\n                })\n                .then(function() {\n                    // Send a request to the server to make the change.\n                    return CalendarRepository.updateEventStartDay(eventId, destinationTimestamp);\n                })\n                .then(function() {\n                    // If the update was successful then broadcast an event letting the calendar\n                    // know that an event has been moved.\n                    $('body').trigger(CalendarEvents.eventMoved, [eventId, originElement, destinationElement]);\n                    return;\n                })\n                .always(function() {\n                    // Always remove the loading icons regardless of whether the update\n                    // request was successful or not.\n                    var destinationLoadingElement = destinationElement.find(SELECTORS.LOADING_ICON);\n                    destinationElement.find(SELECTORS.DAY_CONTENT).removeClass('hidden');\n                    Templates.replaceNode(destinationLoadingElement, '', '');\n\n                    if (originElement) {\n                        var originLoadingElement = originElement.find(SELECTORS.LOADING_ICON);\n                        originElement.find(SELECTORS.DAY_CONTENT).removeClass('hidden');\n                        Templates.replaceNode(originLoadingElement, '', '');\n                    }\n                    return;\n                })\n                .fail(Notification.exception);\n        }\n    };\n\n    /**\n     * Listen to and handle any calendar events fired by the calendar UI.\n     *\n     * @method registerCalendarEventListeners\n     * @param {object} root The calendar root element\n     * @param {object} eventFormModalPromise A promise reolved with the event form modal\n     */\n    var registerCalendarEventListeners = function(root, eventFormModalPromise) {\n        var body = $('body');\n\n        body.on(CalendarEvents.created, function() {\n            CalendarViewManager.reloadCurrentMonth(root);\n        });\n        body.on(CalendarEvents.deleted, function() {\n            CalendarViewManager.reloadCurrentMonth(root);\n        });\n        body.on(CalendarEvents.updated, function() {\n            CalendarViewManager.reloadCurrentMonth(root);\n        });\n        body.on(CalendarEvents.editActionEvent, function(e, url) {\n            // Action events needs to be edit directly on the course module.\n            window.location.assign(url);\n        });\n        // Handle the event fired by the drag and drop code.\n        body.on(CalendarEvents.moveEvent, handleMoveEvent);\n        // When an event is successfully moved we should updated the UI.\n        body.on(CalendarEvents.eventMoved, function() {\n            CalendarViewManager.reloadCurrentMonth(root);\n        });\n\n        CalendarCrud.registerEditListeners(root, eventFormModalPromise);\n    };\n\n    /**\n     * Register event listeners for the module.\n     *\n     * @param {object} root The calendar root element\n     */\n    var registerEventListeners = function(root) {\n        root.on('change', CalendarSelectors.elements.courseSelector, function() {\n            var selectElement = $(this);\n            var courseId = selectElement.val();\n            CalendarViewManager.reloadCurrentMonth(root, courseId, null)\n                .then(function() {\n                    // We need to get the selector again because the content has changed.\n                    return root.find(CalendarSelectors.elements.courseSelector).val(courseId);\n                })\n                .fail(Notification.exception);\n        });\n\n        var eventFormPromise = CalendarCrud.registerEventFormModal(root),\n            contextId = $(SELECTORS.CALENDAR_MONTH_WRAPPER).data('context-id');\n        registerCalendarEventListeners(root, eventFormPromise);\n\n        if (contextId) {\n            // Bind click events to calendar days.\n            root.on('click', SELECTORS.DAY, function (e) {\n\n                var target = $(e.target);\n\n                if (!target.is(SELECTORS.VIEW_DAY_LINK)) {\n                    var startTime = $(this).attr('data-new-event-timestamp');\n                    eventFormPromise.then(function (modal) {\n                        var wrapper = target.closest(CalendarSelectors.wrapper);\n                        modal.setCourseId(wrapper.data('courseid'));\n\n                        var categoryId = wrapper.data('categoryid');\n                        if (typeof categoryId !== 'undefined') {\n                            modal.setCategoryId(categoryId);\n                        }\n\n                        modal.setContextId(wrapper.data('contextId'));\n                        modal.setStartTime(startTime);\n                        modal.show();\n                        return;\n                    })\n                    .fail(Notification.exception);\n\n                    e.preventDefault();\n                }\n            });\n        }\n    };\n\n    return {\n        init: function(root) {\n            root = $(root);\n            CalendarViewManager.init(root);\n            registerEventListeners(root);\n        }\n    };\n});\n"]}